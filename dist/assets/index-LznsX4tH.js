(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();let ia=0;function rt(n){const e=document.querySelector("[data-app-loader]");if(e){if(n){ia+=1,e.hidden=!1,e.classList.add("is-visible");return}ia=Math.max(0,ia-1),ia===0&&(e.classList.remove("is-visible"),e.hidden=!0)}}function Y(n,e="info"){const r=new Set(["info","success","error"]).has(e)?e:"info",i=document.createElement("div");i.className=`toast toast-${r}`,i.setAttribute("role",r==="error"?"alert":"status"),i.setAttribute("aria-live",r==="error"?"assertive":"polite"),i.setAttribute("aria-atomic","true"),i.textContent=n;const s=document.querySelector("[data-toast-container]");s&&(s.appendChild(i),setTimeout(()=>i.classList.add("visible"),20),setTimeout(()=>{i.classList.remove("visible"),i.classList.add("toast-leaving"),i.addEventListener("transitionend",()=>i.remove(),{once:!0})},3200))}function kl(n){const e=document.querySelector("[data-drawer]"),t=document.querySelector("[data-drawer-body]");if(!e||!t)return;t.innerHTML="",t.appendChild(n);const r=n.classList.contains("menu-list");e.classList.toggle("drawer--menu-background",r),e.classList.add("open")}function ks(){const n=document.querySelector("[data-drawer]");n&&(n.classList.remove("open"),n.classList.remove("drawer--menu-background"))}function ln(n,e){const t=document.createElement("select");return n.forEach(r=>{const i=document.createElement("option");i.value=r.value,i.textContent=r.label,r.value===e&&(i.selected=!0),t.appendChild(i)}),t}function de({label:n,name:e,type:t="text",value:r="",placeholder:i=""}){const s=document.createElement("label");s.className="field";const l=document.createElement("span");l.textContent=n;const u=document.createElement("input");return u.type=t,u.name=e,u.value=r,u.placeholder=i,s.appendChild(l),s.appendChild(u),s}function yn({label:n,name:e,value:t="",placeholder:r=""}){const i=document.createElement("label");i.className="field";const s=document.createElement("span");s.textContent=n;const l=document.createElement("textarea");return l.name=e,l.value=t,l.placeholder=r,i.appendChild(s),i.appendChild(l),i}function Pn({title:n="Conferma",message:e,confirmLabel:t="Conferma",cancelLabel:r="Annulla"}={}){return new Promise(i=>{const s=document.querySelector("[data-confirm-modal]");if(!s){i(!1);return}const l=s.querySelector("[data-confirm-title]"),u=s.querySelector("[data-confirm-message]"),h=s.querySelector("[data-confirm-ok]"),f=s.querySelector("[data-confirm-cancel]"),g=s.querySelector("[data-confirm-overlay]");l&&(l.textContent=n),u&&(u.textContent=e||""),h&&(h.textContent=t),f&&(f.textContent=r),s.hidden=!1,s.classList.add("open");const y=v=>{s.classList.remove("open"),s.hidden=!0,h==null||h.removeEventListener("click",_),f==null||f.removeEventListener("click",w),g==null||g.removeEventListener("click",w),i(v)},_=()=>y(!0),w=()=>y(!1);h==null||h.addEventListener("click",_),f==null||f.addEventListener("click",w),g==null||g.addEventListener("click",w)})}function dt({title:n="Inserisci dati",content:e="",submitLabel:t="Conferma",cancelLabel:r="Annulla",cardClass:i="",showFooter:s=!0,onOpen:l}={}){return new Promise(u=>{var M;const h=document.querySelector("[data-form-modal]");if(!h){u(null);return}const f=h.querySelector(".modal-card"),g=h.querySelector("[data-form-title]"),y=h.querySelector("[data-form-body]"),_=h.querySelector("[data-form-fields]"),w=h.querySelector("[data-form-submit]"),v=h.querySelector("[data-form-cancel]"),E=h.querySelector(".modal-footer"),j=h.querySelector("[data-form-overlay]"),V=((M=h.dataset.formCardClasses)==null?void 0:M.split(" ").filter(Boolean))??[];f&&V.length&&V.forEach(F=>f.classList.remove(F));const z=Array.isArray(i)?i:i?[i]:[];f&&z.length&&z.forEach(F=>f.classList.add(F)),h.dataset.formCardClasses=z.join(" "),g&&(g.textContent=n),w&&(w.textContent=t),E&&(E.hidden=!s),v&&(r===null?v.hidden=!0:(v.hidden=!1,v.textContent=r)),_&&(_.innerHTML="",typeof e=="string"?_.innerHTML=e:e&&_.appendChild(e)),h.hidden=!1,h.classList.add("open");let T=null;if(typeof l=="function"){const F=l({modal:h,formEl:y,fieldsEl:_});typeof F=="function"&&(T=F)}const H=F=>{h.classList.remove("open"),h.hidden=!0,f&&h.dataset.formCardClasses&&(h.dataset.formCardClasses.split(" ").filter(Boolean).forEach(pe=>f.classList.remove(pe)),h.dataset.formCardClasses=""),T&&T(),y==null||y.removeEventListener("submit",U),v==null||v.removeEventListener("click",R),j==null||j.removeEventListener("click",R),u(F)},U=F=>{F.preventDefault();const pe=y?new FormData(y):null;H(pe)},R=()=>H(null);y==null||y.addEventListener("submit",U),v==null||v.addEventListener("click",R),j==null||j.addEventListener("click",R)})}const pr=new Set,fa="dd_active_character",Kt={user:null,profile:null,characters:[],activeCharacterId:null,offline:!1,cache:{items:[],resources:[],journal:[],wallet:null,tags:[]}};function Pi(n){return n?`${fa}:${n}`:fa}function bt(n){return n==null||n===""?null:String(n)}function Sl(n){return typeof localStorage>"u"?null:bt(localStorage.getItem(Pi(n)))}function El(n,e){if(typeof localStorage>"u")return;const t=Pi(n),r=bt(e);r?localStorage.setItem(t,r):localStorage.removeItem(t)}function Al(n){if(typeof localStorage>"u")return;n&&localStorage.removeItem(Pi(n));const e=`${fa}:`;Object.keys(localStorage).filter(t=>t===fa||t.startsWith(e)).forEach(t=>localStorage.removeItem(t))}function ht(){return Kt}function un(n){Object.assign(Kt,n),pr.forEach(e=>e(Kt))}function Cl(n){return pr.add(n),()=>pr.delete(n)}function Ea(n){var e;Kt.activeCharacterId=bt(n),El((e=Kt.user)==null?void 0:e.id,Kt.activeCharacterId),pr.forEach(t=>t(Kt))}function uo(){Kt.user=null,Kt.profile=null,Kt.characters=[],Kt.activeCharacterId=null,Kt.cache={items:[],resources:[],journal:[],wallet:null,tags:[]},pr.forEach(n=>n(Kt))}function xt(n,e){Kt.cache[n]=e,pr.forEach(t=>t(Kt))}function $l(n){const e="/dungeons-dragons-app/";n.innerHTML=`
    <div class="app-shell">
      <header class="app-header" data-app-header>
        <div class="app-header-left">
          <div class="app-logo">
            <img src="${e}icons/logo_dd.png" alt="Dungeons & Dragons" class="app-logo-image" />
          </div>
          <div>           
          </div>
        </div>
        <div class="app-header-right">
          <div class="header-meta" data-header-meta>
            <div class="header-meta-item" data-user-row>
              <div class="header-avatar" data-user-avatar></div>
              <div class="header-meta-text">
                <span class="header-meta-label">Utente</span>
                <strong data-user-name></strong>
              </div>
            </div>
            <div class="header-meta-item" data-character-row>
              <div class="header-avatar" data-character-avatar></div>
              <div class="header-meta-text">
                <span class="header-meta-label">Personaggio</span>
                <strong data-character-name></strong>
              </div>
            </div>
          </div>
          <div class="header-action-wrap">
            <button class="menu-button" type="button" data-menu-button aria-label="Apri menu">
              <span></span>
              <span></span>
              <span></span>
            </button>
          </div>
        </div>
      </header>
      <div class="offline-banner" data-offline-banner hidden>
        Offline (solo lettura)
      </div>
      <main class="app-main" data-route-outlet></main>
      <div class="actions-fab" data-actions-fab>
        <div class="actions-fab-menu" data-actions-menu>
          <button class="actions-fab-item" type="button" data-rest="short_rest">Riposo Breve</button>
          <button class="actions-fab-item" type="button" data-add-loot>Loot</button>
          <button class="actions-fab-item" type="button" data-money-action="pay" data-fab-scope="inventory">Paga</button>
          <button class="actions-fab-item" type="button" data-money-action="receive" data-fab-scope="inventory">Ricevi</button>
          <button class="actions-fab-item" type="button" data-hp-action="heal">Cura</button>
          <button class="actions-fab-item" type="button" data-hp-action="damage">Danno</button>
          <button class="actions-fab-item" type="button" data-edit-conditions data-fab-scope="home">Condizioni</button>
          <button class="actions-fab-item" type="button" data-open-dice="roller">Dadi</button>
          <button class="actions-fab-item" type="button" data-rest="long_rest">Riposo Lungo</button>
        </div>
        <button class="actions-fab-toggle" type="button" data-actions-toggle aria-expanded="false">
          Azioni
        </button>
      </div>
      <div class="actions-fab-backdrop" aria-hidden="true"></div>
      <nav class="bottom-nav" data-bottom-nav>
        <a href="#/home" data-tab="home"><span class="bottom-nav__pill">Scheda Personaggio</span></a>
        <a href="#/inventory" data-tab="inventory"><span class="bottom-nav__pill">Inventario</span></a>
        <a href="#/journal" data-tab="journal"><span class="bottom-nav__pill">Diario</span></a>
      </nav>
      <div class="drawer" data-drawer>
        <div class="drawer-overlay" data-drawer-close></div>
        <div class="drawer-panel">          
          <div data-drawer-body></div>
        </div>
      </div>
      <div class="modal" data-confirm-modal hidden>
        <div class="modal-overlay" data-confirm-overlay></div>
        <div class="modal-card" role="dialog" aria-modal="true">
          <div class="modal-header">
            <p class="modal-title" data-confirm-title>Conferma</p>
            <div class="modal-divider" aria-hidden="true"></div>
          </div>
          <div class="modal-body">
            <p data-confirm-message></p>
          </div>
          <div class="modal-footer">
            <div class="modal-divider" aria-hidden="true"></div>
            <div class="modal-actions">
              <div class="modal-actions__left">
                <button class="ghost-button" data-confirm-cancel>Annulla</button>
              </div>
              <div class="modal-actions__right">
                <button class="primary" data-confirm-ok>Conferma</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" data-form-modal hidden>
        <div class="modal-overlay" data-form-overlay></div>
        <div class="modal-card" role="dialog" aria-modal="true">
          <div class="modal-header">
            <p class="modal-title" data-form-title>Inserisci dati</p>
            <div class="modal-divider" aria-hidden="true"></div>
          </div>
          <form data-form-body class="modal-form">
            <div class="modal-body" data-form-fields></div>
            <div class="modal-footer">
              <div class="modal-divider" aria-hidden="true"></div>
              <div class="modal-actions">
                <div class="modal-actions__left">
                  <button class="ghost-button" type="button" data-form-cancel>Annulla</button>
                </div>
                <div class="modal-actions__right">
                  <button class="primary" type="submit" data-form-submit>Conferma</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="toast-container" data-toast-container></div>
      <div class="app-loading-overlay" data-app-loader hidden>
        <div class="app-loading-spinner" aria-hidden="true"></div>
        <p class="app-loading-text">Caricamento in corso...</p>
      </div>
    </div>
  `,n.querySelectorAll("[data-drawer-close]").forEach(s=>s.addEventListener("click",ks));const t=n.querySelector("[data-menu-button]");t&&t.addEventListener("click",()=>{kl(Ol())});const r=n.querySelector("[data-actions-fab]"),i=n.querySelector("[data-actions-toggle]");r&&i&&i.addEventListener("click",s=>{s.stopPropagation(),r.classList.toggle("is-open"),i.setAttribute("aria-expanded",r.classList.contains("is-open"))}),n.addEventListener("click",s=>{s.target.closest("[data-drawer-close]")&&ks(),r&&r.classList.contains("is-open")&&(s.target.closest("[data-actions-fab]")||(r.classList.remove("is-open"),i==null||i.setAttribute("aria-expanded","false")))})}function Tl(n){document.querySelectorAll("[data-bottom-nav] a").forEach(e=>{const t=e.getAttribute("href")===`#/${n}`;e.classList.toggle("active",t)})}function xl(){const n=document.querySelector("[data-offline-banner]");if(!n)return;const{offline:e}=ht(),t=window.location.hash.replace("#/","")||"home";n.hidden=t==="login"||!e}function ho(){var w,v,E;const n=document.querySelector("[data-header-meta]"),e=document.querySelector("[data-menu-button]");if(!n)return;const{user:t,characters:r,activeCharacterId:i}=ht(),s=r.find(j=>j.id===i),l=n.querySelector("[data-user-row]"),u=n.querySelector("[data-character-row]"),h=n.querySelector("[data-user-name]"),f=n.querySelector("[data-character-name]"),g=n.querySelector("[data-user-avatar]"),y=n.querySelector("[data-character-avatar]"),_=((w=t==null?void 0:t.user_metadata)==null?void 0:w.display_name)||(t==null?void 0:t.email)||"Utente";l&&(l.hidden=!t),h&&(h.textContent=t?_:""),g&&Ss(g,_,(v=t==null?void 0:t.user_metadata)==null?void 0:v.avatar_url),u&&(u.hidden=!s),f&&(f.textContent=(s==null?void 0:s.name)??""),y&&Ss(y,s==null?void 0:s.name,(E=s==null?void 0:s.data)==null?void 0:E.avatar_url),n.hidden=!t,e&&(e.hidden=!t)}function Ol(){const n=document.createElement("div");return n.className="menu-list",n.innerHTML=`
    <a class="menu-item" href="#/characters" data-drawer-close>Seleziona personaggi</a>
    <button class="menu-item menu-item--danger" type="button" data-logout data-drawer-close>Logout</button>
  `,n}function Ss(n,e,t){if(n.innerHTML="",t){const s=document.createElement("img");s.src=t,s.alt=e?`Avatar di ${e}`:"Avatar",n.appendChild(s);return}const r=Rl(e),i=document.createElement("span");i.textContent=r,n.appendChild(i)}function Rl(n=""){const e=n.split(" ").filter(Boolean);return e.length?e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]}${e[1][0]}`.toUpperCase():"??"}const fi=new Map;function Dr(n,e){fi.set(n,e)}function Nl(n){window.location.hash=`#/${n}`}function Pl(){window.addEventListener("hashchange",()=>{Es()}),Es()}async function Es(){const n=document.querySelector("[data-route-outlet]");if(!n)return;const e=window.location.hash.replace("#/","")||"home",{user:t}=ht(),r=document.querySelector("[data-bottom-nav]"),i=document.querySelector("[data-actions-fab]"),s=document.querySelector(".actions-fab-backdrop"),l=document.querySelector("[data-app-header]"),u=document.querySelector("[data-offline-banner]"),h=document.querySelector(".app-shell"),f=e==="login"||e==="characters",g=e==="login",y=["home","inventory","journal"],_=y.includes(e),w=e==="login"||e==="characters";h&&h.classList.toggle("app-shell--auth",w),document.body.classList.toggle("no-route-scroll",w);const v=(E,j)=>{const{offline:V}=ht();r&&(r.hidden=E),i&&(i.hidden=!j,i.classList.remove("is-open")),s&&(s.hidden=!j),l&&(l.hidden=g),u&&(u.hidden=g||!V),i&&i.querySelectorAll("[data-fab-scope]").forEach(z=>{z.hidden=!y.includes(e)&&z.dataset.fabScope!==e})};rt(!0);try{if(!t&&e!=="login"){v(!0,!1),window.location.hash="#/login";return}if(t&&e==="login"){v(!1,_),window.location.hash="#/home";return}const E=fi.get(e)||fi.get("home");Tl(e),v(f,_),w||(n.innerHTML=""),await(E==null?void 0:E(n))}finally{rt(!1)}}function Aa(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(n);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(n,r[i])&&(t[r[i]]=n[r[i]]);return t}function Il(n,e,t,r){function i(s){return s instanceof t?s:new t(function(l){l(s)})}return new(t||(t=Promise))(function(s,l){function u(g){try{f(r.next(g))}catch(y){l(y)}}function h(g){try{f(r.throw(g))}catch(y){l(y)}}function f(g){g.done?s(g.value):i(g.value).then(u,h)}f((r=r.apply(n,e||[])).next())})}const Ll=n=>n?(...e)=>n(...e):(...e)=>fetch(...e);class Ii extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class ql extends Ii{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class As extends Ii{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Cs extends Ii{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var pi;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(pi||(pi={}));class jl{constructor(e,{headers:t={},customFetch:r,region:i=pi.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=Ll(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return Il(this,arguments,void 0,function*(t,r={}){var i;let s,l;try{const{headers:u,method:h,body:f,signal:g,timeout:y}=r;let _={},{region:w}=r;w||(w=this.region);const v=new URL(`${this.url}/${t}`);w&&w!=="any"&&(_["x-region"]=w,v.searchParams.set("forceFunctionRegion",w));let E;f&&(u&&!Object.prototype.hasOwnProperty.call(u,"Content-Type")||!u)?typeof Blob<"u"&&f instanceof Blob||f instanceof ArrayBuffer?(_["Content-Type"]="application/octet-stream",E=f):typeof f=="string"?(_["Content-Type"]="text/plain",E=f):typeof FormData<"u"&&f instanceof FormData?E=f:(_["Content-Type"]="application/json",E=JSON.stringify(f)):f&&typeof f!="string"&&!(typeof Blob<"u"&&f instanceof Blob)&&!(f instanceof ArrayBuffer)&&!(typeof FormData<"u"&&f instanceof FormData)?E=JSON.stringify(f):E=f;let j=g;y&&(l=new AbortController,s=setTimeout(()=>l.abort(),y),g?(j=l.signal,g.addEventListener("abort",()=>l.abort())):j=l.signal);const V=yield this.fetch(v.toString(),{method:h||"POST",headers:Object.assign(Object.assign(Object.assign({},_),this.headers),u),body:E,signal:j}).catch(U=>{throw new ql(U)}),z=V.headers.get("x-relay-error");if(z&&z==="true")throw new As(V);if(!V.ok)throw new Cs(V);let T=((i=V.headers.get("Content-Type"))!==null&&i!==void 0?i:"text/plain").split(";")[0].trim(),H;return T==="application/json"?H=yield V.json():T==="application/octet-stream"||T==="application/pdf"?H=yield V.blob():T==="text/event-stream"?H=V:T==="multipart/form-data"?H=yield V.formData():H=yield V.text(),{data:H,error:null,response:V}}catch(u){return{data:null,error:u,response:u instanceof Cs||u instanceof As?u.context:void 0}}finally{s&&clearTimeout(s)}})}}var Dl=class extends Error{constructor(n){super(n.message),this.name="PostgrestError",this.details=n.details,this.hint=n.hint,this.code=n.code}},Ml=class{constructor(n){var e,t;this.shouldThrowOnError=!1,this.method=n.method,this.url=n.url,this.headers=new Headers(n.headers),this.schema=n.schema,this.body=n.body,this.shouldThrowOnError=(e=n.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=n.signal,this.isMaybeSingle=(t=n.isMaybeSingle)!==null&&t!==void 0?t:!1,n.fetch?this.fetch=n.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(n,e){return this.headers=new Headers(this.headers),this.headers.set(n,e),this}then(n,e){var t=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const r=this.fetch;let i=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async s=>{let l=null,u=null,h=null,f=s.status,g=s.statusText;if(s.ok){var y,_;if(t.method!=="HEAD"){var w;const V=await s.text();V===""||(t.headers.get("Accept")==="text/csv"||t.headers.get("Accept")&&(!((w=t.headers.get("Accept"))===null||w===void 0)&&w.includes("application/vnd.pgrst.plan+text"))?u=V:u=JSON.parse(V))}const E=(y=t.headers.get("Prefer"))===null||y===void 0?void 0:y.match(/count=(exact|planned|estimated)/),j=(_=s.headers.get("content-range"))===null||_===void 0?void 0:_.split("/");E&&j&&j.length>1&&(h=parseInt(j[1])),t.isMaybeSingle&&t.method==="GET"&&Array.isArray(u)&&(u.length>1?(l={code:"PGRST116",details:`Results contain ${u.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},u=null,h=null,f=406,g="Not Acceptable"):u.length===1?u=u[0]:u=null)}else{var v;const E=await s.text();try{l=JSON.parse(E),Array.isArray(l)&&s.status===404&&(u=[],l=null,f=200,g="OK")}catch{s.status===404&&E===""?(f=204,g="No Content"):l={message:E}}if(l&&t.isMaybeSingle&&(!(l==null||(v=l.details)===null||v===void 0)&&v.includes("0 rows"))&&(l=null,f=200,g="OK"),l&&t.shouldThrowOnError)throw new Dl(l)}return{error:l,data:u,count:h,status:f,statusText:g}});return this.shouldThrowOnError||(i=i.catch(s=>{var l;let u="";const h=s==null?void 0:s.cause;if(h){var f,g,y,_;const v=(f=h==null?void 0:h.message)!==null&&f!==void 0?f:"",E=(g=h==null?void 0:h.code)!==null&&g!==void 0?g:"";u=`${(y=s==null?void 0:s.name)!==null&&y!==void 0?y:"FetchError"}: ${s==null?void 0:s.message}`,u+=`

Caused by: ${(_=h==null?void 0:h.name)!==null&&_!==void 0?_:"Error"}: ${v}`,E&&(u+=` (${E})`),h!=null&&h.stack&&(u+=`
${h.stack}`)}else{var w;u=(w=s==null?void 0:s.stack)!==null&&w!==void 0?w:""}return{error:{message:`${(l=s==null?void 0:s.name)!==null&&l!==void 0?l:"FetchError"}: ${s==null?void 0:s.message}`,details:u,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),i.then(n,e)}returns(){return this}overrideTypes(){return this}},Bl=class extends Ml{select(n){let e=!1;const t=(n??"*").split("").map(r=>/\s/.test(r)&&!e?"":(r==='"'&&(e=!e),r)).join("");return this.url.searchParams.set("select",t),this.headers.append("Prefer","return=representation"),this}order(n,{ascending:e=!0,nullsFirst:t,foreignTable:r,referencedTable:i=r}={}){const s=i?`${i}.order`:"order",l=this.url.searchParams.get(s);return this.url.searchParams.set(s,`${l?`${l},`:""}${n}.${e?"asc":"desc"}${t===void 0?"":t?".nullsfirst":".nullslast"}`),this}limit(n,{foreignTable:e,referencedTable:t=e}={}){const r=typeof t>"u"?"limit":`${t}.limit`;return this.url.searchParams.set(r,`${n}`),this}range(n,e,{foreignTable:t,referencedTable:r=t}={}){const i=typeof r>"u"?"offset":`${r}.offset`,s=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(i,`${n}`),this.url.searchParams.set(s,`${e-n+1}`),this}abortSignal(n){return this.signal=n,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:n=!1,verbose:e=!1,settings:t=!1,buffers:r=!1,wal:i=!1,format:s="text"}={}){var l;const u=[n?"analyze":null,e?"verbose":null,t?"settings":null,r?"buffers":null,i?"wal":null].filter(Boolean).join("|"),h=(l=this.headers.get("Accept"))!==null&&l!==void 0?l:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${s}; for="${h}"; options=${u};`),s==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(n){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${n}`),this}};const $s=new RegExp("[,()]");var or=class extends Bl{eq(n,e){return this.url.searchParams.append(n,`eq.${e}`),this}neq(n,e){return this.url.searchParams.append(n,`neq.${e}`),this}gt(n,e){return this.url.searchParams.append(n,`gt.${e}`),this}gte(n,e){return this.url.searchParams.append(n,`gte.${e}`),this}lt(n,e){return this.url.searchParams.append(n,`lt.${e}`),this}lte(n,e){return this.url.searchParams.append(n,`lte.${e}`),this}like(n,e){return this.url.searchParams.append(n,`like.${e}`),this}likeAllOf(n,e){return this.url.searchParams.append(n,`like(all).{${e.join(",")}}`),this}likeAnyOf(n,e){return this.url.searchParams.append(n,`like(any).{${e.join(",")}}`),this}ilike(n,e){return this.url.searchParams.append(n,`ilike.${e}`),this}ilikeAllOf(n,e){return this.url.searchParams.append(n,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(n,e){return this.url.searchParams.append(n,`ilike(any).{${e.join(",")}}`),this}regexMatch(n,e){return this.url.searchParams.append(n,`match.${e}`),this}regexIMatch(n,e){return this.url.searchParams.append(n,`imatch.${e}`),this}is(n,e){return this.url.searchParams.append(n,`is.${e}`),this}isDistinct(n,e){return this.url.searchParams.append(n,`isdistinct.${e}`),this}in(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&$s.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`in.(${t})`),this}notIn(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&$s.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`not.in.(${t})`),this}contains(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cs.{${e.join(",")}}`):this.url.searchParams.append(n,`cs.${JSON.stringify(e)}`),this}containedBy(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cd.{${e.join(",")}}`):this.url.searchParams.append(n,`cd.${JSON.stringify(e)}`),this}rangeGt(n,e){return this.url.searchParams.append(n,`sr.${e}`),this}rangeGte(n,e){return this.url.searchParams.append(n,`nxl.${e}`),this}rangeLt(n,e){return this.url.searchParams.append(n,`sl.${e}`),this}rangeLte(n,e){return this.url.searchParams.append(n,`nxr.${e}`),this}rangeAdjacent(n,e){return this.url.searchParams.append(n,`adj.${e}`),this}overlaps(n,e){return typeof e=="string"?this.url.searchParams.append(n,`ov.${e}`):this.url.searchParams.append(n,`ov.{${e.join(",")}}`),this}textSearch(n,e,{config:t,type:r}={}){let i="";r==="plain"?i="pl":r==="phrase"?i="ph":r==="websearch"&&(i="w");const s=t===void 0?"":`(${t})`;return this.url.searchParams.append(n,`${i}fts${s}.${e}`),this}match(n){return Object.entries(n).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(n,e,t){return this.url.searchParams.append(n,`not.${e}.${t}`),this}or(n,{foreignTable:e,referencedTable:t=e}={}){const r=t?`${t}.or`:"or";return this.url.searchParams.append(r,`(${n})`),this}filter(n,e,t){return this.url.searchParams.append(n,`${e}.${t}`),this}},Ul=class{constructor(n,{headers:e={},schema:t,fetch:r}){this.url=n,this.headers=new Headers(e),this.schema=t,this.fetch=r}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(n,e){const{head:t=!1,count:r}=e??{},i=t?"HEAD":"GET";let s=!1;const l=(n??"*").split("").map(f=>/\s/.test(f)&&!s?"":(f==='"'&&(s=!s),f)).join(""),{url:u,headers:h}=this.cloneRequestState();return u.searchParams.set("select",l),r&&h.append("Prefer",`count=${r}`),new or({method:i,url:u,headers:h,schema:this.schema,fetch:this.fetch})}insert(n,{count:e,defaultToNull:t=!0}={}){var r;const i="POST",{url:s,headers:l}=this.cloneRequestState();if(e&&l.append("Prefer",`count=${e}`),t||l.append("Prefer","missing=default"),Array.isArray(n)){const u=n.reduce((h,f)=>h.concat(Object.keys(f)),[]);if(u.length>0){const h=[...new Set(u)].map(f=>`"${f}"`);s.searchParams.set("columns",h.join(","))}}return new or({method:i,url:s,headers:l,schema:this.schema,body:n,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch})}upsert(n,{onConflict:e,ignoreDuplicates:t=!1,count:r,defaultToNull:i=!0}={}){var s;const l="POST",{url:u,headers:h}=this.cloneRequestState();if(h.append("Prefer",`resolution=${t?"ignore":"merge"}-duplicates`),e!==void 0&&u.searchParams.set("on_conflict",e),r&&h.append("Prefer",`count=${r}`),i||h.append("Prefer","missing=default"),Array.isArray(n)){const f=n.reduce((g,y)=>g.concat(Object.keys(y)),[]);if(f.length>0){const g=[...new Set(f)].map(y=>`"${y}"`);u.searchParams.set("columns",g.join(","))}}return new or({method:l,url:u,headers:h,schema:this.schema,body:n,fetch:(s=this.fetch)!==null&&s!==void 0?s:fetch})}update(n,{count:e}={}){var t;const r="PATCH",{url:i,headers:s}=this.cloneRequestState();return e&&s.append("Prefer",`count=${e}`),new or({method:r,url:i,headers:s,schema:this.schema,body:n,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch})}delete({count:n}={}){var e;const t="DELETE",{url:r,headers:i}=this.cloneRequestState();return n&&i.append("Prefer",`count=${n}`),new or({method:t,url:r,headers:i,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch})}},zl=class fo{constructor(e,{headers:t={},schema:r,fetch:i}={}){this.url=e,this.headers=new Headers(t),this.schemaName=r,this.fetch=i}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new Ul(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new fo(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:i=!1,count:s}={}){var l;let u;const h=new URL(`${this.url}/rpc/${e}`);let f;const g=w=>w!==null&&typeof w=="object"&&(!Array.isArray(w)||w.some(g)),y=r&&Object.values(t).some(g);y?(u="POST",f=t):r||i?(u=r?"HEAD":"GET",Object.entries(t).filter(([w,v])=>v!==void 0).map(([w,v])=>[w,Array.isArray(v)?`{${v.join(",")}}`:`${v}`]).forEach(([w,v])=>{h.searchParams.append(w,v)})):(u="POST",f=t);const _=new Headers(this.headers);return y?_.set("Prefer",s?`count=${s},return=minimal`:"return=minimal"):s&&_.set("Prefer",`count=${s}`),new or({method:u,url:h,headers:_,schema:this.schemaName,body:f,fetch:(l=this.fetch)!==null&&l!==void 0?l:fetch})}};class Fl{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const t=globalThis.process;if(t){const r=t.versions;if(r&&r.node){const i=r.node,s=parseInt(i.replace(/^v/,"").split(".")[0]);return s>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${s} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${s} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const Kl="2.91.1",Hl=`realtime-js/${Kl}`,Wl="1.0.0",po="2.0.0",Ts=po,mi=1e4,Vl=1e3,Gl=100;var Rn;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(Rn||(Rn={}));var Tt;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(Tt||(Tt={}));var fn;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(fn||(fn={}));var gi;(function(n){n.websocket="websocket"})(gi||(gi={}));var Hn;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(Hn||(Hn={}));class Jl{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,r;const i=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,i)}_encodeJsonUserBroadcastPush(e){var t,r;const i=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:{},l=new TextEncoder().encode(JSON.stringify(i)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,l)}_encodeUserBroadcastPush(e,t,r){var i,s;const l=e.topic,u=(i=e.ref)!==null&&i!==void 0?i:"",h=(s=e.join_ref)!==null&&s!==void 0?s:"",f=e.payload.event,g=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},y=Object.keys(g).length===0?"":JSON.stringify(g);if(h.length>255)throw new Error(`joinRef length ${h.length} exceeds maximum of 255`);if(u.length>255)throw new Error(`ref length ${u.length} exceeds maximum of 255`);if(l.length>255)throw new Error(`topic length ${l.length} exceeds maximum of 255`);if(f.length>255)throw new Error(`userEvent length ${f.length} exceeds maximum of 255`);if(y.length>255)throw new Error(`metadata length ${y.length} exceeds maximum of 255`);const _=this.USER_BROADCAST_PUSH_META_LENGTH+h.length+u.length+l.length+f.length+y.length,w=new ArrayBuffer(this.HEADER_LENGTH+_);let v=new DataView(w),E=0;v.setUint8(E++,this.KINDS.userBroadcastPush),v.setUint8(E++,h.length),v.setUint8(E++,u.length),v.setUint8(E++,l.length),v.setUint8(E++,f.length),v.setUint8(E++,y.length),v.setUint8(E++,t),Array.from(h,V=>v.setUint8(E++,V.charCodeAt(0))),Array.from(u,V=>v.setUint8(E++,V.charCodeAt(0))),Array.from(l,V=>v.setUint8(E++,V.charCodeAt(0))),Array.from(f,V=>v.setUint8(E++,V.charCodeAt(0))),Array.from(y,V=>v.setUint8(E++,V.charCodeAt(0)));var j=new Uint8Array(w.byteLength+r.byteLength);return j.set(new Uint8Array(w),0),j.set(new Uint8Array(r),w.byteLength),j.buffer}decode(e,t){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return t(r)}if(typeof e=="string"){const r=JSON.parse(e),[i,s,l,u,h]=r;return t({join_ref:i,ref:s,topic:l,event:u,payload:h})}return t({})}_binaryDecode(e){const t=new DataView(e),r=t.getUint8(0),i=new TextDecoder;switch(r){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,t,i)}}_decodeUserBroadcast(e,t,r){const i=t.getUint8(1),s=t.getUint8(2),l=t.getUint8(3),u=t.getUint8(4);let h=this.HEADER_LENGTH+4;const f=r.decode(e.slice(h,h+i));h=h+i;const g=r.decode(e.slice(h,h+s));h=h+s;const y=r.decode(e.slice(h,h+l));h=h+l;const _=e.slice(h,e.byteLength),w=u===this.JSON_ENCODING?JSON.parse(r.decode(_)):_,v={type:this.BROADCAST_EVENT,event:g,payload:w};return l>0&&(v.meta=JSON.parse(y)),{join_ref:null,ref:null,topic:f,event:this.BROADCAST_EVENT,payload:v}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e==null?void 0:e.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>t.includes(r)))}}class mo{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var nt;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(nt||(nt={}));const xs=(n,e,t={})=>{var r;const i=(r=t.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((s,l)=>(s[l]=Yl(l,n,e,i),s),{}):{}},Yl=(n,e,t,r)=>{const i=e.find(u=>u.name===n),s=i==null?void 0:i.type,l=t[n];return s&&!r.includes(s)?go(s,l):vi(l)},go=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return ec(e,t)}switch(n){case nt.bool:return Ql(e);case nt.float4:case nt.float8:case nt.int2:case nt.int4:case nt.int8:case nt.numeric:case nt.oid:return Xl(e);case nt.json:case nt.jsonb:return Zl(e);case nt.timestamp:return tc(e);case nt.abstime:case nt.date:case nt.daterange:case nt.int4range:case nt.int8range:case nt.money:case nt.reltime:case nt.text:case nt.time:case nt.timestamptz:case nt.timetz:case nt.tsrange:case nt.tstzrange:return vi(e);default:return vi(e)}},vi=n=>n,Ql=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Xl=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Zl=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch{return n}return n},ec=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let s;const l=n.slice(1,t);try{s=JSON.parse("["+l+"]")}catch{s=l?l.split(","):[]}return s.map(u=>go(e,u))}return n},tc=n=>typeof n=="string"?n.replace(" ","T"):n,vo=n=>{const e=new URL(n);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class ri{constructor(e,t,r={},i=mi){this.channel=e,this.event=t,this.payload=r,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Os;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(Os||(Os={}));class Tr{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},i=>{const{onJoin:s,onLeave:l,onSync:u}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Tr.syncState(this.state,i,s,l),this.pendingDiffs.forEach(h=>{this.state=Tr.syncDiff(this.state,h,s,l)}),this.pendingDiffs=[],u()}),this.channel._on(r.diff,{},i=>{const{onJoin:s,onLeave:l,onSync:u}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=Tr.syncDiff(this.state,i,s,l),u())}),this.onJoin((i,s,l)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:s,newPresences:l})}),this.onLeave((i,s,l)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:s,leftPresences:l})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,i){const s=this.cloneDeep(e),l=this.transformState(t),u={},h={};return this.map(s,(f,g)=>{l[f]||(h[f]=g)}),this.map(l,(f,g)=>{const y=s[f];if(y){const _=g.map(j=>j.presence_ref),w=y.map(j=>j.presence_ref),v=g.filter(j=>w.indexOf(j.presence_ref)<0),E=y.filter(j=>_.indexOf(j.presence_ref)<0);v.length>0&&(u[f]=v),E.length>0&&(h[f]=E)}else u[f]=g}),this.syncDiff(s,{joins:u,leaves:h},r,i)}static syncDiff(e,t,r,i){const{joins:s,leaves:l}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),i||(i=()=>{}),this.map(s,(u,h)=>{var f;const g=(f=e[u])!==null&&f!==void 0?f:[];if(e[u]=this.cloneDeep(h),g.length>0){const y=e[u].map(w=>w.presence_ref),_=g.filter(w=>y.indexOf(w.presence_ref)<0);e[u].unshift(..._)}r(u,g,h)}),this.map(l,(u,h)=>{let f=e[u];if(!f)return;const g=h.map(y=>y.presence_ref);f=f.filter(y=>g.indexOf(y.presence_ref)<0),e[u]=f,i(u,f,h),f.length===0&&delete e[u]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const i=e[r];return"metas"in i?t[r]=i.metas.map(s=>(s.presence_ref=s.phx_ref,delete s.phx_ref,delete s.phx_ref_prev,s)):t[r]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Rs;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(Rs||(Rs={}));var xr;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(xr||(xr={}));var Sn;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(Sn||(Sn={}));class hr{constructor(e,t={config:{}},r){var i,s;if(this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=Tt.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new ri(this,fn.join,this.params,this.timeout),this.rejoinTimer=new mo(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=Tt.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(l=>l.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=Tt.closed,this.socket._remove(this)}),this._onError(l=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,l),this.state=Tt.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=Tt.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",l=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,l),this.state=Tt.errored,this.rejoinTimer.scheduleTimeout())}),this._on(fn.reply,{},(l,u)=>{this._trigger(this._replyEventName(u),l)}),this.presence=new Tr(this),this.broadcastEndpointURL=vo(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((s=(i=this.params.config)===null||i===void 0?void 0:i.broadcast)===null||s===void 0)&&s.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var r,i,s;if(this.socket.isConnected()||this.socket.connect(),this.state==Tt.closed){const{config:{broadcast:l,presence:u,private:h}}=this.params,f=(i=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(w=>w.filter))!==null&&i!==void 0?i:[],g=!!this.bindings[xr.PRESENCE]&&this.bindings[xr.PRESENCE].length>0||((s=this.params.config.presence)===null||s===void 0?void 0:s.enabled)===!0,y={},_={broadcast:l,presence:Object.assign(Object.assign({},u),{enabled:g}),postgres_changes:f,private:h};this.socket.accessTokenValue&&(y.access_token=this.socket.accessTokenValue),this._onError(w=>e==null?void 0:e(Sn.CHANNEL_ERROR,w)),this._onClose(()=>e==null?void 0:e(Sn.CLOSED)),this.updateJoinPayload(Object.assign({config:_},y)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:w})=>{var v;if(this.socket._isManualToken()||this.socket.setAuth(),w===void 0){e==null||e(Sn.SUBSCRIBED);return}else{const E=this.bindings.postgres_changes,j=(v=E==null?void 0:E.length)!==null&&v!==void 0?v:0,V=[];for(let z=0;z<j;z++){const T=E[z],{filter:{event:H,schema:U,table:R,filter:M}}=T,F=w&&w[z];if(F&&F.event===H&&hr.isFilterValueEqual(F.schema,U)&&hr.isFilterValueEqual(F.table,R)&&hr.isFilterValueEqual(F.filter,M))V.push(Object.assign(Object.assign({},T),{id:F.id}));else{this.unsubscribe(),this.state=Tt.errored,e==null||e(Sn.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=V,e&&e(Sn.SUBSCRIBED);return}}).receive("error",w=>{this.state=Tt.errored,e==null||e(Sn.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(w).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(Sn.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===Tt.joined&&e===xr.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,t,r)}async httpSend(e,t,r={}){var i;if(t==null)return Promise.reject("Payload is required for httpSend()");const s={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(s.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:s,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},u=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(i=r.timeout)!==null&&i!==void 0?i:this.timeout);if(u.status===202)return{success:!0};let h=u.statusText;try{const f=await u.json();h=f.error||f.message||h}catch{}return Promise.reject(new Error(h))}async send(e,t={}){var r,i;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:s,payload:l}=e,u={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(u.Authorization=`Bearer ${this.socket.accessTokenValue}`);const h={method:"POST",headers:u,body:JSON.stringify({messages:[{topic:this.subTopic,event:s,payload:l,private:this.private}]})};try{const f=await this._fetchWithTimeout(this.broadcastEndpointURL,h,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((i=f.body)===null||i===void 0?void 0:i.cancel()),f.ok?"ok":"error"}catch(f){return f.name==="AbortError"?"timed out":"error"}}else return new Promise(s=>{var l,u,h;const f=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((h=(u=(l=this.params)===null||l===void 0?void 0:l.config)===null||u===void 0?void 0:u.broadcast)===null||h===void 0)&&h.ack)&&s("ok"),f.receive("ok",()=>s("ok")),f.receive("error",()=>s("error")),f.receive("timeout",()=>s("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=Tt.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(fn.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(i=>{r=new ri(this,fn.leave,{},e),r.receive("ok",()=>{t(),i("ok")}).receive("timeout",()=>{t(),i("timed out")}).receive("error",()=>{i("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r==null||r.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=Tt.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){const i=new AbortController,s=setTimeout(()=>i.abort(),r),l=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(s),l}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new ri(this,e,t,r);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Gl){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var i,s;const l=e.toLocaleLowerCase(),{close:u,error:h,leave:f,join:g}=fn;if(r&&[u,h,f,g].indexOf(l)>=0&&r!==this._joinRef())return;let _=this._onMessage(l,t,r);if(t&&!_)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(l)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(w=>{var v,E,j;return((v=w.filter)===null||v===void 0?void 0:v.event)==="*"||((j=(E=w.filter)===null||E===void 0?void 0:E.event)===null||j===void 0?void 0:j.toLocaleLowerCase())===l}).map(w=>w.callback(_,r)):(s=this.bindings[l])===null||s===void 0||s.filter(w=>{var v,E,j,V,z,T,H,U;if(["broadcast","presence","postgres_changes"].includes(l))if("id"in w){const R=w.id,M=(v=w.filter)===null||v===void 0?void 0:v.event;return R&&((E=t.ids)===null||E===void 0?void 0:E.includes(R))&&(M==="*"||(M==null?void 0:M.toLocaleLowerCase())===((j=t.data)===null||j===void 0?void 0:j.type.toLocaleLowerCase()))&&(!(!((V=w.filter)===null||V===void 0)&&V.table)||w.filter.table===((z=t.data)===null||z===void 0?void 0:z.table))}else{const R=(H=(T=w==null?void 0:w.filter)===null||T===void 0?void 0:T.event)===null||H===void 0?void 0:H.toLocaleLowerCase();return R==="*"||R===((U=t==null?void 0:t.event)===null||U===void 0?void 0:U.toLocaleLowerCase())}else return w.type.toLocaleLowerCase()===l}).map(w=>{if(typeof _=="object"&&"ids"in _){const v=_.data,{schema:E,table:j,commit_timestamp:V,type:z,errors:T}=v;_=Object.assign(Object.assign({},{schema:E,table:j,commit_timestamp:V,eventType:z,new:{},old:{},errors:T}),this._getPayloadRecords(v))}w.callback(_,r)})}_isClosed(){return this.state===Tt.closed}_isJoined(){return this.state===Tt.joined}_isJoining(){return this.state===Tt.joining}_isLeaving(){return this.state===Tt.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const i=e.toLocaleLowerCase(),s={type:i,filter:t,callback:r};return this.bindings[i]?this.bindings[i].push(s):this.bindings[i]=[s],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(i=>{var s;return!(((s=i.type)===null||s===void 0?void 0:s.toLocaleLowerCase())===r&&hr.isEqual(i.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}static isFilterValueEqual(e,t){return(e??void 0)===(t??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(fn.close,{},e)}_onError(e){this._on(fn.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=Tt.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=xs(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=xs(e.columns,e.old_record)),t}}const ai=()=>{},sa={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},nc=[1e3,2e3,5e3,1e4],rc=1e4,ac=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class ic{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=mi,this.transport=null,this.heartbeatIntervalMs=sa.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=ai,this.ref=0,this.reconnectTimer=null,this.vsn=Ts,this.logger=ai,this.conn=null,this.sendBuffer=[],this.serializer=new Jl,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=i=>i?(...s)=>i(...s):(...s)=>fetch(...s),!(!((r=t==null?void 0:t.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${gi.websocket}`,this.httpEndpoint=vo(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t==null?void 0:t.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Fl.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case Rn.connecting:return Hn.Connecting;case Rn.open:return Hn.Open;case Rn.closing:return Hn.Closing;default:return Hn.Closed}}isConnected(){return this.connectionState()===Hn.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const r=`realtime:${e}`,i=this.getChannels().find(s=>s.topic===r);if(i)return i;{const s=new hr(`realtime:${e}`,t,this);return this.channels.push(s),s}}push(e){const{topic:t,event:r,payload:i,ref:s}=e,l=()=>{this.encode(e,u=>{var h;(h=this.conn)===null||h===void 0||h.send(u)})};this.log("push",`${t} ${r} (${s})`,i),this.isConnected()?l():this.sendBuffer.push(l)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Vl,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},sa.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply"&&t.ref&&t.ref===this.pendingHeartbeatRef){const f=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error",f)}catch(g){this.log("error","error in heartbeat callback",g)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:r,event:i,payload:s,ref:l}=t,u=l?`(${l})`:"",h=s.status||"";this.log("receive",`${h} ${r} ${i} ${u}`.trim(),s),this.channels.filter(f=>f._isMember(r)).forEach(f=>f._trigger(i,s,l)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===Rn.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===Rn.open||this.conn.readyState===Rn.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this._terminateWorker()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(fn.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${r}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([ac],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t,r=!1;if(e)t=e,r=!0;else if(this.accessToken)try{t=await this.accessToken()}catch(i){this.log("error","Error fetching access token from callback",i),t=this.accessTokenValue}else t=this.accessTokenValue;r?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(i=>{const s={access_token:t,version:Hl};t&&i.updateJoinPayload(s),i.joinedOnce&&i._isJoined()&&i._push(fn.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(t=>{this.log("error",`Error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new mo(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},sa.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,i,s,l,u,h,f,g,y,_,w;switch(this.transport=(t=e==null?void 0:e.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e==null?void 0:e.timeout)!==null&&r!==void 0?r:mi,this.heartbeatIntervalMs=(i=e==null?void 0:e.heartbeatIntervalMs)!==null&&i!==void 0?i:sa.HEARTBEAT_INTERVAL,this.worker=(s=e==null?void 0:e.worker)!==null&&s!==void 0?s:!1,this.accessToken=(l=e==null?void 0:e.accessToken)!==null&&l!==void 0?l:null,this.heartbeatCallback=(u=e==null?void 0:e.heartbeatCallback)!==null&&u!==void 0?u:ai,this.vsn=(h=e==null?void 0:e.vsn)!==null&&h!==void 0?h:Ts,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(f=e==null?void 0:e.reconnectAfterMs)!==null&&f!==void 0?f:v=>nc[v-1]||rc,this.vsn){case Wl:this.encode=(g=e==null?void 0:e.encode)!==null&&g!==void 0?g:(v,E)=>E(JSON.stringify(v)),this.decode=(y=e==null?void 0:e.decode)!==null&&y!==void 0?y:(v,E)=>E(JSON.parse(v));break;case po:this.encode=(_=e==null?void 0:e.encode)!==null&&_!==void 0?_:this.serializer.encode.bind(this.serializer),this.decode=(w=e==null?void 0:e.decode)!==null&&w!==void 0?w:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}var Rr=class extends Error{constructor(n,e){var t;super(n),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&((t=e.icebergType)==null?void 0:t.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function sc(n,e,t){const r=new URL(e,n);if(t)for(const[i,s]of Object.entries(t))s!==void 0&&r.searchParams.set(i,s);return r.toString()}async function oc(n){return!n||n.type==="none"?{}:n.type==="bearer"?{Authorization:`Bearer ${n.token}`}:n.type==="header"?{[n.name]:n.value}:n.type==="custom"?await n.getHeaders():{}}function lc(n){const e=n.fetchImpl??globalThis.fetch;return{async request({method:t,path:r,query:i,body:s,headers:l}){const u=sc(n.baseUrl,r,i),h=await oc(n.auth),f=await e(u,{method:t,headers:{...s?{"Content-Type":"application/json"}:{},...h,...l},body:s?JSON.stringify(s):void 0}),g=await f.text(),y=(f.headers.get("content-type")||"").includes("application/json"),_=y&&g?JSON.parse(g):g;if(!f.ok){const w=y?_:void 0,v=w==null?void 0:w.error;throw new Rr((v==null?void 0:v.message)??`Request failed with status ${f.status}`,{status:f.status,icebergType:v==null?void 0:v.type,icebergCode:v==null?void 0:v.code,details:w})}return{status:f.status,headers:f.headers,data:_}}}}function oa(n){return n.join("")}var cc=class{constructor(n,e=""){this.client=n,this.prefix=e}async listNamespaces(n){const e=n?{parent:oa(n.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(n,e){const t={namespace:n.namespace,properties:e==null?void 0:e.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(n){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${oa(n.namespace)}`})}async loadNamespaceMetadata(n){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${oa(n.namespace)}`})).data.properties}}async namespaceExists(n){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${oa(n.namespace)}`}),!0}catch(e){if(e instanceof Rr&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(n,e){try{return await this.createNamespace(n,e)}catch(t){if(t instanceof Rr&&t.status===409)return;throw t}}};function er(n){return n.join("")}var uc=class{constructor(n,e="",t){this.client=n,this.prefix=e,this.accessDelegation=t}async listTables(n){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${er(n.namespace)}/tables`})).data.identifiers}async createTable(n,e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${er(n.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(n,e){const t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${er(n.namespace)}/tables/${n.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(n,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${er(n.namespace)}/tables/${n.name}`,query:{purgeRequested:String((e==null?void 0:e.purge)??!1)}})}async loadTable(n){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${er(n.namespace)}/tables/${n.name}`,headers:e})).data.metadata}async tableExists(n){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${er(n.namespace)}/tables/${n.name}`,headers:e}),!0}catch(t){if(t instanceof Rr&&t.status===404)return!1;throw t}}async createTableIfNotExists(n,e){try{return await this.createTable(n,e)}catch(t){if(t instanceof Rr&&t.status===409)return await this.loadTable({namespace:n.namespace,name:e.name});throw t}}},dc=class{constructor(n){var r;let e="v1";n.catalogName&&(e+=`/${n.catalogName}`);const t=n.baseUrl.endsWith("/")?n.baseUrl:`${n.baseUrl}/`;this.client=lc({baseUrl:t,auth:n.auth,fetchImpl:n.fetch}),this.accessDelegation=(r=n.accessDelegation)==null?void 0:r.join(","),this.namespaceOps=new cc(this.client,e),this.tableOps=new uc(this.client,e,this.accessDelegation)}async listNamespaces(n){return this.namespaceOps.listNamespaces(n)}async createNamespace(n,e){return this.namespaceOps.createNamespace(n,e)}async dropNamespace(n){await this.namespaceOps.dropNamespace(n)}async loadNamespaceMetadata(n){return this.namespaceOps.loadNamespaceMetadata(n)}async listTables(n){return this.tableOps.listTables(n)}async createTable(n,e){return this.tableOps.createTable(n,e)}async updateTable(n,e){return this.tableOps.updateTable(n,e)}async dropTable(n,e){await this.tableOps.dropTable(n,e)}async loadTable(n){return this.tableOps.loadTable(n)}async namespaceExists(n){return this.namespaceOps.namespaceExists(n)}async tableExists(n){return this.tableOps.tableExists(n)}async createNamespaceIfNotExists(n,e){return this.namespaceOps.createNamespaceIfNotExists(n,e)}async createTableIfNotExists(n,e){return this.tableOps.createTableIfNotExists(n,e)}},Ca=class extends Error{constructor(n){super(n),this.__isStorageError=!0,this.name="StorageError"}};function ot(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}var hc=class extends Ca{constructor(n,e,t){super(n),this.name="StorageApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},bi=class extends Ca{constructor(n,e){super(n),this.name="StorageUnknownError",this.originalError=e}};const Li=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),fc=()=>Response,yi=n=>{if(Array.isArray(n))return n.map(t=>yi(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,r])=>{const i=t.replace(/([-_][a-z])/gi,s=>s.toUpperCase().replace(/[-_]/g,""));e[i]=yi(r)}),e},pc=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},mc=n=>!n||typeof n!="string"||n.length===0||n.length>100||n.trim()!==n||n.includes("/")||n.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(n);function Nr(n){"@babel/helpers - typeof";return Nr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Nr(n)}function gc(n,e){if(Nr(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(Nr(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function vc(n){var e=gc(n,"string");return Nr(e)=="symbol"?e:e+""}function bc(n,e,t){return(e=vc(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Ns(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function Te(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ns(Object(t),!0).forEach(function(r){bc(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Ns(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const ii=n=>{var e;return n.msg||n.message||n.error_description||(typeof n.error=="string"?n.error:(e=n.error)===null||e===void 0?void 0:e.message)||JSON.stringify(n)},yc=async(n,e,t)=>{n instanceof await fc()&&!(t!=null&&t.noResolveJson)?n.json().then(r=>{const i=n.status||500,s=(r==null?void 0:r.statusCode)||i+"";e(new hc(ii(r),i,s))}).catch(r=>{e(new bi(ii(r),r))}):e(new bi(ii(n),n))},_c=(n,e,t,r)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"||!r?i:(pc(r)?(i.headers=Te({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(r)):i.body=r,e!=null&&e.duplex&&(i.duplex=e.duplex),Te(Te({},i),t))};async function Mr(n,e,t,r,i,s){return new Promise((l,u)=>{n(t,_c(e,r,i,s)).then(h=>{if(!h.ok)throw h;return r!=null&&r.noResolveJson?h:h.json()}).then(h=>l(h)).catch(h=>yc(h,u,r))})}async function Pr(n,e,t,r){return Mr(n,"GET",e,t,r)}async function hn(n,e,t,r,i){return Mr(n,"POST",e,r,i,t)}async function _i(n,e,t,r,i){return Mr(n,"PUT",e,r,i,t)}async function wc(n,e,t,r){return Mr(n,"HEAD",e,Te(Te({},t),{},{noResolveJson:!0}),r)}async function qi(n,e,t,r,i){return Mr(n,"DELETE",e,r,i,t)}var kc=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e}then(n,e){return this.execute().then(n,e)}async execute(){var n=this;try{return{data:(await n.downloadFn()).body,error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(ot(e))return{data:null,error:e};throw e}}};let bo;bo=Symbol.toStringTag;var Sc=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e,this[bo]="BlobDownloadBuilder",this.promise=null}asStream(){return new kc(this.downloadFn,this.shouldThrowOnError)}then(n,e){return this.getPromise().then(n,e)}catch(n){return this.getPromise().catch(n)}finally(n){return this.getPromise().finally(n)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var n=this;try{return{data:await(await n.downloadFn()).blob(),error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(ot(e))return{data:null,error:e};throw e}}};const Ec={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Ps={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var Ac=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1,this.url=n,this.headers=e,this.bucketId=t,this.fetch=Li(r)}throwOnError(){return this.shouldThrowOnError=!0,this}async uploadOrUpdate(n,e,t,r){var i=this;try{let s;const l=Te(Te({},Ps),r);let u=Te(Te({},i.headers),n==="POST"&&{"x-upsert":String(l.upsert)});const h=l.metadata;typeof Blob<"u"&&t instanceof Blob?(s=new FormData,s.append("cacheControl",l.cacheControl),h&&s.append("metadata",i.encodeMetadata(h)),s.append("",t)):typeof FormData<"u"&&t instanceof FormData?(s=t,s.has("cacheControl")||s.append("cacheControl",l.cacheControl),h&&!s.has("metadata")&&s.append("metadata",i.encodeMetadata(h))):(s=t,u["cache-control"]=`max-age=${l.cacheControl}`,u["content-type"]=l.contentType,h&&(u["x-metadata"]=i.toBase64(i.encodeMetadata(h))),(typeof ReadableStream<"u"&&s instanceof ReadableStream||s&&typeof s=="object"&&"pipe"in s&&typeof s.pipe=="function")&&!l.duplex&&(l.duplex="half")),r!=null&&r.headers&&(u=Te(Te({},u),r.headers));const f=i._removeEmptyFolders(e),g=i._getFinalPath(f),y=await(n=="PUT"?_i:hn)(i.fetch,`${i.url}/object/${g}`,s,Te({headers:u},l!=null&&l.duplex?{duplex:l.duplex}:{}));return{data:{path:f,id:y.Id,fullPath:y.Key},error:null}}catch(s){if(i.shouldThrowOnError)throw s;if(ot(s))return{data:null,error:s};throw s}}async upload(n,e,t){return this.uploadOrUpdate("POST",n,e,t)}async uploadToSignedUrl(n,e,t,r){var i=this;const s=i._removeEmptyFolders(n),l=i._getFinalPath(s),u=new URL(i.url+`/object/upload/sign/${l}`);u.searchParams.set("token",e);try{let h;const f=Te({upsert:Ps.upsert},r),g=Te(Te({},i.headers),{"x-upsert":String(f.upsert)});return typeof Blob<"u"&&t instanceof Blob?(h=new FormData,h.append("cacheControl",f.cacheControl),h.append("",t)):typeof FormData<"u"&&t instanceof FormData?(h=t,h.append("cacheControl",f.cacheControl)):(h=t,g["cache-control"]=`max-age=${f.cacheControl}`,g["content-type"]=f.contentType),{data:{path:s,fullPath:(await _i(i.fetch,u.toString(),h,{headers:g})).Key},error:null}}catch(h){if(i.shouldThrowOnError)throw h;if(ot(h))return{data:null,error:h};throw h}}async createSignedUploadUrl(n,e){var t=this;try{let r=t._getFinalPath(n);const i=Te({},t.headers);e!=null&&e.upsert&&(i["x-upsert"]="true");const s=await hn(t.fetch,`${t.url}/object/upload/sign/${r}`,{},{headers:i}),l=new URL(t.url+s.url),u=l.searchParams.get("token");if(!u)throw new Ca("No token returned by API");return{data:{signedUrl:l.toString(),path:n,token:u},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ot(r))return{data:null,error:r};throw r}}async update(n,e,t){return this.uploadOrUpdate("PUT",n,e,t)}async move(n,e,t){var r=this;try{return{data:await hn(r.fetch,`${r.url}/object/move`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t==null?void 0:t.destinationBucket},{headers:r.headers}),error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(ot(i))return{data:null,error:i};throw i}}async copy(n,e,t){var r=this;try{return{data:{path:(await hn(r.fetch,`${r.url}/object/copy`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t==null?void 0:t.destinationBucket},{headers:r.headers})).Key},error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(ot(i))return{data:null,error:i};throw i}}async createSignedUrl(n,e,t){var r=this;try{let i=r._getFinalPath(n),s=await hn(r.fetch,`${r.url}/object/sign/${i}`,Te({expiresIn:e},t!=null&&t.transform?{transform:t.transform}:{}),{headers:r.headers});const l=t!=null&&t.download?`&download=${t.download===!0?"":t.download}`:"";return s={signedUrl:encodeURI(`${r.url}${s.signedURL}${l}`)},{data:s,error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(ot(i))return{data:null,error:i};throw i}}async createSignedUrls(n,e,t){var r=this;try{const i=await hn(r.fetch,`${r.url}/object/sign/${r.bucketId}`,{expiresIn:e,paths:n},{headers:r.headers}),s=t!=null&&t.download?`&download=${t.download===!0?"":t.download}`:"";return{data:i.map(l=>Te(Te({},l),{},{signedUrl:l.signedURL?encodeURI(`${r.url}${l.signedURL}${s}`):null})),error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(ot(i))return{data:null,error:i};throw i}}download(n,e){const t=typeof(e==null?void 0:e.transform)<"u"?"render/image/authenticated":"object",r=this.transformOptsToQueryString((e==null?void 0:e.transform)||{}),i=r?`?${r}`:"",s=this._getFinalPath(n),l=()=>Pr(this.fetch,`${this.url}/${t}/${s}${i}`,{headers:this.headers,noResolveJson:!0});return new Sc(l,this.shouldThrowOnError)}async info(n){var e=this;const t=e._getFinalPath(n);try{return{data:yi(await Pr(e.fetch,`${e.url}/object/info/${t}`,{headers:e.headers})),error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(ot(r))return{data:null,error:r};throw r}}async exists(n){var e=this;const t=e._getFinalPath(n);try{return await wc(e.fetch,`${e.url}/object/${t}`,{headers:e.headers}),{data:!0,error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(ot(r)&&r instanceof bi){const i=r.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:r}}throw r}}getPublicUrl(n,e){const t=this._getFinalPath(n),r=[],i=e!=null&&e.download?`download=${e.download===!0?"":e.download}`:"";i!==""&&r.push(i);const s=typeof(e==null?void 0:e.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((e==null?void 0:e.transform)||{});l!==""&&r.push(l);let u=r.join("&");return u!==""&&(u=`?${u}`),{data:{publicUrl:encodeURI(`${this.url}/${s}/public/${t}${u}`)}}}async remove(n){var e=this;try{return{data:await qi(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}async list(n,e,t){var r=this;try{const i=Te(Te(Te({},Ec),e),{},{prefix:n||""});return{data:await hn(r.fetch,`${r.url}/object/list/${r.bucketId}`,i,{headers:r.headers},t),error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(ot(i))return{data:null,error:i};throw i}}async listV2(n,e){var t=this;try{const r=Te({},n);return{data:await hn(t.fetch,`${t.url}/object/list-v2/${t.bucketId}`,r,{headers:t.headers},e),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ot(r))return{data:null,error:r};throw r}}encodeMetadata(n){return JSON.stringify(n)}toBase64(n){return typeof Buffer<"u"?Buffer.from(n).toString("base64"):btoa(n)}_getFinalPath(n){return`${this.bucketId}/${n.replace(/^\/+/,"")}`}_removeEmptyFolders(n){return n.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(n){const e=[];return n.width&&e.push(`width=${n.width}`),n.height&&e.push(`height=${n.height}`),n.resize&&e.push(`resize=${n.resize}`),n.format&&e.push(`format=${n.format}`),n.quality&&e.push(`quality=${n.quality}`),e.join("&")}};const yo="2.91.1",_o={"X-Client-Info":`storage-js/${yo}`};var Cc=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1;const i=new URL(n);r!=null&&r.useNewHostname&&/supabase\.(co|in|red)$/.test(i.hostname)&&!i.hostname.includes("storage.supabase.")&&(i.hostname=i.hostname.replace("supabase.","storage.supabase.")),this.url=i.href.replace(/\/$/,""),this.headers=Te(Te({},_o),e),this.fetch=Li(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async listBuckets(n){var e=this;try{const t=e.listBucketOptionsToQueryString(n);return{data:await Pr(e.fetch,`${e.url}/bucket${t}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await Pr(e.fetch,`${e.url}/bucket/${n}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}async createBucket(n,e={public:!1}){var t=this;try{return{data:await hn(t.fetch,`${t.url}/bucket`,{id:n,name:n,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ot(r))return{data:null,error:r};throw r}}async updateBucket(n,e){var t=this;try{return{data:await _i(t.fetch,`${t.url}/bucket/${n}`,{id:n,name:n,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ot(r))return{data:null,error:r};throw r}}async emptyBucket(n){var e=this;try{return{data:await hn(e.fetch,`${e.url}/bucket/${n}/empty`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await qi(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}listBucketOptionsToQueryString(n){const e={};return n&&("limit"in n&&(e.limit=String(n.limit)),"offset"in n&&(e.offset=String(n.offset)),n.search&&(e.search=n.search),n.sortColumn&&(e.sortColumn=n.sortColumn),n.sortOrder&&(e.sortOrder=n.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},$c=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=Te(Te({},_o),e),this.fetch=Li(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await hn(e.fetch,`${e.url}/bucket`,{name:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}async listBuckets(n){var e=this;try{const t=new URLSearchParams;(n==null?void 0:n.limit)!==void 0&&t.set("limit",n.limit.toString()),(n==null?void 0:n.offset)!==void 0&&t.set("offset",n.offset.toString()),n!=null&&n.sortColumn&&t.set("sortColumn",n.sortColumn),n!=null&&n.sortOrder&&t.set("sortOrder",n.sortOrder),n!=null&&n.search&&t.set("search",n.search);const r=t.toString(),i=r?`${e.url}/bucket?${r}`:`${e.url}/bucket`;return{data:await Pr(e.fetch,i,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await qi(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ot(t))return{data:null,error:t};throw t}}from(n){var e=this;if(!mc(n))throw new Ca("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const t=new dc({baseUrl:this.url,catalogName:n,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),r=this.shouldThrowOnError;return new Proxy(t,{get(i,s){const l=i[s];return typeof l!="function"?l:async(...u)=>{try{return{data:await l.apply(i,u),error:null}}catch(h){if(r)throw h;return{data:null,error:h}}}}})}};const ji={"X-Client-Info":`storage-js/${yo}`,"Content-Type":"application/json"};var wo=class extends Error{constructor(n){super(n),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}};function nn(n){return typeof n=="object"&&n!==null&&"__isStorageVectorsError"in n}var si=class extends wo{constructor(n,e,t){super(n),this.name="StorageVectorsApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},Tc=class extends wo{constructor(n,e){super(n),this.name="StorageVectorsUnknownError",this.originalError=e}};const Di=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),xc=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},Is=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),Oc=async(n,e,t)=>{if(n&&typeof n=="object"&&"status"in n&&"ok"in n&&typeof n.status=="number"&&!(t!=null&&t.noResolveJson)){const r=n.status||500,i=n;if(typeof i.json=="function")i.json().then(s=>{const l=(s==null?void 0:s.statusCode)||(s==null?void 0:s.code)||r+"";e(new si(Is(s),r,l))}).catch(()=>{const s=r+"";e(new si(i.statusText||`HTTP ${r} error`,r,s))});else{const s=r+"";e(new si(i.statusText||`HTTP ${r} error`,r,s))}}else e(new Tc(Is(n),n))},Rc=(n,e,t,r)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return r?(xc(r)?(i.headers=Te({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(r)):i.body=r,Te(Te({},i),t)):i};async function Nc(n,e,t,r,i,s){return new Promise((l,u)=>{n(t,Rc(e,r,i,s)).then(h=>{if(!h.ok)throw h;if(r!=null&&r.noResolveJson)return h;const f=h.headers.get("content-type");return!f||!f.includes("application/json")?{}:h.json()}).then(h=>l(h)).catch(h=>Oc(h,u,r))})}async function rn(n,e,t,r,i){return Nc(n,"POST",e,r,i,t)}var Pc=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=Te(Te({},ji),e),this.fetch=Di(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createIndex(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/CreateIndex`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async getIndex(n,e){var t=this;try{return{data:await rn(t.fetch,`${t.url}/GetIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(nn(r))return{data:null,error:r};throw r}}async listIndexes(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/ListIndexes`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async deleteIndex(n,e){var t=this;try{return{data:await rn(t.fetch,`${t.url}/DeleteIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers})||{},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(nn(r))return{data:null,error:r};throw r}}},Ic=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=Te(Te({},ji),e),this.fetch=Di(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async putVectors(n){var e=this;try{if(n.vectors.length<1||n.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:await rn(e.fetch,`${e.url}/PutVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async getVectors(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/GetVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async listVectors(n){var e=this;try{if(n.segmentCount!==void 0){if(n.segmentCount<1||n.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(n.segmentIndex!==void 0&&(n.segmentIndex<0||n.segmentIndex>=n.segmentCount))throw new Error(`segmentIndex must be between 0 and ${n.segmentCount-1}`)}return{data:await rn(e.fetch,`${e.url}/ListVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async queryVectors(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/QueryVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async deleteVectors(n){var e=this;try{if(n.keys.length<1||n.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:await rn(e.fetch,`${e.url}/DeleteVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}},Lc=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=Te(Te({},ji),e),this.fetch=Di(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async listBuckets(n={}){var e=this;try{return{data:await rn(e.fetch,`${e.url}/ListVectorBuckets`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await rn(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(nn(t))return{data:null,error:t};throw t}}},qc=class extends Lc{constructor(n,e={}){super(n,e.headers||{},e.fetch)}from(n){return new jc(this.url,this.headers,n,this.fetch)}async createBucket(n){var e=()=>super.createBucket,t=this;return e().call(t,n)}async getBucket(n){var e=()=>super.getBucket,t=this;return e().call(t,n)}async listBuckets(n={}){var e=()=>super.listBuckets,t=this;return e().call(t,n)}async deleteBucket(n){var e=()=>super.deleteBucket,t=this;return e().call(t,n)}},jc=class extends Pc{constructor(n,e,t,r){super(n,e,r),this.vectorBucketName=t}async createIndex(n){var e=()=>super.createIndex,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName}))}async listIndexes(n={}){var e=()=>super.listIndexes,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName}))}async getIndex(n){var e=()=>super.getIndex,t=this;return e().call(t,t.vectorBucketName,n)}async deleteIndex(n){var e=()=>super.deleteIndex,t=this;return e().call(t,t.vectorBucketName,n)}index(n){return new Dc(this.url,this.headers,this.vectorBucketName,n,this.fetch)}},Dc=class extends Ic{constructor(n,e,t,r,i){super(n,e,i),this.vectorBucketName=t,this.indexName=r}async putVectors(n){var e=()=>super.putVectors,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async getVectors(n){var e=()=>super.getVectors,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async listVectors(n={}){var e=()=>super.listVectors,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async queryVectors(n){var e=()=>super.queryVectors,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async deleteVectors(n){var e=()=>super.deleteVectors,t=this;return e().call(t,Te(Te({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}},Mc=class extends Cc{constructor(n,e={},t,r){super(n,e,t,r)}from(n){return new Ac(this.url,this.headers,n,this.fetch)}get vectors(){return new qc(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new $c(this.url+"/iceberg",this.headers,this.fetch)}};const ko="2.91.1",lr=30*1e3,wi=3,oi=wi*lr,Bc="http://localhost:9999",Uc="supabase.auth.token",zc={"X-Client-Info":`gotrue-js/${ko}`},ki="X-Supabase-Api-Version",So={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Fc=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Kc=10*60*1e3;class Ir extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}}function Se(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class Hc extends Ir{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}}function Wc(n){return Se(n)&&n.name==="AuthApiError"}class Wn extends Ir{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class En extends Ir{constructor(e,t,r,i){super(e,r,i),this.name=t,this.status=r}}class tn extends En{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function Vc(n){return Se(n)&&n.name==="AuthSessionMissingError"}class tr extends En{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class la extends En{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class ca extends En{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Gc(n){return Se(n)&&n.name==="AuthImplicitGrantRedirectError"}class Ls extends En{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Jc extends En{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class Si extends En{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function li(n){return Se(n)&&n.name==="AuthRetryableFetchError"}class qs extends En{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}}class Ei extends En{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const pa="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),js=` 	
\r=`.split(""),Yc=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<js.length;e+=1)n[js[e].charCodeAt(0)]=-2;for(let e=0;e<pa.length;e+=1)n[pa[e].charCodeAt(0)]=e;return n})();function Ds(n,e,t){if(n!==null)for(e.queue=e.queue<<8|n,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(pa[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(pa[r]),e.queuedBits-=6}}function Eo(n,e,t){const r=Yc[n];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function Ms(n){const e=[],t=l=>{e.push(String.fromCodePoint(l))},r={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},s=l=>{Zc(l,r,t)};for(let l=0;l<n.length;l+=1)Eo(n.charCodeAt(l),i,s);return e.join("")}function Qc(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function Xc(n,e){for(let t=0;t<n.length;t+=1){let r=n.charCodeAt(t);if(r>55295&&r<=56319){const i=(r-55296)*1024&65535;r=(n.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}Qc(r,e)}}function Zc(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let r=1;r<6;r+=1)if(!(n>>7-r&1)){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function fr(n){const e=[],t={queue:0,queuedBits:0},r=i=>{e.push(i)};for(let i=0;i<n.length;i+=1)Eo(n.charCodeAt(i),t,r);return new Uint8Array(e)}function eu(n){const e=[];return Xc(n,t=>e.push(t)),new Uint8Array(e)}function Vn(n){const e=[],t={queue:0,queuedBits:0},r=i=>{e.push(i)};return n.forEach(i=>Ds(i,t,r)),Ds(null,t,r),e.join("")}function tu(n){return Math.round(Date.now()/1e3)+n}function nu(){return Symbol("auth-callback")}const Lt=()=>typeof window<"u"&&typeof document<"u",zn={tested:!1,writable:!1},Ao=()=>{if(!Lt())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(zn.tested)return zn.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),zn.tested=!0,zn.writable=!0}catch{zn.tested=!0,zn.writable=!1}return zn.writable};function ru(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,s)=>{e[s]=i})}catch{}return t.searchParams.forEach((r,i)=>{e[i]=r}),e}const Co=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),au=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",cr=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},Fn=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},It=async(n,e)=>{await n.removeItem(e)};class $a{constructor(){this.promise=new $a.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}$a.promiseConstructor=Promise;function ci(n){const e=n.split(".");if(e.length!==3)throw new Ei("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!Fc.test(e[r]))throw new Ei("JWT not in base64url format");return{header:JSON.parse(Ms(e[0])),payload:JSON.parse(Ms(e[1])),signature:fr(e[2]),raw:{header:e[0],payload:e[1]}}}async function iu(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function su(n,e){return new Promise((r,i)=>{(async()=>{for(let s=0;s<1/0;s++)try{const l=await n(s);if(!e(s,null,l)){r(l);return}}catch(l){if(!e(s,l)){i(l);return}}})()})}function ou(n){return("0"+n.toString(16)).substr(-2)}function lu(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let i="";for(let s=0;s<56;s++)i+=t.charAt(Math.floor(Math.random()*r));return i}return crypto.getRandomValues(e),Array.from(e,ou).join("")}async function cu(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(r);return Array.from(i).map(s=>String.fromCharCode(s)).join("")}async function uu(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await cu(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function nr(n,e,t=!1){const r=lu();let i=r;t&&(i+="/PASSWORD_RECOVERY"),await cr(n,`${e}-code-verifier`,i);const s=await uu(r);return[s,r===s?"plain":"s256"]}const du=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function hu(n){const e=n.headers.get(ki);if(!e||!e.match(du))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function fu(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function pu(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const mu=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function rr(n){if(!mu.test(n))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function ui(){const n={};return new Proxy(n,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function gu(n,e){return new Proxy(n,{get:(t,r,i)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){const s=r.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)"||s==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,r,i)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,r,i)}})}function Bs(n){return JSON.parse(JSON.stringify(n))}const Kn=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),vu=[502,503,504];async function Us(n){var e;if(!au(n))throw new Si(Kn(n),0);if(vu.includes(n.status))throw new Si(Kn(n),n.status);let t;try{t=await n.json()}catch(s){throw new Wn(Kn(s),s)}let r;const i=hu(n);if(i&&i.getTime()>=So["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new qs(Kn(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new tn}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((s,l)=>s&&typeof l=="string",!0))throw new qs(Kn(t),n.status,t.weak_password.reasons);throw new Hc(Kn(t),n.status||500,r)}const bu=(n,e,t,r)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),t))};async function $e(n,e,t,r){var i;const s=Object.assign({},r==null?void 0:r.headers);s[ki]||(s[ki]=So["2024-01-01"].name),r!=null&&r.jwt&&(s.Authorization=`Bearer ${r.jwt}`);const l=(i=r==null?void 0:r.query)!==null&&i!==void 0?i:{};r!=null&&r.redirectTo&&(l.redirect_to=r.redirectTo);const u=Object.keys(l).length?"?"+new URLSearchParams(l).toString():"",h=await yu(n,e,t+u,{headers:s,noResolveJson:r==null?void 0:r.noResolveJson},{},r==null?void 0:r.body);return r!=null&&r.xform?r==null?void 0:r.xform(h):{data:Object.assign({},h),error:null}}async function yu(n,e,t,r,i,s){const l=bu(e,r,i,s);let u;try{u=await n(t,Object.assign({},l))}catch(h){throw console.error(h),new Si(Kn(h),0)}if(u.ok||await Us(u),r!=null&&r.noResolveJson)return u;try{return await u.json()}catch(h){await Us(h)}}function dn(n){var e;let t=null;ku(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=tu(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function zs(n){const e=dn(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function Nn(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function _u(n){return{data:n,error:null}}function wu(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:i,verification_type:s}=n,l=Aa(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),u={action_link:e,email_otp:t,hashed_token:r,redirect_to:i,verification_type:s},h=Object.assign({},l);return{data:{properties:u,user:h},error:null}}function Fs(n){return n}function ku(n){return n.access_token&&n.refresh_token&&n.expires_in}const di=["global","local","others"];class Su{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=Co(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=di[0]){if(di.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${di.join(", ")}`);try{return await $e(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(Se(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await $e(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:Nn})}catch(r){if(Se(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=Aa(e,["options"]),i=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(i.new_email=r==null?void 0:r.newEmail,delete i.newEmail),await $e(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:wu,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(Se(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await $e(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:Nn})}catch(t){if(Se(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,i,s,l,u,h;try{const f={nextPage:null,lastPage:0,total:0},g=await $e(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(s=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:""},xform:Fs});if(g.error)throw g.error;const y=await g.json(),_=(l=g.headers.get("x-total-count"))!==null&&l!==void 0?l:0,w=(h=(u=g.headers.get("link"))===null||u===void 0?void 0:u.split(","))!==null&&h!==void 0?h:[];return w.length>0&&(w.forEach(v=>{const E=parseInt(v.split(";")[0].split("=")[1].substring(0,1)),j=JSON.parse(v.split(";")[1].split("=")[1]);f[`${j}Page`]=E}),f.total=parseInt(_)),{data:Object.assign(Object.assign({},y),f),error:null}}catch(f){if(Se(f))return{data:{users:[]},error:f};throw f}}async getUserById(e){rr(e);try{return await $e(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:Nn})}catch(t){if(Se(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){rr(e);try{return await $e(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:Nn})}catch(r){if(Se(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){rr(e);try{return await $e(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:Nn})}catch(r){if(Se(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){rr(e.userId);try{const{data:t,error:r}=await $e(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:r}}catch(t){if(Se(t))return{data:null,error:t};throw t}}async _deleteFactor(e){rr(e.userId),rr(e.id);try{return{data:await $e(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(Se(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,r,i,s,l,u,h;try{const f={nextPage:null,lastPage:0,total:0},g=await $e(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(s=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:""},xform:Fs});if(g.error)throw g.error;const y=await g.json(),_=(l=g.headers.get("x-total-count"))!==null&&l!==void 0?l:0,w=(h=(u=g.headers.get("link"))===null||u===void 0?void 0:u.split(","))!==null&&h!==void 0?h:[];return w.length>0&&(w.forEach(v=>{const E=parseInt(v.split(";")[0].split("=")[1].substring(0,1)),j=JSON.parse(v.split(";")[1].split("=")[1]);f[`${j}Page`]=E}),f.total=parseInt(_)),{data:Object.assign(Object.assign({},y),f),error:null}}catch(f){if(Se(f))return{data:{clients:[]},error:f};throw f}}async _createOAuthClient(e){try{return await $e(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(Se(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await $e(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(Se(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await $e(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(Se(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await $e(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(Se(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await $e(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(Se(t))return{data:null,error:t};throw t}}}function Ks(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}const ar={debug:!!(globalThis&&Ao()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class $o extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Eu extends $o{}async function Au(n,e,t){ar.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),ar.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async i=>{if(i){ar.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,i.name);try{return await t()}finally{ar.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,i.name)}}else{if(e===0)throw ar.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new Eu(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(ar.debug)try{const s=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(s,null,"  "))}catch(s){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",s)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function Cu(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function To(n){if(!/^0x[a-fA-F0-9]{40}$/.test(n))throw new Error(`@supabase/auth-js: Address "${n}" is invalid.`);return n.toLowerCase()}function $u(n){return parseInt(n,16)}function Tu(n){const e=new TextEncoder().encode(n);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function xu(n){var e;const{chainId:t,domain:r,expirationTime:i,issuedAt:s=new Date,nonce:l,notBefore:u,requestId:h,resources:f,scheme:g,uri:y,version:_}=n;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(l&&l.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${l}`);if(!y)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(_!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${_}`);if(!((e=n.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${n.statement}`)}const w=To(n.address),v=g?`${g}://${r}`:r,E=n.statement?`${n.statement}
`:"",j=`${v} wants you to sign in with your Ethereum account:
${w}

${E}`;let V=`URI: ${y}
Version: ${_}
Chain ID: ${t}${l?`
Nonce: ${l}`:""}
Issued At: ${s.toISOString()}`;if(i&&(V+=`
Expiration Time: ${i.toISOString()}`),u&&(V+=`
Not Before: ${u.toISOString()}`),h&&(V+=`
Request ID: ${h}`),f){let z=`
Resources:`;for(const T of f){if(!T||typeof T!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${T}`);z+=`
- ${T}`}V+=z}return`${j}
${V}`}class kt extends Error{constructor({message:e,code:t,cause:r,name:i}){var s;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(s=i??(r instanceof Error?r.name:void 0))!==null&&s!==void 0?s:"Unknown Error",this.code=t}}class ma extends kt{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function Ou({error:n,options:e}){var t,r,i;const{publicKey:s}=e;if(!s)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new kt({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else if(n.name==="ConstraintError"){if(((t=s.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new kt({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:n});if(e.mediation==="conditional"&&((r=s.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new kt({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:n});if(((i=s.authenticatorSelection)===null||i===void 0?void 0:i.userVerification)==="required")return new kt({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:n})}else{if(n.name==="InvalidStateError")return new kt({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:n});if(n.name==="NotAllowedError")return new kt({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="NotSupportedError")return s.pubKeyCredParams.filter(u=>u.type==="public-key").length===0?new kt({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:n}):new kt({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:n});if(n.name==="SecurityError"){const l=window.location.hostname;if(xo(l)){if(s.rp.id!==l)return new kt({message:`The RP ID "${s.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new kt({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="TypeError"){if(s.user.id.byteLength<1||s.user.id.byteLength>64)return new kt({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:n})}else if(n.name==="UnknownError")return new kt({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new kt({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}function Ru({error:n,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new kt({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else{if(n.name==="NotAllowedError")return new kt({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="SecurityError"){const r=window.location.hostname;if(xo(r)){if(t.rpId!==r)return new kt({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new kt({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="UnknownError")return new kt({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new kt({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}class Nu{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const Pu=new Nu;function Iu(n){if(!n)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(n);const{challenge:e,user:t,excludeCredentials:r}=n,i=Aa(n,["challenge","user","excludeCredentials"]),s=fr(e).buffer,l=Object.assign(Object.assign({},t),{id:fr(t.id).buffer}),u=Object.assign(Object.assign({},i),{challenge:s,user:l});if(r&&r.length>0){u.excludeCredentials=new Array(r.length);for(let h=0;h<r.length;h++){const f=r[h];u.excludeCredentials[h]=Object.assign(Object.assign({},f),{id:fr(f.id).buffer,type:f.type||"public-key",transports:f.transports})}}return u}function Lu(n){if(!n)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(n);const{challenge:e,allowCredentials:t}=n,r=Aa(n,["challenge","allowCredentials"]),i=fr(e).buffer,s=Object.assign(Object.assign({},r),{challenge:i});if(t&&t.length>0){s.allowCredentials=new Array(t.length);for(let l=0;l<t.length;l++){const u=t[l];s.allowCredentials[l]=Object.assign(Object.assign({},u),{id:fr(u.id).buffer,type:u.type||"public-key",transports:u.transports})}}return s}function qu(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n;return{id:n.id,rawId:n.id,response:{attestationObject:Vn(new Uint8Array(n.response.attestationObject)),clientDataJSON:Vn(new Uint8Array(n.response.clientDataJSON))},type:"public-key",clientExtensionResults:n.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function ju(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n,r=n.getClientExtensionResults(),i=n.response;return{id:n.id,rawId:n.id,response:{authenticatorData:Vn(new Uint8Array(i.authenticatorData)),clientDataJSON:Vn(new Uint8Array(i.clientDataJSON)),signature:Vn(new Uint8Array(i.signature)),userHandle:i.userHandle?Vn(new Uint8Array(i.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function xo(n){return n==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(n)}function Hs(){var n,e;return!!(Lt()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((n=navigator==null?void 0:navigator.credentials)===null||n===void 0?void 0:n.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function Du(n){try{const e=await navigator.credentials.create(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new ma("Browser returned unexpected credential type",e)}:{data:null,error:new ma("Empty credential response",e)}}catch(e){return{data:null,error:Ou({error:e,options:n})}}}async function Mu(n){try{const e=await navigator.credentials.get(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new ma("Browser returned unexpected credential type",e)}:{data:null,error:new ma("Empty credential response",e)}}catch(e){return{data:null,error:Ru({error:e,options:n})}}}const Bu={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},Uu={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function ga(...n){const e=i=>i!==null&&typeof i=="object"&&!Array.isArray(i),t=i=>i instanceof ArrayBuffer||ArrayBuffer.isView(i),r={};for(const i of n)if(i)for(const s in i){const l=i[s];if(l!==void 0)if(Array.isArray(l))r[s]=l;else if(t(l))r[s]=l;else if(e(l)){const u=r[s];e(u)?r[s]=ga(u,l):r[s]=ga(l)}else r[s]=l}return r}function zu(n,e){return ga(Bu,n,e||{})}function Fu(n,e){return ga(Uu,n,e||{})}class Ku{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:r,signal:i},s){try{const{data:l,error:u}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!l)return{data:null,error:u};const h=i??Pu.createNewAbortSignal();if(l.webauthn.type==="create"){const{user:f}=l.webauthn.credential_options.publicKey;f.name||(f.name=`${f.id}:${r}`),f.displayName||(f.displayName=f.name)}switch(l.webauthn.type){case"create":{const f=zu(l.webauthn.credential_options.publicKey,s==null?void 0:s.create),{data:g,error:y}=await Du({publicKey:f,signal:h});return g?{data:{factorId:e,challengeId:l.id,webauthn:{type:l.webauthn.type,credential_response:g}},error:null}:{data:null,error:y}}case"request":{const f=Fu(l.webauthn.credential_options.publicKey,s==null?void 0:s.request),{data:g,error:y}=await Mu(Object.assign(Object.assign({},l.webauthn.credential_options),{publicKey:f,signal:h}));return g?{data:{factorId:e,challengeId:l.id,webauthn:{type:l.webauthn.type,credential_response:g}},error:null}:{data:null,error:y}}}}catch(l){return Se(l)?{data:null,error:l}:{data:null,error:new Wn("Unexpected error in challenge",l)}}}async _verify({challengeId:e,factorId:t,webauthn:r}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},s){if(!t)return{data:null,error:new Ir("rpId is required for WebAuthn authentication")};try{if(!Hs())return{data:null,error:new Wn("Browser does not support WebAuthn",null)};const{data:l,error:u}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:r},signal:i},{request:s});if(!l)return{data:null,error:u};const{webauthn:h}=l;return this._verify({factorId:e,challengeId:l.challengeId,webauthn:{type:h.type,rpId:t,rpOrigins:r,credential_response:h.credential_response}})}catch(l){return Se(l)?{data:null,error:l}:{data:null,error:new Wn("Unexpected error in authenticate",l)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},s){if(!t)return{data:null,error:new Ir("rpId is required for WebAuthn registration")};try{if(!Hs())return{data:null,error:new Wn("Browser does not support WebAuthn",null)};const{data:l,error:u}=await this._enroll({friendlyName:e});if(!l)return await this.client.mfa.listFactors().then(g=>{var y;return(y=g.data)===null||y===void 0?void 0:y.all.find(_=>_.factor_type==="webauthn"&&_.friendly_name===e&&_.status!=="unverified")}).then(g=>g?this.client.mfa.unenroll({factorId:g==null?void 0:g.id}):void 0),{data:null,error:u};const{data:h,error:f}=await this._challenge({factorId:l.id,friendlyName:l.friendly_name,webauthn:{rpId:t,rpOrigins:r},signal:i},{create:s});return h?this._verify({factorId:l.id,challengeId:h.challengeId,webauthn:{rpId:t,rpOrigins:r,type:h.webauthn.type,credential_response:h.webauthn.credential_response}}):{data:null,error:f}}catch(l){return Se(l)?{data:null,error:l}:{data:null,error:new Wn("Unexpected error in register",l)}}}}Cu();const Hu={url:Bc,storageKey:Uc,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:zc,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function Ws(n,e,t){return await t()}const ir={};class Lr{get jwks(){var e,t;return(t=(e=ir[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){ir[this.storageKey]=Object.assign(Object.assign({},ir[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=ir[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){ir[this.storageKey]=Object.assign(Object.assign({},ir[this.storageKey]),{cachedAt:e})}constructor(e){var t,r,i;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const s=Object.assign(Object.assign({},Hu),e);if(this.storageKey=s.storageKey,this.instanceID=(t=Lr.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,Lr.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!s.debug,typeof s.debug=="function"&&(this.logger=s.debug),this.instanceID>0&&Lt()){const l=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(l),this.logDebugMessages&&console.trace(l)}if(this.persistSession=s.persistSession,this.autoRefreshToken=s.autoRefreshToken,this.admin=new Su({url:s.url,headers:s.headers,fetch:s.fetch}),this.url=s.url,this.headers=s.headers,this.fetch=Co(s.fetch),this.lock=s.lock||Ws,this.detectSessionInUrl=s.detectSessionInUrl,this.flowType=s.flowType,this.hasCustomAuthorizationHeader=s.hasCustomAuthorizationHeader,this.throwOnError=s.throwOnError,this.lockAcquireTimeout=s.lockAcquireTimeout,s.lock?this.lock=s.lock:this.persistSession&&Lt()&&(!((r=globalThis==null?void 0:globalThis.navigator)===null||r===void 0)&&r.locks)?this.lock=Au:this.lock=Ws,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new Ku(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(s.storage?this.storage=s.storage:Ao()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Ks(this.memoryStorage)),s.userStorage&&(this.userStorage=s.userStorage)):(this.memoryStorage={},this.storage=Ks(this.memoryStorage)),Lt()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(l){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",l)}(i=this.broadcastChannel)===null||i===void 0||i.addEventListener("message",async l=>{this._debug("received broadcast notification from other tab or client",l),await this._notifyAllSubscribers(l.data.event,l.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${ko}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},r="none";if(Lt()&&(t=ru(window.location.href),this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce")),Lt()&&this.detectSessionInUrl&&r!=="none"){const{data:i,error:s}=await this._getSessionFromURL(t,r);if(s){if(this._debug("#_initialize()","error detecting session from URL",s),Gc(s)){const h=(e=s.details)===null||e===void 0?void 0:e.code;if(h==="identity_already_exists"||h==="identity_not_found"||h==="single_identity_not_deletable")return{error:s}}return{error:s}}const{session:l,redirectType:u}=i;return this._debug("#_initialize()","detected session in URL",l,"redirect type",u),await this._saveSession(l),setTimeout(async()=>{u==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",l):await this._notifyAllSubscribers("SIGNED_IN",l)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return Se(t)?this._returnResult({error:t}):this._returnResult({error:new Wn("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,i;try{const s=await $e(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:dn}),{data:l,error:u}=s;if(u||!l)return this._returnResult({data:{user:null,session:null},error:u});const h=l.session,f=l.user;return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",h)),this._returnResult({data:{user:f,session:h},error:null})}catch(s){if(Se(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signUp(e){var t,r,i;try{let s;if("email"in e){const{email:g,password:y,options:_}=e;let w=null,v=null;this.flowType==="pkce"&&([w,v]=await nr(this.storage,this.storageKey)),s=await $e(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:_==null?void 0:_.emailRedirectTo,body:{email:g,password:y,data:(t=_==null?void 0:_.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:_==null?void 0:_.captchaToken},code_challenge:w,code_challenge_method:v},xform:dn})}else if("phone"in e){const{phone:g,password:y,options:_}=e;s=await $e(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:g,password:y,data:(r=_==null?void 0:_.data)!==null&&r!==void 0?r:{},channel:(i=_==null?void 0:_.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:_==null?void 0:_.captchaToken}},xform:dn})}else throw new la("You must provide either an email or phone number and a password");const{data:l,error:u}=s;if(u||!l)return await It(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:u});const h=l.session,f=l.user;return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",h)),this._returnResult({data:{user:f,session:h},error:null})}catch(s){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithPassword(e){try{let t;if("email"in e){const{email:s,password:l,options:u}=e;t=await $e(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:s,password:l,gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:zs})}else if("phone"in e){const{phone:s,password:l,options:u}=e;t=await $e(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:s,password:l,gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:zs})}else throw new la("You must provide either an email or phone number and a password");const{data:r,error:i}=t;if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!r||!r.session||!r.user){const s=new tr;return this._returnResult({data:{user:null,session:null},error:s})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:i})}catch(t){if(Se(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,r,i,s;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(s=e.options)===null||s===void 0?void 0:s.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,r,i,s,l,u,h,f,g,y,_;let w,v;if("message"in e)w=e.message,v=e.signature;else{const{chain:E,wallet:j,statement:V,options:z}=e;let T;if(Lt())if(typeof j=="object")T=j;else{const pe=window;if("ethereum"in pe&&typeof pe.ethereum=="object"&&"request"in pe.ethereum&&typeof pe.ethereum.request=="function")T=pe.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof j!="object"||!(z!=null&&z.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");T=j}const H=new URL((t=z==null?void 0:z.url)!==null&&t!==void 0?t:window.location.href),U=await T.request({method:"eth_requestAccounts"}).then(pe=>pe).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!U||U.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const R=To(U[0]);let M=(r=z==null?void 0:z.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!M){const pe=await T.request({method:"eth_chainId"});M=$u(pe)}const F={domain:H.host,address:R,statement:V,uri:H.href,version:"1",chainId:M,nonce:(i=z==null?void 0:z.signInWithEthereum)===null||i===void 0?void 0:i.nonce,issuedAt:(l=(s=z==null?void 0:z.signInWithEthereum)===null||s===void 0?void 0:s.issuedAt)!==null&&l!==void 0?l:new Date,expirationTime:(u=z==null?void 0:z.signInWithEthereum)===null||u===void 0?void 0:u.expirationTime,notBefore:(h=z==null?void 0:z.signInWithEthereum)===null||h===void 0?void 0:h.notBefore,requestId:(f=z==null?void 0:z.signInWithEthereum)===null||f===void 0?void 0:f.requestId,resources:(g=z==null?void 0:z.signInWithEthereum)===null||g===void 0?void 0:g.resources};w=xu(F),v=await T.request({method:"personal_sign",params:[Tu(w),R]})}try{const{data:E,error:j}=await $e(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:w,signature:v},!((y=e.options)===null||y===void 0)&&y.captchaToken?{gotrue_meta_security:{captcha_token:(_=e.options)===null||_===void 0?void 0:_.captchaToken}}:null),xform:dn});if(j)throw j;if(!E||!E.session||!E.user){const V=new tr;return this._returnResult({data:{user:null,session:null},error:V})}return E.session&&(await this._saveSession(E.session),await this._notifyAllSubscribers("SIGNED_IN",E.session)),this._returnResult({data:Object.assign({},E),error:j})}catch(E){if(Se(E))return this._returnResult({data:{user:null,session:null},error:E});throw E}}async signInWithSolana(e){var t,r,i,s,l,u,h,f,g,y,_,w;let v,E;if("message"in e)v=e.message,E=e.signature;else{const{chain:j,wallet:V,statement:z,options:T}=e;let H;if(Lt())if(typeof V=="object")H=V;else{const R=window;if("solana"in R&&typeof R.solana=="object"&&("signIn"in R.solana&&typeof R.solana.signIn=="function"||"signMessage"in R.solana&&typeof R.solana.signMessage=="function"))H=R.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof V!="object"||!(T!=null&&T.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");H=V}const U=new URL((t=T==null?void 0:T.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in H&&H.signIn){const R=await H.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},T==null?void 0:T.signInWithSolana),{version:"1",domain:U.host,uri:U.href}),z?{statement:z}:null));let M;if(Array.isArray(R)&&R[0]&&typeof R[0]=="object")M=R[0];else if(R&&typeof R=="object"&&"signedMessage"in R&&"signature"in R)M=R;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in M&&"signature"in M&&(typeof M.signedMessage=="string"||M.signedMessage instanceof Uint8Array)&&M.signature instanceof Uint8Array)v=typeof M.signedMessage=="string"?M.signedMessage:new TextDecoder().decode(M.signedMessage),E=M.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in H)||typeof H.signMessage!="function"||!("publicKey"in H)||typeof H!="object"||!H.publicKey||!("toBase58"in H.publicKey)||typeof H.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");v=[`${U.host} wants you to sign in with your Solana account:`,H.publicKey.toBase58(),...z?["",z,""]:[""],"Version: 1",`URI: ${U.href}`,`Issued At: ${(i=(r=T==null?void 0:T.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((s=T==null?void 0:T.signInWithSolana)===null||s===void 0)&&s.notBefore?[`Not Before: ${T.signInWithSolana.notBefore}`]:[],...!((l=T==null?void 0:T.signInWithSolana)===null||l===void 0)&&l.expirationTime?[`Expiration Time: ${T.signInWithSolana.expirationTime}`]:[],...!((u=T==null?void 0:T.signInWithSolana)===null||u===void 0)&&u.chainId?[`Chain ID: ${T.signInWithSolana.chainId}`]:[],...!((h=T==null?void 0:T.signInWithSolana)===null||h===void 0)&&h.nonce?[`Nonce: ${T.signInWithSolana.nonce}`]:[],...!((f=T==null?void 0:T.signInWithSolana)===null||f===void 0)&&f.requestId?[`Request ID: ${T.signInWithSolana.requestId}`]:[],...!((y=(g=T==null?void 0:T.signInWithSolana)===null||g===void 0?void 0:g.resources)===null||y===void 0)&&y.length?["Resources",...T.signInWithSolana.resources.map(M=>`- ${M}`)]:[]].join(`
`);const R=await H.signMessage(new TextEncoder().encode(v),"utf8");if(!R||!(R instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");E=R}}try{const{data:j,error:V}=await $e(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:v,signature:Vn(E)},!((_=e.options)===null||_===void 0)&&_.captchaToken?{gotrue_meta_security:{captcha_token:(w=e.options)===null||w===void 0?void 0:w.captchaToken}}:null),xform:dn});if(V)throw V;if(!j||!j.session||!j.user){const z=new tr;return this._returnResult({data:{user:null,session:null},error:z})}return j.session&&(await this._saveSession(j.session),await this._notifyAllSubscribers("SIGNED_IN",j.session)),this._returnResult({data:Object.assign({},j),error:V})}catch(j){if(Se(j))return this._returnResult({data:{user:null,session:null},error:j});throw j}}async _exchangeCodeForSession(e){const t=await Fn(this.storage,`${this.storageKey}-code-verifier`),[r,i]=(t??"").split("/");try{if(!r&&this.flowType==="pkce")throw new Jc;const{data:s,error:l}=await $e(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:dn});if(await It(this.storage,`${this.storageKey}-code-verifier`),l)throw l;if(!s||!s.session||!s.user){const u=new tr;return this._returnResult({data:{user:null,session:null,redirectType:null},error:u})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign(Object.assign({},s),{redirectType:i??null}),error:l})}catch(s){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(s))return this._returnResult({data:{user:null,session:null,redirectType:null},error:s});throw s}}async signInWithIdToken(e){try{const{options:t,provider:r,token:i,access_token:s,nonce:l}=e,u=await $e(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:i,access_token:s,nonce:l,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:dn}),{data:h,error:f}=u;if(f)return this._returnResult({data:{user:null,session:null},error:f});if(!h||!h.session||!h.user){const g=new tr;return this._returnResult({data:{user:null,session:null},error:g})}return h.session&&(await this._saveSession(h.session),await this._notifyAllSubscribers("SIGNED_IN",h.session)),this._returnResult({data:h,error:f})}catch(t){if(Se(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,r,i,s,l;try{if("email"in e){const{email:u,options:h}=e;let f=null,g=null;this.flowType==="pkce"&&([f,g]=await nr(this.storage,this.storageKey));const{error:y}=await $e(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:u,data:(t=h==null?void 0:h.data)!==null&&t!==void 0?t:{},create_user:(r=h==null?void 0:h.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken},code_challenge:f,code_challenge_method:g},redirectTo:h==null?void 0:h.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:y})}if("phone"in e){const{phone:u,options:h}=e,{data:f,error:g}=await $e(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:u,data:(i=h==null?void 0:h.data)!==null&&i!==void 0?i:{},create_user:(s=h==null?void 0:h.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken},channel:(l=h==null?void 0:h.channel)!==null&&l!==void 0?l:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:f==null?void 0:f.message_id},error:g})}throw new la("You must provide either an email or phone number.")}catch(u){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(u))return this._returnResult({data:{user:null,session:null},error:u});throw u}}async verifyOtp(e){var t,r;try{let i,s;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,s=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:l,error:u}=await $e(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:s}}),redirectTo:i,xform:dn});if(u)throw u;if(!l)throw new Error("An error occurred on token verification.");const h=l.session,f=l.user;return h!=null&&h.access_token&&(await this._saveSession(h),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",h)),this._returnResult({data:{user:f,session:h},error:null})}catch(i){if(Se(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithSSO(e){var t,r,i,s,l;try{let u=null,h=null;this.flowType==="pkce"&&([u,h]=await nr(this.storage,this.storageKey));const f=await $e(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:u,code_challenge_method:h}),headers:this.headers,xform:_u});return!((s=f.data)===null||s===void 0)&&s.url&&Lt()&&!(!((l=e.options)===null||l===void 0)&&l.skipBrowserRedirect)&&window.location.assign(f.data.url),this._returnResult(f)}catch(u){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(u))return this._returnResult({data:null,error:u});throw u}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new tn;const{error:i}=await $e(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:i})})}catch(e){if(Se(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:i,options:s}=e,{error:l}=await $e(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:i,gotrue_meta_security:{captcha_token:s==null?void 0:s.captchaToken}},redirectTo:s==null?void 0:s.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:l})}else if("phone"in e){const{phone:r,type:i,options:s}=e,{data:l,error:u}=await $e(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:i,gotrue_meta_security:{captcha_token:s==null?void 0:s.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:u})}throw new la("You must provide either an email or phone number and a type")}catch(t){if(Se(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await Fn(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<oi:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const l=await Fn(this.userStorage,this.storageKey+"-user");l!=null&&l.user?e.user=l.user:e.user=ui()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const l={value:this.suppressGetSessionWarning};e.user=gu(e.user,l),l.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:i,error:s}=await this._callRefreshToken(e.refresh_token);return s?this._returnResult({data:{session:null},error:s}):this._returnResult({data:{session:i},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const t=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return t.data.user&&(this.suppressGetSessionWarning=!0),t}async _getUser(e){try{return e?await $e(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:Nn}):await this._useSession(async t=>{var r,i,s;const{data:l,error:u}=t;if(u)throw u;return!(!((r=l.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new tn}:await $e(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(s=(i=l.session)===null||i===void 0?void 0:i.access_token)!==null&&s!==void 0?s:void 0,xform:Nn})})}catch(t){if(Se(t))return Vc(t)&&(await this._removeSession(),await It(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:i,error:s}=r;if(s)throw s;if(!i.session)throw new tn;const l=i.session;let u=null,h=null;this.flowType==="pkce"&&e.email!=null&&([u,h]=await nr(this.storage,this.storageKey));const{data:f,error:g}=await $e(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:u,code_challenge_method:h}),jwt:l.access_token,xform:Nn});if(g)throw g;return l.user=f.user,await this._saveSession(l),await this._notifyAllSubscribers("USER_UPDATED",l),this._returnResult({data:{user:l.user},error:null})})}catch(r){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new tn;const t=Date.now()/1e3;let r=t,i=!0,s=null;const{payload:l}=ci(e.access_token);if(l.exp&&(r=l.exp,i=r<=t),i){const{data:u,error:h}=await this._callRefreshToken(e.refresh_token);if(h)return this._returnResult({data:{user:null,session:null},error:h});if(!u)return{data:{user:null,session:null},error:null};s=u}else{const{data:u,error:h}=await this._getUser(e.access_token);if(h)throw h;s={access_token:e.access_token,refresh_token:e.refresh_token,user:u.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)}return this._returnResult({data:{user:s.user,session:s},error:null})}catch(t){if(Se(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:l,error:u}=t;if(u)throw u;e=(r=l.session)!==null&&r!==void 0?r:void 0}if(!(e!=null&&e.refresh_token))throw new tn;const{data:i,error:s}=await this._callRefreshToken(e.refresh_token);return s?this._returnResult({data:{user:null,session:null},error:s}):i?this._returnResult({data:{user:i.user,session:i},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(Se(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!Lt())throw new ca("No browser detected.");if(e.error||e.error_description||e.error_code)throw new ca(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Ls("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new ca("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ls("No code detected.");const{data:z,error:T}=await this._exchangeCodeForSession(e.code);if(T)throw T;const H=new URL(window.location.href);return H.searchParams.delete("code"),window.history.replaceState(window.history.state,"",H.toString()),{data:{session:z.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:i,access_token:s,refresh_token:l,expires_in:u,expires_at:h,token_type:f}=e;if(!s||!u||!l||!f)throw new ca("No session defined in URL");const g=Math.round(Date.now()/1e3),y=parseInt(u);let _=g+y;h&&(_=parseInt(h));const w=_-g;w*1e3<=lr&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${w}s, should have been closer to ${y}s`);const v=_-y;g-v>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",v,_,g):g-v<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",v,_,g);const{data:E,error:j}=await this._getUser(s);if(j)throw j;const V={provider_token:r,provider_refresh_token:i,access_token:s,expires_in:y,expires_at:_,refresh_token:l,token_type:f,user:E.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:V,redirectType:e.type},error:null})}catch(r){if(Se(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await Fn(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:i,error:s}=t;if(s)return this._returnResult({error:s});const l=(r=i.session)===null||r===void 0?void 0:r.access_token;if(l){const{error:u}=await this.admin.signOut(l,e);if(u&&!(Wc(u)&&(u.status===404||u.status===401||u.status===403)))return this._returnResult({error:u})}return e!=="others"&&(await this._removeSession(),await It(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=nu(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,i;try{const{data:{session:s},error:l}=t;if(l)throw l;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",s)),this._debug("INITIAL_SESSION","callback id",e,"session",s)}catch(s){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",s),console.error(s)}})}async resetPasswordForEmail(e,t={}){let r=null,i=null;this.flowType==="pkce"&&([r,i]=await nr(this.storage,this.storageKey,!0));try{return await $e(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(s){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(s))return this._returnResult({data:null,error:s});throw s}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:r,error:i}=await this._useSession(async s=>{var l,u,h,f,g;const{data:y,error:_}=s;if(_)throw _;const w=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(l=e.options)===null||l===void 0?void 0:l.redirectTo,scopes:(u=e.options)===null||u===void 0?void 0:u.scopes,queryParams:(h=e.options)===null||h===void 0?void 0:h.queryParams,skipBrowserRedirect:!0});return await $e(this.fetch,"GET",w,{headers:this.headers,jwt:(g=(f=y.session)===null||f===void 0?void 0:f.access_token)!==null&&g!==void 0?g:void 0})});if(i)throw i;return Lt()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),this._returnResult({data:{provider:e.provider,url:r==null?void 0:r.url},error:null})}catch(r){if(Se(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var r;try{const{error:i,data:{session:s}}=t;if(i)throw i;const{options:l,provider:u,token:h,access_token:f,nonce:g}=e,y=await $e(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=s==null?void 0:s.access_token)!==null&&r!==void 0?r:void 0,body:{provider:u,id_token:h,access_token:f,nonce:g,link_identity:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken}},xform:dn}),{data:_,error:w}=y;return w?this._returnResult({data:{user:null,session:null},error:w}):!_||!_.session||!_.user?this._returnResult({data:{user:null,session:null},error:new tr}):(_.session&&(await this._saveSession(_.session),await this._notifyAllSubscribers("USER_UPDATED",_.session)),this._returnResult({data:_,error:w}))}catch(i){if(await It(this.storage,`${this.storageKey}-code-verifier`),Se(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,i;const{data:s,error:l}=t;if(l)throw l;return await $e(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(r=s.session)===null||r===void 0?void 0:r.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await su(async i=>(i>0&&await iu(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await $e(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:dn})),(i,s)=>{const l=200*Math.pow(2,i);return s&&li(s)&&Date.now()+l-r<lr})}catch(r){if(this._debug(t,"error",r),Se(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),Lt()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const i=await Fn(this.storage,this.storageKey);if(i&&this.userStorage){let l=await Fn(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!l&&(l={user:i.user},await cr(this.userStorage,this.storageKey+"-user",l)),i.user=(e=l==null?void 0:l.user)!==null&&e!==void 0?e:ui()}else if(i&&!i.user&&!i.user){const l=await Fn(this.storage,this.storageKey+"-user");l&&(l!=null&&l.user)?(i.user=l.user,await It(this.storage,this.storageKey+"-user"),await cr(this.storage,this.storageKey,i)):i.user=ui()}if(this._debug(r,"session from storage",i),!this._isValidSession(i)){this._debug(r,"session is not valid"),i!==null&&await this._removeSession();return}const s=((t=i.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<oi;if(this._debug(r,`session has${s?"":" not"} expired with margin of ${oi}s`),s){if(this.autoRefreshToken&&i.refresh_token){const{error:l}=await this._callRefreshToken(i.refresh_token);l&&(console.error(l),li(l)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",l),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{const{data:l,error:u}=await this._getUser(i.access_token);!u&&(l!=null&&l.user)?(i.user=l.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(l){console.error("Error getting user data:",l),this._debug(r,"error getting user data, skipping SIGNED_IN notification",l)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(r,"error",i),console.error(i);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new tn;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new $a;const{data:s,error:l}=await this._refreshAccessToken(e);if(l)throw l;if(!s.session)throw new tn;await this._saveSession(s.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",s.session);const u={data:s.session,error:null};return this.refreshingDeferred.resolve(u),u}catch(s){if(this._debug(i,"error",s),Se(s)){const l={data:null,error:s};return li(s)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(l),l}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(s),s}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,r=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const s=[],l=Array.from(this.stateChangeEmitters.values()).map(async u=>{try{await u.callback(e,t)}catch(h){s.push(h)}});if(await Promise.all(l),s.length>0){for(let u=0;u<s.length;u+=1)console.error(s[u]);throw s[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await It(this.storage,`${this.storageKey}-code-verifier`);const t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await cr(this.userStorage,this.storageKey+"-user",{user:t.user});const i=Object.assign({},t);delete i.user;const s=Bs(i);await cr(this.storage,this.storageKey,s)}else{const i=Bs(t);await cr(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await It(this.storage,this.storageKey),await It(this.storage,this.storageKey+"-code-verifier"),await It(this.storage,this.storageKey+"-user"),this.userStorage&&await It(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Lt()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),lr);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const t=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const t=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,t&&clearTimeout(t)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((r.expires_at*1e3-e)/lr);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${lr}ms, refresh threshold is ${wi} ticks`),i<=wi&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof $o)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Lt()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const i=[`provider=${encodeURIComponent(t)}`];if(r!=null&&r.redirectTo&&i.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&i.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[s,l]=await nr(this.storage,this.storageKey),u=new URLSearchParams({code_challenge:`${encodeURIComponent(s)}`,code_challenge_method:`${encodeURIComponent(l)}`});i.push(u.toString())}if(r!=null&&r.queryParams){const s=new URLSearchParams(r.queryParams);i.push(s.toString())}return r!=null&&r.skipBrowserRedirect&&i.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:i,error:s}=t;return s?this._returnResult({data:null,error:s}):await $e(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,i;const{data:s,error:l}=t;if(l)return this._returnResult({data:null,error:l});const u=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:h,error:f}=await $e(this.fetch,"POST",`${this.url}/factors`,{body:u,headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token});return f?this._returnResult({data:null,error:f}):(e.factorType==="totp"&&h.type==="totp"&&(!((i=h==null?void 0:h.totp)===null||i===void 0)&&i.qr_code)&&(h.totp.qr_code=`data:image/svg+xml;utf-8,${h.totp.qr_code}`),this._returnResult({data:h,error:null}))})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:i,error:s}=t;if(s)return this._returnResult({data:null,error:s});const l=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?qu(e.webauthn.credential_response):ju(e.webauthn.credential_response)})}:{code:e.code}),{data:u,error:h}=await $e(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:l,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return h?this._returnResult({data:null,error:h}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+u.expires_in},u)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",u),this._returnResult({data:u,error:h}))})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:i,error:s}=t;if(s)return this._returnResult({data:null,error:s});const l=await $e(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});if(l.error)return l;const{data:u}=l;if(u.type!=="webauthn")return{data:u,error:null};switch(u.webauthn.type){case"create":return{data:Object.assign(Object.assign({},u),{webauthn:Object.assign(Object.assign({},u.webauthn),{credential_options:Object.assign(Object.assign({},u.webauthn.credential_options),{publicKey:Iu(u.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},u),{webauthn:Object.assign(Object.assign({},u.webauthn),{credential_options:Object.assign(Object.assign({},u.webauthn.credential_options),{publicKey:Lu(u.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:r}=await this.getUser();if(r)return{data:null,error:r};const i={all:[],phone:[],totp:[],webauthn:[]};for(const s of(e=t==null?void 0:t.factors)!==null&&e!==void 0?e:[])i.all.push(s),s.status==="verified"&&i[s.factor_type].push(s);return{data:i,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:r},error:i}=await this.getSession();if(i)return this._returnResult({data:null,error:i});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:s}=ci(r.access_token);let l=null;s.aal&&(l=s.aal);let u=l;((t=(e=r.user.factors)===null||e===void 0?void 0:e.filter(g=>g.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(u="aal2");const f=s.amr||[];return{data:{currentLevel:l,nextLevel:u,currentAuthenticationMethods:f},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:r},error:i}=t;return i?this._returnResult({data:null,error:i}):r?await $e(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:s=>({data:s,error:null})}):this._returnResult({data:null,error:new tn})})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:i},error:s}=r;if(s)return this._returnResult({data:null,error:s});if(!i)return this._returnResult({data:null,error:new tn});const l=await $e(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"approve"},xform:u=>({data:u,error:null})});return l.data&&l.data.redirect_url&&Lt()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(l.data.redirect_url),l})}catch(r){if(Se(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:i},error:s}=r;if(s)return this._returnResult({data:null,error:s});if(!i)return this._returnResult({data:null,error:new tn});const l=await $e(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"deny"},xform:u=>({data:u,error:null})});return l.data&&l.data.redirect_url&&Lt()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(l.data.redirect_url),l})}catch(r){if(Se(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;return r?this._returnResult({data:null,error:r}):t?await $e(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new tn})})}catch(e){if(Se(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{const{data:{session:r},error:i}=t;return i?this._returnResult({data:null,error:i}):r?(await $e(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new tn})})}catch(t){if(Se(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(u=>u.kid===e);if(r)return r;const i=Date.now();if(r=this.jwks.keys.find(u=>u.kid===e),r&&this.jwks_cached_at+Kc>i)return r;const{data:s,error:l}=await $e(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(l)throw l;return!s.keys||s.keys.length===0||(this.jwks=s,this.jwks_cached_at=i,r=s.keys.find(u=>u.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){const{data:w,error:v}=await this.getSession();if(v||!w.session)return this._returnResult({data:null,error:v});r=w.session.access_token}const{header:i,payload:s,signature:l,raw:{header:u,payload:h}}=ci(r);t!=null&&t.allowExpired||fu(s.exp);const f=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,t!=null&&t.keys?{keys:t.keys}:t==null?void 0:t.jwks);if(!f){const{error:w}=await this.getUser(r);if(w)throw w;return{data:{claims:s,header:i,signature:l},error:null}}const g=pu(i.alg),y=await crypto.subtle.importKey("jwk",f,g,!0,["verify"]);if(!await crypto.subtle.verify(g,y,l,eu(`${u}.${h}`)))throw new Ei("Invalid JWT signature");return{data:{claims:s,header:i,signature:l},error:null}}catch(r){if(Se(r))return this._returnResult({data:null,error:r});throw r}}}Lr.nextInstanceID={};const Wu=Lr,Vu="2.91.1";let Cr="";typeof Deno<"u"?Cr="deno":typeof document<"u"?Cr="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Cr="react-native":Cr="node";const Gu={"X-Client-Info":`supabase-js-${Cr}/${Vu}`},Ju={headers:Gu},Yu={schema:"public"},Qu={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Xu={};function qr(n){"@babel/helpers - typeof";return qr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},qr(n)}function Zu(n,e){if(qr(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(qr(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function ed(n){var e=Zu(n,"string");return qr(e)=="symbol"?e:e+""}function td(n,e,t){return(e=ed(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Vs(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function ut(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Vs(Object(t),!0).forEach(function(r){td(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Vs(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const nd=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),rd=()=>Headers,ad=(n,e,t)=>{const r=nd(t),i=rd();return async(s,l)=>{var u;const h=(u=await e())!==null&&u!==void 0?u:n;let f=new i(l==null?void 0:l.headers);return f.has("apikey")||f.set("apikey",n),f.has("Authorization")||f.set("Authorization",`Bearer ${h}`),r(s,ut(ut({},l),{},{headers:f}))}};function id(n){return n.endsWith("/")?n:n+"/"}function sd(n,e){var t,r;const{db:i,auth:s,realtime:l,global:u}=n,{db:h,auth:f,realtime:g,global:y}=e,_={db:ut(ut({},h),i),auth:ut(ut({},f),s),realtime:ut(ut({},g),l),storage:{},global:ut(ut(ut({},y),u),{},{headers:ut(ut({},(t=y==null?void 0:y.headers)!==null&&t!==void 0?t:{}),(r=u==null?void 0:u.headers)!==null&&r!==void 0?r:{})}),accessToken:async()=>""};return n.accessToken?_.accessToken=n.accessToken:delete _.accessToken,_}function od(n){const e=n==null?void 0:n.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(id(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var ld=class extends Wu{constructor(n){super(n)}},cd=class{constructor(n,e,t){var r,i;this.supabaseUrl=n,this.supabaseKey=e;const s=od(n);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",s),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",s),this.storageUrl=new URL("storage/v1",s),this.functionsUrl=new URL("functions/v1",s);const l=`sb-${s.hostname.split(".")[0]}-auth-token`,u={db:Yu,realtime:Xu,auth:ut(ut({},Qu),{},{storageKey:l}),global:Ju},h=sd(t??{},u);if(this.storageKey=(r=h.auth.storageKey)!==null&&r!==void 0?r:"",this.headers=(i=h.global.headers)!==null&&i!==void 0?i:{},h.accessToken)this.accessToken=h.accessToken,this.auth=new Proxy({},{get:(g,y)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(y)} is not possible`)}});else{var f;this.auth=this._initSupabaseAuthClient((f=h.auth)!==null&&f!==void 0?f:{},this.headers,h.global.fetch)}this.fetch=ad(e,this._getAccessToken.bind(this),h.global.fetch),this.realtime=this._initRealtimeClient(ut({headers:this.headers,accessToken:this._getAccessToken.bind(this)},h.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(g=>this.realtime.setAuth(g)).catch(g=>console.warn("Failed to set initial Realtime auth token:",g)),this.rest=new zl(new URL("rest/v1",s).href,{headers:this.headers,schema:h.db.schema,fetch:this.fetch}),this.storage=new Mc(this.storageUrl.href,this.headers,this.fetch,t==null?void 0:t.storage),h.accessToken||this._listenForAuthEvents()}get functions(){return new jl(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(n){return this.rest.from(n)}schema(n){return this.rest.schema(n)}rpc(n,e={},t={head:!1,get:!1,count:void 0}){return this.rest.rpc(n,e,t)}channel(n,e={config:{}}){return this.realtime.channel(n,e)}getChannels(){return this.realtime.getChannels()}removeChannel(n){return this.realtime.removeChannel(n)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var n=this,e,t;if(n.accessToken)return await n.accessToken();const{data:r}=await n.auth.getSession();return(e=(t=r.session)===null||t===void 0?void 0:t.access_token)!==null&&e!==void 0?e:n.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:i,storageKey:s,flowType:l,lock:u,debug:h,throwOnError:f},g,y){const _={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new ld({url:this.authUrl.href,headers:ut(ut({},_),g),storageKey:s,autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:i,flowType:l,lock:u,debug:h,throwOnError:f,fetch:y,hasCustomAuthorizationHeader:Object.keys(this.headers).some(w=>w.toLowerCase()==="authorization")})}_initRealtimeClient(n){return new ic(this.realtimeUrl.href,ut(ut({},n),{},{params:ut(ut({},{apikey:this.supabaseKey}),n==null?void 0:n.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((n,e)=>{this._handleTokenChanged(n,"CLIENT",e==null?void 0:e.access_token)})}_handleTokenChanged(n,e,t){(n==="TOKEN_REFRESHED"||n==="SIGNED_IN")&&this.changedAccessToken!==t?(this.changedAccessToken=t,this.realtime.setAuth(t)):n==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const ud=(n,e,t)=>new cd(n,e,t);function dd(){if(typeof window<"u")return!1;const n=globalThis.process;if(!n)return!1;const e=n.version;if(e==null)return!1;const t=e.match(/^v(\d+)\./);return t?parseInt(t[1],10)<=18:!1}dd()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const hd=void 0,fd=void 0,De=ud(hd,fd);var Gs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function pd(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Oo={exports:{}};(function(n,e){(function(t,r){n.exports=r()})(Gs,function(){var t=function(a,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,d){c.__proto__=d}||function(c,d){for(var p in d)Object.prototype.hasOwnProperty.call(d,p)&&(c[p]=d[p])})(a,o)},r=function(){return(r=Object.assign||function(a){for(var o,c=1,d=arguments.length;c<d;c++)for(var p in o=arguments[c])Object.prototype.hasOwnProperty.call(o,p)&&(a[p]=o[p]);return a}).apply(this,arguments)};function i(a,o,c){for(var d,p=0,m=o.length;p<m;p++)!d&&p in o||((d=d||Array.prototype.slice.call(o,0,p))[p]=o[p]);return a.concat(d||Array.prototype.slice.call(o))}var s=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Gs,l=Object.keys,u=Array.isArray;function h(a,o){return typeof o!="object"||l(o).forEach(function(c){a[c]=o[c]}),a}typeof Promise>"u"||s.Promise||(s.Promise=Promise);var f=Object.getPrototypeOf,g={}.hasOwnProperty;function y(a,o){return g.call(a,o)}function _(a,o){typeof o=="function"&&(o=o(f(a))),(typeof Reflect>"u"?l:Reflect.ownKeys)(o).forEach(function(c){v(a,c,o[c])})}var w=Object.defineProperty;function v(a,o,c,d){w(a,o,h(c&&y(c,"get")&&typeof c.get=="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},d))}function E(a){return{from:function(o){return a.prototype=Object.create(o.prototype),v(a.prototype,"constructor",a),{extend:_.bind(null,a.prototype)}}}}var j=Object.getOwnPropertyDescriptor,V=[].slice;function z(a,o,c){return V.call(a,o,c)}function T(a,o){return o(a)}function H(a){if(!a)throw new Error("Assertion Failed")}function U(a){s.setImmediate?setImmediate(a):setTimeout(a,0)}function R(a,o){if(typeof o=="string"&&y(a,o))return a[o];if(!o)return a;if(typeof o!="string"){for(var c=[],d=0,p=o.length;d<p;++d){var m=R(a,o[d]);c.push(m)}return c}var b=o.indexOf(".");if(b!==-1){var k=a[o.substr(0,b)];return k==null?void 0:R(k,o.substr(b+1))}}function M(a,o,c){if(a&&o!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof o!="string"&&"length"in o){H(typeof c!="string"&&"length"in c);for(var d=0,p=o.length;d<p;++d)M(a,o[d],c[d])}else{var m,b,k=o.indexOf(".");k!==-1?(m=o.substr(0,k),(b=o.substr(k+1))===""?c===void 0?u(a)&&!isNaN(parseInt(m))?a.splice(m,1):delete a[m]:a[m]=c:M(k=!(k=a[m])||!y(a,m)?a[m]={}:k,b,c)):c===void 0?u(a)&&!isNaN(parseInt(o))?a.splice(o,1):delete a[o]:a[o]=c}}function F(a){var o,c={};for(o in a)y(a,o)&&(c[o]=a[o]);return c}var pe=[].concat;function Ae(a){return pe.apply([],a)}var st="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ae([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(o){return o+a+"Array"})}))).filter(function(a){return s[a]}),G=new Set(st.map(function(a){return s[a]})),L=null;function B(a){return L=new WeakMap,a=function o(c){if(!c||typeof c!="object")return c;var d=L.get(c);if(d)return d;if(u(c)){d=[],L.set(c,d);for(var p=0,m=c.length;p<m;++p)d.push(o(c[p]))}else if(G.has(c.constructor))d=c;else{var b,k=f(c);for(b in d=k===Object.prototype?{}:Object.create(k),L.set(c,d),c)y(c,b)&&(d[b]=o(c[b]))}return d}(a),L=null,a}var X={}.toString;function ee(a){return X.call(a).slice(8,-1)}var ue=typeof Symbol<"u"?Symbol.iterator:"@@iterator",be=typeof ue=="symbol"?function(a){var o;return a!=null&&(o=a[ue])&&o.apply(a)}:function(){return null};function ge(a,o){return o=a.indexOf(o),0<=o&&a.splice(o,1),0<=o}var he={};function ye(a){var o,c,d,p;if(arguments.length===1){if(u(a))return a.slice();if(this===he&&typeof a=="string")return[a];if(p=be(a)){for(c=[];!(d=p.next()).done;)c.push(d.value);return c}if(a==null)return[a];if(typeof(o=a.length)!="number")return[a];for(c=new Array(o);o--;)c[o]=a[o];return c}for(o=arguments.length,c=new Array(o);o--;)c[o]=arguments[o];return c}var Pe=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Ct=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],on=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Ct),Ve={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Q(a,o){this.name=a,this.message=o}function ze(a,o){return a+". Errors: "+Object.keys(o).map(function(c){return o[c].toString()}).filter(function(c,d,p){return p.indexOf(c)===d}).join(`
`)}function we(a,o,c,d){this.failures=o,this.failedKeys=d,this.successCount=c,this.message=ze(a,o)}function Oe(a,o){this.name="BulkError",this.failures=Object.keys(o).map(function(c){return o[c]}),this.failuresByPos=o,this.message=ze(a,this.failures)}E(Q).from(Error).extend({toString:function(){return this.name+": "+this.message}}),E(we).from(Q),E(Oe).from(Q);var Re=on.reduce(function(a,o){return a[o]=o+"Error",a},{}),Be=Q,ce=on.reduce(function(a,o){var c=o+"Error";function d(p,m){this.name=c,p?typeof p=="string"?(this.message="".concat(p).concat(m?`
 `+m:""),this.inner=m||null):typeof p=="object"&&(this.message="".concat(p.name," ").concat(p.message),this.inner=p):(this.message=Ve[o]||c,this.inner=null)}return E(d).from(Be),a[o]=d,a},{});ce.Syntax=SyntaxError,ce.Type=TypeError,ce.Range=RangeError;var Rt=Ct.reduce(function(a,o){return a[o+"Error"]=ce[o],a},{}),Et=on.reduce(function(a,o){return["Syntax","Type","Range"].indexOf(o)===-1&&(a[o+"Error"]=ce[o]),a},{});function qe(){}function At(a){return a}function Nt(a,o){return a==null||a===At?o:function(c){return o(a(c))}}function ft(a,o){return function(){a.apply(this,arguments),o.apply(this,arguments)}}function at(a,o){return a===qe?o:function(){var c=a.apply(this,arguments);c!==void 0&&(arguments[0]=c);var d=this.onsuccess,p=this.onerror;this.onsuccess=null,this.onerror=null;var m=o.apply(this,arguments);return d&&(this.onsuccess=this.onsuccess?ft(d,this.onsuccess):d),p&&(this.onerror=this.onerror?ft(p,this.onerror):p),m!==void 0?m:c}}function Vt(a,o){return a===qe?o:function(){a.apply(this,arguments);var c=this.onsuccess,d=this.onerror;this.onsuccess=this.onerror=null,o.apply(this,arguments),c&&(this.onsuccess=this.onsuccess?ft(c,this.onsuccess):c),d&&(this.onerror=this.onerror?ft(d,this.onerror):d)}}function Ut(a,o){return a===qe?o:function(c){var d=a.apply(this,arguments);h(c,d);var p=this.onsuccess,m=this.onerror;return this.onsuccess=null,this.onerror=null,c=o.apply(this,arguments),p&&(this.onsuccess=this.onsuccess?ft(p,this.onsuccess):p),m&&(this.onerror=this.onerror?ft(m,this.onerror):m),d===void 0?c===void 0?void 0:c:h(d,c)}}function it(a,o){return a===qe?o:function(){return o.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function yt(a,o){return a===qe?o:function(){var c=a.apply(this,arguments);if(c&&typeof c.then=="function"){for(var d=this,p=arguments.length,m=new Array(p);p--;)m[p]=arguments[p];return c.then(function(){return o.apply(d,m)})}return o.apply(this,arguments)}}Et.ModifyError=we,Et.DexieError=Q,Et.BulkError=Oe;var Je=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function lt(a){Je=a}var Xe={},Ne=100,st=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,f(a),a];var o=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[o,f(o),a]}(),Ct=st[0],on=st[1],st=st[2],on=on&&on.then,_t=Ct&&Ct.constructor,wt=!!st,jt=function(a,o){an.push([a,o]),Jt&&(queueMicrotask(qn),Jt=!1)},Gt=!0,Jt=!0,$t=[],le=[],Ye=At,Ce={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:qe,pgp:!1,env:{},finalize:qe},ve=Ce,an=[],et=0,mn=[];function ae(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var o=this._PSD=ve;if(typeof a!="function"){if(a!==Xe)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Yt(this,this._value))}this._state=null,this._value=null,++o.ref,function c(d,p){try{p(function(m){if(d._state===null){if(m===d)throw new TypeError("A promise cannot be resolved with itself.");var b=d._lib&&K();m&&typeof m.then=="function"?c(d,function(k,A){m instanceof ae?m._then(k,A):m.then(k,A)}):(d._state=!0,d._value=m,Cn(d)),b&&fe()}},Yt.bind(null,d))}catch(m){Yt(d,m)}}(this,a)}var An={get:function(){var a=ve,o=Qt;function c(d,p){var m=this,b=!a.global&&(a!==ve||o!==Qt),k=b&&!Z(),A=new ae(function(C,N){$n(m,new Gn(gr(d,a,b,k),gr(p,a,b,k),C,N,a))});return this._consoleTask&&(A._consoleTask=this._consoleTask),A}return c.prototype=Xe,c},set:function(a){v(this,"then",a&&a.prototype===Xe?An:{get:function(){return a},set:An.set})}};function Gn(a,o,c,d,p){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof o=="function"?o:null,this.resolve=c,this.reject=d,this.psd=p}function Yt(a,o){var c,d;le.push(o),a._state===null&&(c=a._lib&&K(),o=Ye(o),a._state=!1,a._value=o,d=a,$t.some(function(p){return p._value===d._value})||$t.push(d),Cn(a),c&&fe())}function Cn(a){var o=a._listeners;a._listeners=[];for(var c=0,d=o.length;c<d;++c)$n(a,o[c]);var p=a._PSD;--p.ref||p.finalize(),et===0&&(++et,jt(function(){--et==0&&me()},[]))}function $n(a,o){if(a._state!==null){var c=a._state?o.onFulfilled:o.onRejected;if(c===null)return(a._state?o.resolve:o.reject)(a._value);++o.psd.ref,++et,jt(Ln,[c,a,o])}else a._listeners.push(o)}function Ln(a,o,c){try{var d,p=o._value;!o._state&&le.length&&(le=[]),d=Je&&o._consoleTask?o._consoleTask.run(function(){return a(p)}):a(p),o._state||le.indexOf(p)!==-1||function(m){for(var b=$t.length;b;)if($t[--b]._value===m._value)return $t.splice(b,1)}(o),c.resolve(d)}catch(m){c.reject(m)}finally{--et==0&&me(),--c.psd.ref||c.psd.finalize()}}function qn(){_n(Ce,function(){K()&&fe()})}function K(){var a=Gt;return Jt=Gt=!1,a}function fe(){var a,o,c;do for(;0<an.length;)for(a=an,an=[],c=a.length,o=0;o<c;++o){var d=a[o];d[0].apply(null,d[1])}while(0<an.length);Jt=Gt=!0}function me(){var a=$t;$t=[],a.forEach(function(d){d._PSD.onunhandled.call(null,d._value,d)});for(var o=mn.slice(0),c=o.length;c;)o[--c]()}function Ke(a){return new ae(Xe,!1,a)}function Ee(a,o){var c=ve;return function(){var d=K(),p=ve;try{return He(c,!0),a.apply(this,arguments)}catch(m){o&&o(m)}finally{He(p,!1),d&&fe()}}}_(ae.prototype,{then:An,_then:function(a,o){$n(this,new Gn(null,null,a,o,ve))},catch:function(a){if(arguments.length===1)return this.then(null,a);var o=a,c=arguments[1];return typeof o=="function"?this.then(null,function(d){return(d instanceof o?c:Ke)(d)}):this.then(null,function(d){return(d&&d.name===o?c:Ke)(d)})},finally:function(a){return this.then(function(o){return ae.resolve(a()).then(function(){return o})},function(o){return ae.resolve(a()).then(function(){return Ke(o)})})},timeout:function(a,o){var c=this;return a<1/0?new ae(function(d,p){var m=setTimeout(function(){return p(new ce.Timeout(o))},a);c.then(d,p).finally(clearTimeout.bind(null,m))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&v(ae.prototype,Symbol.toStringTag,"Dexie.Promise"),Ce.env=ct(),_(ae,{all:function(){var a=ye.apply(null,arguments).map(xe);return new ae(function(o,c){a.length===0&&o([]);var d=a.length;a.forEach(function(p,m){return ae.resolve(p).then(function(b){a[m]=b,--d||o(a)},c)})})},resolve:function(a){return a instanceof ae?a:a&&typeof a.then=="function"?new ae(function(o,c){a.then(o,c)}):new ae(Xe,!0,a)},reject:Ke,race:function(){var a=ye.apply(null,arguments).map(xe);return new ae(function(o,c){a.map(function(d){return ae.resolve(d).then(o,c)})})},PSD:{get:function(){return ve},set:function(a){return ve=a}},totalEchoes:{get:function(){return Qt}},newPSD:Fe,usePSD:_n,scheduler:{get:function(){return jt},set:function(a){jt=a}},rejectionMapper:{get:function(){return Ye},set:function(a){Ye=a}},follow:function(a,o){return new ae(function(c,d){return Fe(function(p,m){var b=ve;b.unhandleds=[],b.onunhandled=m,b.finalize=ft(function(){var k,A=this;k=function(){A.unhandleds.length===0?p():m(A.unhandleds[0])},mn.push(function C(){k(),mn.splice(mn.indexOf(C),1)}),++et,jt(function(){--et==0&&me()},[])},b.finalize),a()},o,c,d)})}}),_t&&(_t.allSettled&&v(ae,"allSettled",function(){var a=ye.apply(null,arguments).map(xe);return new ae(function(o){a.length===0&&o([]);var c=a.length,d=new Array(c);a.forEach(function(p,m){return ae.resolve(p).then(function(b){return d[m]={status:"fulfilled",value:b}},function(b){return d[m]={status:"rejected",reason:b}}).then(function(){return--c||o(d)})})})}),_t.any&&typeof AggregateError<"u"&&v(ae,"any",function(){var a=ye.apply(null,arguments).map(xe);return new ae(function(o,c){a.length===0&&c(new AggregateError([]));var d=a.length,p=new Array(d);a.forEach(function(m,b){return ae.resolve(m).then(function(k){return o(k)},function(k){p[b]=k,--d||c(new AggregateError(p))})})})}),_t.withResolvers&&(ae.withResolvers=_t.withResolvers));var Me={awaits:0,echoes:0,id:0},sn=0,Ht=[],Pt=0,Qt=0,zt=0;function Fe(a,o,c,d){var p=ve,m=Object.create(p);return m.parent=p,m.ref=0,m.global=!1,m.id=++zt,Ce.env,m.env=wt?{Promise:ae,PromiseProp:{value:ae,configurable:!0,writable:!0},all:ae.all,race:ae.race,allSettled:ae.allSettled,any:ae.any,resolve:ae.resolve,reject:ae.reject}:{},o&&h(m,o),++p.ref,m.finalize=function(){--this.parent.ref||this.parent.finalize()},d=_n(m,a,c,d),m.ref===0&&m.finalize(),d}function Xt(){return Me.id||(Me.id=++sn),++Me.awaits,Me.echoes+=Ne,Me.id}function Z(){return!!Me.awaits&&(--Me.awaits==0&&(Me.id=0),Me.echoes=Me.awaits*Ne,!0)}function xe(a){return Me.echoes&&a&&a.constructor===_t?(Xt(),a.then(function(o){return Z(),o},function(o){return Z(),pt(o)})):a}function Qe(){var a=Ht[Ht.length-1];Ht.pop(),He(a,!1)}function He(a,o){var c,d=ve;(o?!Me.echoes||Pt++&&a===ve:!Pt||--Pt&&a===ve)||queueMicrotask(o?(function(p){++Qt,Me.echoes&&--Me.echoes!=0||(Me.echoes=Me.awaits=Me.id=0),Ht.push(ve),He(p,!0)}).bind(null,a):Qe),a!==ve&&(ve=a,d===Ce&&(Ce.env=ct()),wt&&(c=Ce.env.Promise,o=a.env,(d.global||a.global)&&(Object.defineProperty(s,"Promise",o.PromiseProp),c.all=o.all,c.race=o.race,c.resolve=o.resolve,c.reject=o.reject,o.allSettled&&(c.allSettled=o.allSettled),o.any&&(c.any=o.any))))}function ct(){var a=s.Promise;return wt?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(s,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function _n(a,o,c,d,p){var m=ve;try{return He(a,!0),o(c,d,p)}finally{He(m,!1)}}function gr(a,o,c,d){return typeof a!="function"?a:function(){var p=ve;c&&Xt(),He(o,!0);try{return a.apply(this,arguments)}finally{He(p,!1),d&&queueMicrotask(Z)}}}function Oa(a){Promise===_t&&Me.echoes===0?Pt===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+on).indexOf("[native code]")===-1&&(Xt=Z=qe);var pt=ae.reject,jn="",wn="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Vi="String expected.",Jn=[],Ur="__dbnames",Ra="readonly",Na="readwrite";function Dn(a,o){return a?o?function(){return a.apply(this,arguments)&&o.apply(this,arguments)}:a:o}var Gi={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function zr(a){return typeof a!="string"||/\./.test(a)?function(o){return o}:function(o){return o[a]===void 0&&a in o&&delete(o=B(o))[a],o}}function Ji(){throw ce.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function We(a,o){try{var c=Yi(a),d=Yi(o);if(c!==d)return c==="Array"?1:d==="Array"?-1:c==="binary"?1:d==="binary"?-1:c==="string"?1:d==="string"?-1:c==="Date"?1:d!=="Date"?NaN:-1;switch(c){case"number":case"Date":case"string":return o<a?1:a<o?-1:0;case"binary":return function(p,m){for(var b=p.length,k=m.length,A=b<k?b:k,C=0;C<A;++C)if(p[C]!==m[C])return p[C]<m[C]?-1:1;return b===k?0:b<k?-1:1}(Qi(a),Qi(o));case"Array":return function(p,m){for(var b=p.length,k=m.length,A=b<k?b:k,C=0;C<A;++C){var N=We(p[C],m[C]);if(N!==0)return N}return b===k?0:b<k?-1:1}(a,o)}}catch{}return NaN}function Yi(a){var o=typeof a;return o!="object"?o:ArrayBuffer.isView(a)?"binary":(a=ee(a),a==="ArrayBuffer"?"binary":a)}function Qi(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}function Fr(a,o,c){var d=a.schema.yProps;return d?(o&&0<c.numFailures&&(o=o.filter(function(p,m){return!c.failures[m]})),Promise.all(d.map(function(p){return p=p.updatesTable,o?a.db.table(p).where("k").anyOf(o).delete():a.db.table(p).clear()})).then(function(){return c})):c}var vr=(Xi.prototype.execute=function(a){var o=this["@@propmod"];if(o.add!==void 0){var c=o.add;if(u(c))return i(i([],u(a)?a:[],!0),c).sort();if(typeof c=="number")return(Number(a)||0)+c;if(typeof c=="bigint")try{return BigInt(a)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(o.remove!==void 0){var d=o.remove;if(u(d))return u(a)?a.filter(function(p){return!d.includes(p)}).sort():[];if(typeof d=="number")return Number(a)-d;if(typeof d=="bigint")try{return BigInt(a)-d}catch{return BigInt(0)-d}throw new TypeError("Invalid subtrahend ".concat(d))}return c=(c=o.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof a=="string"&&a.startsWith(c)?o.replacePrefix[1]+a.substring(c.length):a},Xi);function Xi(a){this["@@propmod"]=a}function Zi(a,o){for(var c=l(o),d=c.length,p=!1,m=0;m<d;++m){var b=c[m],k=o[b],A=R(a,b);k instanceof vr?(M(a,b,k.execute(A)),p=!0):A!==k&&(M(a,b,k),p=!0)}return p}var es=(tt.prototype._trans=function(a,o,c){var d=this._tx||ve.trans,p=this.name,m=Je&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function b(C,N,S){if(!S.schema[p])throw new ce.NotFound("Table "+p+" not part of transaction");return o(S.idbtrans,S)}var k=K();try{var A=d&&d.db._novip===this.db._novip?d===ve.trans?d._promise(a,b,c):Fe(function(){return d._promise(a,b,c)},{trans:d,transless:ve.transless||ve}):function C(N,S,I,$){if(N.idbdb&&(N._state.openComplete||ve.letThrough||N._vip)){var x=N._createTransaction(S,I,N._dbSchema);try{x.create(),N._state.PR1398_maxLoop=3}catch(O){return O.name===Re.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return C(N,S,I,$)})):pt(O)}return x._promise(S,function(O,P){return Fe(function(){return ve.trans=x,$(O,P,x)})}).then(function(O){if(S==="readwrite")try{x.idbtrans.commit()}catch{}return S==="readonly"?O:x._completion.then(function(){return O})})}if(N._state.openComplete)return pt(new ce.DatabaseClosed(N._state.dbOpenError));if(!N._state.isBeingOpened){if(!N._state.autoOpen)return pt(new ce.DatabaseClosed);N.open().catch(qe)}return N._state.dbReadyPromise.then(function(){return C(N,S,I,$)})}(this.db,a,[this.name],b);return m&&(A._consoleTask=m,A=A.catch(function(C){return console.trace(C),pt(C)})),A}finally{k&&fe()}},tt.prototype.get=function(a,o){var c=this;return a&&a.constructor===Object?this.where(a).first(o):a==null?pt(new ce.Type("Invalid argument to Table.get()")):this._trans("readonly",function(d){return c.core.get({trans:d,key:a}).then(function(p){return c.hook.reading.fire(p)})}).then(o)},tt.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(u(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var o=l(a);if(o.length===1)return this.where(o[0]).equals(a[o[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(k){if(k.compound&&o.every(function(C){return 0<=k.keyPath.indexOf(C)})){for(var A=0;A<o.length;++A)if(o.indexOf(k.keyPath[A])===-1)return!1;return!0}return!1}).sort(function(k,A){return k.keyPath.length-A.keyPath.length})[0];if(c&&this.db._maxKey!==jn){var m=c.keyPath.slice(0,o.length);return this.where(m).equals(m.map(function(A){return a[A]}))}!c&&Je&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(o.join("+"),"]"));var d=this.schema.idxByName;function p(k,A){return We(k,A)===0}var b=o.reduce(function(S,A){var C=S[0],N=S[1],S=d[A],I=a[A];return[C||S,C||!S?Dn(N,S&&S.multi?function($){return $=R($,A),u($)&&$.some(function(x){return p(I,x)})}:function($){return p(I,R($,A))}):N]},[null,null]),m=b[0],b=b[1];return m?this.where(m.name).equals(a[m.keyPath]).filter(b):c?this.filter(b):this.where(o).equals("")},tt.prototype.filter=function(a){return this.toCollection().and(a)},tt.prototype.count=function(a){return this.toCollection().count(a)},tt.prototype.offset=function(a){return this.toCollection().offset(a)},tt.prototype.limit=function(a){return this.toCollection().limit(a)},tt.prototype.each=function(a){return this.toCollection().each(a)},tt.prototype.toArray=function(a){return this.toCollection().toArray(a)},tt.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},tt.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,u(a)?"[".concat(a.join("+"),"]"):a))},tt.prototype.reverse=function(){return this.toCollection().reverse()},tt.prototype.mapToClass=function(a){var o,c=this.db,d=this.name;function p(){return o!==null&&o.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof Ji&&(function(A,C){if(typeof C!="function"&&C!==null)throw new TypeError("Class extends value "+String(C)+" is not a constructor or null");function N(){this.constructor=A}t(A,C),A.prototype=C===null?Object.create(C):(N.prototype=C.prototype,new N)}(p,o=a),Object.defineProperty(p.prototype,"db",{get:function(){return c},enumerable:!1,configurable:!0}),p.prototype.table=function(){return d},a=p);for(var m=new Set,b=a.prototype;b;b=f(b))Object.getOwnPropertyNames(b).forEach(function(A){return m.add(A)});function k(A){if(!A)return A;var C,N=Object.create(a.prototype);for(C in A)if(!m.has(C))try{N[C]=A[C]}catch{}return N}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=k,this.hook("reading",k),a},tt.prototype.defineClass=function(){return this.mapToClass(function(a){h(this,a)})},tt.prototype.add=function(a,o){var c=this,d=this.schema.primKey,p=d.auto,m=d.keyPath,b=a;return m&&p&&(b=zr(m)(a)),this._trans("readwrite",function(k){return c.core.mutate({trans:k,type:"add",keys:o!=null?[o]:null,values:[b]})}).then(function(k){return k.numFailures?ae.reject(k.failures[0]):k.lastResult}).then(function(k){if(m)try{M(a,m,k)}catch{}return k})},tt.prototype.upsert=function(a,o){var c=this,d=this.schema.primKey.keyPath;return this._trans("readwrite",function(p){return c.core.get({trans:p,key:a}).then(function(m){var b=m??{};return Zi(b,o),d&&M(b,d,a),c.core.mutate({trans:p,type:"put",values:[b],keys:[a],upsert:!0,updates:{keys:[a],changeSpecs:[o]}}).then(function(k){return k.numFailures?ae.reject(k.failures[0]):!!m})})})},tt.prototype.update=function(a,o){return typeof a!="object"||u(a)?this.where(":id").equals(a).modify(o):(a=R(a,this.schema.primKey.keyPath),a===void 0?pt(new ce.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(o))},tt.prototype.put=function(a,o){var c=this,d=this.schema.primKey,p=d.auto,m=d.keyPath,b=a;return m&&p&&(b=zr(m)(a)),this._trans("readwrite",function(k){return c.core.mutate({trans:k,type:"put",values:[b],keys:o!=null?[o]:null})}).then(function(k){return k.numFailures?ae.reject(k.failures[0]):k.lastResult}).then(function(k){if(m)try{M(a,m,k)}catch{}return k})},tt.prototype.delete=function(a){var o=this;return this._trans("readwrite",function(c){return o.core.mutate({trans:c,type:"delete",keys:[a]}).then(function(d){return Fr(o,[a],d)}).then(function(d){return d.numFailures?ae.reject(d.failures[0]):void 0})})},tt.prototype.clear=function(){var a=this;return this._trans("readwrite",function(o){return a.core.mutate({trans:o,type:"deleteRange",range:Gi}).then(function(c){return Fr(a,null,c)})}).then(function(o){return o.numFailures?ae.reject(o.failures[0]):void 0})},tt.prototype.bulkGet=function(a){var o=this;return this._trans("readonly",function(c){return o.core.getMany({keys:a,trans:c}).then(function(d){return d.map(function(p){return o.hook.reading.fire(p)})})})},tt.prototype.bulkAdd=function(a,o,c){var d=this,p=Array.isArray(o)?o:void 0,m=(c=c||(p?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(b){var C=d.schema.primKey,k=C.auto,C=C.keyPath;if(C&&p)throw new ce.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(p&&p.length!==a.length)throw new ce.InvalidArgument("Arguments objects and keys must have the same length");var A=a.length,C=C&&k?a.map(zr(C)):a;return d.core.mutate({trans:b,type:"add",keys:p,values:C,wantResults:m}).then(function(x){var S=x.numFailures,I=x.results,$=x.lastResult,x=x.failures;if(S===0)return m?I:$;throw new Oe("".concat(d.name,".bulkAdd(): ").concat(S," of ").concat(A," operations failed"),x)})})},tt.prototype.bulkPut=function(a,o,c){var d=this,p=Array.isArray(o)?o:void 0,m=(c=c||(p?void 0:o))?c.allKeys:void 0;return this._trans("readwrite",function(b){var C=d.schema.primKey,k=C.auto,C=C.keyPath;if(C&&p)throw new ce.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(p&&p.length!==a.length)throw new ce.InvalidArgument("Arguments objects and keys must have the same length");var A=a.length,C=C&&k?a.map(zr(C)):a;return d.core.mutate({trans:b,type:"put",keys:p,values:C,wantResults:m}).then(function(x){var S=x.numFailures,I=x.results,$=x.lastResult,x=x.failures;if(S===0)return m?I:$;throw new Oe("".concat(d.name,".bulkPut(): ").concat(S," of ").concat(A," operations failed"),x)})})},tt.prototype.bulkUpdate=function(a){var o=this,c=this.core,d=a.map(function(b){return b.key}),p=a.map(function(b){return b.changes}),m=[];return this._trans("readwrite",function(b){return c.getMany({trans:b,keys:d,cache:"clone"}).then(function(k){var A=[],C=[];a.forEach(function(S,I){var $=S.key,x=S.changes,O=k[I];if(O){for(var P=0,q=Object.keys(x);P<q.length;P++){var D=q[P],W=x[D];if(D===o.schema.primKey.keyPath){if(We(W,$)!==0)throw new ce.Constraint("Cannot update primary key in bulkUpdate()")}else M(O,D,W)}m.push(I),A.push($),C.push(O)}});var N=A.length;return c.mutate({trans:b,type:"put",keys:A,values:C,updates:{keys:d,changeSpecs:p}}).then(function(S){var I=S.numFailures,$=S.failures;if(I===0)return N;for(var x=0,O=Object.keys($);x<O.length;x++){var P,q=O[x],D=m[Number(q)];D!=null&&(P=$[q],delete $[q],$[D]=P)}throw new Oe("".concat(o.name,".bulkUpdate(): ").concat(I," of ").concat(N," operations failed"),$)})})})},tt.prototype.bulkDelete=function(a){var o=this,c=a.length;return this._trans("readwrite",function(d){return o.core.mutate({trans:d,type:"delete",keys:a}).then(function(p){return Fr(o,a,p)})}).then(function(b){var p=b.numFailures,m=b.lastResult,b=b.failures;if(p===0)return m;throw new Oe("".concat(o.name,".bulkDelete(): ").concat(p," of ").concat(c," operations failed"),b)})},tt);function tt(){}function br(a){function o(b,k){if(k){for(var A=arguments.length,C=new Array(A-1);--A;)C[A-1]=arguments[A];return c[b].subscribe.apply(null,C),a}if(typeof b=="string")return c[b]}var c={};o.addEventType=m;for(var d=1,p=arguments.length;d<p;++d)m(arguments[d]);return o;function m(b,k,A){if(typeof b!="object"){var C;k=k||it;var N={subscribers:[],fire:A=A||qe,subscribe:function(S){N.subscribers.indexOf(S)===-1&&(N.subscribers.push(S),N.fire=k(N.fire,S))},unsubscribe:function(S){N.subscribers=N.subscribers.filter(function(I){return I!==S}),N.fire=N.subscribers.reduce(k,A)}};return c[b]=o[b]=N}l(C=b).forEach(function(S){var I=C[S];if(u(I))m(S,C[S][0],C[S][1]);else{if(I!=="asap")throw new ce.InvalidArgument("Invalid event config");var $=m(S,At,function(){for(var x=arguments.length,O=new Array(x);x--;)O[x]=arguments[x];$.subscribers.forEach(function(P){U(function(){P.apply(null,O)})})})}})}}function yr(a,o){return E(o).from({prototype:a}),o}function Yn(a,o){return!(a.filter||a.algorithm||a.or)&&(o?a.justLimit:!a.replayFilter)}function Pa(a,o){a.filter=Dn(a.filter,o)}function Ia(a,o,c){var d=a.replayFilter;a.replayFilter=d?function(){return Dn(d(),o())}:o,a.justLimit=c&&!d}function Kr(a,o){if(a.isPrimKey)return o.primaryKey;var c=o.getIndexByKeyPath(a.index);if(!c)throw new ce.Schema("KeyPath "+a.index+" on object store "+o.name+" is not indexed");return c}function ts(a,o,c){var d=Kr(a,o.schema);return o.openCursor({trans:c,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:d,range:a.range}})}function Hr(a,o,c,d){var p=a.replayFilter?Dn(a.filter,a.replayFilter()):a.filter;if(a.or){var m={},b=function(k,A,C){var N,S;p&&!p(A,C,function(I){return A.stop(I)},function(I){return A.fail(I)})||((S=""+(N=A.primaryKey))=="[object ArrayBuffer]"&&(S=""+new Uint8Array(N)),y(m,S)||(m[S]=!0,o(k,A,C)))};return Promise.all([a.or._iterate(b,c),ns(ts(a,d,c),a.algorithm,b,!a.keysOnly&&a.valueMapper)])}return ns(ts(a,d,c),Dn(a.algorithm,p),o,!a.keysOnly&&a.valueMapper)}function ns(a,o,c,d){var p=Ee(d?function(m,b,k){return c(d(m),b,k)}:c);return a.then(function(m){if(m)return m.start(function(){var b=function(){return m.continue()};o&&!o(m,function(k){return b=k},function(k){m.stop(k),b=qe},function(k){m.fail(k),b=qe})||p(m.value,m,function(k){return b=k}),b()})})}var nl=(Ge.prototype._read=function(a,o){var c=this._ctx;return c.error?c.table._trans(null,pt.bind(null,c.error)):c.table._trans("readonly",a).then(o)},Ge.prototype._write=function(a){var o=this._ctx;return o.error?o.table._trans(null,pt.bind(null,o.error)):o.table._trans("readwrite",a,"locked")},Ge.prototype._addAlgorithm=function(a){var o=this._ctx;o.algorithm=Dn(o.algorithm,a)},Ge.prototype._iterate=function(a,o){return Hr(this._ctx,a,o,this._ctx.table.core)},Ge.prototype.clone=function(a){var o=Object.create(this.constructor.prototype),c=Object.create(this._ctx);return a&&h(c,a),o._ctx=c,o},Ge.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ge.prototype.each=function(a){var o=this._ctx;return this._read(function(c){return Hr(o,a,c,o.table.core)})},Ge.prototype.count=function(a){var o=this;return this._read(function(c){var d=o._ctx,p=d.table.core;if(Yn(d,!0))return p.count({trans:c,query:{index:Kr(d,p.schema),range:d.range}}).then(function(b){return Math.min(b,d.limit)});var m=0;return Hr(d,function(){return++m,!1},c,p).then(function(){return m})}).then(a)},Ge.prototype.sortBy=function(a,o){var c=a.split(".").reverse(),d=c[0],p=c.length-1;function m(A,C){return C?m(A[c[C]],C-1):A[d]}var b=this._ctx.dir==="next"?1:-1;function k(A,C){return We(m(A,p),m(C,p))*b}return this.toArray(function(A){return A.sort(k)}).then(o)},Ge.prototype.toArray=function(a){var o=this;return this._read(function(c){var d=o._ctx;if(d.dir==="next"&&Yn(d,!0)&&0<d.limit){var p=d.valueMapper,m=Kr(d,d.table.core.schema);return d.table.core.query({trans:c,limit:d.limit,values:!0,query:{index:m,range:d.range}}).then(function(k){return k=k.result,p?k.map(p):k})}var b=[];return Hr(d,function(k){return b.push(k)},c,d.table.core).then(function(){return b})},a)},Ge.prototype.offset=function(a){var o=this._ctx;return a<=0||(o.offset+=a,Yn(o)?Ia(o,function(){var c=a;return function(d,p){return c===0||(c===1?--c:p(function(){d.advance(c),c=0}),!1)}}):Ia(o,function(){var c=a;return function(){return--c<0}})),this},Ge.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),Ia(this._ctx,function(){var o=a;return function(c,d,p){return--o<=0&&d(p),0<=o}},!0),this},Ge.prototype.until=function(a,o){return Pa(this._ctx,function(c,d,p){return!a(c.value)||(d(p),o)}),this},Ge.prototype.first=function(a){return this.limit(1).toArray(function(o){return o[0]}).then(a)},Ge.prototype.last=function(a){return this.reverse().first(a)},Ge.prototype.filter=function(a){var o;return Pa(this._ctx,function(c){return a(c.value)}),(o=this._ctx).isMatch=Dn(o.isMatch,a),this},Ge.prototype.and=function(a){return this.filter(a)},Ge.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},Ge.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ge.prototype.desc=function(){return this.reverse()},Ge.prototype.eachKey=function(a){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,d){a(d.key,d)})},Ge.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},Ge.prototype.eachPrimaryKey=function(a){var o=this._ctx;return o.keysOnly=!o.isMatch,this.each(function(c,d){a(d.primaryKey,d)})},Ge.prototype.keys=function(a){var o=this._ctx;o.keysOnly=!o.isMatch;var c=[];return this.each(function(d,p){c.push(p.key)}).then(function(){return c}).then(a)},Ge.prototype.primaryKeys=function(a){var o=this._ctx;if(o.dir==="next"&&Yn(o,!0)&&0<o.limit)return this._read(function(d){var p=Kr(o,o.table.core.schema);return o.table.core.query({trans:d,values:!1,limit:o.limit,query:{index:p,range:o.range}})}).then(function(d){return d.result}).then(a);o.keysOnly=!o.isMatch;var c=[];return this.each(function(d,p){c.push(p.primaryKey)}).then(function(){return c}).then(a)},Ge.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},Ge.prototype.firstKey=function(a){return this.limit(1).keys(function(o){return o[0]}).then(a)},Ge.prototype.lastKey=function(a){return this.reverse().firstKey(a)},Ge.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var o={};return Pa(this._ctx,function(p){var d=p.primaryKey.toString(),p=y(o,d);return o[d]=!0,!p}),this},Ge.prototype.modify=function(a){var o=this,c=this._ctx;return this._write(function(d){var p=typeof a=="function"?a:function(O){return Zi(O,a)},m=c.table.core,C=m.schema.primaryKey,b=C.outbound,k=C.extractKey,A=200,C=o.db._options.modifyChunkSize;C&&(A=typeof C=="object"?C[m.name]||C["*"]||200:C);function N(O,D){var q=D.failures,D=D.numFailures;I+=O-D;for(var W=0,J=l(q);W<J.length;W++){var ne=J[W];S.push(q[ne])}}var S=[],I=0,$=[],x=a===rs;return o.clone().primaryKeys().then(function(O){function P(D){var W=Math.min(A,O.length-D),J=O.slice(D,D+W);return(x?Promise.resolve([]):m.getMany({trans:d,keys:J,cache:"immutable"})).then(function(ne){var se=[],te=[],re=b?[]:null,oe=x?J:[];if(!x)for(var ie=0;ie<W;++ie){var _e=ne[ie],Le={value:B(_e),primKey:O[D+ie]};p.call(Le,Le.value,Le)!==!1&&(Le.value==null?oe.push(O[D+ie]):b||We(k(_e),k(Le.value))===0?(te.push(Le.value),b&&re.push(O[D+ie])):(oe.push(O[D+ie]),se.push(Le.value)))}return Promise.resolve(0<se.length&&m.mutate({trans:d,type:"add",values:se}).then(function(je){for(var Ue in je.failures)oe.splice(parseInt(Ue),1);N(se.length,je)})).then(function(){return(0<te.length||q&&typeof a=="object")&&m.mutate({trans:d,type:"put",keys:re,values:te,criteria:q,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<D}).then(function(je){return N(te.length,je)})}).then(function(){return(0<oe.length||q&&x)&&m.mutate({trans:d,type:"delete",keys:oe,criteria:q,isAdditionalChunk:0<D}).then(function(je){return Fr(c.table,oe,je)}).then(function(je){return N(oe.length,je)})}).then(function(){return O.length>D+W&&P(D+A)})})}var q=Yn(c)&&c.limit===1/0&&(typeof a!="function"||x)&&{index:c.index,range:c.range};return P(0).then(function(){if(0<S.length)throw new we("Error modifying one or more objects",S,I,$);return O.length})})})},Ge.prototype.delete=function(){var a=this._ctx,o=a.range;return!Yn(a)||a.table.schema.yProps||!a.isPrimKey&&o.type!==3?this.modify(rs):this._write(function(c){var d=a.table.core.schema.primaryKey,p=o;return a.table.core.count({trans:c,query:{index:d,range:p}}).then(function(m){return a.table.core.mutate({trans:c,type:"deleteRange",range:p}).then(function(A){var k=A.failures,A=A.numFailures;if(A)throw new we("Could not delete some values",Object.keys(k).map(function(C){return k[C]}),m-A);return m-A})})})},Ge);function Ge(){}var rs=function(a,o){return o.value=null};function rl(a,o){return a<o?-1:a===o?0:1}function al(a,o){return o<a?-1:a===o?0:1}function Zt(a,o,c){return a=a instanceof is?new a.Collection(a):a,a._ctx.error=new(c||TypeError)(o),a}function Qn(a){return new a.Collection(a,function(){return as("")}).limit(0)}function Wr(a,o,c,d){var p,m,b,k,A,C,N,S=c.length;if(!c.every(function(x){return typeof x=="string"}))return Zt(a,Vi);function I(x){p=x==="next"?function(P){return P.toUpperCase()}:function(P){return P.toLowerCase()},m=x==="next"?function(P){return P.toLowerCase()}:function(P){return P.toUpperCase()},b=x==="next"?rl:al;var O=c.map(function(P){return{lower:m(P),upper:p(P)}}).sort(function(P,q){return b(P.lower,q.lower)});k=O.map(function(P){return P.upper}),A=O.map(function(P){return P.lower}),N=(C=x)==="next"?"":d}I("next"),a=new a.Collection(a,function(){return Tn(k[0],A[S-1]+d)}),a._ondirectionchange=function(x){I(x)};var $=0;return a._addAlgorithm(function(x,O,P){var q=x.key;if(typeof q!="string")return!1;var D=m(q);if(o(D,A,$))return!0;for(var W=null,J=$;J<S;++J){var ne=function(se,te,re,oe,ie,_e){for(var Le=Math.min(se.length,oe.length),je=-1,Ue=0;Ue<Le;++Ue){var en=te[Ue];if(en!==oe[Ue])return ie(se[Ue],re[Ue])<0?se.substr(0,Ue)+re[Ue]+re.substr(Ue+1):ie(se[Ue],oe[Ue])<0?se.substr(0,Ue)+oe[Ue]+re.substr(Ue+1):0<=je?se.substr(0,je)+te[je]+re.substr(je+1):null;ie(se[Ue],en)<0&&(je=Ue)}return Le<oe.length&&_e==="next"?se+re.substr(se.length):Le<se.length&&_e==="prev"?se.substr(0,re.length):je<0?null:se.substr(0,je)+oe[je]+re.substr(je+1)}(q,D,k[J],A[J],b,C);ne===null&&W===null?$=J+1:(W===null||0<b(W,ne))&&(W=ne)}return O(W!==null?function(){x.continue(W+N)}:P),!1}),a}function Tn(a,o,c,d){return{type:2,lower:a,upper:o,lowerOpen:c,upperOpen:d}}function as(a){return{type:1,lower:a,upper:a}}var is=(Object.defineProperty(Ot.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ot.prototype.between=function(a,o,c,d){c=c!==!1,d=d===!0;try{return 0<this._cmp(a,o)||this._cmp(a,o)===0&&(c||d)&&(!c||!d)?Qn(this):new this.Collection(this,function(){return Tn(a,o,!c,!d)})}catch{return Zt(this,wn)}},Ot.prototype.equals=function(a){return a==null?Zt(this,wn):new this.Collection(this,function(){return as(a)})},Ot.prototype.above=function(a){return a==null?Zt(this,wn):new this.Collection(this,function(){return Tn(a,void 0,!0)})},Ot.prototype.aboveOrEqual=function(a){return a==null?Zt(this,wn):new this.Collection(this,function(){return Tn(a,void 0,!1)})},Ot.prototype.below=function(a){return a==null?Zt(this,wn):new this.Collection(this,function(){return Tn(void 0,a,!1,!0)})},Ot.prototype.belowOrEqual=function(a){return a==null?Zt(this,wn):new this.Collection(this,function(){return Tn(void 0,a)})},Ot.prototype.startsWith=function(a){return typeof a!="string"?Zt(this,Vi):this.between(a,a+jn,!0,!0)},Ot.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):Wr(this,function(o,c){return o.indexOf(c[0])===0},[a],jn)},Ot.prototype.equalsIgnoreCase=function(a){return Wr(this,function(o,c){return o===c[0]},[a],"")},Ot.prototype.anyOfIgnoreCase=function(){var a=ye.apply(he,arguments);return a.length===0?Qn(this):Wr(this,function(o,c){return c.indexOf(o)!==-1},a,"")},Ot.prototype.startsWithAnyOfIgnoreCase=function(){var a=ye.apply(he,arguments);return a.length===0?Qn(this):Wr(this,function(o,c){return c.some(function(d){return o.indexOf(d)===0})},a,jn)},Ot.prototype.anyOf=function(){var a=this,o=ye.apply(he,arguments),c=this._cmp;try{o.sort(c)}catch{return Zt(this,wn)}if(o.length===0)return Qn(this);var d=new this.Collection(this,function(){return Tn(o[0],o[o.length-1])});d._ondirectionchange=function(m){c=m==="next"?a._ascending:a._descending,o.sort(c)};var p=0;return d._addAlgorithm(function(m,b,k){for(var A=m.key;0<c(A,o[p]);)if(++p===o.length)return b(k),!1;return c(A,o[p])===0||(b(function(){m.continue(o[p])}),!1)}),d},Ot.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ot.prototype.noneOf=function(){var a=ye.apply(he,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return Zt(this,wn)}var o=a.reduce(function(c,d){return c?c.concat([[c[c.length-1][1],d]]):[[-1/0,d]]},null);return o.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(o,{includeLowers:!1,includeUppers:!1})},Ot.prototype.inAnyRange=function(q,o){var c=this,d=this._cmp,p=this._ascending,m=this._descending,b=this._min,k=this._max;if(q.length===0)return Qn(this);if(!q.every(function(D){return D[0]!==void 0&&D[1]!==void 0&&p(D[0],D[1])<=0}))return Zt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ce.InvalidArgument);var A=!o||o.includeLowers!==!1,C=o&&o.includeUppers===!0,N,S=p;function I(D,W){return S(D[0],W[0])}try{(N=q.reduce(function(D,W){for(var J=0,ne=D.length;J<ne;++J){var se=D[J];if(d(W[0],se[1])<0&&0<d(W[1],se[0])){se[0]=b(se[0],W[0]),se[1]=k(se[1],W[1]);break}}return J===ne&&D.push(W),D},[])).sort(I)}catch{return Zt(this,wn)}var $=0,x=C?function(D){return 0<p(D,N[$][1])}:function(D){return 0<=p(D,N[$][1])},O=A?function(D){return 0<m(D,N[$][0])}:function(D){return 0<=m(D,N[$][0])},P=x,q=new this.Collection(this,function(){return Tn(N[0][0],N[N.length-1][1],!A,!C)});return q._ondirectionchange=function(D){S=D==="next"?(P=x,p):(P=O,m),N.sort(I)},q._addAlgorithm(function(D,W,J){for(var ne,se=D.key;P(se);)if(++$===N.length)return W(J),!1;return!x(ne=se)&&!O(ne)||(c._cmp(se,N[$][1])===0||c._cmp(se,N[$][0])===0||W(function(){S===p?D.continue(N[$][0]):D.continue(N[$][1])}),!1)}),q},Ot.prototype.startsWithAnyOf=function(){var a=ye.apply(he,arguments);return a.every(function(o){return typeof o=="string"})?a.length===0?Qn(this):this.inAnyRange(a.map(function(o){return[o,o+jn]})):Zt(this,"startsWithAnyOf() only works with strings")},Ot);function Ot(){}function gn(a){return Ee(function(o){return _r(o),a(o.target.error),!1})}function _r(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var wr="storagemutated",La="x-storagemutated-1",xn=br(null,wr),il=(vn.prototype._lock=function(){return H(!ve.global),++this._reculock,this._reculock!==1||ve.global||(ve.lockOwnerFor=this),this},vn.prototype._unlock=function(){if(H(!ve.global),--this._reculock==0)for(ve.global||(ve.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{_n(a[1],a[0])}catch{}}return this},vn.prototype._locked=function(){return this._reculock&&ve.lockOwnerFor!==this},vn.prototype.create=function(a){var o=this;if(!this.mode)return this;var c=this.db.idbdb,d=this.db._state.dbOpenError;if(H(!this.idbtrans),!a&&!c)switch(d&&d.name){case"DatabaseClosedError":throw new ce.DatabaseClosed(d);case"MissingAPIError":throw new ce.MissingAPI(d.message,d);default:throw new ce.OpenFailed(d)}if(!this.active)throw new ce.TransactionInactive;return H(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||c).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ee(function(p){_r(p),o._reject(a.error)}),a.onabort=Ee(function(p){_r(p),o.active&&o._reject(new ce.Abort(a.error)),o.active=!1,o.on("abort").fire(p)}),a.oncomplete=Ee(function(){o.active=!1,o._resolve(),"mutatedParts"in a&&xn.storagemutated.fire(a.mutatedParts)}),this},vn.prototype._promise=function(a,o,c){var d=this;if(a==="readwrite"&&this.mode!=="readwrite")return pt(new ce.ReadOnly("Transaction is readonly"));if(!this.active)return pt(new ce.TransactionInactive);if(this._locked())return new ae(function(m,b){d._blockedFuncs.push([function(){d._promise(a,o,c).then(m,b)},ve])});if(c)return Fe(function(){var m=new ae(function(b,k){d._lock();var A=o(b,k,d);A&&A.then&&A.then(b,k)});return m.finally(function(){return d._unlock()}),m._lib=!0,m});var p=new ae(function(m,b){var k=o(m,b,d);k&&k.then&&k.then(m,b)});return p._lib=!0,p},vn.prototype._root=function(){return this.parent?this.parent._root():this},vn.prototype.waitFor=function(a){var o,c=this._root(),d=ae.resolve(a);c._waitingFor?c._waitingFor=c._waitingFor.then(function(){return d}):(c._waitingFor=d,c._waitingQueue=[],o=c.idbtrans.objectStore(c.storeNames[0]),function m(){for(++c._spinCount;c._waitingQueue.length;)c._waitingQueue.shift()();c._waitingFor&&(o.get(-1/0).onsuccess=m)}());var p=c._waitingFor;return new ae(function(m,b){d.then(function(k){return c._waitingQueue.push(Ee(m.bind(null,k)))},function(k){return c._waitingQueue.push(Ee(b.bind(null,k)))}).finally(function(){c._waitingFor===p&&(c._waitingFor=null)})})},vn.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ce.Abort))},vn.prototype.table=function(a){var o=this._memoizedTables||(this._memoizedTables={});if(y(o,a))return o[a];var c=this.schema[a];if(!c)throw new ce.NotFound("Table "+a+" not part of transaction");return c=new this.db.Table(a,c,this),c.core=this.db.core.table(a),o[a]=c},vn);function vn(){}function qa(a,o,c,d,p,m,b,k){return{name:a,keyPath:o,unique:c,multi:d,auto:p,compound:m,src:(c&&!b?"&":"")+(d?"*":"")+(p?"++":"")+ss(o),type:k}}function ss(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function ja(a,o,c){return{name:a,primKey:o,indexes:c,mappedClass:null,idxByName:(d=function(p){return[p.name,p]},c.reduce(function(p,m,b){return b=d(m,b),b&&(p[b[0]]=b[1]),p},{}))};var d}var kr=function(a){try{return a.only([[]]),kr=function(){return[[]]},[[]]}catch{return kr=function(){return jn},jn}};function Da(a){return a==null?function(){}:typeof a=="string"?(o=a).split(".").length===1?function(c){return c[o]}:function(c){return R(c,o)}:function(c){return R(c,a)};var o}function os(a){return[].slice.call(a)}var sl=0;function Sr(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function ol(a,o,A){function d(P){if(P.type===3)return null;if(P.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var $=P.lower,x=P.upper,O=P.lowerOpen,P=P.upperOpen;return $===void 0?x===void 0?null:o.upperBound(x,!!P):x===void 0?o.lowerBound($,!!O):o.bound($,x,!!O,!!P)}function p(I){var $,x=I.name;return{name:x,schema:I,mutate:function(O){var P=O.trans,q=O.type,D=O.keys,W=O.values,J=O.range;return new Promise(function(ne,se){ne=Ee(ne);var te=P.objectStore(x),re=te.keyPath==null,oe=q==="put"||q==="add";if(!oe&&q!=="delete"&&q!=="deleteRange")throw new Error("Invalid operation type: "+q);var ie,_e=(D||W||{length:1}).length;if(D&&W&&D.length!==W.length)throw new Error("Given keys array must have same length as given values array.");if(_e===0)return ne({numFailures:0,failures:{},results:[],lastResult:void 0});function Le(Ft){++en,_r(Ft)}var je=[],Ue=[],en=0;if(q==="deleteRange"){if(J.type===4)return ne({numFailures:en,failures:Ue,results:[],lastResult:void 0});J.type===3?je.push(ie=te.clear()):je.push(ie=te.delete(d(J)))}else{var re=oe?re?[W,D]:[W,null]:[D,null],Ie=re[0],Mt=re[1];if(oe)for(var Bt=0;Bt<_e;++Bt)je.push(ie=Mt&&Mt[Bt]!==void 0?te[q](Ie[Bt],Mt[Bt]):te[q](Ie[Bt])),ie.onerror=Le;else for(Bt=0;Bt<_e;++Bt)je.push(ie=te[q](Ie[Bt])),ie.onerror=Le}function aa(Ft){Ft=Ft.target.result,je.forEach(function(Un,ni){return Un.error!=null&&(Ue[ni]=Un.error)}),ne({numFailures:en,failures:Ue,results:q==="delete"?D:je.map(function(Un){return Un.result}),lastResult:Ft})}ie.onerror=function(Ft){Le(Ft),aa(Ft)},ie.onsuccess=aa})},getMany:function(O){var P=O.trans,q=O.keys;return new Promise(function(D,W){D=Ee(D);for(var J,ne=P.objectStore(x),se=q.length,te=new Array(se),re=0,oe=0,ie=function(je){je=je.target,te[je._pos]=je.result,++oe===re&&D(te)},_e=gn(W),Le=0;Le<se;++Le)q[Le]!=null&&((J=ne.get(q[Le]))._pos=Le,J.onsuccess=ie,J.onerror=_e,++re);re===0&&D(te)})},get:function(O){var P=O.trans,q=O.key;return new Promise(function(D,W){D=Ee(D);var J=P.objectStore(x).get(q);J.onsuccess=function(ne){return D(ne.target.result)},J.onerror=gn(W)})},query:($=C,function(O){return new Promise(function(P,q){P=Ee(P);var D,W,J,re=O.trans,ne=O.values,se=O.limit,ie=O.query,te=se===1/0?void 0:se,oe=ie.index,ie=ie.range,re=re.objectStore(x),oe=oe.isPrimaryKey?re:re.index(oe.name),ie=d(ie);if(se===0)return P({result:[]});$?((te=ne?oe.getAll(ie,te):oe.getAllKeys(ie,te)).onsuccess=function(_e){return P({result:_e.target.result})},te.onerror=gn(q)):(D=0,W=!ne&&"openKeyCursor"in oe?oe.openKeyCursor(ie):oe.openCursor(ie),J=[],W.onsuccess=function(_e){var Le=W.result;return Le?(J.push(ne?Le.value:Le.primaryKey),++D===se?P({result:J}):void Le.continue()):P({result:J})},W.onerror=gn(q))})}),openCursor:function(O){var P=O.trans,q=O.values,D=O.query,W=O.reverse,J=O.unique;return new Promise(function(ne,se){ne=Ee(ne);var oe=D.index,te=D.range,re=P.objectStore(x),re=oe.isPrimaryKey?re:re.index(oe.name),oe=W?J?"prevunique":"prev":J?"nextunique":"next",ie=!q&&"openKeyCursor"in re?re.openKeyCursor(d(te),oe):re.openCursor(d(te),oe);ie.onerror=gn(se),ie.onsuccess=Ee(function(_e){var Le,je,Ue,en,Ie=ie.result;Ie?(Ie.___id=++sl,Ie.done=!1,Le=Ie.continue.bind(Ie),je=(je=Ie.continuePrimaryKey)&&je.bind(Ie),Ue=Ie.advance.bind(Ie),en=function(){throw new Error("Cursor not stopped")},Ie.trans=P,Ie.stop=Ie.continue=Ie.continuePrimaryKey=Ie.advance=function(){throw new Error("Cursor not started")},Ie.fail=Ee(se),Ie.next=function(){var Mt=this,Bt=1;return this.start(function(){return Bt--?Mt.continue():Mt.stop()}).then(function(){return Mt})},Ie.start=function(Mt){function Bt(){if(ie.result)try{Mt()}catch(Ft){Ie.fail(Ft)}else Ie.done=!0,Ie.start=function(){throw new Error("Cursor behind last entry")},Ie.stop()}var aa=new Promise(function(Ft,Un){Ft=Ee(Ft),ie.onerror=gn(Un),Ie.fail=Un,Ie.stop=function(ni){Ie.stop=Ie.continue=Ie.continuePrimaryKey=Ie.advance=en,Ft(ni)}});return ie.onsuccess=Ee(function(Ft){ie.onsuccess=Bt,Bt()}),Ie.continue=Le,Ie.continuePrimaryKey=je,Ie.advance=Ue,Bt(),aa},ne(Ie)):ne(null)},se)})},count:function(O){var P=O.query,q=O.trans,D=P.index,W=P.range;return new Promise(function(J,ne){var se=q.objectStore(x),te=D.isPrimaryKey?se:se.index(D.name),se=d(W),te=se?te.count(se):te.count();te.onsuccess=Ee(function(re){return J(re.target.result)}),te.onerror=gn(ne)})}}}var m,b,k,N=(b=A,k=os((m=a).objectStoreNames),{schema:{name:m.name,tables:k.map(function(I){return b.objectStore(I)}).map(function(I){var $=I.keyPath,P=I.autoIncrement,x=u($),O={},P={name:I.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:$==null,compound:x,keyPath:$,autoIncrement:P,unique:!0,extractKey:Da($)},indexes:os(I.indexNames).map(function(q){return I.index(q)}).map(function(J){var D=J.name,W=J.unique,ne=J.multiEntry,J=J.keyPath,ne={name:D,compound:u(J),keyPath:J,unique:W,multiEntry:ne,extractKey:Da(J)};return O[Sr(J)]=ne}),getIndexByKeyPath:function(q){return O[Sr(q)]}};return O[":id"]=P.primaryKey,$!=null&&(O[Sr($)]=P.primaryKey),P})},hasGetAll:0<k.length&&"getAll"in b.objectStore(k[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),A=N.schema,C=N.hasGetAll,N=A.tables.map(p),S={};return N.forEach(function(I){return S[I.name]=I}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(I){if(!S[I])throw new Error("Table '".concat(I,"' not found"));return S[I]},MIN_KEY:-1/0,MAX_KEY:kr(o),schema:A}}function ll(a,o,c,d){var p=c.IDBKeyRange;return c.indexedDB,{dbcore:(d=ol(o,p,d),a.dbcore.reduce(function(m,b){return b=b.create,r(r({},m),b(m))},d))}}function Vr(a,d){var c=d.db,d=ll(a._middlewares,c,a._deps,d);a.core=d.dbcore,a.tables.forEach(function(p){var m=p.name;a.core.schema.tables.some(function(b){return b.name===m})&&(p.core=a.core.table(m),a[m]instanceof a.Table&&(a[m].core=p.core))})}function Gr(a,o,c,d){c.forEach(function(p){var m=d[p];o.forEach(function(b){var k=function A(C,N){return j(C,N)||(C=f(C))&&A(C,N)}(b,p);(!k||"value"in k&&k.value===void 0)&&(b===a.Transaction.prototype||b instanceof a.Transaction?v(b,p,{get:function(){return this.table(p)},set:function(A){w(this,p,{value:A,writable:!0,configurable:!0,enumerable:!0})}}):b[p]=new a.Table(p,m))})})}function Ma(a,o){o.forEach(function(c){for(var d in c)c[d]instanceof a.Table&&delete c[d]})}function cl(a,o){return a._cfg.version-o._cfg.version}function ul(a,o,c,d){var p=a._dbSchema;c.objectStoreNames.contains("$meta")&&!p.$meta&&(p.$meta=ja("$meta",cs("")[0],[]),a._storeNames.push("$meta"));var m=a._createTransaction("readwrite",a._storeNames,p);m.create(c),m._completion.catch(d);var b=m._reject.bind(m),k=ve.transless||ve;Fe(function(){return ve.trans=m,ve.transless=k,o!==0?(Vr(a,c),C=o,((A=m).storeNames.includes("$meta")?A.table("$meta").get("version").then(function(N){return N??C}):ae.resolve(C)).then(function(N){return I=N,$=m,x=c,O=[],N=(S=a)._versions,P=S._dbSchema=Yr(0,S.idbdb,x),(N=N.filter(function(q){return q._cfg.version>=I})).length!==0?(N.forEach(function(q){O.push(function(){var D=P,W=q._cfg.dbschema;Qr(S,D,x),Qr(S,W,x),P=S._dbSchema=W;var J=Ba(D,W);J.add.forEach(function(oe){Ua(x,oe[0],oe[1].primKey,oe[1].indexes)}),J.change.forEach(function(oe){if(oe.recreate)throw new ce.Upgrade("Not yet support for changing primary key");var ie=x.objectStore(oe.name);oe.add.forEach(function(_e){return Jr(ie,_e)}),oe.change.forEach(function(_e){ie.deleteIndex(_e.name),Jr(ie,_e)}),oe.del.forEach(function(_e){return ie.deleteIndex(_e)})});var ne=q._cfg.contentUpgrade;if(ne&&q._cfg.version>I){Vr(S,x),$._memoizedTables={};var se=F(W);J.del.forEach(function(oe){se[oe]=D[oe]}),Ma(S,[S.Transaction.prototype]),Gr(S,[S.Transaction.prototype],l(se),se),$.schema=se;var te,re=Pe(ne);return re&&Xt(),J=ae.follow(function(){var oe;(te=ne($))&&re&&(oe=Z.bind(null,null),te.then(oe,oe))}),te&&typeof te.then=="function"?ae.resolve(te):J.then(function(){return te})}}),O.push(function(D){var W,J,ne=q._cfg.dbschema;W=ne,J=D,[].slice.call(J.db.objectStoreNames).forEach(function(se){return W[se]==null&&J.db.deleteObjectStore(se)}),Ma(S,[S.Transaction.prototype]),Gr(S,[S.Transaction.prototype],S._storeNames,S._dbSchema),$.schema=S._dbSchema}),O.push(function(D){S.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(S.idbdb.version/10)===q._cfg.version?(S.idbdb.deleteObjectStore("$meta"),delete S._dbSchema.$meta,S._storeNames=S._storeNames.filter(function(W){return W!=="$meta"})):D.objectStore("$meta").put(q._cfg.version,"version"))})}),function q(){return O.length?ae.resolve(O.shift()($.idbtrans)).then(q):ae.resolve()}().then(function(){ls(P,x)})):ae.resolve();var S,I,$,x,O,P}).catch(b)):(l(p).forEach(function(N){Ua(c,N,p[N].primKey,p[N].indexes)}),Vr(a,c),void ae.follow(function(){return a.on.populate.fire(m)}).catch(b));var A,C})}function dl(a,o){ls(a._dbSchema,o),o.db.version%10!=0||o.objectStoreNames.contains("$meta")||o.db.createObjectStore("$meta").add(Math.ceil(o.db.version/10-1),"version");var c=Yr(0,a.idbdb,o);Qr(a,a._dbSchema,o);for(var d=0,p=Ba(c,a._dbSchema).change;d<p.length;d++){var m=function(b){if(b.change.length||b.recreate)return console.warn("Unable to patch indexes of table ".concat(b.name," because it has changes on the type of index or primary key.")),{value:void 0};var k=o.objectStore(b.name);b.add.forEach(function(A){Je&&console.debug("Dexie upgrade patch: Creating missing index ".concat(b.name,".").concat(A.src)),Jr(k,A)})}(p[d]);if(typeof m=="object")return m.value}}function Ba(a,o){var c,d={del:[],add:[],change:[]};for(c in a)o[c]||d.del.push(c);for(c in o){var p=a[c],m=o[c];if(p){var b={name:c,def:m,recreate:!1,del:[],add:[],change:[]};if(""+(p.primKey.keyPath||"")!=""+(m.primKey.keyPath||"")||p.primKey.auto!==m.primKey.auto)b.recreate=!0,d.change.push(b);else{var k=p.idxByName,A=m.idxByName,C=void 0;for(C in k)A[C]||b.del.push(C);for(C in A){var N=k[C],S=A[C];N?N.src!==S.src&&b.change.push(S):b.add.push(S)}(0<b.del.length||0<b.add.length||0<b.change.length)&&d.change.push(b)}}else d.add.push([c,m])}return d}function Ua(a,o,c,d){var p=a.db.createObjectStore(o,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});return d.forEach(function(m){return Jr(p,m)}),p}function ls(a,o){l(a).forEach(function(c){o.db.objectStoreNames.contains(c)||(Je&&console.debug("Dexie: Creating missing table",c),Ua(o,c,a[c].primKey,a[c].indexes))})}function Jr(a,o){a.createIndex(o.name,o.keyPath,{unique:o.unique,multiEntry:o.multi})}function Yr(a,o,c){var d={};return z(o.objectStoreNames,0).forEach(function(p){for(var m=c.objectStore(p),b=qa(ss(C=m.keyPath),C||"",!0,!1,!!m.autoIncrement,C&&typeof C!="string",!0),k=[],A=0;A<m.indexNames.length;++A){var N=m.index(m.indexNames[A]),C=N.keyPath,N=qa(N.name,C,!!N.unique,!!N.multiEntry,!1,C&&typeof C!="string",!1);k.push(N)}d[p]=ja(p,b,k)}),d}function Qr(a,o,c){for(var d=c.db.objectStoreNames,p=0;p<d.length;++p){var m=d[p],b=c.objectStore(m);a._hasGetAll="getAll"in b;for(var k=0;k<b.indexNames.length;++k){var A=b.indexNames[k],C=b.index(A).keyPath,N=typeof C=="string"?C:"["+z(C).join("+")+"]";!o[m]||(C=o[m].idxByName[N])&&(C.name=A,delete o[m].idxByName[N],o[m].idxByName[A]=C)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&s.WorkerGlobalScope&&s instanceof s.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function cs(a){return a.split(",").map(function(o,c){var m=o.split(":"),d=(p=m[1])===null||p===void 0?void 0:p.trim(),p=(o=m[0].trim()).replace(/([&*]|\+\+)/g,""),m=/^\[/.test(p)?p.match(/^\[(.*)\]$/)[1].split("+"):p;return qa(p,m||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),u(m),c===0,d)})}var hl=(Xn.prototype._createTableSchema=ja,Xn.prototype._parseIndexSyntax=cs,Xn.prototype._parseStoresSpec=function(a,o){var c=this;l(a).forEach(function(d){if(a[d]!==null){var p=c._parseIndexSyntax(a[d]),m=p.shift();if(!m)throw new ce.Schema("Invalid schema for table "+d+": "+a[d]);if(m.unique=!0,m.multi)throw new ce.Schema("Primary key cannot be multiEntry*");p.forEach(function(b){if(b.auto)throw new ce.Schema("Only primary key can be marked as autoIncrement (++)");if(!b.keyPath)throw new ce.Schema("Index must have a name and cannot be an empty string")}),p=c._createTableSchema(d,m,p),o[d]=p}})},Xn.prototype.stores=function(c){var o=this.db;this._cfg.storesSource=this._cfg.storesSource?h(this._cfg.storesSource,c):c;var c=o._versions,d={},p={};return c.forEach(function(m){h(d,m._cfg.storesSource),p=m._cfg.dbschema={},m._parseStoresSpec(d,p)}),o._dbSchema=p,Ma(o,[o._allTables,o,o.Transaction.prototype]),Gr(o,[o._allTables,o,o.Transaction.prototype,this._cfg.tables],l(p),p),o._storeNames=l(p),this},Xn.prototype.upgrade=function(a){return this._cfg.contentUpgrade=yt(this._cfg.contentUpgrade||qe,a),this},Xn);function Xn(){}function za(a,o){var c=a._dbNamesDB;return c||(c=a._dbNamesDB=new kn(Ur,{addons:[],indexedDB:a,IDBKeyRange:o})).version(1).stores({dbnames:"name"}),c.table("dbnames")}function Fa(a){return a&&typeof a.databases=="function"}function Ka(a){return Fe(function(){return ve.letThrough=!0,a()})}function Ha(a){return!("from"in a)}var Dt=function(a,o){if(!this){var c=new Dt;return a&&"d"in a&&h(c,a),c}h(this,arguments.length?{d:1,from:a,to:1<arguments.length?o:a}:{d:0})};function Er(a,o,c){var d=We(o,c);if(!isNaN(d)){if(0<d)throw RangeError();if(Ha(a))return h(a,{from:o,to:c,d:1});var p=a.l,d=a.r;if(We(c,a.from)<0)return p?Er(p,o,c):a.l={from:o,to:c,d:1,l:null,r:null},ds(a);if(0<We(o,a.to))return d?Er(d,o,c):a.r={from:o,to:c,d:1,l:null,r:null},ds(a);We(o,a.from)<0&&(a.from=o,a.l=null,a.d=d?d.d+1:1),0<We(c,a.to)&&(a.to=c,a.r=null,a.d=a.l?a.l.d+1:1),c=!a.r,p&&!a.l&&Ar(a,p),d&&c&&Ar(a,d)}}function Ar(a,o){Ha(o)||function c(d,A){var m=A.from,b=A.to,k=A.l,A=A.r;Er(d,m,b),k&&c(d,k),A&&c(d,A)}(a,o)}function us(a,o){var c=Xr(o),d=c.next();if(d.done)return!1;for(var p=d.value,m=Xr(a),b=m.next(p.from),k=b.value;!d.done&&!b.done;){if(We(k.from,p.to)<=0&&0<=We(k.to,p.from))return!0;We(p.from,k.from)<0?p=(d=c.next(k.from)).value:k=(b=m.next(p.from)).value}return!1}function Xr(a){var o=Ha(a)?null:{s:0,n:a};return{next:function(c){for(var d=0<arguments.length;o;)switch(o.s){case 0:if(o.s=1,d)for(;o.n.l&&We(c,o.n.from)<0;)o={up:o,n:o.n.l,s:1};else for(;o.n.l;)o={up:o,n:o.n.l,s:1};case 1:if(o.s=2,!d||We(c,o.n.to)<=0)return{value:o.n,done:!1};case 2:if(o.n.r){o.s=3,o={up:o,n:o.n.r,s:0};continue}case 3:o=o.up}return{done:!0}}}}function ds(a){var o,c,d=(((o=a.r)===null||o===void 0?void 0:o.d)||0)-(((c=a.l)===null||c===void 0?void 0:c.d)||0),p=1<d?"r":d<-1?"l":"";p&&(o=p=="r"?"l":"r",c=r({},a),d=a[p],a.from=d.from,a.to=d.to,a[p]=d[p],c[p]=d[o],(a[o]=c).d=hs(c)),a.d=hs(a)}function hs(c){var o=c.r,c=c.l;return(o?c?Math.max(o.d,c.d):o.d:c?c.d:0)+1}function Zr(a,o){return l(o).forEach(function(c){a[c]?Ar(a[c],o[c]):a[c]=function d(p){var m,b,k={};for(m in p)y(p,m)&&(b=p[m],k[m]=!b||typeof b!="object"||G.has(b.constructor)?b:d(b));return k}(o[c])}),a}function Wa(a,o){return a.all||o.all||Object.keys(a).some(function(c){return o[c]&&us(o[c],a[c])})}_(Dt.prototype,((on={add:function(a){return Ar(this,a),this},addKey:function(a){return Er(this,a,a),this},addKeys:function(a){var o=this;return a.forEach(function(c){return Er(o,c,c)}),this},hasKey:function(a){var o=Xr(this).next(a).value;return o&&We(o.from,a)<=0&&0<=We(o.to,a)}})[ue]=function(){return Xr(this)},on));var Mn={},Va={},Ga=!1;function ea(a){Zr(Va,a),Ga||(Ga=!0,setTimeout(function(){Ga=!1,Ja(Va,!(Va={}))},0))}function Ja(a,o){o===void 0&&(o=!1);var c=new Set;if(a.all)for(var d=0,p=Object.values(Mn);d<p.length;d++)fs(b=p[d],a,c,o);else for(var m in a){var b,k=/^idb\:\/\/(.*)\/(.*)\//.exec(m);k&&(m=k[1],k=k[2],(b=Mn["idb://".concat(m,"/").concat(k)])&&fs(b,a,c,o))}c.forEach(function(A){return A()})}function fs(a,o,c,d){for(var p=[],m=0,b=Object.entries(a.queries.query);m<b.length;m++){for(var k=b[m],A=k[0],C=[],N=0,S=k[1];N<S.length;N++){var I=S[N];Wa(o,I.obsSet)?I.subscribers.forEach(function(P){return c.add(P)}):d&&C.push(I)}d&&p.push([A,C])}if(d)for(var $=0,x=p;$<x.length;$++){var O=x[$],A=O[0],C=O[1];a.queries.query[A]=C}}function fl(a){var o=a._state,c=a._deps.indexedDB;if(o.isBeingOpened||a.idbdb)return o.dbReadyPromise.then(function(){return o.dbOpenError?pt(o.dbOpenError):a});o.isBeingOpened=!0,o.dbOpenError=null,o.openComplete=!1;var d=o.openCanceller,p=Math.round(10*a.verno),m=!1;function b(){if(o.openCanceller!==d)throw new ce.DatabaseClosed("db.open() was cancelled")}function k(){return new ae(function(I,$){if(b(),!c)throw new ce.MissingAPI;var x=a.name,O=o.autoSchema||!p?c.open(x):c.open(x,p);if(!O)throw new ce.MissingAPI;O.onerror=gn($),O.onblocked=Ee(a._fireOnBlocked),O.onupgradeneeded=Ee(function(P){var q;N=O.transaction,o.autoSchema&&!a._options.allowEmptyDB?(O.onerror=_r,N.abort(),O.result.close(),(q=c.deleteDatabase(x)).onsuccess=q.onerror=Ee(function(){$(new ce.NoSuchDatabase("Database ".concat(x," doesnt exist")))})):(N.onerror=gn($),P=P.oldVersion>Math.pow(2,62)?0:P.oldVersion,S=P<1,a.idbdb=O.result,m&&dl(a,N),ul(a,P/10,N,$))},$),O.onsuccess=Ee(function(){N=null;var P,q,D,W,J,ne=a.idbdb=O.result,se=z(ne.objectStoreNames);if(0<se.length)try{var te=ne.transaction((W=se).length===1?W[0]:W,"readonly");if(o.autoSchema)q=ne,D=te,(P=a).verno=q.version/10,D=P._dbSchema=Yr(0,q,D),P._storeNames=z(q.objectStoreNames,0),Gr(P,[P._allTables],l(D),D);else if(Qr(a,a._dbSchema,te),((J=Ba(Yr(0,(J=a).idbdb,te),J._dbSchema)).add.length||J.change.some(function(re){return re.add.length||re.change.length}))&&!m)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),ne.close(),p=ne.version+1,m=!0,I(k());Vr(a,te)}catch{}Jn.push(a),ne.onversionchange=Ee(function(re){o.vcFired=!0,a.on("versionchange").fire(re)}),ne.onclose=Ee(function(){a.close({disableAutoOpen:!1})}),S&&(J=a._deps,te=x,ne=J.indexedDB,J=J.IDBKeyRange,Fa(ne)||te===Ur||za(ne,J).put({name:te}).catch(qe)),I()},$)}).catch(function(I){switch(I==null?void 0:I.name){case"UnknownError":if(0<o.PR1398_maxLoop)return o.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),k();break;case"VersionError":if(0<p)return p=0,k()}return ae.reject(I)})}var A,C=o.dbReadyResolve,N=null,S=!1;return ae.race([d,(typeof navigator>"u"?ae.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(I){function $(){return indexedDB.databases().finally(I)}A=setInterval($,100),$()}).finally(function(){return clearInterval(A)}):Promise.resolve()).then(k)]).then(function(){return b(),o.onReadyBeingFired=[],ae.resolve(Ka(function(){return a.on.ready.fire(a.vip)})).then(function I(){if(0<o.onReadyBeingFired.length){var $=o.onReadyBeingFired.reduce(yt,qe);return o.onReadyBeingFired=[],ae.resolve(Ka(function(){return $(a.vip)})).then(I)}})}).finally(function(){o.openCanceller===d&&(o.onReadyBeingFired=null,o.isBeingOpened=!1)}).catch(function(I){o.dbOpenError=I;try{N&&N.abort()}catch{}return d===o.openCanceller&&a._close(),pt(I)}).finally(function(){o.openComplete=!0,C()}).then(function(){var I;return S&&(I={},a.tables.forEach(function($){$.schema.indexes.forEach(function(x){x.name&&(I["idb://".concat(a.name,"/").concat($.name,"/").concat(x.name)]=new Dt(-1/0,[[[]]]))}),I["idb://".concat(a.name,"/").concat($.name,"/")]=I["idb://".concat(a.name,"/").concat($.name,"/:dels")]=new Dt(-1/0,[[[]]])}),xn(wr).fire(I),Ja(I,!0)),a})}function Ya(a){function o(m){return a.next(m)}var c=p(o),d=p(function(m){return a.throw(m)});function p(m){return function(A){var k=m(A),A=k.value;return k.done?A:A&&typeof A.then=="function"?A.then(c,d):u(A)?Promise.all(A).then(c,d):c(A)}}return p(o)()}function ta(a,o,c){for(var d=u(a)?a.slice():[a],p=0;p<c;++p)d.push(o);return d}var pl={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return r(r({},a),{table:function(o){var c=a.table(o),d=c.schema,p={},m=[];function b(S,I,$){var x=Sr(S),O=p[x]=p[x]||[],P=S==null?0:typeof S=="string"?1:S.length,q=0<I,q=r(r({},$),{name:q?"".concat(x,"(virtual-from:").concat($.name,")"):$.name,lowLevelIndex:$,isVirtual:q,keyTail:I,keyLength:P,extractKey:Da(S),unique:!q&&$.unique});return O.push(q),q.isPrimaryKey||m.push(q),1<P&&b(P===2?S[0]:S.slice(0,P-1),I+1,$),O.sort(function(D,W){return D.keyTail-W.keyTail}),q}o=b(d.primaryKey.keyPath,0,d.primaryKey),p[":id"]=[o];for(var k=0,A=d.indexes;k<A.length;k++){var C=A[k];b(C.keyPath,0,C)}function N(S){var I,$=S.query.index;return $.isVirtual?r(r({},S),{query:{index:$.lowLevelIndex,range:(I=S.query.range,$=$.keyTail,{type:I.type===1?2:I.type,lower:ta(I.lower,I.lowerOpen?a.MAX_KEY:a.MIN_KEY,$),lowerOpen:!0,upper:ta(I.upper,I.upperOpen?a.MIN_KEY:a.MAX_KEY,$),upperOpen:!0})}}):S}return r(r({},c),{schema:r(r({},d),{primaryKey:o,indexes:m,getIndexByKeyPath:function(S){return(S=p[Sr(S)])&&S[0]}}),count:function(S){return c.count(N(S))},query:function(S){return c.query(N(S))},openCursor:function(S){var I=S.query.index,$=I.keyTail,x=I.isVirtual,O=I.keyLength;return x?c.openCursor(N(S)).then(function(q){return q&&P(q)}):c.openCursor(S);function P(q){return Object.create(q,{continue:{value:function(D){D!=null?q.continue(ta(D,S.reverse?a.MAX_KEY:a.MIN_KEY,$)):S.unique?q.continue(q.key.slice(0,O).concat(S.reverse?a.MIN_KEY:a.MAX_KEY,$)):q.continue()}},continuePrimaryKey:{value:function(D,W){q.continuePrimaryKey(ta(D,a.MAX_KEY,$),W)}},primaryKey:{get:function(){return q.primaryKey}},key:{get:function(){var D=q.key;return O===1?D[0]:D.slice(0,O)}},value:{get:function(){return q.value}}})}}})}})}};function Qa(a,o,c,d){return c=c||{},d=d||"",l(a).forEach(function(p){var m,b,k;y(o,p)?(m=a[p],b=o[p],typeof m=="object"&&typeof b=="object"&&m&&b?(k=ee(m))!==ee(b)?c[d+p]=o[p]:k==="Object"?Qa(m,b,c,d+p+"."):m!==b&&(c[d+p]=o[p]):m!==b&&(c[d+p]=o[p])):c[d+p]=void 0}),l(o).forEach(function(p){y(a,p)||(c[d+p]=o[p])}),c}function Xa(a,o){return o.type==="delete"?o.keys:o.keys||o.values.map(a.extractKey)}var ml={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return r(r({},a),{table:function(o){var c=a.table(o),d=c.schema.primaryKey;return r(r({},c),{mutate:function(p){var m=ve.trans,b=m.table(o).hook,k=b.deleting,A=b.creating,C=b.updating;switch(p.type){case"add":if(A.fire===qe)break;return m._promise("readwrite",function(){return N(p)},!0);case"put":if(A.fire===qe&&C.fire===qe)break;return m._promise("readwrite",function(){return N(p)},!0);case"delete":if(k.fire===qe)break;return m._promise("readwrite",function(){return N(p)},!0);case"deleteRange":if(k.fire===qe)break;return m._promise("readwrite",function(){return function S(I,$,x){return c.query({trans:I,values:!1,query:{index:d,range:$},limit:x}).then(function(O){var P=O.result;return N({type:"delete",keys:P,trans:I}).then(function(q){return 0<q.numFailures?Promise.reject(q.failures[0]):P.length<x?{failures:[],numFailures:0,lastResult:void 0}:S(I,r(r({},$),{lower:P[P.length-1],lowerOpen:!0}),x)})})}(p.trans,p.range,1e4)},!0)}return c.mutate(p);function N(S){var I,$,x,O=ve.trans,P=S.keys||Xa(d,S);if(!P)throw new Error("Keys missing");return(S=S.type==="add"||S.type==="put"?r(r({},S),{keys:P}):r({},S)).type!=="delete"&&(S.values=i([],S.values)),S.keys&&(S.keys=i([],S.keys)),I=c,x=P,(($=S).type==="add"?Promise.resolve([]):I.getMany({trans:$.trans,keys:x,cache:"immutable"})).then(function(q){var D=P.map(function(W,J){var ne,se,te,re=q[J],oe={onerror:null,onsuccess:null};return S.type==="delete"?k.fire.call(oe,W,re,O):S.type==="add"||re===void 0?(ne=A.fire.call(oe,W,S.values[J],O),W==null&&ne!=null&&(S.keys[J]=W=ne,d.outbound||M(S.values[J],d.keyPath,W))):(ne=Qa(re,S.values[J]),(se=C.fire.call(oe,ne,W,re,O))&&(te=S.values[J],Object.keys(se).forEach(function(ie){y(te,ie)?te[ie]=se[ie]:M(te,ie,se[ie])}))),oe});return c.mutate(S).then(function(W){for(var J=W.failures,ne=W.results,se=W.numFailures,W=W.lastResult,te=0;te<P.length;++te){var re=(ne||P)[te],oe=D[te];re==null?oe.onerror&&oe.onerror(J[te]):oe.onsuccess&&oe.onsuccess(S.type==="put"&&q[te]?S.values[te]:re)}return{failures:J,results:ne,numFailures:se,lastResult:W}}).catch(function(W){return D.forEach(function(J){return J.onerror&&J.onerror(W)}),Promise.reject(W)})})}}})}})}};function ps(a,o,c){try{if(!o||o.keys.length<a.length)return null;for(var d=[],p=0,m=0;p<o.keys.length&&m<a.length;++p)We(o.keys[p],a[m])===0&&(d.push(c?B(o.values[p]):o.values[p]),++m);return d.length===a.length?d:null}catch{return null}}var gl={stack:"dbcore",level:-1,create:function(a){return{table:function(o){var c=a.table(o);return r(r({},c),{getMany:function(d){if(!d.cache)return c.getMany(d);var p=ps(d.keys,d.trans._cache,d.cache==="clone");return p?ae.resolve(p):c.getMany(d).then(function(m){return d.trans._cache={keys:d.keys,values:d.cache==="clone"?B(m):m},m})},mutate:function(d){return d.type!=="add"&&(d.trans._cache=null),c.mutate(d)}})}}}};function ms(a,o){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!o.schema.primaryKey.outbound}function gs(a,o){switch(a){case"query":return o.values&&!o.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var vl={stack:"dbcore",level:0,name:"Observability",create:function(a){var o=a.schema.name,c=new Dt(a.MIN_KEY,a.MAX_KEY);return r(r({},a),{transaction:function(d,p,m){if(ve.subscr&&p!=="readonly")throw new ce.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(ve.querier));return a.transaction(d,p,m)},table:function(d){var p=a.table(d),m=p.schema,b=m.primaryKey,S=m.indexes,k=b.extractKey,A=b.outbound,C=b.autoIncrement&&S.filter(function($){return $.compound&&$.keyPath.includes(b.keyPath)}),N=r(r({},p),{mutate:function($){function x(ie){return ie="idb://".concat(o,"/").concat(d,"/").concat(ie),W[ie]||(W[ie]=new Dt)}var O,P,q,D=$.trans,W=$.mutatedParts||($.mutatedParts={}),J=x(""),ne=x(":dels"),se=$.type,oe=$.type==="deleteRange"?[$.range]:$.type==="delete"?[$.keys]:$.values.length<50?[Xa(b,$).filter(function(ie){return ie}),$.values]:[],te=oe[0],re=oe[1],oe=$.trans._cache;return u(te)?(J.addKeys(te),(oe=se==="delete"||te.length===re.length?ps(te,oe):null)||ne.addKeys(te),(oe||re)&&(O=x,P=oe,q=re,m.indexes.forEach(function(ie){var _e=O(ie.name||"");function Le(Ue){return Ue!=null?ie.extractKey(Ue):null}function je(Ue){return ie.multiEntry&&u(Ue)?Ue.forEach(function(en){return _e.addKey(en)}):_e.addKey(Ue)}(P||q).forEach(function(Ue,Mt){var Ie=P&&Le(P[Mt]),Mt=q&&Le(q[Mt]);We(Ie,Mt)!==0&&(Ie!=null&&je(Ie),Mt!=null&&je(Mt))})}))):te?(re={from:(re=te.lower)!==null&&re!==void 0?re:a.MIN_KEY,to:(re=te.upper)!==null&&re!==void 0?re:a.MAX_KEY},ne.add(re),J.add(re)):(J.add(c),ne.add(c),m.indexes.forEach(function(ie){return x(ie.name).add(c)})),p.mutate($).then(function(ie){return!te||$.type!=="add"&&$.type!=="put"||(J.addKeys(ie.results),C&&C.forEach(function(_e){for(var Le=$.values.map(function(Ie){return _e.extractKey(Ie)}),je=_e.keyPath.findIndex(function(Ie){return Ie===b.keyPath}),Ue=0,en=ie.results.length;Ue<en;++Ue)Le[Ue][je]=ie.results[Ue];x(_e.name).addKeys(Le)})),D.mutatedParts=Zr(D.mutatedParts||{},W),ie})}}),S=function(x){var O=x.query,x=O.index,O=O.range;return[x,new Dt((x=O.lower)!==null&&x!==void 0?x:a.MIN_KEY,(O=O.upper)!==null&&O!==void 0?O:a.MAX_KEY)]},I={get:function($){return[b,new Dt($.key)]},getMany:function($){return[b,new Dt().addKeys($.keys)]},count:S,query:S,openCursor:S};return l(I).forEach(function($){N[$]=function(x){var O=ve.subscr,P=!!O,q=ms(ve,p)&&gs($,x)?x.obsSet={}:O;if(P){var D=function(re){return re="idb://".concat(o,"/").concat(d,"/").concat(re),q[re]||(q[re]=new Dt)},W=D(""),J=D(":dels"),O=I[$](x),P=O[0],O=O[1];if(($==="query"&&P.isPrimaryKey&&!x.values?J:D(P.name||"")).add(O),!P.isPrimaryKey){if($!=="count"){var ne=$==="query"&&A&&x.values&&p.query(r(r({},x),{values:!1}));return p[$].apply(this,arguments).then(function(re){if($==="query"){if(A&&x.values)return ne.then(function(Le){return Le=Le.result,W.addKeys(Le),re});var oe=x.values?re.result.map(k):re.result;(x.values?W:J).addKeys(oe)}else if($==="openCursor"){var ie=re,_e=x.values;return ie&&Object.create(ie,{key:{get:function(){return J.addKey(ie.primaryKey),ie.key}},primaryKey:{get:function(){var Le=ie.primaryKey;return J.addKey(Le),Le}},value:{get:function(){return _e&&W.addKey(ie.primaryKey),ie.value}}})}return re})}J.add(c)}}return p[$].apply(this,arguments)}}),N}})}};function vs(a,o,c){if(c.numFailures===0)return o;if(o.type==="deleteRange")return null;var d=o.keys?o.keys.length:"values"in o&&o.values?o.values.length:1;return c.numFailures===d?null:(o=r({},o),u(o.keys)&&(o.keys=o.keys.filter(function(p,m){return!(m in c.failures)})),"values"in o&&u(o.values)&&(o.values=o.values.filter(function(p,m){return!(m in c.failures)})),o)}function Za(a,o){return c=a,((d=o).lower===void 0||(d.lowerOpen?0<We(c,d.lower):0<=We(c,d.lower)))&&(a=a,(o=o).upper===void 0||(o.upperOpen?We(a,o.upper)<0:We(a,o.upper)<=0));var c,d}function bs(a,o,I,d,p,m){if(!I||I.length===0)return a;var b=o.query.index,k=b.multiEntry,A=o.query.range,C=d.schema.primaryKey.extractKey,N=b.extractKey,S=(b.lowLevelIndex||b).extractKey,I=I.reduce(function($,x){var O=$,P=[];if(x.type==="add"||x.type==="put")for(var q=new Dt,D=x.values.length-1;0<=D;--D){var W,J=x.values[D],ne=C(J);q.hasKey(ne)||(W=N(J),(k&&u(W)?W.some(function(ie){return Za(ie,A)}):Za(W,A))&&(q.addKey(ne),P.push(J)))}switch(x.type){case"add":var se=new Dt().addKeys(o.values?$.map(function(_e){return C(_e)}):$),O=$.concat(o.values?P.filter(function(_e){return _e=C(_e),!se.hasKey(_e)&&(se.addKey(_e),!0)}):P.map(function(_e){return C(_e)}).filter(function(_e){return!se.hasKey(_e)&&(se.addKey(_e),!0)}));break;case"put":var te=new Dt().addKeys(x.values.map(function(_e){return C(_e)}));O=$.filter(function(_e){return!te.hasKey(o.values?C(_e):_e)}).concat(o.values?P:P.map(function(_e){return C(_e)}));break;case"delete":var re=new Dt().addKeys(x.keys);O=$.filter(function(_e){return!re.hasKey(o.values?C(_e):_e)});break;case"deleteRange":var oe=x.range;O=$.filter(function(_e){return!Za(C(_e),oe)})}return O},a);return I===a?a:(I.sort(function($,x){return We(S($),S(x))||We(C($),C(x))}),o.limit&&o.limit<1/0&&(I.length>o.limit?I.length=o.limit:a.length===o.limit&&I.length<o.limit&&(p.dirty=!0)),m?Object.freeze(I):I)}function ys(a,o){return We(a.lower,o.lower)===0&&We(a.upper,o.upper)===0&&!!a.lowerOpen==!!o.lowerOpen&&!!a.upperOpen==!!o.upperOpen}function bl(a,o){return function(c,d,p,m){if(c===void 0)return d!==void 0?-1:0;if(d===void 0)return 1;if((d=We(c,d))===0){if(p&&m)return 0;if(p)return 1;if(m)return-1}return d}(a.lower,o.lower,a.lowerOpen,o.lowerOpen)<=0&&0<=function(c,d,p,m){if(c===void 0)return d!==void 0?1:0;if(d===void 0)return-1;if((d=We(c,d))===0){if(p&&m)return 0;if(p)return-1;if(m)return 1}return d}(a.upper,o.upper,a.upperOpen,o.upperOpen)}function yl(a,o,c,d){a.subscribers.add(c),d.addEventListener("abort",function(){var p,m;a.subscribers.delete(c),a.subscribers.size===0&&(p=a,m=o,setTimeout(function(){p.subscribers.size===0&&ge(m,p)},3e3))})}var _l={stack:"dbcore",level:0,name:"Cache",create:function(a){var o=a.schema.name;return r(r({},a),{transaction:function(c,d,p){var m,b,k=a.transaction(c,d,p);return d==="readwrite"&&(b=(m=new AbortController).signal,p=function(A){return function(){if(m.abort(),d==="readwrite"){for(var C=new Set,N=0,S=c;N<S.length;N++){var I=S[N],$=Mn["idb://".concat(o,"/").concat(I)];if($){var x=a.table(I),O=$.optimisticOps.filter(function(_e){return _e.trans===k});if(k._explicit&&A&&k.mutatedParts)for(var P=0,q=Object.values($.queries.query);P<q.length;P++)for(var D=0,W=(se=q[P]).slice();D<W.length;D++)Wa((te=W[D]).obsSet,k.mutatedParts)&&(ge(se,te),te.subscribers.forEach(function(_e){return C.add(_e)}));else if(0<O.length){$.optimisticOps=$.optimisticOps.filter(function(_e){return _e.trans!==k});for(var J=0,ne=Object.values($.queries.query);J<ne.length;J++)for(var se,te,re,oe=0,ie=(se=ne[J]).slice();oe<ie.length;oe++)(te=ie[oe]).res!=null&&k.mutatedParts&&(A&&!te.dirty?(re=Object.isFrozen(te.res),re=bs(te.res,te.req,O,x,te,re),te.dirty?(ge(se,te),te.subscribers.forEach(function(_e){return C.add(_e)})):re!==te.res&&(te.res=re,te.promise=ae.resolve({result:re}))):(te.dirty&&ge(se,te),te.subscribers.forEach(function(_e){return C.add(_e)})))}}}C.forEach(function(_e){return _e()})}}},k.addEventListener("abort",p(!1),{signal:b}),k.addEventListener("error",p(!1),{signal:b}),k.addEventListener("complete",p(!0),{signal:b})),k},table:function(c){var d=a.table(c),p=d.schema.primaryKey;return r(r({},d),{mutate:function(m){var b=ve.trans;if(p.outbound||b.db._options.cache==="disabled"||b.explicit||b.idbtrans.mode!=="readwrite")return d.mutate(m);var k=Mn["idb://".concat(o,"/").concat(c)];return k?(b=d.mutate(m),m.type!=="add"&&m.type!=="put"||!(50<=m.values.length||Xa(p,m).some(function(A){return A==null}))?(k.optimisticOps.push(m),m.mutatedParts&&ea(m.mutatedParts),b.then(function(A){0<A.numFailures&&(ge(k.optimisticOps,m),(A=vs(0,m,A))&&k.optimisticOps.push(A),m.mutatedParts&&ea(m.mutatedParts))}),b.catch(function(){ge(k.optimisticOps,m),m.mutatedParts&&ea(m.mutatedParts)})):b.then(function(A){var C=vs(0,r(r({},m),{values:m.values.map(function(N,S){var I;return A.failures[S]?N:(N=(I=p.keyPath)!==null&&I!==void 0&&I.includes(".")?B(N):r({},N),M(N,p.keyPath,A.results[S]),N)})}),A);k.optimisticOps.push(C),queueMicrotask(function(){return m.mutatedParts&&ea(m.mutatedParts)})}),b):d.mutate(m)},query:function(m){if(!ms(ve,d)||!gs("query",m))return d.query(m);var b=((C=ve.trans)===null||C===void 0?void 0:C.db._options.cache)==="immutable",S=ve,k=S.requery,A=S.signal,C=function(x,O,P,q){var D=Mn["idb://".concat(x,"/").concat(O)];if(!D)return[];if(!(O=D.queries[P]))return[null,!1,D,null];var W=O[(q.query?q.query.index.name:null)||""];if(!W)return[null,!1,D,null];switch(P){case"query":var J=W.find(function(ne){return ne.req.limit===q.limit&&ne.req.values===q.values&&ys(ne.req.query.range,q.query.range)});return J?[J,!0,D,W]:[W.find(function(ne){return("limit"in ne.req?ne.req.limit:1/0)>=q.limit&&(!q.values||ne.req.values)&&bl(ne.req.query.range,q.query.range)}),!1,D,W];case"count":return J=W.find(function(ne){return ys(ne.req.query.range,q.query.range)}),[J,!!J,D,W]}}(o,c,"query",m),N=C[0],S=C[1],I=C[2],$=C[3];return N&&S?N.obsSet=m.obsSet:(S=d.query(m).then(function(x){var O=x.result;if(N&&(N.res=O),b){for(var P=0,q=O.length;P<q;++P)Object.freeze(O[P]);Object.freeze(O)}else x.result=B(O);return x}).catch(function(x){return $&&N&&ge($,N),Promise.reject(x)}),N={obsSet:m.obsSet,promise:S,subscribers:new Set,type:"query",req:m,dirty:!1},$?$.push(N):($=[N],(I=I||(Mn["idb://".concat(o,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[m.query.index.name||""]=$)),yl(N,$,k,A),N.promise.then(function(x){return{result:bs(x.result,m,I==null?void 0:I.optimisticOps,d,N,b)}})}})}})}};function na(a,o){return new Proxy(a,{get:function(c,d,p){return d==="db"?o:Reflect.get(c,d,p)}})}var kn=(mt.prototype.version=function(a){if(isNaN(a)||a<.1)throw new ce.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new ce.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var o=this._versions,c=o.filter(function(d){return d._cfg.version===a})[0];return c||(c=new this.Version(a),o.push(c),o.sort(cl),c.stores({}),this._state.autoSchema=!1,c)},mt.prototype._whenReady=function(a){var o=this;return this.idbdb&&(this._state.openComplete||ve.letThrough||this._vip)?a():new ae(function(c,d){if(o._state.openComplete)return d(new ce.DatabaseClosed(o._state.dbOpenError));if(!o._state.isBeingOpened){if(!o._state.autoOpen)return void d(new ce.DatabaseClosed);o.open().catch(qe)}o._state.dbReadyPromise.then(c,d)}).then(a)},mt.prototype.use=function(a){var o=a.stack,c=a.create,d=a.level,p=a.name;return p&&this.unuse({stack:o,name:p}),a=this._middlewares[o]||(this._middlewares[o]=[]),a.push({stack:o,create:c,level:d??10,name:p}),a.sort(function(m,b){return m.level-b.level}),this},mt.prototype.unuse=function(a){var o=a.stack,c=a.name,d=a.create;return o&&this._middlewares[o]&&(this._middlewares[o]=this._middlewares[o].filter(function(p){return d?p.create!==d:!!c&&p.name!==c})),this},mt.prototype.open=function(){var a=this;return _n(Ce,function(){return fl(a)})},mt.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var a=this._state,o=Jn.indexOf(this);if(0<=o&&Jn.splice(o,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new ae(function(c){a.dbReadyResolve=c}),a.openCanceller=new ae(function(c,d){a.cancelOpen=d}))},mt.prototype.close=function(c){var o=(c===void 0?{disableAutoOpen:!0}:c).disableAutoOpen,c=this._state;o?(c.isBeingOpened&&c.cancelOpen(new ce.DatabaseClosed),this._close(),c.autoOpen=!1,c.dbOpenError=new ce.DatabaseClosed):(this._close(),c.autoOpen=this._options.autoOpen||c.isBeingOpened,c.openComplete=!1,c.dbOpenError=null)},mt.prototype.delete=function(a){var o=this;a===void 0&&(a={disableAutoOpen:!0});var c=0<arguments.length&&typeof arguments[0]!="object",d=this._state;return new ae(function(p,m){function b(){o.close(a);var k=o._deps.indexedDB.deleteDatabase(o.name);k.onsuccess=Ee(function(){var A,C,N;A=o._deps,C=o.name,N=A.indexedDB,A=A.IDBKeyRange,Fa(N)||C===Ur||za(N,A).delete(C).catch(qe),p()}),k.onerror=gn(m),k.onblocked=o._fireOnBlocked}if(c)throw new ce.InvalidArgument("Invalid closeOptions argument to db.delete()");d.isBeingOpened?d.dbReadyPromise.then(b):b()})},mt.prototype.backendDB=function(){return this.idbdb},mt.prototype.isOpen=function(){return this.idbdb!==null},mt.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},mt.prototype.hasFailed=function(){return this._state.dbOpenError!==null},mt.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(mt.prototype,"tables",{get:function(){var a=this;return l(this._allTables).map(function(o){return a._allTables[o]})},enumerable:!1,configurable:!0}),mt.prototype.transaction=function(){var a=(function(o,c,d){var p=arguments.length;if(p<2)throw new ce.InvalidArgument("Too few arguments");for(var m=new Array(p-1);--p;)m[p-1]=arguments[p];return d=m.pop(),[o,Ae(m),d]}).apply(this,arguments);return this._transaction.apply(this,a)},mt.prototype._transaction=function(a,o,c){var d=this,p=ve.trans;p&&p.db===this&&a.indexOf("!")===-1||(p=null);var m,b,k=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(b=o.map(function(C){if(C=C instanceof d.Table?C.name:C,typeof C!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return C}),a=="r"||a===Ra)m=Ra;else{if(a!="rw"&&a!=Na)throw new ce.InvalidArgument("Invalid transaction mode: "+a);m=Na}if(p){if(p.mode===Ra&&m===Na){if(!k)throw new ce.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");p=null}p&&b.forEach(function(C){if(p&&p.storeNames.indexOf(C)===-1){if(!k)throw new ce.SubTransaction("Table "+C+" not included in parent transaction.");p=null}}),k&&p&&!p.active&&(p=null)}}catch(C){return p?p._promise(null,function(N,S){S(C)}):pt(C)}var A=(function C(N,S,I,$,x){return ae.resolve().then(function(){var O=ve.transless||ve,P=N._createTransaction(S,I,N._dbSchema,$);if(P.explicit=!0,O={trans:P,transless:O},$)P.idbtrans=$.idbtrans;else try{P.create(),P.idbtrans._explicit=!0,N._state.PR1398_maxLoop=3}catch(W){return W.name===Re.InvalidState&&N.isOpen()&&0<--N._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),N.close({disableAutoOpen:!1}),N.open().then(function(){return C(N,S,I,null,x)})):pt(W)}var q,D=Pe(x);return D&&Xt(),O=ae.follow(function(){var W;(q=x.call(P,P))&&(D?(W=Z.bind(null,null),q.then(W,W)):typeof q.next=="function"&&typeof q.throw=="function"&&(q=Ya(q)))},O),(q&&typeof q.then=="function"?ae.resolve(q).then(function(W){return P.active?W:pt(new ce.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):O.then(function(){return q})).then(function(W){return $&&P._resolve(),P._completion.then(function(){return W})}).catch(function(W){return P._reject(W),pt(W)})})}).bind(null,this,m,b,p,c);return p?p._promise(m,A,"lock"):ve.trans?_n(ve.transless,function(){return d._whenReady(A)}):this._whenReady(A)},mt.prototype.table=function(a){if(!y(this._allTables,a))throw new ce.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},mt);function mt(a,o){var c=this;this._middlewares={},this.verno=0;var d=mt.dependencies;this._options=o=r({addons:mt.addons,autoOpen:!0,indexedDB:d.indexedDB,IDBKeyRange:d.IDBKeyRange,cache:"cloned"},o),this._deps={indexedDB:o.indexedDB,IDBKeyRange:o.IDBKeyRange},d=o.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var p,m,b,k,A,C={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:qe,dbReadyPromise:null,cancelOpen:qe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:o.autoOpen};C.dbReadyPromise=new ae(function(S){C.dbReadyResolve=S}),C.openCanceller=new ae(function(S,I){C.cancelOpen=I}),this._state=C,this.name=a,this.on=br(this,"populate","blocked","versionchange","close",{ready:[yt,qe]}),this.once=function(S,I){var $=function(){for(var x=[],O=0;O<arguments.length;O++)x[O]=arguments[O];c.on(S).unsubscribe($),I.apply(c,x)};return c.on(S,$)},this.on.ready.subscribe=T(this.on.ready.subscribe,function(S){return function(I,$){mt.vip(function(){var x,O=c._state;O.openComplete?(O.dbOpenError||ae.resolve().then(I),$&&S(I)):O.onReadyBeingFired?(O.onReadyBeingFired.push(I),$&&S(I)):(S(I),x=c,$||S(function P(){x.on.ready.unsubscribe(I),x.on.ready.unsubscribe(P)}))})}}),this.Collection=(p=this,yr(nl.prototype,function(q,P){this.db=p;var $=Gi,x=null;if(P)try{$=P()}catch(D){x=D}var O=q._ctx,P=O.table,q=P.hook.reading.fire;this._ctx={table:P,index:O.index,isPrimKey:!O.index||P.schema.primKey.keyPath&&O.index===P.schema.primKey.name,range:$,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:x,or:O.or,valueMapper:q!==At?q:null}})),this.Table=(m=this,yr(es.prototype,function(S,I,$){this.db=m,this._tx=$,this.name=S,this.schema=I,this.hook=m._allTables[S]?m._allTables[S].hook:br(null,{creating:[at,qe],reading:[Nt,At],updating:[Ut,qe],deleting:[Vt,qe]})})),this.Transaction=(b=this,yr(il.prototype,function(S,I,$,x,O){var P=this;S!=="readonly"&&I.forEach(function(q){q=(q=$[q])===null||q===void 0?void 0:q.yProps,q&&(I=I.concat(q.map(function(D){return D.updatesTable})))}),this.db=b,this.mode=S,this.storeNames=I,this.schema=$,this.chromeTransactionDurability=x,this.idbtrans=null,this.on=br(this,"complete","error","abort"),this.parent=O||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new ae(function(q,D){P._resolve=q,P._reject=D}),this._completion.then(function(){P.active=!1,P.on.complete.fire()},function(q){var D=P.active;return P.active=!1,P.on.error.fire(q),P.parent?P.parent._reject(q):D&&P.idbtrans&&P.idbtrans.abort(),pt(q)})})),this.Version=(k=this,yr(hl.prototype,function(S){this.db=k,this._cfg={version:S,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(A=this,yr(is.prototype,function(S,I,$){if(this.db=A,this._ctx={table:S,index:I===":id"?null:I,or:$},this._cmp=this._ascending=We,this._descending=function(x,O){return We(O,x)},this._max=function(x,O){return 0<We(x,O)?x:O},this._min=function(x,O){return We(x,O)<0?x:O},this._IDBKeyRange=A._deps.IDBKeyRange,!this._IDBKeyRange)throw new ce.MissingAPI})),this.on("versionchange",function(S){0<S.newVersion?console.warn("Another connection wants to upgrade database '".concat(c.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(c.name,"'. Closing db now to resume the delete request.")),c.close({disableAutoOpen:!1})}),this.on("blocked",function(S){!S.newVersion||S.newVersion<S.oldVersion?console.warn("Dexie.delete('".concat(c.name,"') was blocked")):console.warn("Upgrade '".concat(c.name,"' blocked by other connection holding version ").concat(S.oldVersion/10))}),this._maxKey=kr(o.IDBKeyRange),this._createTransaction=function(S,I,$,x){return new c.Transaction(S,I,$,c._options.chromeTransactionDurability,x)},this._fireOnBlocked=function(S){c.on("blocked").fire(S),Jn.filter(function(I){return I.name===c.name&&I!==c&&!I._state.vcFired}).map(function(I){return I.on("versionchange").fire(S)})},this.use(gl),this.use(_l),this.use(vl),this.use(pl),this.use(ml);var N=new Proxy(this,{get:function(S,I,$){if(I==="_vip")return!0;if(I==="table")return function(O){return na(c.table(O),N)};var x=Reflect.get(S,I,$);return x instanceof es?na(x,N):I==="tables"?x.map(function(O){return na(O,N)}):I==="_createTransaction"?function(){return na(x.apply(this,arguments),N)}:x}});this.vip=N,d.forEach(function(S){return S(c)})}var ra,on=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",wl=(ei.prototype.subscribe=function(a,o,c){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:o,complete:c})},ei.prototype[on]=function(){return this},ei);function ei(a){this._subscribe=a}try{ra={indexedDB:s.indexedDB||s.mozIndexedDB||s.webkitIndexedDB||s.msIndexedDB,IDBKeyRange:s.IDBKeyRange||s.webkitIDBKeyRange}}catch{ra={indexedDB:null,IDBKeyRange:null}}function _s(a){var o,c=!1,d=new wl(function(p){var m=Pe(a),b,k=!1,A={},C={},N={get closed(){return k},unsubscribe:function(){k||(k=!0,b&&b.abort(),S&&xn.storagemutated.unsubscribe($))}};p.start&&p.start(N);var S=!1,I=function(){return Oa(x)},$=function(O){Zr(A,O),Wa(C,A)&&I()},x=function(){var O,P,q;!k&&ra.indexedDB&&(A={},O={},b&&b.abort(),b=new AbortController,q=function(D){var W=K();try{m&&Xt();var J=Fe(a,D);return J=m?J.finally(Z):J}finally{W&&fe()}}(P={subscr:O,signal:b.signal,requery:I,querier:a,trans:null}),Promise.resolve(q).then(function(D){c=!0,o=D,k||P.signal.aborted||(A={},function(W){for(var J in W)if(y(W,J))return;return 1}(C=O)||S||(xn(wr,$),S=!0),Oa(function(){return!k&&p.next&&p.next(D)}))},function(D){c=!1,["DatabaseClosedError","AbortError"].includes(D==null?void 0:D.name)||k||Oa(function(){k||p.error&&p.error(D)})}))};return setTimeout(I,0),N});return d.hasValue=function(){return c},d.getValue=function(){return o},d}var Bn=kn;function ti(a){var o=On;try{On=!0,xn.storagemutated.fire(a),Ja(a,!0)}finally{On=o}}_(Bn,r(r({},Et),{delete:function(a){return new Bn(a,{addons:[]}).delete()},exists:function(a){return new Bn(a,{addons:[]}).open().then(function(o){return o.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return o=Bn.dependencies,c=o.indexedDB,o=o.IDBKeyRange,(Fa(c)?Promise.resolve(c.databases()).then(function(d){return d.map(function(p){return p.name}).filter(function(p){return p!==Ur})}):za(c,o).toCollection().primaryKeys()).then(a)}catch{return pt(new ce.MissingAPI)}var o,c},defineClass:function(){return function(a){h(this,a)}},ignoreTransaction:function(a){return ve.trans?_n(ve.transless,a):a()},vip:Ka,async:function(a){return function(){try{var o=Ya(a.apply(this,arguments));return o&&typeof o.then=="function"?o:ae.resolve(o)}catch(c){return pt(c)}}},spawn:function(a,o,c){try{var d=Ya(a.apply(c,o||[]));return d&&typeof d.then=="function"?d:ae.resolve(d)}catch(p){return pt(p)}},currentTransaction:{get:function(){return ve.trans||null}},waitFor:function(a,o){return o=ae.resolve(typeof a=="function"?Bn.ignoreTransaction(a):a).timeout(o||6e4),ve.trans?ve.trans.waitFor(o):o},Promise:ae,debug:{get:function(){return Je},set:function(a){lt(a)}},derive:E,extend:h,props:_,override:T,Events:br,on:xn,liveQuery:_s,extendObservabilitySet:Zr,getByKeyPath:R,setByKeyPath:M,delByKeyPath:function(a,o){typeof o=="string"?M(a,o,void 0):"length"in o&&[].map.call(o,function(c){M(a,c,void 0)})},shallowClone:F,deepClone:B,getObjectDiff:Qa,cmp:We,asap:U,minKey:-1/0,addons:[],connections:Jn,errnames:Re,dependencies:ra,cache:Mn,semVer:"4.2.1",version:"4.2.1".split(".").map(function(a){return parseInt(a)}).reduce(function(a,o,c){return a+o/Math.pow(10,2*c)})})),Bn.maxKey=kr(Bn.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(xn(wr,function(a){On||(a=new CustomEvent(La,{detail:a}),On=!0,dispatchEvent(a),On=!1)}),addEventListener(La,function(a){a=a.detail,On||ti(a)}));var Zn,On=!1,ws=function(){};return typeof BroadcastChannel<"u"&&((ws=function(){(Zn=new BroadcastChannel(La)).onmessage=function(a){return a.data&&ti(a.data)}})(),typeof Zn.unref=="function"&&Zn.unref(),xn(wr,function(a){On||Zn.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!kn.disableBfCache&&a.persisted){Je&&console.debug("Dexie: handling persisted pagehide"),Zn!=null&&Zn.close();for(var o=0,c=Jn;o<c.length;o++)c[o].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!kn.disableBfCache&&a.persisted&&(Je&&console.debug("Dexie: handling persisted pageshow"),ws(),ti({all:new Dt(-1/0,[[]])}))})),ae.rejectionMapper=function(a,o){return!a||a instanceof Q||a instanceof TypeError||a instanceof SyntaxError||!a.name||!Rt[a.name]?a:(o=new Rt[a.name](o||a.message,a),"stack"in a&&v(o,"stack",{get:function(){return this.inner.stack}}),o)},lt(Je),r(kn,Object.freeze({__proto__:null,Dexie:kn,liveQuery:_s,Entity:Ji,cmp:We,PropModification:vr,replacePrefix:function(a,o){return new vr({replacePrefix:[a,o]})},add:function(a){return new vr({add:a})},remove:function(a){return new vr({remove:a})},default:kn,RangeSet:Dt,mergeRanges:Ar,rangesOverlap:us}),{default:kn}),kn})})(Oo);var md=Oo.exports;const Ai=pd(md),Js=Symbol.for("Dexie"),va=globalThis[Js]||(globalThis[Js]=Ai);if(Ai.semVer!==va.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Ai.semVer} and ${va.semVer}`);const{liveQuery:kf,mergeRanges:Sf,rangesOverlap:Ef,RangeSet:Af,cmp:Cf,Entity:$f,PropModification:Tf,replacePrefix:xf,add:Of,remove:Rf,DexieYProvider:Nf}=va,vt=new va("dungeonDragon");vt.version(1).stores({characters:"id,user_id",items:"id,character_id,user_id",resources:"id,character_id,user_id",wallet:"character_id,user_id",journal:"id,character_id,user_id",tags:"id,user_id",entryTags:"[entry_id+tag_id],entry_id,tag_id"});async function gd(){var s;const{user:n}=ht();if(!n)return;const e=await vt.characters.where("user_id").equals(n.id).toArray();e.length&&un({characters:e});const t=Sl(n.id),r=bt(t),i=r&&e.some(l=>bt(l.id)===r)?r:bt((s=e[0])==null?void 0:s.id);if(i){Ea(i);const[l,u,h,f,g]=await Promise.all([vt.items.where("character_id").equals(i).toArray(),vt.resources.where("character_id").equals(i).toArray(),vt.journal.where("character_id").equals(i).toArray(),vt.wallet.where("character_id").equals(i).first(),vt.tags.where("user_id").equals(n.id).toArray()]);xt("items",l),xt("resources",u),xt("journal",h),xt("wallet",f??null),xt("tags",g)}}async function qt({characters:n,items:e,resources:t,wallet:r,journal:i,tags:s,entryTags:l}){n&&await vt.characters.bulkPut(n),e&&await vt.items.bulkPut(e),t&&await vt.resources.bulkPut(t),r&&await vt.wallet.put(r),i&&await vt.journal.bulkPut(i),s&&await vt.tags.bulkPut(s),l&&await vt.entryTags.bulkPut(l)}async function vd(){await Promise.all([vt.characters.clear(),vt.items.clear(),vt.resources.clear(),vt.wallet.clear(),vt.journal.clear(),vt.tags.clear(),vt.entryTags.clear()])}async function bd(){var e;const{data:n}=await De.auth.getSession();un({user:((e=n.session)==null?void 0:e.user)??null}),De.auth.onAuthStateChange((t,r)=>{r!=null&&r.user?un({user:r.user}):uo()})}async function Ro(n){var e;if(n){rt(!0);try{await De.from("profiles").upsert({id:n.id,display_name:((e=n.user_metadata)==null?void 0:e.display_name)??""})}finally{rt(!1)}}}async function yd(){var e;const n=(e=ht().user)==null?void 0:e.id;try{await De.auth.signOut()}finally{Al(n),await vd(),uo()}}function _d(n){const e="/dungeons-dragons-app/";n.innerHTML=`
    <section class="login-view auth-screen">
      <div class="card login-card">
        <div class="login-header">
          <img class="login-logo" src="${e}icons/logo_dd.png" alt="Dungeon & Dragon" />
          <div>
            <p class="eyebrow">Dungeons &amp; Dragons</p>
            <p class="login-title">Gestionale Personaggi</p>
          </div>
        </div>
        <p class="login-subtitle">Usa email e password per entrare o creare l'account.</p>
        <form class="login-form" data-login-form>
          <label class="field">
            <span >Email</span>
            <input type="email" name="email" required placeholder="nome@email.it" />
          </label>
          <label class="field">
            <span>Password</span>
            <input type="password" name="password" required minlength="6" />
          </label>
          <div class="login-form__toggle-row">
            <span>Nuovo account</span>
            <label class="diceov-toggle condition-modal__toggle" aria-label="Nuovo account">
              <input type="checkbox" name="signup" />
              <span class="diceov-toggle-track" aria-hidden="true"></span>
            </label>
          </div>
          <div class="login-form__actions">
            <button class="primary" type="submit" data-login-submit>Accedi</button>
          </div>
        </form>
      </div>
    </section>
  `;const t=n.querySelector("[data-login-form]"),r=t.querySelector('input[name="signup"]'),i=t.querySelector("[data-login-submit]"),s=()=>{!i||!r||(i.textContent=r.checked?"Registrati":"Accedi")};r==null||r.addEventListener("change",s),s(),t.addEventListener("submit",async l=>{var w;l.preventDefault();const u=new FormData(t),h=String(u.get("email")),f=String(u.get("password")),g=u.get("signup")==="on",y=()=>{Y("Esiste gi un account con questa email. Prova ad accedere.","error")},_=()=>{Y("Registrazione completata. Conferma l'email prima di procedere con il login.","success")};try{const v=g?await De.auth.signUp({email:h,password:f}):await De.auth.signInWithPassword({email:h,password:f});if(v.error)throw v.error;if(g){const j=(w=v.data.user)==null?void 0:w.identities;if(Array.isArray(j)&&j.length===0){y();return}_(),t.reset(),s();return}const E=v.data.user;E&&(un({user:E}),await Ro(E),window.location.hash="#/characters")}catch(v){const E=String((v==null?void 0:v.message)||"");if(g&&/already\s+(registered|exists|in use)|user\s+already/i.test(E)){y();return}Y(v.message??"Errore login","error")}})}async function No(n){const{data:e,error:t}=await De.from("characters").select("*").eq("user_id",n).order("created_at",{ascending:!0});if(t)throw t;return e??[]}async function wd(n){const{data:e,error:t}=await De.from("characters").insert(n).select("*").single();if(t)throw t;return e}async function Po(n,e){const{data:t,error:r}=await De.from("characters").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function kd(n,e){var h;const{data:t,error:r}=await De.from("resources").select("*").eq("character_id",n);if(r)throw r;const s=(t??[]).map(f=>{const g=Number(f.max_uses)||0,y=Number(f.used)||0;if(g===0||y===0||f.reset_on==="none"||f.reset_on===null)return null;const _=f.recovery_short===null||f.recovery_short===""?NaN:Number(f.recovery_short),w=f.recovery_long===null||f.recovery_long===""?NaN:Number(f.recovery_long),v=f.reset_on==="short_rest"?g:0,E=f.reset_on==="long_rest"?g:0,j=Number.isNaN(_)?v:_,V=Number.isNaN(w)?E:w;if(e==="short_rest"&&f.reset_on!=="short_rest")return null;const T=e==="short_rest"||e==="long_rest"&&f.reset_on==="short_rest"?j:V;if(!T)return null;const H=Math.max(y-T,0);return H===y?null:{id:f.id,used:H}}).filter(Boolean);if(!s.length)return;const u=(h=(await Promise.all(s.map(f=>De.from("resources").update({used:f.used}).eq("id",f.id)))).find(f=>f.error))==null?void 0:h.error;if(u)throw u}async function Io(n){const{data:e,error:t}=await De.from("resources").select("*").eq("character_id",n).order("created_at",{ascending:!0});if(t)throw t;return e??[]}async function Sd(n){const{data:e,error:t}=await De.from("resources").insert(n).select("*").single();if(t)throw t;return e}async function Ci(n,e){const{data:t,error:r}=await De.from("resources").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Ed(n){const{error:e}=await De.from("resources").delete().eq("id",n);if(e)throw e}async function Lo(n){const{data:e,error:t}=await De.from("items").select("*").eq("character_id",n).order("created_at",{ascending:!0});if(t)throw t;return e??[]}async function qo(n){const{data:e,error:t}=await De.from("items").insert(n).select("*").single();if(t)throw t;return e}async function ba(n,e){const{data:t,error:r}=await De.from("items").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Ad(n){const{error:e}=await De.from("items").delete().eq("id",n);if(e)throw e}let ke=null;function Cd(){return`
    <div id="diceRoller"></div>
    <main id="diceRollerUI">
      <div class="top_field" hidden>
        <input type="text" id="textInput" spellcheck="false" inputmode="none" virtualkeyboardpolicy="manual"
               value="1d20"/>
      </div>
      <div id="diceLimit" style="display:none">Wow that's a lot of dice! <br>[Limit: 20]</div>    
      <div id="numPad" class="center_field" style="display:none">
        <table class="numPad">
          <tr><td onclick="main.input('del')" colspan="2">del</td><td onclick="main.input('bksp')" colspan="2">bksp</td></tr>
          <tr><td onclick="main.input('7')">7</td><td onclick="main.input('8')">8</td><td onclick="main.input('9')">9</td><td onclick="main.input('+')" rowspan="2">+</td></tr>
          <tr><td onclick="main.input('4')">4</td><td onclick="main.input('5')">5</td><td onclick="main.input('6')">6</td></tr>
          <tr><td onclick="main.input('1')">1</td><td onclick="main.input('2')">2</td><td onclick="main.input('3')">3</td><td onclick="main.input('-')" rowspan="2">-</td></tr>
          <tr><td onclick="main.input('0')" colspan="2">0</td><td onclick="main.input('d')">d</td></tr>
        </table>
        <button onclick="main.clearInput()">CLEAR</button>
        <button onclick="main.setInput()">OK</button>
      </div>
      <div class="bottom_field" hidden><span id="result"></span></div>
    </main>
  `}function $d(){return`
  <div class="diceov-backdrop" data-close></div>
  <div class="diceov-stage" role="dialog" aria-modal="true" aria-label="Lancio dadi">
    <button class="diceov-close" data-close aria-label="Chiudi" hidden></button>
    <section class="diceov-panel">
      <header class="diceov-header">
        <div>      
          <p class="diceov-eyebrow" data-dice-title>Lancia dadi</h3>
        </div>
      </header>
      <div class="diceov-controls">   
        <div class="diceov-control diceov-control--row" data-modifier-home>
         <div class="diceov-control" data-dice-control="d20">
          <label class="diceov-label" for="dice-roll-mode">Modalit</label>
          <select id="dice-roll-mode" name="dice-roll-mode">
            <option value="normal" selected>Normale</option>
            <option value="advantage">Vantaggio</option>
            <option value="disadvantage">Svantaggio</option>
          </select>
        </div>
          <div class="diceov-control" data-dice-select hidden>
            <label class="diceov-label" for="dice-roll-select" data-dice-select-label>Seleziona</label>
            <select id="dice-roll-select" name="dice-roll-select"></select>
          </div>
          <div class="diceov-field diceov-field--modifier">
            <label class="diceov-label" for="dice-modifier">Mod</label>
            <input id="dice-modifier" type="number" name="dice-modifier" value="0" step="1" />
          </div>
          <div class="diceov-control" data-dice-buff="d20" hidden>
            <label class="diceov-label" for="dice-buff-d20">Buff/Debuff</label>
            <select id="dice-buff-d20" name="dice-buff-d20">
              <option value="none" selected>Nessuno</option>
              <option value="plus-d4">+d4</option>
              <option value="plus-d6">+d6</option>
              <option value="minus-d4">-d4</option>
              <option value="minus-d6">-d6</option>
            </select>
          </div>
           <div class="diceov-control" data-dice-control="d20">
          <div class="diceov-inspiration" data-dice-inspiration>
            <span class="diceov-label">Ispirazione</span>
            <label class="diceov-toggle">
              <input id="dice-inspiration" type="checkbox" name="dice-inspiration" />
              <span class="diceov-toggle-track" aria-hidden="true"></span>
            </label>
          </div>
        </div>
         <p class="diceov-warning" data-inspiration-warning hidden>
              Attenzione: userai il punto ispirazione su questo tiro.
            </p>
         <p class="diceov-warning" data-weakness-warning hidden></p>
         <p class="diceov-warning" data-rollmode-warning hidden></p>
         <p class="diceov-warning" data-autofail-warning hidden></p>
        </div>
       
        <div class="diceov-control" data-dice-control="generic">       
          <div class="diceov-generic-row">
            <div class="diceov-field">
              <label class="diceov-label" for="dice-count">Dadi</label>
              <input id="dice-count" type="number" name="dice-count" min="1" value="1" />
            </div>
            <div class="diceov-field">
              <label class="diceov-label" for="dice-type">Tipo dado</label>
              <select id="dice-type" name="dice-type">
                <option value="d4">d4</option>
                <option value="d6">d6</option>
                <option value="d8">d8</option>
                <option value="d10">d10</option>
                <option value="d12">d12</option>
                <option value="d20" selected>d20</option>
                <option value="d100">d100</option>
              </select>
            </div>
            <div class="diceov-field">
              <label class="diceov-label" for="dice-notation">Notazione</label>
              <input id="dice-notation" class="diceov-generic-notation" type="text" name="dice-notation" value="1d20" spellcheck="false" />
            </div>
            <div class="diceov-field diceov-field--modifier">
              <label class="diceov-label" for="dice-modifier-generic">Mod</label>
              <input id="dice-modifier-generic" type="number" name="dice-modifier-generic" value="0" step="1" />
            </div>
            <div class="diceov-field" data-dice-buff="damage" hidden>
              <label class="diceov-label" for="dice-buff-damage">Buff/Debuff</label>
              <select id="dice-buff-damage" name="dice-buff-damage">
                <option value="none" selected>Nessuno</option>
                <option value="plus-d4">+d4</option>
                <option value="plus-d6">+d6</option>
                <option value="minus-d4">-d4</option>
                <option value="minus-d6">-d6</option>
              </select>
            </div>
          </div>
          <p class="diceov-hint">Puoi combinare dadi diversi (es. 2d6+1d4).</p>
        </div>
      </div>
      <div class="diceov-results">
        <div class="diceov-result diceov-result--full">
          <p class="diceov-result-label">Risultato</p>
          <p class="diceov-result-value" data-dice-result></p>
          <p class="diceov-result-detail" data-dice-detail>Lancia i dadi per vedere il totale.</p>
        </div>
      </div>
    </section>
    ${Cd()}
    <section class="diceov-history-accordion" data-history-accordion>
      <button class="diceov-history-toggle" type="button" data-history-toggle aria-expanded="false">
        <span>Storico tiri</span>
        <span class="diceov-history-toggle-icon" aria-hidden="true"></span>
      </button>
      <div class="diceov-history-panel" data-dice-history-panel hidden>
        <div class="diceov-history-list" data-dice-history></div>
      </div>
    </section>
  </div>`}function Td(n){const e=String(n).match(/\d+/g);return e?parseInt(e[e.length-1],10):null}function hi(n){return(Array.isArray(n==null?void 0:n.result)?n.result:[]).some(t=>typeof t=="number"&&t<0)}const jo="diceRollHistory",xd=12;function Do(n){const e=bt(n);return`${jo}:${e||"global"}`}function Od(n){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(Do(n));if(e){const i=JSON.parse(e);return Array.isArray(i)?i:[]}const t=window.localStorage.getItem(jo),r=t?JSON.parse(t):[];return Array.isArray(r)?r:[]}catch{return[]}}function Rd(n,e){if(!(typeof window>"u"))try{window.localStorage.setItem(Do(e),JSON.stringify(n))}catch{}}function Nd(n){try{return new Date(n).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"})}catch{return n}}function ua(n){return n?n>0?`+${n}`:`${n}`:"+0"}function sr(n){const e=n.querySelector('select[name="dice-roll-mode"]');return(e==null?void 0:e.value)??"normal"}function Ys(n,e){const t=n.querySelector("#textInput");t&&(t.value=e,window.main&&typeof window.main.setInput=="function"&&window.main.setInput())}function da(n){var r,i;const e=Math.max(Number((r=n.querySelector('[name="dice-count"]'))==null?void 0:r.value)||1,1),t=((i=n.querySelector('[name="dice-type"]'))==null?void 0:i.value)||"d20";return`${e}${t}`}function Pd(n,e){const t=String(e||"").trim().match(/^(\d+)\s*d\s*(\d+)$/i);if(!t)return;const r=n.querySelector('[name="dice-count"]'),i=n.querySelector('[name="dice-type"]');r&&(r.value=t[1]),i&&(i.value=`d${t[2]}`)}function Id(n,e){n.dataset.diceMode=e,n.querySelectorAll("[data-dice-control]").forEach(t=>{const r=t.dataset.diceControl===e||t.dataset.diceControl==="d20"&&e==="d20";t.toggleAttribute("hidden",!r)})}function Or({sides:n=20,keepOpen:e=!1,title:t="Lancia dadi",mode:r="generic",notation:i=null,modifier:s=null,selection:l=null,allowInspiration:u=!1,onConsumeInspiration:h=null,rollType:f=null,weakPoints:g=0,characterId:y=null,historyLabel:_=null}={}){var qn;ke||(ke=document.createElement("div"),ke.id="dice-overlay",ke.innerHTML=$d(),document.body.appendChild(ke),window.main&&typeof window.main.init=="function"&&window.main.init(),window.main&&typeof window.main.setInput=="function"&&window.main.setInput(),ke.addEventListener("click",K=>{K.target.closest("[data-close]")&&ur()}),document.addEventListener("keydown",Mo,!0));try{const K=ke.querySelector("#result");K&&(K.textContent="");const fe=ke.querySelector("#diceLimit");fe&&(fe.style.display="none")}catch{}window.main&&typeof window.main.clearDice=="function"&&window.main.clearDice(),(qn=ke.querySelector("[data-dice-title]"))==null||qn.replaceChildren(document.createTextNode(t)),Id(ke,r==="generic"?"generic":"d20");const v=ke.querySelector('input[name="dice-inspiration"]'),E=ke.querySelector("[data-dice-inspiration]"),j=ke.querySelector("[data-inspiration-warning]"),V=ke.querySelector("[data-weakness-warning]"),z=ke.querySelector("[data-rollmode-warning]"),T=ke.querySelector("[data-autofail-warning]"),H=ke.querySelector('select[name="dice-roll-mode"]'),U=ke.querySelector('input[name="dice-modifier"]'),R=U==null?void 0:U.closest(".diceov-field--modifier"),M=ke.querySelector('input[name="dice-modifier-generic"]'),F=ke.querySelector('input[name="dice-notation"]'),pe=ke.querySelector("[data-dice-select]"),Ae=ke.querySelector("[data-dice-select-label]"),G=ke.querySelector('select[name="dice-roll-select"]'),L=ke.querySelector("[data-dice-result]"),B=ke.querySelector("[data-dice-detail]"),X=ke.querySelector('[data-dice-buff="d20"]'),ee=ke.querySelector('select[name="dice-buff-d20"]'),ue=ke.querySelector('[data-dice-buff="damage"]'),be=ke.querySelector('select[name="dice-buff-damage"]'),ge=ke.querySelector(".diceov-stage"),he=ke.querySelector("[data-history-accordion]"),ye=ke.querySelector("[data-history-toggle]"),Pe=ke.querySelector("[data-dice-history-panel]"),Ve=ke.querySelector("[data-dice-history]"),Q={lastRoll:null,lastBuff:null,inspirationAvailable:!!u,inspirationConsumed:!1,selectionOptions:Array.isArray(l==null?void 0:l.options)?l.options:[],history:Od(y),selectionRollMode:null,selectionRollModeReason:null},ze=Math.max(0,Number(g)||0),we=f==="TA"&&ze>=1?"Svantaggio: punti indebolimento (prove di caratteristica).":(f==="TS"||f==="TC")&&ze>=3?"Svantaggio: punti indebolimento (tiri salvezza/colpire).":null;function Oe(){const K=!!we,fe=Q.selectionRollMode,me=fe==="advantage",Ke=K||fe==="disadvantage";return me&&Ke?{mode:"normal",weaknessWarning:null,rollModeWarning:"Vantaggio e svantaggio si annullano: tiro normale."}:{mode:Ke?"disadvantage":me?"advantage":"normal",weaknessWarning:Ke?we:null,rollModeWarning:Q.selectionRollModeReason}}function Re(){return r==="generic"&&M||U}function Be(){if(!R)return;const K=r==="generic";R.toggleAttribute("hidden",K)}function ce(K="",fe="Lancia i dadi per vedere il totale."){L&&(L.textContent=K),B&&(B.textContent=fe),Q.lastRoll=null,Q.lastBuff=null}function Rt(){if(Ve){if(!Q.history.length){Ve.innerHTML='<p class="diceov-history-empty">Nessun tiro ancora.</p>';return}Ve.innerHTML=Q.history.map(K=>`
        <div class="diceov-history-row">
          <div class="diceov-history-type diceov-history-type--${String(K.type||"gen").toLowerCase()}">
            <span class="diceov-history-type-code">${K.type||""}</span>
            ${K.subtype?`<span class="diceov-history-subtype">${K.subtype}</span>`:""}
            ${K.context?`<span class="diceov-history-subtype">${K.context}</span>`:""}
            ${K.inspired?'<span class="diceov-history-flag">Isp.</span>':""}
          </div>
          <span class="diceov-history-rollmode">${K.rollModeLabel||""}</span>
          <span class="diceov-history-total">${K.total??""}</span>
          <span class="diceov-history-date">${Nd(K.timestamp)}</span>
        </div>
      `).join("")}}function Et(K){Q.history=[K,...Q.history].slice(0,xd),Rd(Q.history,y),Rt()}function qe(){if(!H)return;const K=!!(v!=null&&v.checked);if(K){const fe=sr(ke);H.value=fe==="disadvantage"?"normal":"advantage"}else Ut();H.disabled=K,j&&j.toggleAttribute("hidden",!K),at(),Vt()}function At(K){Q.inspirationAvailable=!!K,E&&E.toggleAttribute("hidden",!Q.inspirationAvailable),v&&(v.checked=!1,v.disabled=!Q.inspirationAvailable),!Q.inspirationAvailable&&H&&(H.disabled=!1),!Q.inspirationAvailable&&j&&j.setAttribute("hidden","")}function Nt(){var Ke,Ee;if(!pe||!G)return;if(!Q.selectionOptions.length){pe.setAttribute("hidden",""),G.innerHTML="",Q.selectionRollMode=null,Q.selectionRollModeReason=null,T&&T.setAttribute("hidden","");return}pe.removeAttribute("hidden"),Ae&&(Ae.textContent=(l==null?void 0:l.label)||"Seleziona"),G.innerHTML=Q.selectionOptions.map(Me=>`
        <option value="${Me.value}" ${Me.disabled?"disabled":""}>${Me.label}</option>
      `).join("");const K=Q.selectionOptions.filter(Me=>!Me.disabled),fe=(l==null?void 0:l.value)??((Ke=K[0])==null?void 0:Ke.value)??((Ee=Q.selectionOptions[0])==null?void 0:Ee.value);fe!==void 0&&(G.value=fe);const me=Q.selectionOptions.find(Me=>Me.value===G.value);me&&!me.disabled&&U&&(U.value=Number(me.modifier)||0),Q.selectionRollMode=me!=null&&me.disabled?null:(me==null?void 0:me.rollMode)||null,Q.selectionRollModeReason=me!=null&&me.disabled?null:(me==null?void 0:me.rollModeReason)||null,G&&(G.disabled=K.length===0),ft()}function ft(){if(!T)return;const K=Q.selectionOptions.filter(Ee=>Ee.disabled&&Ee.disabledReason);if(!K.length){T.setAttribute("hidden",""),T.textContent="";return}const fe=K.map(Ee=>Ee.shortLabel||Ee.label||Ee.value).filter(Boolean).join(", "),me=[...new Set(K.map(Ee=>Ee.disabledReason).filter(Boolean))],Ke=me.length?` (${me.join("; ")})`:"";T.textContent=`TS ${fe}: fallimento diretto${Ke}.`,T.removeAttribute("hidden")}function at(){if(!V)return;const K=Oe(),fe=!!K.weaknessWarning&&sr(ke)==="disadvantage";V.textContent=K.weaknessWarning??"",V.toggleAttribute("hidden",!fe)}function Vt(){if(!z)return;const K=Oe(),fe=sr(ke),me=!!K.rollModeWarning&&K.mode===fe;z.textContent=K.rollModeWarning??"",z.toggleAttribute("hidden",!me)}function Ut(){if(!H)return;const K=Oe();H.value=K.mode,at(),Vt(),st()}function it(){return f==="DMG"&&r==="generic"?{wrapper:ue,select:be}:{wrapper:X,select:ee}}function yt(){const K=["TS","TA","TC","DMG"].includes(f),fe=f==="DMG"&&r==="generic";X&&X.toggleAttribute("hidden",!(K&&!fe)),ue&&ue.toggleAttribute("hidden",!(K&&fe)),ee&&(ee.value="none"),be&&(be.value="none"),K||(Q.lastBuff=null)}function Je(){const{wrapper:K,select:fe}=it();if(!fe||K!=null&&K.hasAttribute("hidden"))return null;const me=fe.value;if(me==="none")return null;const Ke=me.endsWith("d6")?6:4,Ee=me.startsWith("plus"),Me=`${Ee?"+":"-"}d${Ke}`;return{choice:me,sides:Ke,label:Me,sign:Ee?1:-1}}function lt(K){const fe=K.result||[],me=sr(ke),Ke=me==="normal"?1:2,Ee=fe.slice(0,Ke),Me=Je();let sn=null;if(Me&&fe.length>Ke){const Pt=fe[Ke];typeof Pt=="number"&&(sn={...Me,roll:Pt,delta:Me.sign*Pt})}const Ht=Ee.length?me==="advantage"?Math.max(...Ee):me==="disadvantage"?Math.min(...Ee):Ee[0]:null;return{rollMode:me,baseRolls:Ee,picked:Ht,buff:sn}}function Xe(K){const fe=K.result||[],me=Je();if(me&&fe.length){const Ke=fe[fe.length-1];if(typeof Ke=="number")return{baseRolls:fe.slice(0,-1),buff:{...me,roll:Ke,delta:me.sign*Ke}}}return{baseRolls:fe,buff:null}}function Ne(K){if(!(!he||!ye||!Pe)&&(he.classList.toggle("is-open",K),ye.setAttribute("aria-expanded",String(K)),Pe.toggleAttribute("hidden",!K),ge==null||ge.classList.toggle("diceov-stage--history-open",K),K)){const fe=ke.querySelector(".diceov-header");if(fe&&ge){const me=Math.max(fe.getBoundingClientRect().bottom-ge.getBoundingClientRect().top,0);he.style.setProperty("--diceov-history-offset",`${me}px`)}}}function Ct(){if(!G)return null;const K=Q.selectionOptions.find(me=>me.value===G.value);return K&&(K.shortLabel||K.label||"").replace(/\s*\([^)]*\)\s*$/,"").trim()||null}function st(){if(r!=="generic"){const fe=sr(ke)==="normal"?1:2,me=Je(),Ke=me?`+1d${me.sides}`:"";Ys(ke,`${fe}d${n}${Ke}`),ce()}}function _t(){var Ee;const fe=((Ee=F==null?void 0:F.value)==null?void 0:Ee.trim())||da(ke),me=Je(),Ke=me?`${fe}${me.sign<0?"-":"+"}1d${me.sides}`:fe;Ys(ke,Ke),ce()}function wt(){Q.lastRoll&&Gt(Q.lastRoll)}async function jt(){!Q.inspirationAvailable||Q.inspirationConsumed||v!=null&&v.checked&&(Q.inspirationConsumed=!0,At(!1),typeof h=="function"&&await h())}function Gt(K){var Pt,Qt,zt;if(hi(K)){ce("","Lancio non valido, rilancia i dadi.");return}const fe=Number((Pt=Re())==null?void 0:Pt.value)||0;if(r!=="generic"){const Fe=lt(K);if(Q.lastBuff=Fe.buff,!Fe.baseRolls.length){ce();return}const Xt=((Qt=Fe.buff)==null?void 0:Qt.delta)||0,Z=(Fe.picked??0)+fe+Xt,xe=Fe.rollMode==="advantage"?"Vantaggio":Fe.rollMode==="disadvantage"?"Svantaggio":"Normale",Qe=Fe.baseRolls.join(", ");if(L&&(L.textContent=`${Z}`),B){const He=Fe.baseRolls.length>1?` (selezionato ${Fe.picked})`:"",ct=[`${xe}: ${Qe}${He}`,`Mod ${ua(fe)}`];Fe.buff&&ct.push(`${Fe.buff.label} (d${Fe.buff.sides}: ${Fe.buff.roll})`),B.textContent=ct.join("  ")}return}const me=Xe(K);Q.lastBuff=me.buff;const Ke=me.baseRolls.reduce((Fe,Xt)=>Fe+Xt,0),Ee=Number(K.constant)||0,Me=((zt=me.buff)==null?void 0:zt.delta)||0,sn=Ke+Ee+fe+Me,Ht=me.baseRolls.length?`Dadi: ${me.baseRolls.join(", ")}`:"Dadi: ";if(L&&(L.textContent=`${sn}`),B){const Fe=[Ht];Ee&&Fe.push(`Costante ${ua(Ee)}`),fe&&Fe.push(`Mod ${ua(fe)}`),me.buff&&Fe.push(`${me.buff.label} ${ua(me.buff.delta)} (d${me.buff.sides}: ${me.buff.roll})`),B.textContent=Fe.join("  ")}}function Jt(K){var Ht,Pt,Qt;if(hi(K))return null;const fe=Number((Ht=Re())==null?void 0:Ht.value)||0;if(r!=="generic"){const zt=lt(K);if(Q.lastBuff=zt.buff,!zt.baseRolls.length)return null;const Fe=((Pt=zt.buff)==null?void 0:Pt.delta)||0;return{value:zt.picked,total:(zt.picked??0)+fe+Fe}}const me=Xe(K);Q.lastBuff=me.buff;const Ke=me.baseRolls.reduce((zt,Fe)=>zt+Fe,0),Ee=Number(K.constant)||0,Me=((Qt=me.buff)==null?void 0:Qt.delta)||0,sn=Ke+Ee;return{value:sn,total:sn+fe+Me}}function $t(){const K=sr(ke);return["TS","TA","TC"].includes(f)?K==="advantage"?"Vantaggio":K==="disadvantage"?"Svantaggio":"Normale":(f==="GEN"||f===null)&&["advantage","disadvantage"].includes(K)?K==="advantage"?"Vantaggio":"Svantaggio":null}v&&(v.onchange=()=>{qe(),st()}),H&&(H.onchange=()=>{at(),Vt(),st()}),U&&(U.oninput=wt),M&&(M.oninput=wt),F&&(F.oninput=_t),G&&(G.onchange=()=>{const K=Q.selectionOptions.find(fe=>fe.value===G.value);K&&!K.disabled&&U&&(U.value=Number(K.modifier)||0),Q.selectionRollMode=K!=null&&K.disabled?null:(K==null?void 0:K.rollMode)||null,Q.selectionRollModeReason=K!=null&&K.disabled?null:(K==null?void 0:K.rollModeReason)||null,v!=null&&v.checked||Ut(),wt()});const le=ke.querySelector('[name="dice-count"]');le&&(le.oninput=()=>{const K=da(ke);F&&(F.value=K),_t()});const Ye=ke.querySelector('[name="dice-type"]');Ye&&(Ye.onchange=()=>{const K=da(ke);F&&(F.value=K),_t()});const Ce=()=>{Q.lastBuff=null,r==="generic"?_t():st()};ee&&(ee.onchange=Ce),be&&(be.onchange=Ce),ye&&(ye.onclick=()=>{const K=!(he!=null&&he.classList.contains("is-open"));Ne(K)}),Nt(),yt(),At(Q.inspirationAvailable),Ut(),qe(),Be(),Rt(),Ne(!1),ke.removeAttribute("hidden");const ve=s!=null&&s!=="",an=Re();if(an&&ve&&Number.isFinite(Number(s))&&(an.value=Number(s)),r==="generic"){const K=ke.querySelector('[name="dice-count"]'),fe=ke.querySelector('[name="dice-type"]');K&&(K.value="1"),fe&&(fe.value="d20"),F&&(F.value="1d20"),M&&!ve&&(M.value="0"),F&&i&&(F.value=String(i).trim(),Pd(ke,F.value)),F&&!F.value&&(F.value=da(ke)),_t()}else st();const et=ke.querySelector("#result");let mn=null,ae;const An=new Promise(K=>{ae=K}),Gn=()=>{const K=Td((et==null?void 0:et.textContent)||"");K!=null&&(mn=K,jt(),e||ur(),Cn(),ae(K))},Yt=et?new MutationObserver(Gn):null;Yt==null||Yt.observe(et,{childList:!0,characterData:!0,subtree:!0});function Cn(){try{Yt==null||Yt.disconnect()}catch{}}const $n=K=>{if(!(!ke||ke.hasAttribute("hidden"))){if(Q.lastRoll=K.detail||null,Q.lastBuff=null,Q.lastRoll){if(hi(Q.lastRoll)){ce("","Lancio non valido, rilancia i dadi.");return}jt(),Gt(Q.lastRoll)}if(Q.lastRoll){const fe=Jt(Q.lastRoll);fe&&Et({type:f||"GEN",subtype:Ct(),context:_,inspired:Q.inspirationConsumed,rollModeLabel:$t(),value:fe.value,total:fe.total,timestamp:new Date().toISOString()})}}};window.addEventListener("diceRoll",$n);const Ln=ur;return ur=function(){Cn(),window.removeEventListener("diceRoll",$n),ke&&ke.setAttribute("hidden",""),mn==null&&(ae==null||ae(null)),ur=Ln},{waitForRoll:An,close:()=>{Cn(),Ln()}}}function Mo(n){n.key==="Escape"&&ur()}function ur(){ke&&(document.removeEventListener("keydown",Mo,!0),ke.setAttribute("hidden",""))}const pn={str:"FOR",dex:"DES",con:"COS",int:"INT",wis:"SAG",cha:"CAR"},ya=[{key:"acrobatics",label:"Acrobazia",ability:"dex"},{key:"animal_handling",label:"Addestrare animali",ability:"wis"},{key:"arcana",label:"Arcano",ability:"int"},{key:"athletics",label:"Atletica",ability:"str"},{key:"deception",label:"Inganno",ability:"cha"},{key:"history",label:"Storia",ability:"int"},{key:"insight",label:"Intuizione",ability:"wis"},{key:"intimidation",label:"Intimidire",ability:"cha"},{key:"investigation",label:"Indagare",ability:"int"},{key:"medicine",label:"Medicina",ability:"wis"},{key:"nature",label:"Natura",ability:"int"},{key:"perception",label:"Percezione",ability:"wis"},{key:"performance",label:"Intrattenere",ability:"cha"},{key:"persuasion",label:"Persuasione",ability:"cha"},{key:"religion",label:"Religione",ability:"int"},{key:"sleight_of_hand",label:"Rapidit di mano",ability:"dex"},{key:"stealth",label:"Furtivit",ability:"dex"},{key:"survival",label:"Sopravvivenza",ability:"wis"}],_a=[{key:"str",label:"Forza"},{key:"dex",label:"Destrezza"},{key:"con",label:"Costituzione"},{key:"int",label:"Intelligenza"},{key:"wis",label:"Saggezza"},{key:"cha",label:"Carisma"}],Mi=[{key:"accecato",label:"Accecato",effect:"Fallisce le prove basate sulla vista; attacchi contro con vantaggio, suoi attacchi con svantaggio."},{key:"affascinato",label:"Affascinato",effect:"Non pu attaccare lammaliatore; lammaliatore ha vantaggio alle prove sociali."},{key:"assordato",label:"Assordato",effect:"Fallisce le prove basate sulludito."},{key:"avvelenato",label:"Avvelenato",effect:"Svantaggio ai tiri per colpire e alle prove di caratteristica."},{key:"incapacitato",label:"Incapacitato",effect:"Non pu compiere azioni o reazioni."},{key:"intralciato",label:"Intralciato",effect:"Velocit 0; attacchi contro con vantaggio, suoi attacchi con svantaggio; svantaggio ai TS di Destrezza."},{key:"invisibile",label:"Invisibile",effect:"Impossibile da vedere senza mezzi speciali; attacchi contro con svantaggio, suoi attacchi con vantaggio."},{key:"paralizzato",label:"Paralizzato",effect:"Incapacitato; non pu muoversi o parlare; fallisce TS Forza/Destrezza; attacchi contro con vantaggio e critici in mischia."},{key:"pietrificato",label:"Pietrificato",effect:"Incapacitato, non si muove/parla; resistenza a tutti i danni; immunit a veleno e malattie."},{key:"privo_di_sensi",label:"Privo di sensi",effect:"Incapacitato; prono; fallisce TS Forza/Destrezza; attacchi contro con vantaggio e critici in mischia."},{key:"prono",label:"Prono",effect:"Pu solo strisciare; attacchi contro con vantaggio in mischia e svantaggio a distanza; suoi attacchi con svantaggio."},{key:"spaventato",label:"Spaventato",effect:"Svantaggio a prove/attacchi mentre la fonte  in vista; non pu avvicinarsi volontariamente."},{key:"stordito",label:"Stordito",effect:"Incapacitato; non pu muoversi; fallisce TS Forza/Destrezza; attacchi contro con vantaggio."},{key:"trattenuto",label:"Trattenuto",effect:"Velocit 0; termina se lafferrante  incapacitato o se la creatura  allontanata."}],$i=[{key:"weapon_simple",label:"Armi semplici"},{key:"weapon_martial",label:"Armi da guerra"},{key:"armor_light",label:"Armature leggere"},{key:"armor_medium",label:"Armature medie"},{key:"armor_heavy",label:"Armature pesanti"},{key:"shield",label:"Scudi"}],ha=[{label:"Sempre attiva",className:"resource-chip--always"},{label:"Azione Gratuita",className:"resource-chip--free"},{label:"Azione Bonus",className:"resource-chip--bonus"},{label:"Reazione",className:"resource-chip--reaction"},{label:"Azione",className:"resource-chip--action"}];function Ti(n){return n?n.split(/[,;\n]/).map(e=>e.trim()).filter(Boolean):[]}function Ld(n){if(!n)return{tools:[],languages:[]};const e=n.replace(/\r/g,""),t=/(lingue|lingua|strumenti|strumento)\s*:/gi,r={tools:[],languages:[]};let i=0,s=null,l;const u=(h,f)=>{if(!h||!f)return;const g=f.split(/[,;\n]/).map(y=>y.trim()).filter(Boolean);r[h].push(...g)};for(;(l=t.exec(e))!==null;)s&&u(s,e.slice(i,l.index)),s=l[1].toLowerCase().startsWith("ling")?"languages":"tools",i=t.lastIndex;return s?(u(s,e.slice(i)),r):{tools:Ti(n),languages:[]}}function St(n){if(n==null||n==="")return null;const e=Number(n);return Number.isNaN(e)?null:e}function Wt(n){const e=St(n);return e===null?null:Math.floor((e-10)/2)}function Br(n,e,t){const r=Wt(n);if(r===null)return null;const i=t>0&&e!==null?e*t:0;return r+i}function qd(n,e,t,r){const i=!!t.perception,s=!!r.perception,l=Br(n.wis,e,i?s?2:1:0);return l===null?null:10+l}function Bo(n){if(!n||typeof n!="string")return null;const e=n.trim().match(/d(\d+)/i);if(!e)return null;const t=Number(e[1]);return Number.isNaN(t)?null:t}function jd(n){return Math.floor(Math.random()*n)+1}function Bi(n){if(!n||typeof n!="string")return null;const e=n.trim();if(!e)return null;const t=/([+-]?)\s*(\d+)\s*d\s*(\d+)/gi,r=[];let i;for(;(i=t.exec(e))!==null;){const u=i[1]==="-"?-1:1,h=Number(i[2]),f=Number(i[3]);if(!Number.isFinite(h)||!Number.isFinite(f)||!h||!f)return null;r.push({count:h,sides:f,sign:u})}return!r.length||e.replace(t,"").trim()?null:{notation:r.map((u,h)=>`${u.sign<0?"-":h===0?"":"+"}${u.count}d${u.sides}`).join(""),parts:r}}function gt(n){return n==null||Number.isNaN(n)?"-":n>=0?`+${n}`:`${n}`}function Dd(n){const e=Wt(n);return gt(e)}function Md(n){if(!n)return"-";const e=n.used??"-",t=n.max??"-",r=n.die?` ${n.die}`:"";return e==="-"&&t==="-"&&!r?"-":e==="-"||t==="-"?`${e} / ${t}${r}`:`${Math.max(Number(t)-Number(e),0)} / ${t}${r}`}function Bd(n,e,t){const r=(t||[]).filter(v=>v.equipable&&In(v).length),i=Wt(e.dex)??0,s=n.ac_ability_modifiers||{},l=Object.keys(s).filter(v=>s[v]).reduce((v,E)=>v+(Wt(e[E])??0),0),u=St(n.ac_bonus)??0,h=r.filter(v=>v.category==="armor"&&!v.is_shield),f=r.filter(v=>v.is_shield).reduce((v,E)=>v+(Number(E.shield_bonus)||0),0),g=h.map(v=>{const E=Number(v.armor_class);if(!E)return null;const j=Number(v.armor_bonus)||0;return v.armor_type==="heavy"?E+j:v.armor_type==="medium"?E+j+Math.min(i,2):E+j+i}).filter(v=>v!==null),y=g.length?Math.max(...g):null,_=St(n.ac);return(y??_??10+i+l)+f+u}function In(n){if(!n)return[];if(Array.isArray(n.equip_slots))return n.equip_slots.filter(Boolean);if(typeof n.equip_slots=="string"&&n.equip_slots.trim())try{const e=JSON.parse(n.equip_slots);if(Array.isArray(e))return e.filter(Boolean)}catch{return[n.equip_slots]}return n.equip_slot?[n.equip_slot]:[]}function Ta(n){return[...n].sort((e,t)=>{const r=Number(e.level)-Number(t.level);return r!==0?r:(e.name??"").localeCompare(t.name??"","it",{sensitivity:"base"})})}function Ui(n){return n.kind==="cantrip"||Number(n.level)===0?"Trucchetto":"Incantesimo"}function Ud(n,e){var y;if(!n||!e)return null;const t=n.data||{},r=e.weapon_range||(e.range_normal?"ranged":"melee"),i=e.attack_ability||(r==="ranged"?"dex":"str"),s=Wt((y=t.abilities)==null?void 0:y[i])??0,l=Number(t.damage_bonus_melee??t.damage_bonus)||0,u=Number(t.damage_bonus_ranged??t.damage_bonus)||0,h=r==="ranged"?u:l,f=s+(Number(e.damage_modifier)||0)+h,g=Bi(e.damage_die);return g?{title:`Danni ${e.name}`,notation:g.notation,modifier:f}:null}function Uo(n){if(!n)return null;const e=Bi(n.damage_die);if(!e)return null;const t=Number(n.damage_modifier)||0;return{title:`Danni ${n.name}`,notation:e.notation,modifier:t}}function zd(n){if(!n)return null;const e=n.hit_dice||{},t=Number(e.max)||0,r=Number(e.used)||0;if(!t||!r)return null;const i=Math.floor(t/2);if(!i)return null;const s=Math.max(r-Math.min(i,r),0);return s===r?null:{...e,used:s}}function Fd(n){if(!n)return null;let e=!1;const t=n.hp||{},r=St(t.max),i={...n};r!=null&&(Number(t.current)||0)!==r&&(i.hp={...t,current:r},e=!0);const s=zd(n);return s&&(i.hit_dice=s,e=!0),e?i:null}function Kd(n,e){if(!n)return null;let t=n;e==="long_rest"&&(t=Fd(n)||n);const r=Hd(t,e);return r&&(t=r),t===n?null:t}function Hd(n,e){if(!n)return null;const t=n.spellcasting||{};if(!t||!t.slots)return null;const r=t.recharge||"long_rest";if(!(e==="long_rest"||r==="short_rest"))return null;const s=Array.from({length:9},(f,g)=>g+1),l={...t.slots||{}},u={...t.slots_max||{}};let h=!1;return s.forEach(f=>{const g=Math.max(0,Number(l[f])||0),y=Number(u[f]),_=Number.isFinite(y)&&y>0?y:g;_!==y&&(u[f]=_,h=!0),_>0&&g!==_&&(l[f]=_,h=!0)}),h?{...n,spellcasting:{...t,slots:l,slots_max:u}}:null}async function xi(n,e,t=null){var qn,K,fe,me,Ke,Ee,Me,sn,Ht,Pt,Qt,zt,Fe,Xt;if(!n)return;const r=(t==null?void 0:t.data)||{},i=r.hp||{},s=r.hit_dice||{},l=r.abilities||{},u=r.skills||{},h=r.skill_mastery||{},f=r.saving_throws||{},g=r.proficiencies||{},y=r.ac_ability_modifiers||{},_=r.spellcasting||{},w=_.slots||{},v=Array.isArray(r.spells)?Ta(r.spells):[],E=document.createElement("div");E.className="character-edit-form";const j=(Z,xe)=>{const Qe=document.createElement("section");Qe.className="character-edit-group",Qe.innerHTML=`<h3>${Z}</h3>`;const He=document.createElement("div");return He.className="character-edit-group__content",xe.forEach(ct=>{ct.classList.add("character-edit-subsection"),He.appendChild(ct)}),Qe.appendChild(He),Qe},V=document.createElement("div");V.className="character-edit-section",V.innerHTML="<h4>Dati principali</h4>";const z=de({label:"Nome",name:"name",placeholder:"Es. Aria",value:(t==null?void 0:t.name)??""});z.querySelector("input").required=!0,V.appendChild(z),V.appendChild(de({label:"Sistema",name:"system",placeholder:"Es. D&D 5e",value:(t==null?void 0:t.system)??""}));const T=document.createElement("div");T.className="character-edit-grid",T.appendChild(de({label:"Livello",name:"level",type:"number",value:r.level??""})),T.appendChild(de({label:"Razza",name:"race",value:r.race??""})),T.appendChild(de({label:"Allineamento",name:"alignment",value:r.alignment??""})),T.appendChild(de({label:"Background",name:"background",value:r.background??""})),T.appendChild(de({label:"Classe",name:"class_name",value:r.class_name??r.class_archetype??""})),T.appendChild(de({label:"Archetipo",name:"archetype",value:r.archetype??""})),V.appendChild(T),V.appendChild(de({label:"Foto (URL)",name:"avatar_url",placeholder:"https://.../ritratto.png",value:r.avatar_url??""})),V.appendChild(yn({label:"Descrizione background",name:"description",placeholder:"Dettagli sul background, origini e tratti distintivi...",value:r.description??""}));const H=document.createElement("div");H.className="character-edit-section",H.innerHTML="<h4>Statistiche base</h4>";const U=document.createElement("div");U.className="character-edit-grid",U.appendChild(de({label:"Bonus competenza",name:"proficiency_bonus",type:"number",value:r.proficiency_bonus??""})),U.appendChild(de({label:"Iniziativa",name:"initiative",type:"number",value:r.initiative??""})),U.appendChild(de({label:"Classe Armatura",name:"ac",type:"number",value:r.ac??""})),U.appendChild(de({label:"Velocit",name:"speed",type:"number",value:r.speed??""})),U.appendChild(de({label:"HP attuali",name:"hp_current",type:"number",value:i.current??""})),U.appendChild(de({label:"HP temporanei",name:"hp_temp",type:"number",value:i.temp??""})),U.appendChild(de({label:"HP massimi",name:"hp_max",type:"number",value:i.max??""})),U.appendChild(de({label:"Dado vita (es. d8)",name:"hit_dice_die",value:s.die??""})),U.appendChild(de({label:"Dadi vita totali",name:"hit_dice_max",type:"number",value:s.max??""})),U.appendChild(de({label:"Dadi vita usati",name:"hit_dice_used",type:"number",value:s.used??""})),H.appendChild(U);const R=document.createElement("div");R.className="character-edit-section",R.innerHTML=`
    <h4>Opzioni CA base</h4>
    <p class="muted">Base = 10 + Destrezza. Seleziona eventuali modificatori extra.</p>
    <div class="character-saving-grid">
      ${[{key:"str",label:"Forza"},{key:"con",label:"Costituzione"},{key:"int",label:"Intelligenza"},{key:"wis",label:"Saggezza"},{key:"cha",label:"Carisma"}].map(Z=>`
        <label class="toggle-pill">
          <input type="checkbox" name="ac_mod_${Z.key}" ${y[Z.key]?"checked":""} />
          <span>${Z.label}</span>
        </label>
      `).join("")}
    </div>
  `,R.appendChild(de({label:"Modificatore CA totale",name:"ac_bonus",type:"number",value:r.ac_bonus??0}));const M=document.createElement("div");M.className="character-edit-section",M.innerHTML="<h4>Caratteristiche</h4>";const F=document.createElement("div");F.className="character-edit-grid",F.appendChild(de({label:"Forza",name:"ability_str",type:"number",value:l.str??""})),F.appendChild(de({label:"Destrezza",name:"ability_dex",type:"number",value:l.dex??""})),F.appendChild(de({label:"Costituzione",name:"ability_con",type:"number",value:l.con??""})),F.appendChild(de({label:"Intelligenza",name:"ability_int",type:"number",value:l.int??""})),F.appendChild(de({label:"Saggezza",name:"ability_wis",type:"number",value:l.wis??""})),F.appendChild(de({label:"Carisma",name:"ability_cha",type:"number",value:l.cha??""})),M.appendChild(F);const pe=document.createElement("div");pe.className="character-edit-section",pe.innerHTML=`
    <h4>Competenze e maestria</h4>
    <div class="character-skill-grid">
      ${ya.map(Z=>{const xe=!!u[Z.key],Qe=!!h[Z.key];return`
        <div class="character-skill-row">
          <div>
            <strong>${Z.label}</strong>
            <span class="muted">${pn[Z.ability]}</span>
          </div>
          <div class="character-toggle-group">
            <label class="toggle-pill">
              <input type="checkbox" name="skill_${Z.key}" ${xe?"checked":""} />
              <span>Competenza</span>
            </label>
            <label class="toggle-pill">
              <input type="checkbox" name="mastery_${Z.key}" ${Qe?"checked":""} />
              <span>Maestria</span>
            </label>
          </div>
        </div>
      `}).join("")}
    </div>
  `;const Ae=document.createElement("div");Ae.className="character-edit-section",Ae.innerHTML=`
    <h4>Tiri salvezza</h4>
    <div class="character-saving-grid">
      ${_a.map(Z=>{const xe=!!f[Z.key];return`
        <label class="toggle-pill">
          <input type="checkbox" name="save_${Z.key}" ${xe?"checked":""} />
          <span>${Z.label}</span>
        </label>
      `}).join("")}
    </div>
  `;const G=document.createElement("div");G.className="character-edit-section",G.innerHTML=`
    <h4>Competenze equipaggiamento</h4>
    <div class="character-saving-grid">
      ${$i.map(Z=>{const xe=!!g[Z.key];return`
        <label class="toggle-pill">
          <input type="checkbox" name="prof_${Z.key}" ${xe?"checked":""} />
          <span>${Z.label}</span>
        </label>
      `}).join("")}
    </div>
  `;const L=document.createElement("div");L.className="character-edit-section",L.innerHTML="<h4>Combattimento e magia</h4>";const B=document.createElement("div");B.className="character-edit-grid",B.appendChild(de({label:"Bonus attacco extra (mischia)",name:"attack_bonus_melee",type:"number",value:r.attack_bonus_melee??r.attack_bonus??0})),B.appendChild(de({label:"Bonus attacco extra (distanza)",name:"attack_bonus_ranged",type:"number",value:r.attack_bonus_ranged??r.attack_bonus??0})),B.appendChild(de({label:"Attacchi extra",name:"extra_attacks",type:"number",value:r.extra_attacks??0})),B.appendChild(de({label:"Bonus danni extra (mischia)",name:"damage_bonus_melee",type:"number",value:r.damage_bonus_melee??r.damage_bonus??0})),B.appendChild(de({label:"Bonus danni extra (distanza)",name:"damage_bonus_ranged",type:"number",value:r.damage_bonus_ranged??r.damage_bonus??0})),L.appendChild(B);const X=document.createElement("label");X.className="checkbox",X.innerHTML='<input type="checkbox" name="is_spellcaster" /> <span>Incantatore</span>';const ee=X.querySelector("input");ee&&(ee.checked=!!r.is_spellcaster),L.appendChild(X);const ue=document.createElement("div");ue.className="character-edit-section spellcasting-section",ue.innerHTML="<h4>Incantesimi</h4>";const be=document.createElement("div");be.className="character-edit-grid";const ge=document.createElement("label");ge.className="field",ge.innerHTML="<span>Caratteristica da incantatore</span>";const he=ln([{value:"",label:"Seleziona..."},{value:"int",label:"Intelligenza"},{value:"wis",label:"Saggezza"},{value:"cha",label:"Carisma"},{value:"str",label:"Forza"},{value:"dex",label:"Destrezza"},{value:"con",label:"Costituzione"}],_.ability??"");he.name="spellcasting_ability",ge.appendChild(he),be.appendChild(ge);const ye=de({label:"CD incantesimi",name:"spell_save_dc",type:"number",value:""}),Pe=ye.querySelector("input");Pe&&(Pe.readOnly=!0,Pe.disabled=!0),be.appendChild(ye);const Ve=de({label:"Tiro per colpire incantesimi",name:"spell_attack_bonus",type:"number",value:""}),Q=Ve.querySelector("input");Q&&(Q.readOnly=!0,Q.disabled=!0),be.appendChild(Ve),ue.appendChild(be);const ze=document.createElement("div");ze.className="character-edit-grid",Array.from({length:9},(Z,xe)=>xe+1).forEach(Z=>{ze.appendChild(de({label:`Slot ${Z}`,name:`spell_slot_${Z}`,type:"number",value:w[Z]??0}))}),ue.appendChild(ze);const we=document.createElement("label");we.className="field",we.innerHTML="<span>Ricarica slot</span>";const Oe=ln([{value:"short_rest",label:"Riposo breve"},{value:"long_rest",label:"Riposo lungo"}],_.recharge??"long_rest");Oe.name="spell_slot_recharge",we.appendChild(Oe),ue.appendChild(we);const Re=document.createElement("label");Re.className="checkbox",Re.innerHTML='<input type="checkbox" name="spell_can_prepare" /> <span>Incantatore con preparazione</span>';const Be=Re.querySelector("input");Be&&(Be.checked=!!_.can_prepare),ue.appendChild(Re),ue.appendChild(yn({label:"Incantesimi (note)",name:"spell_notes",placeholder:"Descrivi gli incantesimi noti/preparati e gli slot principali.",value:r.spell_notes??""}));const ce=document.createElement("div");ce.className="character-edit-section",ce.innerHTML=`
    <h4>Gestione incantesimi</h4>
    ${v.length?`
      <p class="muted">Seleziona gli incantesimi da rimuovere.</p>
      <div class="character-edit-spell-list">
        ${v.map(Z=>`
          <label class="character-edit-spell-row">
            <input type="checkbox" name="remove_spell_${Z.id}" />
            <span>
              <strong>${Z.name}</strong>
              <small>${Ui(Z)}  Livello ${Number(Z.level)||0}</small>
            </span>
          </label>
        `).join("")}
      </div>
    `:'<p class="muted">Nessun incantesimo configurato.</p>'}
  `,L.appendChild(ue),L.appendChild(ce);const Rt={str:M.querySelector('input[name="ability_str"]'),dex:M.querySelector('input[name="ability_dex"]'),con:M.querySelector('input[name="ability_con"]'),int:M.querySelector('input[name="ability_int"]'),wis:M.querySelector('input[name="ability_wis"]'),cha:M.querySelector('input[name="ability_cha"]')},Et=H.querySelector('input[name="proficiency_bonus"]'),qe=()=>{var gr;const Z=he.value,xe=Z?(gr=Rt[Z])==null?void 0:gr.value:null,Qe=Wt(xe),He=St(Et==null?void 0:Et.value),ct=Qe===null||He===null?"":String(8+Qe+He),_n=Qe===null||He===null?"":String(Qe+He);Pe&&(Pe.value=ct),Q&&(Q.value=_n)},At=()=>{ee&&(ue.style.display=ee.checked?"":"none")};ee==null||ee.addEventListener("change",At),he.addEventListener("change",qe),Object.values(Rt).forEach(Z=>Z==null?void 0:Z.addEventListener("input",qe)),Et==null||Et.addEventListener("input",qe),At(),qe();const Nt=document.createElement("div");Nt.className="character-edit-section",Nt.appendChild(yn({label:"Competenze (strumenti, lingue, ecc.)",name:"proficiency_notes",placeholder:"Es. Strumenti: kit da ladro, strumenti musicali; Lingue: comune, elfico",value:r.proficiency_notes??""}));const ft=document.createElement("div");ft.className="character-edit-section",ft.appendChild(yn({label:"Lingue conosciute",name:"language_proficiencies",placeholder:"Es. comune, elfico, draconico",value:r.language_proficiencies??""}));const at=document.createElement("div");at.className="character-edit-section",at.appendChild(yn({label:"Talenti",name:"talents",placeholder:"Es. Maestro d'armi, Tiratore scelto",value:r.talents??""}));const Vt=[{title:"Identit e background",content:j("Identit e background",[V])},{title:"Statistiche e difese",content:j("Statistiche e difese",[H,R])},{title:"Caratteristiche e competenze",content:j("Caratteristiche e competenze",[M,pe,Ae,G])},{title:"Combattimento e magia",content:j("Combattimento e magia",[L])},{title:"Note e dettagli",content:j("Note e dettagli",[Nt,ft,at])}],Ut=document.createElement("div");Ut.className="character-edit-stepper";const it=document.createElement("ol");it.className="character-edit-stepper-nav";const yt=document.createElement("div");yt.className="character-edit-stepper-content";const Je=document.createElement("div");Je.className="character-edit-stepper-actions";const lt=document.createElement("button");lt.type="button",lt.className="secondary",lt.textContent="Indietro";const Xe=document.createElement("button");Xe.type="button",Xe.className="primary",Xe.textContent="Avanti",Je.append(lt,Xe);const Ne=[],Ct=[];Vt.forEach((Z,xe)=>{const Qe=document.createElement("li"),He=document.createElement("button");He.type="button",He.className="character-edit-stepper-button",He.innerHTML=`<span class="step-index">${xe+1}</span><span>${Z.title}</span>`,Qe.appendChild(He),it.appendChild(Qe),Ne.push(He);const ct=document.createElement("div");ct.className="character-edit-step",ct.dataset.step=String(xe),ct.appendChild(Z.content),yt.appendChild(ct),Ct.push(ct)});const st=Z=>Array.from(Z.querySelectorAll("input, select, textarea")),_t=Z=>{const xe=st(Z);return xe.length?xe.filter(Qe=>Qe.required).every(Qe=>Qe.checkValidity()):!0};let wt=0;const jt=()=>{const Z=Ct.map(He=>_t(He)),xe=Z.findIndex(He=>!He),Qe=xe===-1?Ct.length-1:xe;Ct.forEach((He,ct)=>{He.classList.toggle("is-active",ct===wt)}),Ne.forEach((He,ct)=>{He.classList.toggle("is-active",ct===wt),He.classList.toggle("is-complete",Z[ct]),He.disabled=ct>Qe}),lt.disabled=wt===0,Xe.disabled=!Z[wt]||wt>=Ct.length-1},Gt=Z=>{var xe;wt=Math.min(Math.max(Z,0),Ct.length-1),jt(),(xe=Ct[wt])==null||xe.scrollIntoView({behavior:"smooth",block:"start"})};Ne.forEach((Z,xe)=>{Z.addEventListener("click",()=>Gt(xe))}),lt.addEventListener("click",()=>Gt(wt-1)),Xe.addEventListener("click",()=>Gt(wt+1)),E.addEventListener("input",jt),E.addEventListener("change",jt),Ut.append(it,yt,Je),E.appendChild(Ut),jt();const Jt=document.querySelector("[data-form-modal]"),$t=Jt==null?void 0:Jt.querySelector(".modal-card");$t==null||$t.classList.add("modal-card--wide");const le=await dt({title:t?"Modifica personaggio":"Nuovo personaggio",submitLabel:t?"Salva":"Crea",content:E});if($t==null||$t.classList.remove("modal-card--wide"),!le)return;const Ye=(qn=le.get("name"))==null?void 0:qn.trim();if(!Ye){Y("Inserisci un nome per il personaggio","error");return}const Ce=Z=>Z===""?null:Number(Z),ve={...r.skills},an={...r.skill_mastery};ya.forEach(Z=>{const xe=le.has(`mastery_${Z.key}`),Qe=le.has(`skill_${Z.key}`)||xe;ve[Z.key]=Qe,an[Z.key]=xe&&Qe});const et={...r.saving_throws};_a.forEach(Z=>{et[Z.key]=le.has(`save_${Z.key}`)});const mn={...r.proficiencies};$i.forEach(Z=>{mn[Z.key]=le.has(`prof_${Z.key}`)});const ae={...r.ac_ability_modifiers};["str","con","int","wis","cha"].forEach(Z=>{ae[Z]=le.has(`ac_mod_${Z}`)});const An=le.get("is_spellcaster")==="on",Gn=le.get("spell_can_prepare")==="on",Yt=Array.from({length:9},(Z,xe)=>xe+1),Cn=An?{ability:le.get("spellcasting_ability")||null,recharge:le.get("spell_slot_recharge")||"long_rest",can_prepare:Gn,slots:Yt.reduce((Z,xe)=>(Z[xe]=Ce(le.get(`spell_slot_${xe}`))??0,Z),{}),slots_max:Yt.reduce((Z,xe)=>(Z[xe]=Ce(le.get(`spell_slot_${xe}`))??0,Z),{})}:r.spellcasting??null,$n={...r,avatar_url:((K=le.get("avatar_url"))==null?void 0:K.trim())||null,description:((fe=le.get("description"))==null?void 0:fe.trim())||null,hp:{current:Ce(le.get("hp_current")),temp:Ce(le.get("hp_temp")),max:Ce(le.get("hp_max"))},hit_dice:{die:((me=le.get("hit_dice_die"))==null?void 0:me.trim())||null,max:Ce(le.get("hit_dice_max")),used:Ce(le.get("hit_dice_used"))},ac:Ce(le.get("ac")),level:Ce(le.get("level")),race:((Ke=le.get("race"))==null?void 0:Ke.trim())||null,alignment:((Ee=le.get("alignment"))==null?void 0:Ee.trim())||null,background:((Me=le.get("background"))==null?void 0:Me.trim())||null,class_name:((sn=le.get("class_name"))==null?void 0:sn.trim())||null,archetype:((Ht=le.get("archetype"))==null?void 0:Ht.trim())||null,speed:Ce(le.get("speed")),proficiency_bonus:Ce(le.get("proficiency_bonus")),initiative:Ce(le.get("initiative")),attack_bonus_melee:Ce(le.get("attack_bonus_melee"))??0,attack_bonus_ranged:Ce(le.get("attack_bonus_ranged"))??0,extra_attacks:Ce(le.get("extra_attacks"))??0,damage_bonus_melee:Ce(le.get("damage_bonus_melee"))??0,damage_bonus_ranged:Ce(le.get("damage_bonus_ranged"))??0,ac_bonus:Ce(le.get("ac_bonus"))??0,is_spellcaster:An,spell_notes:((Pt=le.get("spell_notes"))==null?void 0:Pt.trim())||null,spellcasting:Cn,ac_ability_modifiers:ae,proficiency_notes:((Qt=le.get("proficiency_notes"))==null?void 0:Qt.trim())||null,language_proficiencies:((zt=le.get("language_proficiencies"))==null?void 0:zt.trim())||null,talents:((Fe=le.get("talents"))==null?void 0:Fe.trim())||null,spells:v.filter(Z=>!le.has(`remove_spell_${Z.id}`)),abilities:{str:Ce(le.get("ability_str")),dex:Ce(le.get("ability_dex")),con:Ce(le.get("ability_con")),int:Ce(le.get("ability_int")),wis:Ce(le.get("ability_wis")),cha:Ce(le.get("ability_cha"))},skills:ve,skill_mastery:an,saving_throws:et,proficiencies:mn},Ln={name:Ye,system:((Xt=le.get("system"))==null?void 0:Xt.trim())||null,data:$n};try{if(t){const Z=await Po(t.id,Ln),xe=ht().characters.map(Qe=>Qe.id===Z.id?Z:Qe);un({characters:xe}),await qt({characters:xe}),Y("Personaggio aggiornato")}else{const Z=await wd({...Ln,user_id:n.id}),xe=[...ht().characters,Z];un({characters:xe}),Ea(Z.id),await qt({characters:xe}),Y("Personaggio creato")}e()}catch{Y(t?"Errore aggiornamento personaggio":"Errore creazione personaggio","error")}}function Oi(n=[]){return n.reduce((e,t)=>{const r=Number(t.qty??0),i=Number(t.weight??0);return e+r*i},0)}function $r(n,e){const t={...n};return Object.keys(e).forEach(r=>{t[r]=Number(t[r]??0)+Number(e[r]??0)}),t}function wa(n,e="lb"){return n==null||Number.isNaN(n)?"-":`${Number(n).toFixed(2).replace(/\.00$/,"")} ${e}`}const zi=[{value:"head",label:"Testa"},{value:"eyes-left",label:"Occhio sinistro"},{value:"eyes-right",label:"Occhio destro"},{value:"ears-left",label:"Orecchio sinistro"},{value:"ears-right",label:"Orecchio destro"},{value:"neck",label:"Collo"},{value:"shoulder-left",label:"Spalla sinistra"},{value:"shoulder-right",label:"Spalla destra"},{value:"back",label:"Schiena"},{value:"chest",label:"Torso"},{value:"arm-left",label:"Braccio sinistro"},{value:"arm-right",label:"Braccio destro"},{value:"hand-left",label:"Mano sinistra"},{value:"hand-right",label:"Mano destra"},{value:"wrist-left",label:"Polso sinistro"},{value:"wrist-right",label:"Polso destro"},{value:"waist",label:"Vita"},{value:"leg-left",label:"Gamba sinistra"},{value:"leg-right",label:"Gamba destra"},{value:"foot-left",label:"Piede sinistro"},{value:"foot-right",label:"Piede destro"},{value:"ring-left",label:"Dita/Anello sinistro"},{value:"ring-right",label:"Dita/Anello destro"},{value:"main-hand",label:"Mano principale"},{value:"off-hand",label:"Mano secondaria"},{value:"eyes",label:"Occhi (generico)"},{value:"ears",label:"Orecchie (generico)"},{value:"shoulders",label:"Spalle (generico)"},{value:"arms",label:"Braccia (generico)"},{value:"hands",label:"Mani (generico)"},{value:"wrists",label:"Polsi (generico)"},{value:"legs",label:"Gambe (generico)"},{value:"feet",label:"Piedi (generico)"},{value:"ring",label:"Dita/Anelli (generico)"}],Fi=[{value:"gear",label:"Vestiario",equipable:!0},{value:"loot",label:"Loot"},{value:"consumable",label:"Consumabili"},{value:"weapon",label:"Armi",equipable:!0},{value:"armor",label:"Armature",equipable:!0},{value:"jewelry",label:"Gioielli e ornamenti",equipable:!0},{value:"tool",label:"Strumenti"},{value:"container",label:"Contenitore",equipable:!0}],Wd=[{value:"",label:"Tutte"},...Fi],Vd=new Map([...Fi.map(n=>[n.value,n.label]),["magic","Magici"]]),Gd=new Map(zi.map(n=>[n.value,n.label])),Jd=[{value:"",label:"Seleziona"},{value:"simple",label:"Semplice"},{value:"martial",label:"Da guerra"}],Yd=[{value:"",label:"Seleziona"},{value:"melee",label:"Mischia"},{value:"ranged",label:"Distanza"}],Qd=[{value:"",label:"Seleziona"},{value:"str",label:"FOR"},{value:"dex",label:"DES"}],Xd=[{value:"",label:"Seleziona"},{value:"light",label:"Leggera"},{value:"medium",label:"Media"},{value:"heavy",label:"Pesante"}];function Ki(n){if(!n)return{};if(typeof n=="string")try{return JSON.parse(n)}catch{return{}}return n}function zo(n){return Vd.get(n)??(n||"Altro")}function Zd(n){return Gd.get(n)??n}function eh(n){return n.map(e=>Zd(e)).join(", ")}function Qs(n){if(!n)return[];if(Array.isArray(n.equip_slots))return n.equip_slots.filter(Boolean);if(typeof n.equip_slots=="string"&&n.equip_slots.trim())try{const e=JSON.parse(n.equip_slots);if(Array.isArray(e))return e.filter(Boolean)}catch{return[n.equip_slots]}return n.equip_slot?[n.equip_slot]:[]}function xa(n){var e,t;return((t=(e=n.data)==null?void 0:e.settings)==null?void 0:t.weight_unit)??"lb"}function Fo(n={}){return{magic:n.is_magic?"Magico":"Non magico",equipable:n.equipable?"Equipaggiabile":"Non equipaggiabile",attunement:n.attunement_active?"In sintonia":"Non in sintonia"}}function th(n,e){var i;const t=((i=n.data)==null?void 0:i.proficiencies)||{},r=e.get("category");if(r==="weapon"){const s=e.get("weapon_type");return s?s==="simple"?!!t.weapon_simple:!!t.weapon_martial:!1}if(r==="armor"){if(e.get("is_shield")==="on")return!!t.shield;const l=e.get("armor_type");return l?l==="light"?!!t.armor_light:l==="medium"?!!t.armor_medium:!!t.armor_heavy:!1}return!0}function nh(n,e){return n?`
    <div>
      <p>Non hai ancora un personaggio.</p>
      <div class="button-row">
        <button class="primary" data-create-character>Nuovo personaggio</button>
      </div>
    </div>
  `:`<p class="muted">${e?"Modalit offline attiva: crea un personaggio quando torni online.":"Accedi per creare un personaggio."}</p>`}function rh(n,e,t=[]){const r=n.data||{},i=r.hp||{},s=r.hit_dice||{},l=r.abilities||{},u=St(r.proficiency_bonus),h=!!r.inspiration,f=r.initiative??Wt(l.dex),g=r.skills||{},y=r.skill_mastery||{},_=qd(l,u,g,y),w=St(i.current),v=St(i.max),E=St(i.temp),j=r.death_saves||{},V=Math.max(0,Math.min(3,Number(j.successes)||0)),z=Math.max(0,Math.min(3,Number(j.failures)||0)),T=v?Math.min(Math.max(Number(w)/v*100,0),100):0,H=Math.max(0,Number(E)||0),U=Math.max(0,Number(v??w??0)),R=H>0,M=R?100:0,F=R?U:1,pe=R?H:0,Ae=v?`${w??"-"}/${v}`:`${w??"-"}`,G=E??"-",L=Math.max(0,Math.min(6,Number(i.weak_points)||0)),B=Array.isArray(r.conditions)?r.conditions:r.condition?[r.condition]:[],X=Mi.filter(we=>B.includes(we.key)),ee=X.length?X.map(we=>we.label).join(", "):"Nessuna condizione",be=`
    <details class="info-tooltip">
      <summary aria-label="Vedi effetti delle condizioni">?</summary>
      <div class="info-tooltip__panel">
        ${X.length?`
      <ul class="condition-track__list">
        ${X.map(we=>`<li><strong>${we.label}:</strong> ${we.effect}</li>`).join("")}
      </ul>
    `:'<p class="muted">Nessun effetto attivo.</p>'}
      </div>
    </details>
  `,ge=[{value:1,description:"Svantaggio sulle prove di caratteristica."},{value:2,description:"Velocit dimezzata."},{value:3,description:"Svantaggio sui tiri per colpire e tiri salvezza."},{value:4,description:"Punti ferita massimi dimezzati."},{value:5,description:"Velocit ridotta a 0."},{value:6,description:"Morte."}],he=ge.filter(we=>we.value<=L),Pe=`
    <details class="info-tooltip">
      <summary aria-label="Vedi effetti dei punti indebolimento">?</summary>
      <div class="info-tooltip__panel">
        ${he.length?`
      <ul class="weakness-track__list">
        ${he.map(we=>`<li>${we.description}</li>`).join("")}
      </ul>
    `:'<p class="muted">Nessun indebolimento.</p>'}
      </div>
    </details>
  `,Ve=`Livello attuale: ${L}`,Q=Bd(r,l,t),ze=[{key:"str",label:pn.str,value:l.str},{key:"dex",label:pn.dex,value:l.dex},{key:"con",label:pn.con,value:l.con},{key:"int",label:pn.int,value:l.int},{key:"wis",label:pn.wis,value:l.wis},{key:"cha",label:pn.cha,value:l.cha}];return`
    <div class="character-overview">
      <div class="character-summary">
        <div class="character-hero">
          ${r.avatar_url?`<img class="character-avatar" src="${r.avatar_url}" alt="Ritratto di ${n.name}" />`:""}
          <div>
            <h3 class="character-name">${n.name}</h3>
            <div class="character-meta">
              <span class="meta-tag">Livello ${r.level??"-"}</span>
              <span class="meta-tag">Razza ${r.race??"-"}</span>
              <span class="meta-tag">Classe ${r.class_name??r.class_archetype??"-"}</span>
              <span class="meta-tag">Archetipo ${r.archetype??"-"}</span>
              <span class="meta-tag">Allineamento ${r.alignment??"-"}</span>
              <span class="meta-tag">Background ${r.background??"-"}</span>
            </div>
          </div>
        </div>
        <div class="character-summary-actions">
          <div class="proficiency-chip">
            <span>Bonus competenza</span>
            <strong>${gt(u)}</strong>
          </div>
          <div class="inspiration-chip">
            <span>Ispirazione</span>
            <button
              class="inspiration-toggle"
              type="button"
              data-toggle-inspiration
              aria-pressed="${h}"
              aria-label="Imposta ispirazione"
              ${e?"":"disabled"}
            >
              <span class="inspiration-toggle__icon" aria-hidden="true"></span>
            </button>
          </div>
          <button class="ghost-button background-button" type="button" data-show-background>
            Background
          </button>
        </div>
      </div>
      <div class="stat-panel">     
        <div class="stat-grid stat-grid--compact stat-grid--abilities">
          ${ze.map(we=>{const Oe=St(we.value),Re=Oe===null?"-":Dd(Oe);return`
            <div class="stat-card stat-card--${we.key}">
              <span>${we.label}</span>
              <strong>${Oe??"-"}</strong>
              <span class="stat-card__modifier" aria-label="Modificatore ${we.label}">${Re}</span>
            </div>
          `}).join("")}
        </div>
      </div>
      <div class="hp-panel">
        <div class="hp-bar-row">
          <div class="armor-class-card">
            <span>CA</span>
            <strong>${Q??"-"}</strong>
            <span class="armor-class-card__sigil" aria-hidden="true"></span>
          </div>
          <div class="armor-class-card armor-class-card--initiative">
            <span>Iniz</span>
            <strong>${gt(St(f))}</strong>
            <span class="armor-class-card__sigil" aria-hidden="true"></span>
          </div>
          <div class="armor-class-card armor-class-card--speed">
            <span>Vel</span>
            <strong>${r.speed??"-"}</strong>
            <span class="armor-class-card__sigil" aria-hidden="true"></span>
          </div>
          <div class="hp-bar-stack">
            <div class="hp-bar-label">
              <span>HP</span>
              <strong>${Ae}</strong>
              <span class="hp-bar-label__divider" aria-hidden="true"></span>
              <span class="hp-bar-label__temp-group ${R?"is-active":""}">
                <span class="hp-bar-label__temp">HP temporanei</span>
                <strong>${G}</strong>
              </span>
            </div>
            <div class="hp-bar-track">
              <div class="hp-bar" style="flex: ${F};">
                <div class="hp-bar__fill" style="width: ${T}%;"></div>
              </div>
              ${R?`
              <div class="hp-bar hp-bar--temp is-active" style="flex: ${pe};">
                <div class="hp-bar__fill hp-bar__fill--temp" style="width: ${M}%;"></div>
              </div>
              `:""}
            </div>
            <div class="hp-panel-hit-dice">
              <span>Dadi vita</span>
              <strong>${Md(s)}</strong>
            </div>
          </div>
        </div>
        <div class="hp-panel-subgrid">
          <div class="stat-chip stat-chip--highlight">
            <span>Percezione passiva</span>
            <strong>${_??"-"}</strong>
          </div>
          <div class="hp-panel-status-row">
            <div class="weakness-track">
              <div class="track-label-row">
                <span class="weakness-track__label">Punti indebolimento</span>
                ${Pe}
              </div>
              <div class="weakness-track__group" role="radiogroup" aria-label="Livelli indebolimento">
                ${ge.map(we=>{const Oe=we.value===L;return`
                  <button
                    class="death-save-dot ${Oe?"is-filled":""}"
                    type="button"
                    role="radio"
                    aria-checked="${Oe}"
                    data-weakness-level="${we.value}"
                    aria-label="Livello ${we.value}: ${we.description}"
                  >
                    <span aria-hidden="true"></span>
                  </button>
                `}).join("")}
              </div>
              <div class="weakness-track__description">${Ve}</div>
            </div>
            <div class="condition-track">
              <div class="track-label-row">
                <span class="condition-track__label">Condizioni</span>
                ${be}
              </div>
              <div class="condition-track__row">
                <span class="condition-track__value">${ee}</span>
              </div>
            </div>
            <div class="death-saves">
              <span class="death-saves__label">TS morte</span>
              <div class="death-saves__group" aria-label="Successi">
                <span class="death-saves__tag"></span>
                ${Array.from({length:3},(we,Oe)=>{const Re=Oe+1;return`
                  <button class="death-save-dot ${Re<=V?"is-filled":""}" type="button" data-death-save="successes" data-death-save-index="${Re}" aria-label="Successi ${Re}">
                    <span aria-hidden="true"></span>
                  </button>
                `}).join("")}
              </div>
              <div class="death-saves__group" aria-label="Fallimenti">
                <span class="death-saves__tag"></span>
                ${Array.from({length:3},(we,Oe)=>{const Re=Oe+1;return`
                  <button class="death-save-dot ${Re<=z?"is-filled":""}" type="button" data-death-save="failures" data-death-save-index="${Re}" aria-label="Fallimenti ${Re}">
                    <span aria-hidden="true"></span>
                  </button>
                `}).join("")}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="home-section">
        <header class="card-header">
          <div>
            <p class="eyebrow">Competenze extra</p>
          </div>
        </header>
        ${sh(n,t,e)}
      </div>
    </div>
  `}function ah(n){const e=n.data||{},t=e.abilities||{},r=St(e.proficiency_bonus),i=e.skills||{},s=e.skill_mastery||{};return`
    <div class="detail-section">
      <div class="detail-grid detail-grid--compact">
        ${ya.map(l=>{const u=!!i[l.key],h=!!s[l.key],f=Br(t[l.ability],r,u?h?2:1:0);return`
          <div class="modifier-card ${h?"modifier-card--mastery":u?"modifier-card--proficiency":""}">
            <div>
              <div class="modifier-title">
                <strong>${l.label}</strong>
                <span class="modifier-ability modifier-ability--${l.ability}">${pn[l.ability]}</span>
              </div>
            </div>
            <div class="modifier-value">${gt(f)}</div>
          </div>
        `}).join("")}
      </div>
    </div>
  `}function ih(n){const e=n.data||{},t=e.abilities||{},r=St(e.proficiency_bonus),i=e.saving_throws||{};return`
    <div class="detail-section">
      <div class="detail-grid detail-grid--compact">
        ${_a.map(s=>{const l=!!i[s.key],u=Br(t[s.key],r,l?1:0);return`
          <div class="modifier-card ${l?"modifier-card--proficiency":""}">
            <div>
              <div class="modifier-title">
                <strong>${s.label}</strong>
              </div>
            </div>
            <div class="modifier-value">${gt(u)}</div>
          </div>
        `}).join("")}
      </div>
    </div>
  `}function sh(n,e=[],t=!1){const r=n.data||{},i=r.proficiencies||{},s=r.proficiency_notes||"",{tools:l,languages:u}=Ld(s),h=r.language_proficiencies||"",f=Ti(h),g=r.talents||"",y=Ti(g),w=[...f,...u].reduce((E,j)=>{const V=j.trim();if(!V)return E;const z=V.toLowerCase();return E.seen.has(z)||(E.seen.add(z),E.values.push(V)),E},{values:[],seen:new Set}).values,v=$i.filter(E=>i[E.key]).map(E=>E.label);return`
    <div class="detail-section">
      <div class="proficiency-tabs" data-proficiency-tabs>
        <div class="tab-bar" role="tablist" aria-label="Competenze extra">
          <button class="tab-bar__button is-active" type="button" role="tab" aria-selected="true" data-proficiency-tab="equipment">
            Equipaggiamento
          </button>
          <button class="tab-bar__button" type="button" role="tab" aria-selected="false" data-proficiency-tab="tools">
            Strumenti
          </button>
          <button class="tab-bar__button" type="button" role="tab" aria-selected="false" data-proficiency-tab="languages">
            Lingue
          </button>
          <button class="tab-bar__button" type="button" role="tab" aria-selected="false" data-proficiency-tab="talents">
            Talenti
          </button>
        </div>
        <div class="detail-card detail-card--text tab-panel is-active" role="tabpanel" data-proficiency-panel="equipment">
          ${v.length?`<div class="tag-row">${v.map(E=>`<span class="chip">${E}</span>`).join("")}</div>`:'<p class="muted">Nessuna competenza equipaggiamento.</p>'}
        </div>
        <div class="detail-card detail-card--text tab-panel" role="tabpanel" data-proficiency-panel="tools">
          ${l.length?`<div class="tag-row">${l.map(E=>`<span class="chip">${E}</span>`).join("")}</div>`:'<p class="muted">Aggiungi strumenti nel profilo.</p>'}
        </div>
        <div class="detail-card detail-card--text tab-panel" role="tabpanel" data-proficiency-panel="languages">
          ${w.length?`<div class="tag-row">${w.map(E=>`<span class="chip">${E}</span>`).join("")}</div>`:'<p class="muted">Aggiungi lingue conosciute nel profilo.</p>'}
        </div>
        <div class="detail-card detail-card--text tab-panel" role="tabpanel" data-proficiency-panel="talents">
          ${y.length?`<div class="tag-row">${y.map(E=>`<span class="chip">${E}</span>`).join("")}</div>`:'<p class="muted">Aggiungi talenti nel profilo.</p>'}
        </div>
      </div>
    </div>
  `}function oh(n,e=[],t=!1){const r=(e||[]).filter(u=>In(u).length),i=(e||[]).filter(u=>u.attunement_active).length,s=Oi(e),l=xa(n);return`
    <section class="card home-card home-section home-scroll-panel">
      <header class="card-header">
        <div>
          <p class="eyebrow">Gestione Equipaggiamento</p>
          <div class="pill-row">
            <span class="pill pill--accent">Oggetti in sintonia: ${i}</span>
            <span class="pill">Carico totale: ${wa(s,l)}</span>
          </div>
        </div>
        <div class="actions">
          ${t?`
            <button class="icon-button icon-button--add" type="button" data-add-equip aria-label="Equipaggia oggetto">
              <span aria-hidden="true">+</span>
            </button>
          `:""}
        </div>
      </header>
      ${r.length?`
          <ul class="inventory-list resource-list resource-list--compact">
            ${r.map(u=>{const h=Fo(u);return`
              <li class="modifier-card attack-card resource-card inventory-item-card">
                <div class="resource-card__badges">
                  ${u.is_magic?`<span class="resource-chip resource-chip--floating resource-chip--magic">${h.magic}</span>`:""}
                  ${u.attunement_active?`<span class="resource-chip resource-chip--floating resource-chip--attunement">${h.attunement}</span>`:""}
                </div>
                <div class="attack-card__body resource-card__body">
                  <div class="resource-card__title item-info">
                    ${u.image_url?`<img class="item-avatar" src="${u.image_url}" alt="Foto di ${u.name}" data-item-image="${u.id}" />`:""}
                    <div class="item-info-body">
                      <div class="item-info-line">
                        <button class="item-name-button attack-card__name-button" type="button" data-item-preview="${u.id}" aria-label="Apri anteprima ${u.name}">${u.name}</button>
                        <span class="muted item-meta">
                          ${zo(u.category)}  ${eh(In(u))}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                ${t?`
                  <div class="resource-card-actions">
                    <button class="resource-action-button" type="button" data-unequip="${u.id}">Rimuovi</button>
                  </div>
                `:""}
              </li>
            `}).join("")}
          </ul>
        `:'<p class="muted">Nessun oggetto equipaggiato.</p>'}
    </section>
  `}function lh(n,e=[]){var H;const t=n.data||{},r=Number(t.attack_bonus_melee??t.attack_bonus)||0,i=Number(t.attack_bonus_ranged??t.attack_bonus)||0,s=Number(t.damage_bonus_melee??t.damage_bonus)||0,l=Number(t.damage_bonus_ranged??t.damage_bonus)||0,u=Number(t.extra_attacks)||0,h=e.filter(U=>U.category==="weapon"&&U.equipable&&In(U).length),g=(t.spellcasting||{}).ability,y=g?(H=t.abilities)==null?void 0:H[g]:null,_=Wt(y),w=St(t.proficiency_bonus),v=_===null||w===null?null:_+w,j=(Array.isArray(t.spells)?t.spells:[]).filter(U=>(U.kind==="cantrip"||Number(U.level)===0)&&U.attack_roll&&U.damage_die),V=j.length&&v!==null&&g;if(!h.length&&!V)return'<p class="muted">Nessuna arma equipaggiata.</p>';const z=[];return u>0&&z.push(`Attacco Extra (${u})`),r&&z.push(`Mischia attacco ${gt(r)}`),s&&z.push(`Mischia danni ${gt(s)}`),i&&z.push(`Distanza attacco ${gt(i)}`),l&&z.push(`Distanza danni ${gt(l)}`),`
    ${z.length?`<div class="tag-row">${z.map(U=>`<span class="chip">${U}</span>`).join("")}</div>`:""}
    <div class="detail-section">
      <div class="detail-grid detail-grid--compact">
        ${h.map(U=>{var we;const R=U.weapon_range||(U.range_normal?"ranged":"melee"),M=U.attack_ability||(R==="ranged"?"dex":"str"),F=Wt((we=t.abilities)==null?void 0:we[M])??0,pe=t.proficiencies||{},G=(U.weapon_type==="simple"?!!pe.weapon_simple:U.weapon_type==="martial"?!!pe.weapon_martial:!1)?St(t.proficiency_bonus)??0:0,L=R==="ranged"?i:r,B=R==="ranged"?l:s,X=F+G+(Number(U.attack_modifier)||0)+L,ee=F+(Number(U.damage_modifier)||0)+B,ue=U.damage_die?U.damage_die:"-",be=ue==="-"?"-":`${ue}${ee?` ${gt(ee)}`:""}`,ge=Number(U.range_normal)||null,he=Number(U.range_disadvantage)||null,ye=Number(U.melee_range)||1.5,Pe=[];R==="melee"&&ye>1.5&&Pe.push(`Portata ${ye} m`),R==="melee"&&U.is_thrown&&ge&&Pe.push(`Lancio ${ge}${he?`/${he}`:""}`),R!=="melee"&&ge&&Pe.push(`Gittata ${ge}${he?`/${he}`:""}`);const Ve=Pe.join("  "),Q=M==="dex"?"DES":M==="str"?"FOR":M.toUpperCase(),ze=U.id??U.name;return`
          <div class="modifier-card attack-card">
            <div class="attack-card__body">
              <div class="attack-card__title">
                <strong class="attack-card__name">${U.name}</strong>
                <span class="modifier-ability modifier-ability--${M}">${Q}</span>
                <span class="attack-card__hit">${gt(X)}</span>
              </div>
              <div class="attack-card__meta">
                <span class="attack-card__damage">${be}</span>
                ${Ve?`<span class="muted">${Ve}</span>`:""}
              </div>
            </div>
            <button class="icon-button icon-button--fire" data-roll-damage="${ze}" aria-label="Calcola danni ${U.name}">
              <span aria-hidden="true"></span>
            </button>
          </div>
        `}).join("")}
        ${V?j.map(U=>{const R=Number(U.damage_modifier)||0,M=`${U.damage_die}${R?` ${gt(R)}`:""}`,F=pn[g]??(g==null?void 0:g.toUpperCase()),pe=U.range?`Range ${U.range}`:"";return`
            <div class="modifier-card attack-card">
              <div class="attack-card__body">
                <div class="attack-card__title">
                  <strong class="attack-card__name">${U.name}</strong>
                  <span class="modifier-ability modifier-ability--${g}">${F}</span>
                  <span class="attack-card__hit">${gt(v)}</span>
                </div>
                <div class="attack-card__meta">
                  <span class="attack-card__damage">${M}</span>
                  <span class="chip chip--small">Trucchetto</span>
                  ${pe?`<span class="muted">${pe}</span>`:""}
                </div>
              </div>
              <button class="icon-button icon-button--fire" data-roll-damage="spell:${U.id}" aria-label="Calcola danni ${U.name}">
                <span aria-hidden="true"></span>
              </button>
            </div>
          `}).join(""):""}
      </div>
    </div>
  `}function ch(n,e=!1){var Ae;const t=n.data||{},r=t.spell_notes||"",i=Array.isArray(t.spells)?Ta(t.spells):[],s=t.spellcasting||{},l=!!s.can_prepare,u=St(t.proficiency_bonus),h=s.ability,f=h?(Ae=t.abilities)==null?void 0:Ae[h]:null,g=Wt(f),y=g===null||u===null?null:8+g+u,_=g===null||u===null?null:g+u,w=h?pn[h]:null,v=s.slots||{},E=s.slots_max||{},j=s.recharge||"long_rest",z=Array.from({length:9},(G,L)=>L+1).map(G=>{const L=Math.max(0,Number(v[G])||0),B=Math.max(L,Number(E[G])||0);return{level:G,count:L,max:B}}).filter(G=>G.max>0),T=[`${w??"-"}`,`CD ${y===null?"-":y}`,`TC ${_===null?"-":gt(_)}`],H=T.length?`<div class="tag-row">${T.map(G=>`<span class="chip">${G}</span>`).join("")}</div>`:"",U=i.filter(G=>{if((Number(G.level)||0)<1)return!1;const B=G.prep_state||"known";return B==="prepared"||B==="always"}),R=i.filter(G=>(Number(G.level)||0)===0),M=U.filter(G=>(G.prep_state||"known")==="always"),F=U.filter(G=>(G.prep_state||"known")!=="always"),pe=(G,L="")=>{const B=Number(G.level)||0;return`
      <div class="modifier-card attack-card resource-card spell-prepared-list__card">
        <button class="spell-prepared-list__item" type="button" data-spell-quick-open="${G.id}">
          <span class="spell-prepared-list__name">${G.name}</span>
          ${B>0?`<span class="chip chip--small">${B}</span>`:'<span class="chip chip--small">Trucchetto</span>'}
          ${L?`<span class="chip chip--small">${L}</span>`:""}
        </button>
        ${e?`
          <div class="resource-card-actions spell-card-actions">
            <button class="resource-action-button resource-icon-button" type="button" data-edit-spell="${G.id}" aria-label="Modifica incantesimo ${G.name}"></button>
            <button class="resource-action-button resource-icon-button" type="button" data-delete-spell="${G.id}" aria-label="Elimina incantesimo ${G.name}"></button>
          </div>
        `:""}
      </div>
    `};return`
    ${H}
    <div class="detail-section">
      <div class="detail-card detail-card--text spell-summary-card">
        <div class="spell-slots">
          <span class="spell-slots__title">Slot rimanenti</span>
          <div class="spell-slots__list">
            ${z.map(G=>{const L=j==="short_rest"?"charge-indicator":"charge-indicator charge-indicator--long",B=Array.from({length:G.max},(X,ee)=>{const ue=ee>=G.count?"charge-indicator--used":"";return`<span class="${[L,ue].filter(Boolean).join(" ")}"></span>`}).join("");return`
              <div class="spell-slot-row">
                <span class="spell-slot-label">Slot ${G.level}</span>
                <span class="spell-slot-count">${G.count}</span>
                <div class="spell-slot-charges" aria-hidden="true">${B||'<span class="spell-slot-empty">-</span>'}</div>
              </div>
            `}).join("")}
          </div>
        </div>
        ${r?`<p class="spell-notes">${r}</p>`:""}
      </div>
      <div class="spell-prepared-list">
        <span class="spell-slots__title">Trucchetti</span>
        ${R.length?`
          <div class="spell-prepared-list__items">
            ${R.map(G=>pe(G)).join("")}
          </div>
        `:'<p class="muted">Nessun trucchetto disponibile.</p>'}
      </div>
      <div class="spell-prepared-list">
        <span class="spell-slots__title">Incantesimi pronti al lancio</span>
        ${U.length?`
          <div class="spell-prepared-list__group">
            <span class="spell-prepared-list__group-title">Preparati</span>
            ${F.length?`<div class="spell-prepared-list__items">${F.map(G=>pe(G,"Preparato")).join("")}</div>`:'<p class="muted">Nessun incantesimo preparato.</p>'}
          </div>
          <div class="spell-prepared-list__group">
            <span class="spell-prepared-list__group-title">Sempre conosciuti</span>
            ${M.length?`<div class="spell-prepared-list__items">${M.map(G=>pe(G,"Sempre preparato")).join("")}</div>`:'<p class="muted">Nessun incantesimo sempre conosciuto.</p>'}
          </div>
        `:'<p class="muted">Nessun incantesimo preparato disponibile.</p>'}
      </div>
      <div class="spell-list-actions">
        ${l?'<button class="secondary spell-list-button spell-list-button--prepare" type="button" data-open-prepared-spells>Prepara Incantesimi</button>':""}
        <button class="primary spell-list-button" type="button" data-spell-list>Lista Incantesimi</button>
      </div>
    </div>
  `}function Xs(n){if(!n)return ha.length;const e=ha.findIndex(t=>t.label===n);return e===-1?ha.length:e}function uh(n){var e;return n?((e=ha.find(t=>t.label===n))==null?void 0:e.className)??"":""}function dh(n){return[...n].sort((e,t)=>{const r=Xs(e.cast_time)-Xs(t.cast_time);return r!==0?r:(e.name??"").localeCompare(t.name??"","it",{sensitivity:"base"})})}function Zs(n,e,{showCharges:t=!0,showUseButton:r=!0,showDescription:i=!1,showCastTime:s=!0}={}){return`
    <ul class="resource-list resource-list--compact">
      ${n.map(l=>`
        <li class="modifier-card attack-card resource-card" data-resource-card="${l.id}">
          ${s&&l.cast_time?`<span class="resource-chip resource-chip--floating ${uh(l.cast_time)}">${l.cast_time}</span>`:""}
          <div class="attack-card__body resource-card__body">
            <div class="attack-card__title resource-card__title">
              <strong class="attack-card__name">${l.name}</strong>
            </div>
            ${i?`<p class="resource-card__description">${l.description??""}</p>`:""}
            ${t&&Number(l.max_uses)?`
              <div class="resource-card__charges">
                ${fh(l)}
              </div>
            `:""}
          </div>
          <div class="resource-card-actions">
            ${r?`
              <button
                class="resource-cta-button resource-cta-button--label"
                data-use-resource="${l.id}"
                ${!Number(l.max_uses)||l.used>=Number(l.max_uses)?"disabled":""}
              >
                Usa
              </button>
            `:""}
            ${e?`
              <button class="resource-action-button resource-icon-button" data-edit-resource="${l.id}" aria-label="Modifica risorsa"></button>
              <button class="resource-action-button resource-icon-button" data-delete-resource="${l.id}" aria-label="Elimina risorsa"></button>
            `:""}
          </div>
        </li>
      `).join("")}
    </ul>
  `}function hh(n,e){if(!n.length)return"<p>Nessuna risorsa.</p>";const t=dh(n),r=t.filter(u=>u.reset_on===null||u.reset_on==="none"),i=t.filter(u=>u.reset_on!==null&&u.reset_on!=="none"),s=i.length?`
      <div class="resource-section resource-section--active">
        <div class="resource-section__body">
          ${Zs(i,e,{showUseButton:!1})}
        </div>
      </div>
    `:'<p class="muted">Nessuna risorsa attiva.</p>',l=r.length?`
      <div class="resource-section">
        <header class="card-header"><div><p class="eyebrow">Risorse Passive</p></div></header>
        <div class="resource-section__body">
          ${Zs(r,e,{showCharges:!1,showUseButton:!1,showDescription:!0,showCastTime:!0})}
        </div>
      </div>
    `:"";return`${s}${l}`}function fh(n){const e=Number(n.max_uses)||0,t=Number(n.used)||0;if(!e)return"";const r=n.reset_on==="long_rest"?"long":"short",i=Math.max(e-t,0),s=Array.from({length:e},(l,u)=>{const h=u<t;return`<span class="${["charge-indicator",r==="long"?"charge-indicator--long":"charge-indicator--short",h?"charge-indicator--used":""].filter(Boolean).join(" ")}" aria-hidden="true"></span>`}).join("");return`
    <div class="resource-charge-row" aria-label="Cariche risorsa">
      <span class="resource-charge-label">Cariche</span>
      <span class="resource-charge-count">${i}/${e}</span>
      <div class="resource-charges" aria-hidden="true">${s}</div>
    </div>
  `}function ph(n){const e="/dungeons-dragons-app/",t={pp:`${e}icons/moneta_platino.png`,gp:`${e}icons/moneta_oro.png`,sp:`${e}icons/moneta_argento.png`,cp:`${e}icons/moneta_rame.png`},r=Ki(n),i=["pp","gp","sp","cp"].map(l=>({coin:l,value:Number((r==null?void 0:r[l])??0)})).filter(l=>l.value!==0);return(i.length?i:[{coin:"gp",value:0}]).map((l,u)=>`
      ${u?'<span class="transaction-coin__divider" aria-hidden="true"></span>':""}
      <span class="transaction-coin" data-coin="${l.coin}">
        <span class="coin-avatar coin-avatar--${l.coin}" aria-hidden="true">
          <img src="${t[l.coin]}" alt="" loading="lazy" />
        </span>
        <span class="transaction-coin__value">${l.value}</span>
      </span>
    `).join("")}function mh(n){const e=Ki(n),t=["pp","gp","sp","cp"].map(r=>({coin:r,value:Number((e==null?void 0:e[r])??0)})).filter(r=>r.value!==0);return t.length?t.map(r=>`${r.value} ${r.coin}`).join("  "):"0 gp"}const gh=8;function vh(n){const e=document.createElement("div");if(e.className="transaction-list",!n.length)return e.innerHTML='<p class="muted">Nessuna transazione registrata.</p>',e;const t=document.createElement("ul");t.className="transaction-items";const r=n.length>gh;return n.forEach(i=>{const s=document.createElement("li"),l=i.direction==="pay"?"Pagamento":"Entrata",u=ph(i.amount),h=mh(i.amount),f=i.direction==="pay"?"transaction-item--outgoing":"transaction-item--incoming";s.className=`transaction-item ${f}`,s.innerHTML=`
      <div class="transaction-info">
        <strong>${l}</strong>
        <p class="muted">${i.reason||"Nessuna nota"}</p>
      </div>
      <span class="transaction-amount" aria-label="${h}">${u}</span>
      <div class="transaction-meta">
        <div class="transaction-actions">
          <button class="icon-button transaction-action-button" type="button" data-edit-transaction="${i.id}" aria-label="Modifica transazione" title="Modifica">
            <span aria-hidden="true"></span>
          </button>
          <button class="icon-button icon-button--danger transaction-action-button transaction-action-button--danger" type="button" data-delete-transaction="${i.id}" aria-label="Elimina transazione" title="Elimina">
            <span aria-hidden="true"></span>
          </button>
        </div>
      </div>
    `,t.appendChild(s)}),e.classList.toggle("transaction-list--scrollable",r),e.appendChild(t),e}function bh(n,e="lb"){const t=n.filter(s=>s.category==="container"),r=n.filter(s=>!s.container_item_id&&s.category!=="container");return`
    ${t.map(s=>{const l=n.filter(g=>g.container_item_id===s.id),u=l.reduce((g,y)=>{const _=Number(y.volume)||0,w=Number(y.qty)||1;return g+_*w},0),h=Number(s.max_volume)||null,f=h?`Volume ${u}/${h}`:u?`Volume ${u}`:"";return`
      <div class="inventory-group">
        <p class="eyebrow">${s.name}${f?`  <span class="muted">${f}</span>`:""}</p>
        ${eo(l,e)}
      </div>
    `}).join("")}
    <div class="inventory-group">
      ${eo(r,e)}
    </div>
  `}function eo(n,e="lb"){return n.length?`
    <div class="inventory-table">
      <div class="inventory-table__header">
        <span>Oggetto</span>
        <span>Categoria</span>
        <span>Qt</span>
        <span>Peso</span>
        <span>Volume</span>
        <span>Azioni</span>
      </div>
      <div class="inventory-table__body">
        ${n.map(t=>{const r=t.volume!==null&&t.volume!==void 0?t.volume:"-",i=Fo(t);return`
          <div class="inventory-table__row">
            <div class="inventory-table__badges">
              ${t.is_magic?`<span class="resource-chip resource-chip--floating resource-chip--magic">${i.magic}</span>`:""}
              ${t.equipable?`<span class="resource-chip resource-chip--floating resource-chip--equipable">${i.equipable}</span>`:""}
              ${t.attunement_active?`<span class="resource-chip resource-chip--floating resource-chip--attunement">${i.attunement}</span>`:""}
            </div>
            <div class="inventory-table__cell inventory-table__cell--item">
              ${t.image_url?`<img class="item-avatar" src="${t.image_url}" alt="Foto di ${t.name}" data-item-image="${t.id}" />`:""}
              <div class="item-info-body">
                <button class="item-name-button" type="button" data-item-preview="${t.id}" aria-label="Apri anteprima ${t.name}">${t.name}</button>
              </div>
            </div>
            <div class="inventory-table__cell">${zo(t.category)}</div>
            <div class="inventory-table__cell">${t.qty}</div>
            <div class="inventory-table__cell">${wa(t.weight??0,e)}</div>
            <div class="inventory-table__cell">${r}</div>
            <div class="inventory-table__cell inventory-table__cell--actions">
              ${t.category==="consumable"?`<button class="resource-action-button" data-use="${t.id}">Consuma</button>`:""}
              <button class="resource-action-button icon-button" data-edit="${t.id}" aria-label="Modifica" title="Modifica">
                <span aria-hidden="true"></span>
              </button>
              <button class="resource-action-button icon-button" data-delete="${t.id}" aria-label="Elimina" title="Elimina">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </div>
        `}).join("")}
      </div>
    </div>
  `:'<p class="muted eyebrow">Nessun oggetto.</p>'}function Ri({amount:n=0,coin:e="gp",reason:t="",occurredOn:r,direction:i="receive",includeDirection:s=!1}={}){const l=r||new Date().toISOString().split("T")[0];return`
    <div class="money-grid compact-grid-fields">
      <label class="field">
        <span>Quantit</span>
        <input name="amount" type="number" value="${n}" min="0" />
      </label>
      <label class="field">
        <span>Tipo moneta</span>
        <select name="coin">
          <option value="pp" ${e==="pp"?"selected":""}>Platino</option>
          <option value="gp" ${e==="gp"?"selected":""}>Oro</option>
          <option value="sp" ${e==="sp"?"selected":""}>Argento</option>
          <option value="cp" ${e==="cp"?"selected":""}>Rame</option>
        </select>
      </label>
       <label class="field">
      <span>Data</span>
      <input name="occurred_on" type="date" value="${l}" />
    </label>
    </div>
    ${s?`
      <label class="field">
        <span>Direzione</span>
        <select name="direction">
          <option value="receive" ${i==="receive"?"selected":""}>Entrata</option>
          <option value="pay" ${i==="pay"?"selected":""}>Pagamento</option>
        </select>
      </label>
    `:""}
    <label class="field">
      <span>Motivo</span>
      <input name="reason" placeholder="Motivo" value="${t}" />
    </label>
   
  `}function yh({amount:n=0,source:e="gp",target:t="pp",targetAmount:r=0,available:i={}}={}){const s=[{key:"pp",label:"Platino",value:Number(i.pp??0)},{key:"gp",label:"Oro",value:Number(i.gp??0)},{key:"sp",label:"Argento",value:Number(i.sp??0)},{key:"cp",label:"Rame",value:Number(i.cp??0)}],l=s.some(f=>f.value>0),u=s.filter(f=>f.value>0).map(f=>`
          <option value="${f.key}" ${e===f.key?"selected":""}>${f.label}</option>
        `).join(""),h=s.map(f=>`
          <option value="${f.key}" ${t===f.key?"selected":""}>${f.label}</option>
        `).join("");return`
    <div class="modal-section">
      <h4 class="modal-section__title">Seleziona le monete da scambiare</h4>
      <div class="money-grid compact-grid-fields">
        <label class="field">
          <span>Tipo moneta</span>
          <select name="source" ${l?"":"disabled"}>
            ${l?u:'<option value="" selected>Nessuna moneta disponibile</option>'}
          </select>
        </label>
        <label class="field">
          <span>Quantit</span>
          <div class="field__input-row">
            <input name="amount" type="number" value="${n}" min="0" step="1" ${l?"":"disabled"} />
            <button class="chip chip--small" type="button" data-exchange-max ${l?"":"disabled"}>Max</button>
          </div>
          <span class="field__hint muted" data-exchange-available></span>
        </label>
      </div>
    </div>
    <div class="modal-section">
      <h4 class="modal-section__title">Scegli la moneta di destinazione</h4>
      <div class="money-grid compact-grid-fields">
        <label class="field">
          <span>Moneta di destinazione</span>
          <select name="target">
            ${h}
          </select>
        </label>
        <label class="field">
          <span>Controvalore</span>
          <input name="target_amount" type="number" value="${r}" min="0" step="1" readonly />
        </label>
      </div>
    </div>
  `}function _h(n={}){const e={pp:Number(n.pp??0),gp:Number(n.gp??0),sp:Number(n.sp??0),cp:Number(n.cp??0)};return`
    <div class="money-grid compact-grid-fields">
      <label class="field">
        <span>Platino (PP)</span>
        <input name="pp" type="number" value="${e.pp}" min="0" step="1" />
      </label>
      <label class="field">
        <span>Oro (GP)</span>
        <input name="gp" type="number" value="${e.gp}" min="0" step="1" />
      </label>
      <label class="field">
        <span>Argento (SP)</span>
        <input name="sp" type="number" value="${e.sp}" min="0" step="1" />
      </label>
      <label class="field">
        <span>Rame (CP)</span>
        <input name="cp" type="number" value="${e.cp}" min="0" step="1" />
      </label>
    </div>
  `}function wh(n){return`
   <div class="compact-field-grid">
      <label class="field">
        <span>Nome</span>
        <input name="name" required />
      </label>
       <label class="field">
        <span>Valore</span>
        <input name="value_cp" type="number" value="0" />
      </label>
   </div>
    <div class="compact-field-grid">  
      <label class="field">
        <span>Quantit</span>
        <input name="qty" type="number" value="1" />
      </label>
      <label class="field">
        <span>Peso</span>
        <input name="weight" type="number" value="0" min="0" step="${n}" />
      </label>
      <label class="field">
        <span>Volume</span>
        <input name="volume" type="number" value="0" min="0" step="0.1" />
      </label>
     
    </div>
  `}async function to(n,e,t,r){var Jt,$t;const i=document.createElement("div");i.className="drawer-form modal-form-grid";const s=(le,Ye="balanced")=>{const Ce=document.createElement("div");return Ce.className=`modal-form-row modal-form-row--${Ye}`,le.filter(Boolean).forEach(ve=>Ce.appendChild(ve)),Ce},l=de({label:"Nome",name:"name",value:(e==null?void 0:e.name)??""}),u=de({label:"Foto (URL)",name:"image_url",placeholder:"https://.../oggetto.png",value:(e==null?void 0:e.image_url)??""});i.appendChild(s([l,u],"balanced"));const h=de({label:"Quantit",name:"qty",type:"number",value:(e==null?void 0:e.qty)??1}),f=de({label:"Peso",name:"weight",type:"number",value:(e==null?void 0:e.weight)??0}),g=f.querySelector("input");if(g){const le=xa(n);g.min="0",g.step=le==="kg"?"0.1":"1"}const y=de({label:"Volume",name:"volume",type:"number",value:(e==null?void 0:e.volume)??0}),_=de({label:"Valore (cp)",name:"value_cp",type:"number",value:(e==null?void 0:e.value_cp)??0});i.appendChild(s([h,f,y,_],"compact"));const w=ln([{value:"",label:"Seleziona"},...Fi],(e==null?void 0:e.category)??"");w.name="category";const v=document.createElement("label");v.className="field",v.innerHTML="<span>Categoria</span>",v.appendChild(w);const E=[{value:"",label:"Nessuno"}].concat(t.filter(le=>le.category==="container").map(le=>({value:le.id,label:le.name}))),j=ln(E,(e==null?void 0:e.container_item_id)??"");j.name="container_item_id";const V=document.createElement("label");V.className="field",V.innerHTML="<span>Contenitore</span>",V.appendChild(j);const z=de({label:"Volume massimo contenitore",name:"max_volume",type:"number",value:(e==null?void 0:e.max_volume)??""}),T=z.querySelector("input");i.appendChild(s([v,V,z],"balanced"));const H=document.createElement("div");H.className="compact-field-grid";const U=document.createElement("label");U.className="checkbox",U.innerHTML='<input type="checkbox" name="equipable" /> <span>Equipaggiabile</span>';const R=U.querySelector("input"),M=document.createElement("label");M.className="checkbox",M.innerHTML='<input type="checkbox" name="sovrapponibile" /> <span>Sovrapponibile</span>';const F=M.querySelector("input"),pe=document.createElement("fieldset");pe.className="equip-slot-field",pe.innerHTML="<legend>Punti del corpo</legend>";const Ae=document.createElement("div");Ae.className="equip-slot-list";const G=Qs(e),L=zi.map(le=>{const Ye=document.createElement("label");Ye.className="checkbox",Ye.innerHTML=`<input type="checkbox" name="equip_slots" value="${le.value}" /> <span>${le.label}</span>`;const Ce=Ye.querySelector("input");return Ce&&G.includes(le.value)&&(Ce.checked=!0),Ae.appendChild(Ye),Ce});pe.appendChild(Ae),H.appendChild(U),H.appendChild(M);const B=document.createElement("label");B.className="checkbox",B.innerHTML='<input type="checkbox" name="attunement_active" /> <span>Sintonia attiva</span>';const X=B.querySelector("input"),ee=document.createElement("label");ee.className="checkbox",ee.innerHTML='<input type="checkbox" name="is_magic" /> <span>Magico</span>';const ue=ee.querySelector("input");i.appendChild(s([H,B,ee],"balanced")),i.appendChild(pe),i.appendChild(yn({label:"Note",name:"notes",value:(e==null?void 0:e.notes)??""}));const be=document.createElement("div");be.className="drawer-form modal-form-grid";const ge=document.createElement("label");ge.className="field",ge.innerHTML="<span>Tipo arma</span>";const he=ln(Jd,(e==null?void 0:e.weapon_type)??"");he.name="weapon_type",ge.appendChild(he);const ye=document.createElement("label");ye.className="field",ye.innerHTML="<span>Propriet arma</span>";const Pe=ln(Yd,(e==null?void 0:e.weapon_range)??"");Pe.name="weapon_range",ye.appendChild(Pe);const Ve=document.createElement("label");Ve.className="field",Ve.innerHTML="<span>Caratteristica tiro per colpire</span>";const Q=ln(Qd,(e==null?void 0:e.attack_ability)??"");Q.name="attack_ability",Ve.appendChild(Q);const ze=de({label:"Dado danno",name:"damage_die",placeholder:"Es. 1d8",value:(e==null?void 0:e.damage_die)??""}),we=de({label:"Modificatore per colpire",name:"attack_modifier",type:"number",value:(e==null?void 0:e.attack_modifier)??0}),Oe=de({label:"Modificatore danno",name:"damage_modifier",type:"number",value:(e==null?void 0:e.damage_modifier)??0}),Re=document.createElement("label");Re.className="checkbox",Re.innerHTML='<input type="checkbox" name="is_thrown" /> <span>Propriet lancio</span>';const Be=Re.querySelector("input"),ce=document.createElement("div");ce.className="compact-field-grid";const Rt=de({label:"Portata arma (m)",name:"melee_range",type:"number",value:(e==null?void 0:e.melee_range)??1.5}),Et=de({label:"Gittata normale",name:"range_normal",type:"number",value:(e==null?void 0:e.range_normal)??""}),qe=de({label:"Gittata svantaggio",name:"range_disadvantage",type:"number",value:(e==null?void 0:e.range_disadvantage)??""});ce.appendChild(Rt),ce.appendChild(Et),ce.appendChild(qe);const At=document.createElement("label");At.className="field",At.innerHTML="<span>Tipo armatura</span>";const Nt=ln(Xd,(e==null?void 0:e.armor_type)??"");Nt.name="armor_type",At.appendChild(Nt);const ft=document.createElement("label");ft.className="checkbox",ft.innerHTML='<input type="checkbox" name="is_shield" /> <span>Scudo</span>';const at=ft.querySelector("input"),Vt=de({label:"Classe armatura base",name:"armor_class",type:"number",value:(e==null?void 0:e.armor_class)??""}),Ut=Vt.querySelector("input"),it=de({label:"Bonus armatura",name:"armor_bonus",type:"number",value:(e==null?void 0:e.armor_bonus)??0}),yt=it.querySelector("input"),Je=de({label:"Bonus scudo",name:"shield_bonus",type:"number",value:(e==null?void 0:e.shield_bonus)??2}),lt=Je.querySelector("input");be.appendChild(s([ge,ye,Ve],"balanced")),be.appendChild(s([ze,we,Oe],"compact")),be.appendChild(s([Re],"compact")),be.appendChild(ce),be.appendChild(s([At,ft,Vt],"balanced")),be.appendChild(s([it,Je],"compact")),i.appendChild(be),X&&(X.checked=(e==null?void 0:e.attunement_active)??!1),ue&&(ue.checked=(e==null?void 0:e.is_magic)??!1),R&&(R.checked=(e==null?void 0:e.equipable)??!1),F&&(F.checked=(e==null?void 0:e.sovrapponibile)??!1),at&&(at.checked=(e==null?void 0:e.is_shield)??!1),Be&&(Be.checked=(e==null?void 0:e.is_thrown)??!1);const Xe=()=>{const le=(R==null?void 0:R.checked)??!1;L.forEach(et=>{et&&(et.disabled=!le,le||(et.checked=!1))}),F&&(F.disabled=!le,le||(F.checked=!1));const Ye=w.value==="weapon",Ce=w.value==="armor",ve=w.value==="container";he.disabled=!Ye,Pe.disabled=!Ye,Q.disabled=!Ye,ze.querySelector("input").disabled=!Ye,we.querySelector("input").disabled=!Ye,Oe.querySelector("input").disabled=!Ye,Be&&(Be.disabled=!Ye),ce.querySelectorAll("input").forEach(et=>{et.disabled=!Ye,Ye?et.name==="melee_range"&&!et.value&&(et.value="1.5"):et.value=""}),Nt.disabled=!Ce,at&&(at.disabled=!Ce),Ut&&(Ut.disabled=!Ce),yt&&(yt.disabled=!Ce),lt&&(lt.disabled=!Ce||!((at==null?void 0:at.checked)??!1)),T&&(T.disabled=!ve,ve||(T.value=""))};R==null||R.addEventListener("change",Xe),w.addEventListener("change",Xe),at==null||at.addEventListener("change",Xe),Be==null||Be.addEventListener("change",Xe),Xe();const Ne=await dt({title:e?"Modifica oggetto":"Nuovo oggetto",submitLabel:e?"Salva":"Crea",content:i,cardClass:["modal-card--wide","modal-card--scrollable"]});if(!Ne)return;const Ct=Ne.get("equipable")==="on",st=Ct?Ne.getAll("equip_slots"):[],_t=st[0]||null,wt=Ne.get("category");if(st.length&&!th(n,Ne)){Y("Non hai la competenza per equipaggiare questo oggetto","error");return}const jt=Ne.get("sovrapponibile")==="on";if(st.length&&!jt&&t.filter(Ye=>Ye.id!==(e==null?void 0:e.id)).filter(Ye=>Qs(Ye).some(Ce=>st.includes(Ce))).length){Y("Uno o pi slot selezionati sono gi occupati","error");return}const Gt={user_id:n.user_id,character_id:n.id,name:Ne.get("name"),image_url:((Jt=Ne.get("image_url"))==null?void 0:Jt.trim())||null,qty:Number(Ne.get("qty")),weight:Number(Ne.get("weight")),volume:Number(Ne.get("volume"))||0,value_cp:Number(Ne.get("value_cp")),category:wt,container_item_id:Ne.get("container_item_id")||null,max_volume:Ne.get("max_volume")===""?null:Number(Ne.get("max_volume")),equipable:Ct,equip_slot:_t,equip_slots:st,sovrapponibile:jt,attunement_active:Ne.get("attunement_active")==="on",is_magic:Ne.get("is_magic")==="on",notes:Ne.get("notes"),weapon_type:Ne.get("weapon_type")||null,weapon_range:Ne.get("weapon_range")||null,attack_ability:Ne.get("attack_ability")||null,damage_die:(($t=Ne.get("damage_die"))==null?void 0:$t.trim())||null,attack_modifier:Number(Ne.get("attack_modifier"))||0,damage_modifier:Number(Ne.get("damage_modifier"))||0,is_thrown:Ne.get("is_thrown")==="on",melee_range:Ne.get("melee_range")===""?null:Number(Ne.get("melee_range")),range_normal:Number(Ne.get("range_normal"))||null,range_disadvantage:Number(Ne.get("range_disadvantage"))||null,armor_type:Ne.get("armor_type")||null,is_shield:Ne.get("is_shield")==="on",armor_class:Number(Ne.get("armor_class"))||null,armor_bonus:Number(Ne.get("armor_bonus"))||0,shield_bonus:Number(Ne.get("shield_bonus"))||0};rt(!0);try{e?(await ba(e.id,Gt),Y("Oggetto aggiornato")):(await qo(Gt),Y("Oggetto creato")),await(r==null?void 0:r())}catch{Y("Errore salvataggio oggetto","error")}finally{rt(!1)}}function ka(n){var r,i;if(!(n!=null&&n.image_url))return;const e=document.createElement("div");e.className="equipment-preview-modal";const t=((r=n.description)==null?void 0:r.trim())||((i=n.notes)==null?void 0:i.trim())||"Nessuna descrizione disponibile per questo equipaggiamento.";e.innerHTML=`
    <div class="detail-card detail-card--text equipment-preview-card">
      <img class="equipment-preview-image" src="${n.image_url}" alt="Foto di ${n.name}" />
      <div class="equipment-preview-content">
        <p>${t}</p>
      </div>
    </div>
  `,dt({title:n.name||"Equipaggiamento",cancelLabel:null,content:e,cardClass:"modal-card--equipment-preview",showFooter:!1})}async function Ko(n){const{data:e,error:t}=await De.from("wallets").select("*").eq("character_id",n).single();if(t&&t.code!=="PGRST116")throw t;return e??null}async function dr(n){const{data:e,error:t}=await De.from("wallets").upsert(n).select("*").single();if(t)throw t;return e}async function Ho(n){const{data:e,error:t}=await De.from("money_transactions").insert(n).select("*").single();if(t)throw t;return e}async function kh(n){const{data:e,error:t}=await De.from("money_transactions").select("*").eq("character_id",n).order("created_at",{ascending:!1});if(t)throw t;return e??[]}async function Sh(n,e){const{data:t,error:r}=await De.from("money_transactions").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Eh(n){const{error:e}=await De.from("money_transactions").delete().eq("id",n);if(e)throw e}async function cn(n,e,t,r){if(!n)return;const i={name:n.name,system:n.system??null,data:e};try{const s=await Po(n.id,i),l=ht().characters.map(u=>u.id===s.id?s:u);un({characters:l}),await qt({characters:l}),t&&Y(t),r&&r()}catch{Y("Errore aggiornamento personaggio","error")}}async function Wo(n,e,t){if(!n)return!1;const r=n.data||{},i=r.spellcasting||{},s={...i.slots||{}},l={...i.slots_max||{}},u=Math.max(0,Number(s[e])||0);if(!u)return Y("Slot incantesimo esauriti","error"),!1;const h=Number(l[e]);return(!Number.isFinite(h)||h<u)&&(l[e]=u),s[e]=Math.max(0,u-1),await cn(n,{...r,spellcasting:{...i,slots:s,slots_max:l}},"Slot incantesimo consumato",t),!0}function Vo(n){switch(n){case"prepared":return"Preparato";case"always":return"Sempre preparato";default:return"Conosciuto"}}function Go(n,e){const t=Uo(e);t&&Or({keepOpen:!0,title:t.title,mode:"generic",notation:t.notation,modifier:t.modifier,rollType:"DMG",characterId:n==null?void 0:n.id})}function Ah(n){if(!n)return;const t=(n.data||{}).description||"Aggiungi una descrizione del background.",r=document.createElement("div");r.className="background-modal";const i=document.createElement("div");i.className="detail-card detail-card--text";const s=document.createElement("div");s.className="background-modal-block";const l=document.createElement("p");l.className="background-modal-description",l.textContent=t,s.appendChild(l),i.appendChild(s),r.appendChild(i),dt({title:"Descrizione background",cancelLabel:null,content:r,cardClass:["modal-card--scrollable","modal-card--background"],showFooter:!1})}async function Ch(n){if(!n)return null;const e=n.data||{},t=Array.isArray(e.conditions)?e.conditions:e.condition?[e.condition]:[],r=document.createElement("div");r.className="condition-modal";const i=document.createElement("div");return i.className="condition-modal__list",Mi.forEach(s=>{const l=document.createElement("label"),u=t.includes(s.key);l.className=`condition-modal__item${u?" is-selected":""}`,l.innerHTML=`
      <span class="condition-modal__item-label"><strong>${s.label}</strong></span>
      <span class="diceov-toggle condition-modal__toggle">
        <input type="checkbox" name="conditions" value="${s.key}" ${u?"checked":""} />
        <span class="diceov-toggle-track" aria-hidden="true"></span>
      </span>
    `;const h=l.querySelector('input[type="checkbox"]');h==null||h.addEventListener("change",()=>{l.classList.toggle("is-selected",h.checked)}),i.appendChild(l)}),r.appendChild(i),dt({title:"Condizioni",submitLabel:"Applica",cancelLabel:"Annulla",content:r,cardClass:"modal-card--wide"})}function $h(n,{onUse:e,onReset:t}={}){var v,E,j;const r=document.createElement("div");r.className="resource-detail";const i=Number(n.max_uses)||0,s=i&&n.used>=i,l=n.reset_on!==null&&n.reset_on!=="none",u=!!(i&&(s?t:e)),h=((v=n.description)==null?void 0:v.trim())||"Nessuna descrizione disponibile per questa risorsa.",g=((E=n.image_url)==null?void 0:E.trim())||"/dungeons-dragons-app/icons/icon.svg",y=!!((j=n.image_url)!=null&&j.trim()),_=y?`Immagine di ${n.name}`:`Immagine placeholder per ${n.name}`,w=y?"resource-detail-image":"resource-detail-image resource-detail-image--placeholder";r.innerHTML=`
    <div class="detail-card detail-card--text resource-detail-card">
      <img class="${w}" src="${g}" alt="${_}" />
      <p>${h}</p>
    </div>
  `,dt({title:n.name||"Risorsa",submitLabel:u?s?"Ripristina":"Usa":"Chiudi",cancelLabel:l&&u?"Chiudi":null,content:r,showFooter:l}).then(async V=>{if(!(!V||!i)){if(s&&t){await t();return}!s&&e&&await e()}})}function Th(n,e){var f;if(!n)return;const t=n.data||{},r=Array.isArray(t.spells)?Ta(t.spells):[],i=!!((f=t.spellcasting)!=null&&f.can_prepare),s=(g,y)=>{var z;const _=Ui(g),w=Number(g.damage_modifier)||0,v=g.damage_die?`${g.damage_die}${w?` ${gt(w)}`:""}`:null,E=g.attack_roll?"Tiro per colpire":null,j=i?g.prep_state||"known":null,V=(z=g.description)==null?void 0:z.trim();return`
              <div class="spell-list-modal__item" data-spell-item="${g.id}">
                <div class="spell-list-modal__item-info">
                  <div class="spell-list-modal__item-title">
                    <strong>${g.name}</strong>
                    <span class="chip chip--small">${_}</span>
                    ${j?`<span class="chip chip--small">${Vo(j)}</span>`:""}
                  </div>
                  <div class="spell-list-modal__item-meta">
                    ${E?`<span>${E}</span>`:""}
                    ${v?`<span>Danni ${v}</span>`:""}
                  </div>
                  ${V?`
                  <button class="spell-list-modal__toggle" type="button" data-spell-toggle="${g.id}" aria-expanded="false">
                    Mostra descrizione
                  </button>
                  <div class="spell-list-modal__item-description" data-spell-description="${g.id}">
                    ${V}
                  </div>
                  `:""}
                </div>
                <div class="spell-list-modal__item-actions">
                  <button class="icon-button" type="button" data-spell-edit="${g.id}" aria-label="Modifica incantesimo" title="Modifica">
                    <span aria-hidden="true"></span>
                  </button>
                  <button class="icon-button icon-button--danger" type="button" data-spell-delete="${g.id}" aria-label="Elimina incantesimo" title="Elimina">
                    <span aria-hidden="true"></span>
                  </button>
                  ${y>0?`<button class="resource-cta-button resource-cta-button--label" type="button" data-spell-cast="${g.id}">Lancia</button>`:""}
                </div>
              </div>
            `},l=document.createElement("div");if(l.className="spell-list-modal",!r.length)l.innerHTML='<p class="muted">Nessun incantesimo configurato.</p>';else{const g=r.reduce((w,v)=>{const E=Number(v.level)||0;return w[E]=w[E]||[],w[E].push(v),w},{}),y=Object.keys(g).map(Number).sort((w,v)=>w-v),_=`
      <nav class="spell-list-modal__nav" aria-label="Livelli incantesimo">
        ${y.map((w,v)=>{const E=w===0?"Trucchetti":`${w} Livello`;return`
          <button class="spell-list-modal__nav-button${v===0?" is-active":""}" type="button" data-spell-level="${w}">
            ${E}
          </button>
        `}).join("")}
      </nav>
    `;l.innerHTML=`${_}${y.map((w,v)=>{const E=w===0?"Trucchetti":`Incantesimi di livello ${w}`,j=i&&w>0,V=j?g[w].filter(T=>(T.prep_state||"known")==="prepared"):[],z=j?g[w].filter(T=>(T.prep_state||"known")!=="prepared"):[];return`
        <section class="spell-list-modal__section${v===0?"":" is-hidden"}" data-spell-section="${w}">
          <h4>${E}</h4>
          ${j?`
          <div class="spell-list-modal__split">
            <div class="spell-list-modal__subsection">
              <h5 class="spell-list-modal__subsection-title">Incantesimi preparati</h5>
              <div class="spell-list-modal__items">
                ${V.length?V.map(T=>s(T,w)).join(""):'<p class="muted">Nessun incantesimo preparato.</p>'}
              </div>
            </div>
            <div class="spell-list-modal__subsection">
              <h5 class="spell-list-modal__subsection-title">Incantesimi conosciuti da preparare</h5>
              <div class="spell-list-modal__items">
                ${z.length?z.map(T=>s(T,w)).join(""):'<p class="muted">Nessun incantesimo da preparare.</p>'}
              </div>
            </div>
          </div>
          `:`
          <div class="spell-list-modal__items">
            ${g[w].map(T=>s(T,w)).join("")}
          </div>
          `}
        </section>
      `}).join("")}`}dt({title:"Lista incantesimi",submitLabel:"Chiudi",cancelLabel:null,content:l,cardClass:"spell-list-modal-card"});const u=document.querySelector("[data-form-modal]"),h=()=>{var g;(g=u==null?void 0:u.querySelector("[data-form-submit]"))==null||g.click()};l.querySelectorAll("[data-spell-cast]").forEach(g=>g.addEventListener("click",async()=>{const y=r.find(v=>v.id===g.dataset.spellCast);if(!y)return;const _=Number(y.level)||0;_<1||!await Wo(n,_,e)||(h(),Go(n,y))})),l.querySelectorAll("[data-spell-edit]").forEach(g=>g.addEventListener("click",()=>{const y=r.find(_=>_.id===g.dataset.spellEdit);y&&(h(),setTimeout(()=>{Ni(n,()=>e==null?void 0:e(),y)},0))})),l.querySelectorAll("[data-spell-level]").forEach(g=>g.addEventListener("click",()=>{const y=g.dataset.spellLevel;y&&(l.querySelectorAll("[data-spell-level]").forEach(_=>{_.classList.toggle("is-active",_===g)}),l.querySelectorAll("[data-spell-section]").forEach(_=>{_.classList.toggle("is-hidden",_.dataset.spellSection!==y)}))})),l.querySelectorAll("[data-spell-toggle]").forEach(g=>g.addEventListener("click",()=>{const y=g.dataset.spellToggle,_=l.querySelector(`[data-spell-item="${y}"]`),w=l.querySelector(`[data-spell-description="${y}"]`);if(!_||!w)return;const v=_.classList.toggle("is-expanded");g.setAttribute("aria-expanded",String(v)),g.textContent=v?"Nascondi descrizione":"Mostra descrizione",w.hidden=!v})),l.querySelectorAll("[data-spell-description]").forEach(g=>{g.hidden=!0}),l.querySelectorAll("[data-spell-item]").forEach(g=>g.addEventListener("click",y=>{if(y.target.closest("button"))return;const _=r.find(w=>w.id===g.dataset.spellItem);_&&(h(),setTimeout(()=>{Jo(n,_,e)},0))})),l.querySelectorAll("[data-spell-delete]").forEach(g=>g.addEventListener("click",async()=>{const y=r.find(E=>E.id===g.dataset.spellDelete);if(!y||!await Pn({title:"Conferma eliminazione incantesimo",message:`Stai per eliminare l'incantesimo "${y.name}" dalla scheda del personaggio. Questa azione non pu essere annullata.`,confirmLabel:"Elimina"}))return;const w=r.filter(E=>E.id!==y.id),v={...n.data,spells:w};await cn(n,v,"Incantesimo eliminato",()=>e==null?void 0:e()),h()}))}function Ni(n,e,t=null){var R;if(!n)return;const r=!!((R=n.data)!=null&&R.is_spellcaster),i=document.createElement("div");i.className="drawer-form modal-form-grid spell-form";const s=(M,F="balanced")=>{const pe=document.createElement("div");return pe.className=`modal-form-row modal-form-row--${F}`,M.filter(Boolean).forEach(Ae=>pe.appendChild(Ae)),pe},l=document.createElement("label");l.className="field",l.innerHTML="<span>Tipo incantesimo</span>";const u=(t==null?void 0:t.kind)??(Number(t==null?void 0:t.level)===0?"cantrip":"spell"),h=ln([{value:"cantrip",label:"Trucchetto"},{value:"spell",label:"Incantesimo"}],u);h.name="spell_kind",l.appendChild(h);const f=de({label:"Nome incantesimo",name:"spell_name",placeholder:"Es. Palla di fuoco",value:(t==null?void 0:t.name)??""}),g=f.querySelector("input");g&&(g.required=!0);const y=de({label:"Livello incantesimo",name:"spell_level",type:"number",value:(t==null?void 0:t.level)??1}),_=y.querySelector("input");_&&(_.min="1",_.max="9");const w=r?document.createElement("label"):null;let v=null;w&&(w.className="field",w.innerHTML="<span>Preparazione</span>",v=ln([{value:"known",label:"Conosciuto"},{value:"prepared",label:"Preparato"},{value:"always",label:"Sempre preparato"}],(t==null?void 0:t.prep_state)??"known"),v.name="spell_prep_state",w.appendChild(v)),i.appendChild(s([l,y,w],"compact")),i.appendChild(s([f],"balanced")),i.appendChild(s([de({label:"Tempo di lancio",name:"spell_cast_time",placeholder:"Es. 1 azione",value:(t==null?void 0:t.cast_time)??""}),de({label:"Durata",name:"spell_duration",placeholder:"Es. 1 minuto",value:(t==null?void 0:t.duration)??""}),de({label:"Range",name:"spell_range",placeholder:"Es. 18 m",value:(t==null?void 0:t.range)??""})],"compact"));const E=document.createElement("label");E.className="checkbox",E.innerHTML='<input type="checkbox" name="spell_concentration" /> <span>Concentrazione</span>';const j=document.createElement("label");j.className="checkbox",j.innerHTML='<input type="checkbox" name="spell_attack_roll" /> <span>Tiro per colpire (targhet)</span>',i.appendChild(s([E,j],"balanced"));const V=de({label:"Dado danno",name:"spell_damage_die",placeholder:"Es. 1d10",value:(t==null?void 0:t.damage_die)??""}),z=de({label:"Modificatore danni",name:"spell_damage_modifier",type:"number",value:(t==null?void 0:t.damage_modifier)??""});i.appendChild(s([V,z],"compact")),i.appendChild(yn({label:"Descrizione",name:"spell_description",placeholder:"Descrizione dell'incantesimo...",value:(t==null?void 0:t.description)??""}));const T=i.querySelector('input[name="spell_concentration"]');T&&(T.checked=!!(t!=null&&t.concentration));const H=i.querySelector('input[name="spell_attack_roll"]');H&&(H.checked=!!(t!=null&&t.attack_roll));const U=()=>{_&&(h.value==="cantrip"?(_.value="0",_.min="0",_.max="0",_.readOnly=!0,_.disabled=!0):(Number(_.value)===0&&(_.value="1"),_.min="1",_.max="9",_.readOnly=!1,_.disabled=!1))};h.addEventListener("change",U),U(),dt({title:t?"Modifica incantesimo":"Nuovo incantesimo",submitLabel:t?"Salva":"Aggiungi",content:i,cardClass:"modal-card--form"}).then(async M=>{var ye,Pe,Ve,Q,ze,we,Oe;if(!M)return;const F=(ye=M.get("spell_name"))==null?void 0:ye.trim();if(!F){Y("Inserisci un nome per l'incantesimo","error");return}const pe=Re=>Re===""||Re===null?null:Number(Re),Ae=M.get("spell_kind")||null,G=pe(M.get("spell_level"))??0,L=Ae==="cantrip"?0:Math.min(9,Math.max(1,G||1)),B=pe(M.get("spell_damage_modifier")),X=r?M.get("spell_prep_state")||"known":(t==null?void 0:t.prep_state)||"known",ee={id:(t==null?void 0:t.id)??`spell-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:F,level:L,kind:Ae||(L===0?"cantrip":"spell"),cast_time:((Pe=M.get("spell_cast_time"))==null?void 0:Pe.trim())||null,duration:((Ve=M.get("spell_duration"))==null?void 0:Ve.trim())||null,range:((Q=M.get("spell_range"))==null?void 0:Q.trim())||null,concentration:M.has("spell_concentration"),attack_roll:M.has("spell_attack_roll"),damage_die:((ze=M.get("spell_damage_die"))==null?void 0:ze.trim())||null,damage_modifier:B,description:((we=M.get("spell_description"))==null?void 0:we.trim())||null,prep_state:X},ue=Array.isArray((Oe=n.data)==null?void 0:Oe.spells)?n.data.spells:[],be=t?ue.map(Re=>Re.id===t.id?ee:Re):[...ue,ee],ge={...n.data,spells:be};await cn(n,ge,t?"Incantesimo aggiornato":"Incantesimo aggiunto",e)})}function Jo(n,e,t){var _;if(!n||!e)return;const r=Math.max(0,Number(e.level)||0),i=Ui(e),s=e.prep_state||"known",l=Vo(s),u=Number(e.damage_modifier)||0,h=e.damage_die?`${e.damage_die}${u?` ${gt(u)}`:""}`:null,f=((_=e.description)==null?void 0:_.trim())||"Nessuna descrizione disponibile.",g=r>0,y=document.createElement("div");y.className="spell-quick-detail",y.innerHTML=`
    <div class="detail-card detail-card--text spell-quick-detail__card">
      <div class="spell-quick-detail__meta">
        <span class="chip chip--small">${i}</span>
        <span class="chip chip--small">${r===0?"Trucchetto":`${r} livello`}</span>
        <span class="chip chip--small">${l}</span>
      </div>
      <div class="spell-quick-detail__stats">
        ${e.attack_roll?"<span>Tiro per colpire</span>":""}
        ${h?`<span>Danni ${h}</span>`:""}
        ${e.duration?`<span>Durata ${e.duration}</span>`:""}
        ${e.range?`<span>Gittata ${e.range}</span>`:""}
      </div>
      <p class="spell-quick-detail__description">${f}</p>
    </div>
  `,dt({title:e.name||"Incantesimo",submitLabel:g?"Lancia":"Chiudi",cancelLabel:g?"Chiudi":null,content:y,cardClass:["modal-card--form","spell-quick-detail-modal"],showFooter:!0}).then(async w=>{!w||!g||!await Wo(n,r,t)||Go(n,e)})}function Yo(n,e){if(!n)return;const t=n.data||{};if(!(t.spellcasting||{}).can_prepare)return;const i=Array.isArray(t.spells)?Ta(t.spells):[],s=i.filter(f=>{const g=f.prep_state||"known",y=Number(f.level)||0;return g!=="always"&&y>0});if(!s.length){Y("Nessun incantesimo preparabile.","info");return}const l=new Set(s.filter(f=>(f.prep_state||"known")==="prepared").map(f=>f.id)),u=document.createElement("div");u.className="prepared-spells-modal",u.innerHTML=`
    <p class="muted">Seleziona gli incantesimi da preparare per oggi.</p>
    <div class="prepared-spells-modal__list prepared-spells-modal__list--toggle">
      ${s.map(f=>{const g=l.has(f.id),y=Number(f.level)||0;return`
          <button
            class="prepared-spells-modal__toggle ${g?"is-active":""}"
            type="button"
            data-prepared-toggle="${f.id}"
            aria-pressed="${g}"
          >
            <span class="prepared-spells-modal__toggle-name">${f.name}</span>
            <span class="chip chip--small">${y}</span>
          </button>
        `}).join("")}
    </div>
  `;const h=()=>{u.querySelectorAll("[data-prepared-toggle]").forEach(f=>{const g=f.dataset.preparedToggle;if(!g)return;const y=l.has(g);f.classList.toggle("is-active",y),f.setAttribute("aria-pressed",String(y))})};u.querySelectorAll("[data-prepared-toggle]").forEach(f=>{f.addEventListener("click",()=>{const g=f.dataset.preparedToggle;g&&(l.has(g)?l.delete(g):l.add(g),h())})}),h(),dt({title:"Incantesimi preparati",submitLabel:"Salva",cancelLabel:"Annulla",content:u,cardClass:"modal-card--form"}).then(async f=>{if(!f)return;const g=i.map(_=>{if((_.prep_state||"known")==="always"||Number(_.level)===0)return _;const v=l.has(_.id);return{..._,prep_state:v?"prepared":"known"}}),y={...n.data,spells:g};await cn(n,y,"Incantesimi preparati aggiornati",e)})}function xh(n){var s;const e=(s=n==null?void 0:n.data)==null?void 0:s.avatar_url;if(!e)return;const t=document.querySelector(".avatar-preview");t&&t.remove();const r=document.createElement("div");r.className="avatar-preview",r.tabIndex=0,r.innerHTML=`
    <img class="avatar-preview__image" src="${e}" alt="Ritratto di ${n.name}" />
  `;const i=()=>{r.remove()};r.addEventListener("click",i),r.addEventListener("keydown",l=>{l.key==="Escape"&&i()}),document.body.appendChild(r),r.focus()}function no(n,e,t=null){if(!n)return;const r=document.createElement("div");r.className="drawer-form modal-form-grid";const i=(F,pe="balanced")=>{const Ae=document.createElement("div");return Ae.className=`modal-form-row modal-form-row--${pe}`,F.filter(Boolean).forEach(G=>Ae.appendChild(G)),Ae},s=de({label:"Nome abilit",name:"name",placeholder:"Es. Azione Impetuosa",value:(t==null?void 0:t.name)??""}),l=de({label:"Foto (URL)",name:"image_url",placeholder:"https://.../risorsa.png",value:(t==null?void 0:t.image_url)??""}),u=document.createElement("label");u.className="field",u.innerHTML="<span>Tipo di lancio</span>";const h=ln([{value:"Sempre attiva",label:"Sempre attiva"},{value:"Azione",label:"Azione"},{value:"Reazione",label:"Reazione"},{value:"Azione Bonus",label:"Azione Bonus"},{value:"Azione Gratuita",label:"Azione Gratuita"}],(t==null?void 0:t.cast_time)??"Azione");h.name="cast_time",u.appendChild(h),r.appendChild(i([s,u,l],"balanced"));const f=document.createElement("div");f.className="modal-toggle-field",f.innerHTML=`
    <span class="modal-toggle-field__label">Passiva (senza cariche)</span>
    <label class="diceov-toggle">
      <input type="checkbox" name="is_passive" />
      <span class="diceov-toggle-track" aria-hidden="true"></span>
    </label>
  `;const g=de({label:"Cariche massime",name:"max_uses",type:"number",value:(t==null?void 0:t.max_uses)??1}),y=de({label:"Cariche consumate",name:"used",type:"number",value:(t==null?void 0:t.used)??0});r.appendChild(i([f,g,y],"compact"));const _=de({label:"Recupero riposo breve",name:"recovery_short",type:"number",value:(t==null?void 0:t.recovery_short)??""}),w=de({label:"Recupero riposo lungo",name:"recovery_long",type:"number",value:(t==null?void 0:t.recovery_long)??""}),v=document.createElement("label");v.className="field",v.innerHTML="<span>Tipo ricarica</span>";const E=ln([{value:"short_rest",label:"Riposo breve"},{value:"long_rest",label:"Riposo lungo"}],(t==null?void 0:t.reset_on)??"long_rest");E.name="reset_on",v.appendChild(E),r.appendChild(i([v,_,w],"balanced"));const j=de({label:"Notazione dado",name:"damage_dice_notation",placeholder:"Es. 2d8+1d4",value:(t==null?void 0:t.damage_dice_notation)??""}),V=de({label:"Modificatore dado",name:"damage_modifier",type:"number",value:(t==null?void 0:t.damage_modifier)??""});r.appendChild(i([j,V],"compact")),r.appendChild(yn({label:"Descrizione",name:"description",placeholder:"Inserisci una descrizione...",value:(t==null?void 0:t.description)??""}));const z=r.querySelector('input[name="max_uses"]'),T=r.querySelector('input[name="used"]'),H=r.querySelector('input[name="recovery_short"]'),U=r.querySelector('input[name="recovery_long"]'),R=r.querySelector('input[name="is_passive"]');R&&(R.checked=Number(t==null?void 0:t.max_uses)===0||(t==null?void 0:t.reset_on)===null||(t==null?void 0:t.reset_on)==="none");const M=()=>{const F=R==null?void 0:R.checked;F&&(z&&(z.value="0"),T&&(T.value="0"),H&&(H.value="0"),U&&(U.value="0")),z&&(z.disabled=F),T&&(T.disabled=F),H&&(H.disabled=F),U&&(U.disabled=F),E.disabled=F};R==null||R.addEventListener("change",M),M(),dt({title:t?"Modifica abilit":"Nuova abilit",submitLabel:t?"Salva":"Crea",content:r,cardClass:"modal-card--form"}).then(async F=>{var ue,be,ge,he;if(!F)return;const pe=(ue=F.get("name"))==null?void 0:ue.trim();if(!pe){Y("Inserisci un nome per la risorsa","error");return}const Ae=ht().user,G=ye=>ye===""||ye===null?null:Number(ye),L=Number(F.get("max_uses"))||0,B=Math.min(Number(F.get("used"))||0,L||0),X=F.get("is_passive")==="on",ee={user_id:(Ae==null?void 0:Ae.id)??n.user_id,character_id:n.id,name:pe,image_url:((be=F.get("image_url"))==null?void 0:be.trim())||null,description:((ge=F.get("description"))==null?void 0:ge.trim())||null,cast_time:F.get("cast_time")||null,damage_dice_notation:((he=F.get("damage_dice_notation"))==null?void 0:he.trim())||null,damage_modifier:G(F.get("damage_modifier")),max_uses:L,used:B,reset_on:X?null:F.get("reset_on"),recovery_short:G(F.get("recovery_short")),recovery_long:G(F.get("recovery_long"))};try{t?(await Ci(t.id,ee),Y("Risorsa aggiornata")):(await Sd(ee),Y("Risorsa creata")),e()}catch{Y("Errore salvataggio risorsa","error")}})}let ro=!1,Sa=null;async function Ze(n){var i;Sa=n;const e=ht(),{user:t,offline:r}=e;rt(!0);try{let s=e.characters;if(!r&&t)try{s=await No(t.id),un({characters:s}),await qt({characters:s})}catch{Y("Errore caricamento personaggi","error")}const l=bt(e.activeCharacterId);!s.some(L=>bt(L.id)===l)&&s.length&&Ea(s[0].id);const h=bt(ht().activeCharacterId),f=s.find(L=>bt(L.id)===h),g=!!t&&!r,y=!!t&&!r,_=!!t&&!r;let w=e.cache.resources,v=e.cache.items;if(!r&&f){const[L,B]=await Promise.allSettled([Io(f.id),Lo(f.id)]),X={};L.status==="fulfilled"?(w=L.value,xt("resources",w),X.resources=w):Y("Errore caricamento risorse","error"),B.status==="fulfilled"?(v=B.value,xt("items",v),X.items=v):Y("Errore caricamento equip","error"),Object.keys(X).length&&await qt(X)}n.innerHTML=`
    <div class="home-layout">
      <div class="home-column home-column--left">
        <section class="card home-card home-section">
          <header class="card-header">
            <div>
              <p class="eyebrow">Tiri salvezza</p>
              <h3></h3>
            </div>
            <div class="actions">
              <button class="icon-button" data-open-dice="saving-throws" aria-label="Lancia dadi tiri salvezza">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          ${f?ih(f):"<p>Nessun personaggio selezionato.</p>"}
        </section>
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Abilit</p>            
            </div>
            <div class="actions">
              <button class="icon-button" data-open-dice="skills" aria-label="Lancia dadi abilit">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          <div class="home-scroll-body">
            ${f?ah(f):"<p>Nessun personaggio selezionato.</p>"}
          </div>
        </section>
      </div>
      <div class="home-column home-column--center">
        <section class="card home-card home-section">
          <header class="card-header">
            <div>
              <p class="eyebrow">Scheda Personaggio</p>           
            </div>
            <div class="actions">
              ${f&&_?`
                <button class="icon-button" data-edit-character aria-label="Modifica personaggio">
                  <span aria-hidden="true"></span>
                </button>
              `:""}
            </div>
          </header>
          ${f?rh(f,_,v):nh(g,r)}
        </section>
        ${f?oh(f,v,_):""}
      </div>
      <div class="home-column home-column--right">
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Attacchi</p>
            </div>
            <div class="actions">
              <button class="icon-button icon-button--dice" data-open-dice="attack-roll" aria-label="Lancia dadi attacchi">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          <div class="home-scroll-body">
            ${f?lh(f,v||[]):"<p>Nessun personaggio selezionato.</p>"}
          </div>
        </section>
        ${(i=f==null?void 0:f.data)!=null&&i.is_spellcaster?`
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Incantesimi</p>
            </div>
            <div class="actions">
              <button class="icon-button icon-button--dice" data-open-dice="spell-attack" aria-label="Lancia dado tiro per colpire incantesimi">
                <span aria-hidden="true"></span>
              </button>
              ${f&&_?`
                <button class="icon-button icon-button--add" data-add-spell aria-label="Aggiungi incantesimo">
                  <span aria-hidden="true">+</span>
                </button>
              `:""}
            </div>
          </header>
          <div class="home-scroll-body">
            ${ch(f,_)}
          </div>
        </section>
        `:""}
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Risorse</p>           
            </div>
            ${f&&y?`
              <button class="icon-button icon-button--add" data-add-resource aria-label="Nuova risorsa">
                <span aria-hidden="true">+</span>
              </button>
            `:""}
          </header>
          <div class="home-scroll-body home-scroll-body--resources">
            ${f?hh(w,y):"<p>Nessun personaggio selezionato.</p>"}
            ${f&&!y?'<p class="muted">Connettiti per aggiungere nuove risorse.</p>':""}
          </div>
        </section>
      </div>
    </div>
  `,Qo();const E=n.querySelector("[data-create-character]");E&&E.addEventListener("click",()=>{xi(t,()=>Ze(n))});const j=n.querySelector("[data-edit-character]");j&&j.addEventListener("click",()=>{xi(t,()=>Ze(n),f)});const V=n.querySelector("[data-add-resource]");V&&V.addEventListener("click",()=>{no(f,()=>Ze(n))});const z=n.querySelector("[data-add-spell]");z&&z.addEventListener("click",()=>{Ni(f,()=>Ze(n))}),n.querySelectorAll("[data-edit-spell]").forEach(L=>L.addEventListener("click",()=>{var ue;const B=L.dataset.editSpell;if(!B||!f)return;const ee=(Array.isArray((ue=f.data)==null?void 0:ue.spells)?f.data.spells:[]).find(be=>be.id===B);ee&&Ni(f,()=>Ze(n),ee)})),n.querySelectorAll("[data-delete-spell]").forEach(L=>L.addEventListener("click",async()=>{var ge;const B=L.dataset.deleteSpell;if(!B||!f)return;const X=Array.isArray((ge=f.data)==null?void 0:ge.spells)?f.data.spells:[],ee=X.find(he=>he.id===B);if(!ee||!await Pn({title:"Conferma eliminazione incantesimo",message:`Stai per eliminare l'incantesimo "${ee.name}" dalla scheda del personaggio. Questa azione non pu essere annullata.`,confirmLabel:"Elimina"}))return;const be={...f.data||{},spells:X.filter(he=>he.id!==ee.id)};await cn(f,be,"Incantesimo eliminato",()=>Ze(n))}));const T=n.querySelector("[data-spell-list]");T&&T.addEventListener("click",()=>{Th(f,()=>Ze(n))});const H=n.querySelector("[data-open-prepared-spells]");H&&H.addEventListener("click",()=>{Yo(f,()=>Ze(n))}),n.querySelectorAll("[data-spell-quick-open]").forEach(L=>L.addEventListener("click",()=>{var ue;const B=L.dataset.spellQuickOpen;if(!B||!f)return;const ee=(Array.isArray((ue=f.data)==null?void 0:ue.spells)?f.data.spells:[]).find(be=>be.id===B);ee&&Jo(f,ee,()=>Ze(n))}));const U=n.querySelector("[data-show-background]");U&&U.addEventListener("click",()=>{Ah(f)});const R=n.querySelector("[data-edit-conditions]");R&&R.addEventListener("click",async()=>{await Xo(n)}),n.querySelectorAll("[data-proficiency-tabs]").forEach(L=>{var be;const B=Array.from(L.querySelectorAll("[data-proficiency-tab]")),X=Array.from(L.querySelectorAll("[data-proficiency-panel]"));if(!B.length||!X.length)return;const ee=ge=>{B.forEach(he=>{const ye=he.dataset.proficiencyTab===ge;he.classList.toggle("is-active",ye),he.setAttribute("aria-selected",String(ye))}),X.forEach(he=>{he.classList.toggle("is-active",he.dataset.proficiencyPanel===ge)})};B.forEach(ge=>{ge.addEventListener("click",()=>{ee(ge.dataset.proficiencyTab)})});const ue=((be=B.find(ge=>ge.classList.contains("is-active")))==null?void 0:be.dataset.proficiencyTab)??B[0].dataset.proficiencyTab;ue&&ee(ue)});const M=n.querySelector("[data-add-equip]");M&&f&&_&&M.addEventListener("click",async()=>{var Ve;const L=(v||[]).filter(Q=>Q.equipable&&!In(Q).length);if(!L.length){Y("Nessun oggetto equipaggiabile disponibile","error");return}const B=document.createElement("div");B.className="drawer-form";const X=document.createElement("label");X.className="field",X.innerHTML="<span>Oggetto</span>";const ee=document.createElement("select");ee.name="item_id",L.forEach(Q=>{const ze=document.createElement("option");ze.value=Q.id,ze.textContent=Q.name,ee.appendChild(ze)}),X.appendChild(ee),B.appendChild(X);const ue=document.createElement("fieldset");ue.className="equip-slot-field",ue.innerHTML="<legend>Punti del corpo</legend>";const be=document.createElement("div");be.className="equip-slot-list",zi.forEach(Q=>{const ze=document.createElement("label");ze.className="checkbox",ze.innerHTML=`<input type="checkbox" name="equip_slots" value="${Q.value}" /> <span>${Q.label}</span>`,be.appendChild(ze)}),ue.appendChild(be),B.appendChild(ue);const ge=await dt({title:"Equipaggia oggetto",submitLabel:"Equipaggia",content:B});if(!ge)return;const he=ge.getAll("equip_slots");if(!he.length){Y("Seleziona almeno uno slot","error");return}const ye=L.find(Q=>String(Q.id)===ge.get("item_id"));if(!ye)return;const Pe=((Ve=f.data)==null?void 0:Ve.proficiencies)||{};if(ye.category==="weapon"){if(!ye.weapon_type){Y("Definisci il tipo di arma prima di equipaggiarla","error");return}if(!(ye.weapon_type==="simple"?!!Pe.weapon_simple:!!Pe.weapon_martial)){Y("Non hai la competenza per equipaggiare questo oggetto","error");return}}if(ye.category==="armor")if(ye.is_shield){if(!Pe.shield){Y("Non hai la competenza per equipaggiare questo oggetto","error");return}}else if(ye.armor_type){if(!(ye.armor_type==="light"?!!Pe.armor_light:ye.armor_type==="medium"?!!Pe.armor_medium:!!Pe.armor_heavy)){Y("Non hai la competenza per equipaggiare questo oggetto","error");return}}else{Y("Definisci il tipo di armatura prima di equipaggiarla","error");return}if(!ye.sovrapponibile&&(v||[]).filter(ze=>ze.id!==ye.id).filter(ze=>In(ze).some(we=>he.includes(we))).length){Y("Uno o pi slot selezionati sono gi occupati","error");return}try{await ba(ye.id,{equip_slot:he[0]||null,equip_slots:he}),Y("Equipaggiamento aggiornato"),Ze(n)}catch{Y("Errore aggiornamento equip","error")}}),n.querySelectorAll("[data-unequip]").forEach(L=>L.addEventListener("click",async()=>{const B=(v||[]).find(X=>X.id===L.dataset.unequip);if(B)try{await ba(B.id,{equip_slot:null,equip_slots:[]}),Y("Equipaggiamento rimosso"),Ze(n)}catch{Y("Errore aggiornamento equip","error")}}));const F=n.querySelector("[data-toggle-inspiration]");F&&f&&_&&F.addEventListener("click",async()=>{const L=f.data||{},B={...L,inspiration:!L.inspiration};await cn(f,B,"Ispirazione aggiornata",()=>Ze(n))}),n.querySelectorAll("[data-open-dice]").forEach(L=>L.addEventListener("click",()=>{Zo(L.dataset.openDice)})),n.querySelectorAll("[data-edit-resource]").forEach(L=>L.addEventListener("click",()=>{const B=w.find(X=>X.id===L.dataset.editResource);B&&no(f,()=>Ze(n),B)})),n.querySelectorAll("[data-roll-damage]").forEach(L=>L.addEventListener("click",()=>{var ue;if(!f)return;const B=L.dataset.rollDamage;if(!B)return;if(B.startsWith("spell:")){const be=B.replace("spell:",""),he=(Array.isArray((ue=f.data)==null?void 0:ue.spells)?f.data.spells:[]).find(Pe=>Pe.id===be);if(!he)return;const ye=Uo(he);if(!ye){Y("Danno non calcolabile per questo trucchetto.","error");return}Or({keepOpen:!0,title:ye.title,mode:"generic",notation:ye.notation,modifier:ye.modifier,rollType:"DMG",characterId:f==null?void 0:f.id});return}const X=v==null?void 0:v.find(be=>String(be.id)===B||be.name===B);if(!X)return;const ee=Ud(f,X);if(!ee){Y("Danno non calcolabile per questa arma.","error");return}Or({keepOpen:!0,title:ee.title,mode:"generic",notation:ee.notation,modifier:ee.modifier,rollType:"DMG",characterId:f==null?void 0:f.id,historyLabel:X.name||null})}));const pe=L=>{var ee;const B=(ee=L==null?void 0:L.damage_dice_notation)==null?void 0:ee.trim();if(!B)return;const X=Bi(B);if(!(X!=null&&X.notation)){Y("Notazione dado non valida per questa abilit","error");return}Or({keepOpen:!0,title:L.name||"Tiro abilit",mode:"generic",notation:X.notation,modifier:Number(L.damage_modifier)||0,rollType:"GEN",characterId:f==null?void 0:f.id,historyLabel:L.name||null})},Ae=async L=>{const B=Number(L.max_uses)||0;if(!(!B||L.used>=B))try{await Ci(L.id,{used:Math.min(L.used+1,B)}),Y("Risorsa usata"),pe(L),Ze(n)}catch{Y("Errore utilizzo risorsa","error")}};n.querySelectorAll("[data-resource-card]").forEach(L=>{const B=async X=>{if(X.target.closest("button"))return;const ee=w.find(ue=>ue.id===L.dataset.resourceCard);ee&&$h(ee,{onUse:()=>Ae(ee),onReset:async()=>{try{await Ci(ee.id,{used:0}),Y("Risorsa ripristinata"),Ze(n)}catch{Y("Errore ripristino risorsa","error")}}})};L.addEventListener("click",B)}),n.querySelectorAll("[data-use-resource]").forEach(L=>L.addEventListener("click",async()=>{const B=w.find(X=>X.id===L.dataset.useResource);B&&await Ae(B)})),n.querySelectorAll("[data-delete-resource]").forEach(L=>L.addEventListener("click",async()=>{const B=w.find(ee=>ee.id===L.dataset.deleteResource);if(!(!B||!await Pn({title:"Conferma eliminazione risorsa",message:`Stai per eliminare la risorsa "${B.name}". Questa azione non pu essere annullata.`,confirmLabel:"Elimina"})))try{await Ed(B.id),Y("Risorsa eliminata"),Ze(n)}catch{Y("Errore eliminazione risorsa","error")}})),n.querySelectorAll("[data-death-save]").forEach(L=>L.addEventListener("click",async()=>{if(!f||!_)return;const{deathSave:B,deathSaveIndex:X}=L.dataset,ee=Number(X);if(!B||!ee)return;const ue=f.data||{},be=ue.death_saves||{},ge=Math.max(0,Math.min(3,Number(be[B])||0)),he=ee===ge?ge-1:ee,ye={successes:Math.max(0,Math.min(3,B==="successes"?he:Number(be.successes)||0)),failures:Math.max(0,Math.min(3,B==="failures"?he:Number(be.failures)||0))};await cn(f,{...ue,death_saves:ye},"Tiri salvezza contro morte aggiornati",()=>Ze(n))})),n.querySelectorAll("[data-weakness-level]").forEach(L=>L.addEventListener("click",async()=>{if(!f||!_)return;const B=Number(L.dataset.weaknessLevel);if(!B)return;const X=f.data||{},ee=X.hp||{},ue=Math.max(0,Math.min(6,Number(ee.weak_points)||0));await cn(f,{...X,hp:{...ee,weak_points:B===ue?0:B}},"Punti indebolimento aggiornati",()=>Ze(n))}));const G=n.querySelector(".character-avatar");G&&(G.setAttribute("draggable","false"),G.addEventListener("click",L=>{L.preventDefault(),xh(f)}),G.addEventListener("contextmenu",L=>{L.preventDefault()}),G.addEventListener("dragstart",L=>{L.preventDefault()})),n.querySelectorAll("[data-item-image]").forEach(L=>{L.setAttribute("draggable","false"),L.addEventListener("click",B=>{B.preventDefault(),B.stopPropagation();const X=v==null?void 0:v.find(ee=>String(ee.id)===L.dataset.itemImage);X&&ka(X)})}),n.querySelectorAll("[data-item-preview]").forEach(L=>{L.addEventListener("click",B=>{B.preventDefault(),B.stopPropagation();const X=v==null?void 0:v.find(ee=>String(ee.id)===L.dataset.itemPreview);X&&ka(X)})})}finally{rt(!1)}}function Oh(){Qo()}function Qo(){ro||(document.addEventListener("click",async n=>{if(!n.target.closest("[data-actions-fab]"))return;const t=n.target.closest("[data-hp-action]"),r=n.target.closest("[data-money-action]"),i=n.target.closest("[data-rest]"),s=n.target.closest("[data-open-dice]"),l=n.target.closest("[data-add-loot]"),u=n.target.closest("[data-edit-conditions]");if(!t&&!r&&!i&&!s&&!l&&!u)return;n.preventDefault(),Rh();const h=Sa??null;if(t){await zh(t.dataset.hpAction,h);return}if(r){if((window.location.hash.replace("#/","")||"home")==="inventory")return;await Ph(r.dataset.moneyAction,h);return}if(i){await Uh(i.dataset.rest,h);return}if(s){Zo(s.dataset.openDice);return}if(l){await Nh(h);return}u&&await Xo(h)}),ro=!0)}function Rh(){const n=document.querySelector("[data-actions-fab]"),e=document.querySelector("[data-actions-toggle]");!n||!n.classList.contains("is-open")||(n.classList.remove("is-open"),e==null||e.setAttribute("aria-expanded","false"))}function mr(){const n=ht(),{user:e,offline:t,characters:r,activeCharacterId:i}=n,s=bt(i);return{activeCharacter:r.find(u=>bt(u.id)===s),canEditCharacter:!!e&&!t}}async function Xo(n){const{activeCharacter:e,canEditCharacter:t}=mr();if(!e||!t)return;const r=await Ch(e);if(!r)return;const i=r.getAll("conditions");await cn(e,{...e.data,conditions:i},"Condizioni aggiornate",()=>{n&&Ze(n)})}async function Nh(n){const{activeCharacter:e}=mr(),t=ht();if(!e)return;if(t.offline){Y("Loot disponibile solo online.","error");return}const i=xa(e)==="kg"?"0.1":"1",s=await dt({title:"Aggiungi loot rapido",submitLabel:"Aggiungi",content:wh(i)});if(s)try{await qo({user_id:e.user_id,character_id:e.id,name:s.get("name"),qty:Number(s.get("qty")),weight:Number(s.get("weight")),volume:Number(s.get("volume"))||0,value_cp:Number(s.get("value_cp")),category:"loot",equipable:!1,equip_slot:null,equip_slots:[],sovrapponibile:!1,is_magic:!1,max_volume:null}),Y("Loot aggiunto"),n&&Ze(n)}catch{Y("Errore loot","error")}}async function Ph(n,e){const{activeCharacter:t,canEditCharacter:r}=mr();if(!t)return;if(!r){Y("Azioni denaro disponibili solo con profilo online","error");return}const i=ht();let s=i.cache.wallet;if(!s&&!i.offline)try{s=await Ko(t.id),xt("wallet",s),s&&await qt({wallet:s})}catch{Y("Errore caricamento wallet","error")}const h=await dt({title:n==="pay"?"Paga monete":"Ricevi monete",submitLabel:n==="pay"?"Paga":"Ricevi",content:Ri({direction:n})});if(!h)return;s||(s={user_id:t.user_id,character_id:t.id,cp:0,sp:0,gp:0,pp:0});const f=h.get("coin"),g=Number(h.get("amount")||0),y={cp:f==="cp"?g:0,sp:f==="sp"?g:0,gp:f==="gp"?g:0,pp:f==="pp"?g:0},_=n==="pay"?-1:1,w=Object.fromEntries(Object.entries(y).map(([E,j])=>[E,j*_])),v=$r(s,w);try{const E=await dr({...v,user_id:s.user_id,character_id:s.character_id});await Ho({user_id:s.user_id,character_id:s.character_id,direction:n,amount:w,reason:h.get("reason"),occurred_on:h.get("occurred_on")}),xt("wallet",E),await qt({wallet:E}),Y("Wallet aggiornato"),e&&Ze(e)}catch{Y("Errore aggiornamento denaro","error")}}const Ih=Mi.reduce((n,e)=>(n[e.key]=e.label,n),{}),ao={advantage:["invisibile"],disadvantage:["accecato","avvelenato","intralciato","prono","spaventato"]},io={disadvantage:{dex:["intralciato"]},autoFail:{str:["paralizzato","privo_di_sensi","stordito"],dex:["paralizzato","privo_di_sensi","stordito"]}};function Hi(n){const e=(n==null?void 0:n.data)||{};return Array.isArray(e.conditions)?e.conditions:e.condition?[e.condition]:[]}function jr(n){return n.map(e=>Ih[e]||e).filter(Boolean)}function Lh(n){const e=ao.advantage.filter(r=>n.includes(r)),t=ao.disadvantage.filter(r=>n.includes(r));return e.length&&t.length?{rollMode:null,rollModeReason:null}:e.length?{rollMode:"advantage",rollModeReason:`Vantaggio: condizioni ${jr(e).join(", ")}.`}:t.length?{rollMode:"disadvantage",rollModeReason:`Svantaggio: condizioni ${jr(t).join(", ")}.`}:{rollMode:null,rollModeReason:null}}function qh(n,e){const r=(io.autoFail[e]||[]).filter(l=>n.includes(l));if(r.length)return{disabled:!0,disabledReason:`Condizioni: ${jr(r).join(", ")}`};const s=(io.disadvantage[e]||[]).filter(l=>n.includes(l));return s.length?{rollMode:"disadvantage",rollModeReason:`Svantaggio: condizioni ${jr(s).join(", ")}.`}:{}}function jh(n,e=[]){const t=n.data||{},r=t.abilities||{},i=St(t.proficiency_bonus),s=t.skills||{},l=t.skill_mastery||{},h=Hi(n).includes("avvelenato")?["avvelenato"]:[],f=(e||[]).some(g=>g.category==="armor"&&g.armor_type==="heavy"&&g.equipable&&In(g).length);return ya.map(g=>{const y=!!s[g.key],_=!!l[g.key],w=Br(r[g.ability],i,y?_?2:1:0),v=w??0,E=g.key==="stealth"&&f,j=[];return h.length&&j.push(`Svantaggio: condizioni ${jr(h).join(", ")}.`),E&&j.push("Svantaggio automatico: armatura pesante su Furtivit."),{value:g.key,label:`${g.label} (${gt(w)})`,shortLabel:g.label,modifier:v,rollMode:j.length?"disadvantage":null,rollModeReason:j.length?j.join(" "):null}})}function Dh(n){const e=n.data||{},t=e.abilities||{},r=St(e.proficiency_bonus),i=e.saving_throws||{},s=Hi(n);return _a.map(l=>{const u=!!i[l.key],h=Br(t[l.key],r,u?1:0),f=h??0,g=qh(s,l.key),y=g.disabled?"  fallimento diretto":"";return{value:l.key,label:`${l.label} (${gt(h)})${y}`,shortLabel:pn[l.key]||l.label,modifier:f,rollMode:g.rollMode||null,rollModeReason:g.rollModeReason||null,disabled:g.disabled||!1,disabledReason:g.disabledReason||null}})}function Mh(n,e=[]){var z;const t=n.data||{},r=Number(t.attack_bonus_melee??t.attack_bonus)||0,i=Number(t.attack_bonus_ranged??t.attack_bonus)||0,s=(e||[]).filter(T=>T.category==="weapon"&&T.equipable&&In(T).length),l=St(t.proficiency_bonus)??0,u=t.proficiencies||{},h=Hi(n),f=Lh(h),g=s.map(T=>{var G;const H=T.weapon_range||(T.range_normal?"ranged":"melee"),U=T.attack_ability||(H==="ranged"?"dex":"str"),R=Wt((G=t.abilities)==null?void 0:G[U])??0,F=(T.weapon_type==="simple"?!!u.weapon_simple:T.weapon_type==="martial"?!!u.weapon_martial:!1)?l:0,pe=H==="ranged"?i:r,Ae=R+F+(Number(T.attack_modifier)||0)+pe;return{value:`weapon:${T.id??T.name}`,label:`${T.name} (${gt(Ae)})`,shortLabel:T.name,modifier:Ae,rollMode:f.rollMode,rollModeReason:f.rollModeReason}}),_=(t.spellcasting||{}).ability,w=_?(z=t.abilities)==null?void 0:z[_]:null,v=Wt(w),E=v===null||l===null?null:v+l,V=(Array.isArray(t.spells)?t.spells:[]).filter(T=>(T.kind==="cantrip"||Number(T.level)===0)&&T.attack_roll&&T.damage_die);return _&&E!==null&&V.forEach(T=>{g.push({value:`spell:${T.id}`,label:`${T.name} (${gt(E)})`,shortLabel:T.name,modifier:E,rollMode:f.rollMode,rollModeReason:f.rollModeReason})}),g}function Bh(n){var h;const e=n.data||{},t=St(e.proficiency_bonus),i=(e.spellcasting||{}).ability,s=i?(h=e.abilities)==null?void 0:h[i]:null,l=Wt(s);if(!i||l===null||t===null)return[];const u=l+t;return[{value:"spell-attack",label:`Incantesimi (${gt(u)})`,shortLabel:"Incantesimi",modifier:u}]}function Zo(n){var f,g,y,_,w;const{activeCharacter:e,canEditCharacter:t}=mr(),r=ht().cache.items||[],i=!!((f=e==null?void 0:e.data)!=null&&f.inspiration)&&t,s=Number((y=(g=e==null?void 0:e.data)==null?void 0:g.hp)==null?void 0:y.weak_points)||0,l=i&&e?async()=>{const v=e.data||{};v.inspiration&&await cn(e,{...v,inspiration:!1},"Ispirazione consumata",Sa?()=>Ze(Sa):null)}:null,h={"saving-throws":{title:"Tiro Salvezza",mode:"d20",rollType:"TS",selection:e?{label:"Tiro salvezza",options:Dh(e)}:null},skills:{title:"Tiro Abilit",mode:"d20",rollType:"TA",selection:e?{label:"Abilit",options:jh(e,r)}:null},"attack-roll":{title:"Tiro per Colpire",mode:"d20",rollType:"TC",selection:e?{label:"Attacco",options:Mh(e,r)}:null},"spell-attack":{title:"Tiro per Colpire Incantesimi",mode:"d20",rollType:"TC",selection:e?{label:"Incantesimi",options:Bh(e)}:null},roller:{title:"Lancia Dadi generico",mode:"generic",rollType:"GEN"}}[n]??{title:"Lancia dadi",mode:"generic"};if(n==="spell-attack"&&!((w=(_=h.selection)==null?void 0:_.options)!=null&&w.length)){Y("Configura abilit da incantatore e bonus competenza per usare questo tiro.","error");return}Fh({...h,allowInspiration:i,onConsumeInspiration:l,weakPoints:s,characterId:e==null?void 0:e.id})}async function Uh(n,e){var i,s;const{activeCharacter:t}=mr();if(!(!t||!await Pn({title:"Conferma riposo",message:n==="long_rest"?"Stai per effettuare un riposo lungo: risorse, slot e recuperi verranno aggiornati in base alle regole configurate.":"Stai per effettuare un riposo breve: verranno aggiornate solo le risorse che si recuperano con questo tipo di riposo.",confirmLabel:"Conferma riposo"})))try{await kd(t.id,n),Y(n==="long_rest"?"Riposo lungo completato":"Riposo breve completato");const u=await Io(t.id);xt("resources",u),await qt({resources:u});const h=Kd(t.data,n);if(h?await cn(t,h,null,e?()=>Ze(e):null):e&&Ze(e),n==="long_rest"){const f=ht().characters.find(g=>g.id===t.id);(s=(i=f==null?void 0:f.data)==null?void 0:i.spellcasting)!=null&&s.can_prepare&&await Yo(f,e?()=>Ze(e):null)}}catch{Y("Errore aggiornamento risorse","error")}}async function zh(n,e){var G,L,B,X,ee,ue,be,ge,he;const{activeCharacter:t,canEditCharacter:r}=mr();if(!t)return;if(!r){Y("Azioni HP disponibili solo con profilo online","error");return}const l=await dt({title:n==="heal"?"Cura PF":"Subisci danno",submitLabel:n==="heal"?"Cura":"Danno",content:Kh(t,{allowHitDice:n==="heal",allowTempHp:n==="heal",allowMaxOverride:n==="damage"})});if(!l)return;const u=l.has("use_hit_dice"),h=l.has("temp_hp"),f=((G=t.data)==null?void 0:G.hit_dice)||{},g=((L=t.data)==null?void 0:L.abilities)||{},y=Number(f.used)||0,_=Number(f.max)||0,w=Bo(f.die),v=Math.max(Number(l.get("hit_dice_count"))||1,1);let E=Number(l.get("amount"));if(n==="heal"&&u){if(!w){Y("Configura un dado vita valido","error");return}if(y>=_){Y("Nessun dado vita disponibile","error");return}const ye=Math.max(_-y,0);if(v>ye){Y(`Hai solo ${ye} dadi vita disponibili`,"error");return}const Pe=Wt(g.con)??0,Q=Array.from({length:v},()=>jd(w)).reduce((ze,we)=>ze+we,0);E=Math.max(Q+Pe*v,1)}if(!E||E<=0){Y("Inserisci un valore valido","error");return}const j=Number((X=(B=t.data)==null?void 0:B.hp)==null?void 0:X.current)||0,V=Number((ue=(ee=t.data)==null?void 0:ee.hp)==null?void 0:ue.temp)||0,z=(ge=(be=t.data)==null?void 0:be.hp)==null?void 0:ge.max,T=l.get("hp_max_override"),H=T===null||T===""?null:Number(T);if(n==="damage"&&H!==null&&(!Number.isFinite(H)||H<=0)){Y("Inserisci un massimo PF valido","error");return}let U=j,R=V;if(n==="heal"&&h)R=V+E;else if(n==="heal")U=j+E;else{const ye=Math.min(V,E);R=V-ye;const Pe=E-ye;U=Math.max(j-Pe,0)}const M=H??z,F=M!=null?Math.min(U,Number(M)):U,pe=n==="heal"&&u?{...f,used:Math.min(y+v,_)}:f,Ae=n==="heal"?`${h?"HP temporanei +":"PF curati +"}${E}${u?` (${v}d${w})`:""}`:`Danno ${E}`;await cn(t,{...t.data,hp:{...(he=t.data)==null?void 0:he.hp,current:F,temp:R,max:H??z},hit_dice:pe},Ae,e?()=>Ze(e):null)}function Fh({title:n,mode:e,selection:t=null,allowInspiration:r=!1,onConsumeInspiration:i=null,rollType:s=null,weakPoints:l=0,characterId:u=null,historyLabel:h=null}){Or({keepOpen:!0,title:n,mode:e,selection:t,allowInspiration:r,onConsumeInspiration:i,rollType:s,weakPoints:l,characterId:u,historyLabel:h})}function Kh(n,{allowHitDice:e=!0,allowTempHp:t=!1,allowMaxOverride:r=!1}={}){var U;const i=document.createElement("div");i.className="modal-form-grid hp-shortcut-fields";const s=de({label:"Valore",name:"amount",type:"number",value:"1"});s.classList.add("hp-shortcut-fields__amount");const l=s.querySelector("input");l&&(l.min="1",l.required=!0);const u=document.createElement("div");if(u.className="modal-form-row modal-form-row--balanced hp-shortcut-fields__row",u.appendChild(s),t){const R=document.createElement("div");R.className="modal-toggle-field",R.innerHTML=`
      <span class="modal-toggle-field__label">HP temporanei</span>
      <label class="diceov-toggle">
        <input type="checkbox" name="temp_hp" />
        <span class="diceov-toggle-track" aria-hidden="true"></span>
      </label>
    `,u.appendChild(R)}if(i.appendChild(u),!e){if(r){const R=de({label:"Nuovo massimo PF",name:"hp_max_override",type:"number",value:""}),M=R.querySelector("input");M&&(M.min="1"),i.appendChild(R)}return i}const h=((U=n==null?void 0:n.data)==null?void 0:U.hit_dice)||{},f=Number(h.used)||0,g=Number(h.max)||0,y=Math.max(g-f,0),_=Bo(h.die),w=y>0&&_,v=document.createElement("div");v.className="modal-toggle-field";const E=h.die?`${h.die}`:"dado vita";v.innerHTML=`
    <span class="modal-toggle-field__label">Usa dado vita (${E})  rimasti ${y}/${g||"-"}</span>
    <label class="diceov-toggle">
      <input type="checkbox" name="use_hit_dice" ${w?"":"disabled"} />
      <span class="diceov-toggle-track" aria-hidden="true"></span>
    </label>
  `;const j=document.createElement("label");j.className="field hit-dice-count hp-shortcut-fields__count",j.innerHTML=`
    <span>Numero dadi vita</span>
    <input type="number" name="hit_dice_count" min="1" max="${y}" value="1" />
  `;const V=document.createElement("div");if(V.className="modal-form-row modal-form-row--balanced hp-shortcut-fields__row",V.append(v,j),i.appendChild(V),!w){const R=document.createElement("p");R.className="muted",R.textContent="Nessun dado vita disponibile o configurato.",i.appendChild(R)}const z=v.querySelector("input"),T=j.querySelector("input");T&&(T.required=!1);const H=()=>{const R=z==null?void 0:z.checked;l&&(l.disabled=!!R,l.required=!R,R?l.value="":l.value||(l.value="1"),T&&(T.disabled=!R,T.required=!!R,R||(T.value="1")))};return z==null||z.addEventListener("change",H),H(),i}async function el(n){const e=ht(),{user:t,offline:r}=e;rt(!0);let i=e.characters;try{if(!r&&t)try{i=await No(t.id),un({characters:i}),await qt({characters:i})}catch{Y("Errore caricamento personaggi","error")}const s=bt(e.activeCharacterId),l=i.find(f=>bt(f.id)===s),u=!!t&&!r;n.innerHTML=`
    <section class="auth-screen character-select-view">
      <div class="card character-select-card">
      <header class="character-select-header">
        <div>
          <p class="title-car-select">Seleziona o crea un personaggio</p>        
        </div>
        ${u?'<button class="icon-button icon-button--add character-select-add" type="button" data-create-character aria-label="Nuovo personaggio" title="Nuovo personaggio">+</button>':""}
      </header>
        <div class="character-card-grid">
        ${i.length?i.map(f=>Hh(f,f.id===(l==null?void 0:l.id))).join(""):"<p>Non hai ancora creato un personaggio.</p>"}
        </div>
      </div>
    </section>
  `,n.querySelectorAll("[data-character-card]").forEach(f=>{f.addEventListener("click",()=>{Ea(f.dataset.characterCard),Nl("home")})});const h=n.querySelector("[data-create-character]");h&&h.addEventListener("click",()=>{xi(t,()=>el(n))})}finally{rt(!1)}}function Hh(n,e){const t=n.data||{},r=t.avatar_url?`<img src="${t.avatar_url}" alt="Ritratto di ${n.name}" />`:`<span>${Wh(n.name)}</span>`,i=t.level?`Livello ${t.level}`:null,s=t.class_name||t.class_archetype||t.archetype,u=[...[i,s].filter(Boolean),t.race].filter(Boolean);return`
    <button class="character-card ${e?"is-active":""}" type="button" data-character-card="${n.id}">
      <div class="character-card-avatar">
        ${r}
      </div>
      <div class="character-card-info">
        <h3>${n.name}</h3>
        ${u.length?`<div class="character-card-tags">
            ${u.map(h=>`<span class="character-tag">${h}</span>`).join("")}
          </div>`:'<p class="character-card-meta muted">Dettagli base non specificati</p>'}
      </div>
    </button>
  `}function Wh(n=""){const e=n.split(" ").filter(Boolean);return e.length?e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]}${e[1][0]}`.toUpperCase():"??"}function Vh(n){const e="/dungeons-dragons-app/";return`
    <div class="wallet-summary">     
      <div class="wallet-list">
        ${[{key:"pp",label:"Platino",icon:`${e}icons/moneta_platino.png`},{key:"gp",label:"Oro",icon:`${e}icons/moneta_oro.png`},{key:"sp",label:"Argento",icon:`${e}icons/moneta_argento.png`},{key:"cp",label:"Rame",icon:`${e}icons/moneta_rame.png`}].map(r=>`
          <div class="stat-card wallet-card">
            <div class="wallet-card__info">
              <span class="coin-avatar coin-avatar--${r.key}" aria-hidden="true">
                <img src="${r.icon}" alt="" loading="lazy" />
              </span>
              <strong>${r.label}</strong>
            </div>
            <strong>${(n==null?void 0:n[r.key])??0}</strong>
          </div>
        `).join("")}
      </div>
    </div>
  `}async function bn(n){const e=ht(),t=bt(e.activeCharacterId),r=e.characters.find(R=>bt(R.id)===t);if(!r){n.innerHTML='<section class="card"><p>Nessun personaggio selezionato.</p></section>';return}const i=async R=>{rt(!0);try{return await R()}finally{rt(!1)}};let s=e.cache.items,l=e.cache.wallet,u=[];if(!e.offline){try{s=await Lo(r.id),xt("items",s),await qt({items:s})}catch{Y("Errore caricamento inventario","error")}try{l=await Ko(r.id),xt("wallet",l),l&&await qt({wallet:l})}catch{Y("Errore caricamento wallet","error")}try{u=await kh(r.id)}catch{Y("Errore caricamento transazioni","error")}}const h=Oi(s),f=xa(r);n.innerHTML=`
    <div class="inventory-layout">
      <section class="card inventory-main">
        <header class="card-header">
          <p class="eyebrow">Inventario</p>
          <div class="button-row">
            <button class="icon-button icon-button--add" type="button" data-add-item aria-label="Nuovo oggetto">
              <span aria-hidden="true">+</span>
            </button>
          </div>
        </header>
        <div class="filters">
          <input type="search" placeholder="Cerca" data-search />
          <select data-category></select>
          <label class="toggle-pill filter-toggle">
            <input type="checkbox" data-equipable-filter />
            <span>Oggetti equipaggiabili</span>
          </label>
          <label class="toggle-pill filter-toggle">
            <input type="checkbox" data-magic-filter />
            <span>Oggetti magici</span>
          </label>
          <span class="pill">Carico totale: <strong data-carry-total>${wa(h,f)}</strong></span>
        </div>
        <div class="inventory-list-scroll" data-inventory-list></div>
      </section>
      <div class="inventory-side">
        <section class="card inventory-wallet">
          <header class="card-header">
            <p class="eyebrow">Monete</p>
            <div class="button-row">
              <button class="icon-button" type="button" data-edit-wallet aria-label="Modifica monete" title="Modifica monete">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          ${Vh(l)}
        </section>
        <section class="card">
          <header class="card-header">
            <p class="eyebrow">Transazioni</p>
            <div class="button-row">
              <button class="icon-button icon-button--swap" type="button" data-exchange-coins aria-label="Scambia monete" title="Scambia monete">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          <div class="inventory-transactions">
            ${e.offline?'<p class="muted">Transazioni disponibili solo online.</p>':vh(u).outerHTML}
          </div>
        </section>
      </div>
    </div>
  `;const g=n.querySelector("[data-inventory-list]"),y=n.querySelector("[data-search]"),_=n.querySelector("[data-category]"),w=n.querySelector("[data-equipable-filter]"),v=n.querySelector("[data-magic-filter]"),E=n.querySelector("[data-carry-total]");Wd.forEach(R=>{const M=document.createElement("option");M.value=R.value,M.textContent=R.equipable?`${R.label}`:R.label,_.appendChild(M)});function j(){const R=y.value.toLowerCase(),M=_.value,F=(w==null?void 0:w.checked)??!1,pe=(v==null?void 0:v.checked)??!1,Ae=s.filter(G=>{const L=G.name.toLowerCase().includes(R),B=!M||G.category===M,X=!F||G.equipable,ee=!pe||G.is_magic;return L&&B&&X&&ee});g.innerHTML=bh(Ae,f),E&&(E.textContent=wa(Oi(Ae),f)),g.querySelectorAll("[data-edit]").forEach(G=>G.addEventListener("click",()=>{const L=s.find(B=>B.id===G.dataset.edit);L&&to(r,L,s,bn.bind(null,n))})),g.querySelectorAll("[data-item-image]").forEach(G=>G.addEventListener("click",L=>{L.preventDefault(),L.stopPropagation();const B=s.find(X=>String(X.id)===G.dataset.itemImage);B&&ka(B)})),g.querySelectorAll("[data-item-preview]").forEach(G=>G.addEventListener("click",L=>{L.preventDefault(),L.stopPropagation();const B=s.find(X=>String(X.id)===G.dataset.itemPreview);B&&ka(B)})),g.querySelectorAll("[data-delete]").forEach(G=>G.addEventListener("click",async()=>{const L=s.find(X=>X.id===G.dataset.delete);!L||!await Pn({title:"Conferma eliminazione oggetto",message:`Stai per eliminare l'oggetto "${L.name}" dall'inventario. Questa azione non pu essere annullata.`,confirmLabel:"Elimina"})||await i(async()=>{try{await Ad(L.id),Y("Oggetto eliminato"),bn(n)}catch{Y("Errore eliminazione","error")}})})),g.querySelectorAll("[data-use]").forEach(G=>G.addEventListener("click",async()=>{const L=s.find(B=>B.id===G.dataset.use);if(L){if(L.qty<=0){Y("Quantit esaurita","error");return}await i(async()=>{try{const B=Math.max(L.qty-1,0);await ba(L.id,{qty:B}),Y("Consumabile usato"),bn(n)}catch{Y("Errore utilizzo consumabile","error")}})}}))}j(),y.addEventListener("input",j),_.addEventListener("change",j),w==null||w.addEventListener("change",j),v==null||v.addEventListener("change",j),document.querySelectorAll("[data-money-action]").forEach(R=>{R.dataset.bound||(R.dataset.bound="true",R.addEventListener("click",async()=>{if((window.location.hash.replace("#/","")||"home")!=="inventory")return;const F=ht(),pe=bt(F.activeCharacterId),Ae=F.characters.find(Q=>bt(Q.id)===pe);if(!Ae)return;l=F.cache.wallet;const G=Ae.user_id,L=Ae.id,B=R.dataset.moneyAction,ue=await dt({title:B==="pay"?"Paga monete":"Ricevi monete",submitLabel:B==="pay"?"Paga":"Ricevi",content:Ri({direction:B})});if(!ue)return;l||(l={user_id:G,character_id:L,cp:0,sp:0,gp:0,pp:0});const be=ue.get("coin"),ge=Number(ue.get("amount")||0),he={cp:be==="cp"?ge:0,sp:be==="sp"?ge:0,gp:be==="gp"?ge:0,pp:be==="pp"?ge:0},ye=B==="pay"?-1:1,Pe=Object.fromEntries(Object.entries(he).map(([Q,ze])=>[Q,ze*ye])),Ve=$r(l,Pe);await i(async()=>{try{const Q=await dr({...Ve,user_id:G,character_id:L});await Ho({user_id:G,character_id:L,direction:B,amount:Pe,reason:ue.get("reason"),occurred_on:ue.get("occurred_on")}),l=Q,xt("wallet",Q),await qt({wallet:Q}),Y("Wallet aggiornato"),bn(n)}catch{Y("Errore aggiornamento denaro","error")}})}))});const V=n.querySelector("[data-edit-wallet]");V&&!V.dataset.bound&&(V.dataset.bound="true",V.addEventListener("click",async()=>{l||(l={user_id:r.user_id,character_id:r.id,cp:0,sp:0,gp:0,pp:0});const R=await dt({title:"Modifica monete",submitLabel:"Salva",content:_h(l)});if(!R)return;const M={...l,pp:Math.max(0,Number(R.get("pp")||0)),gp:Math.max(0,Number(R.get("gp")||0)),sp:Math.max(0,Number(R.get("sp")||0)),cp:Math.max(0,Number(R.get("cp")||0))};await i(async()=>{try{const F=await dr({...M,user_id:l.user_id,character_id:l.character_id});xt("wallet",F),await qt({wallet:F}),Y("Monete aggiornate"),bn(n)}catch{Y("Errore aggiornamento monete","error")}})}));const z=n.querySelector("[data-exchange-coins]");z&&!z.dataset.bound&&(z.dataset.bound="true",z.addEventListener("click",async()=>{const R={cp:1,sp:10,gp:100,pp:1e3},M={cp:"Rame (CP)",sp:"Argento (SP)",gp:"Oro (GP)",pp:"Platino (PP)"},F={cp:Number((l==null?void 0:l.cp)??0),sp:Number((l==null?void 0:l.sp)??0),gp:Number((l==null?void 0:l.gp)??0),pp:Number((l==null?void 0:l.pp)??0)},pe=Object.keys(F).filter(we=>F[we]>0),Ae=pe[0]??"gp",G=pe.find(we=>we!==Ae)??(Ae==="pp"?"gp":"pp"),L=await dt({title:"Scambia monete",submitLabel:"Scambia",content:yh({available:F,source:Ae,target:G}),onOpen:({fieldsEl:we})=>{if(!we)return null;const Oe=we.querySelector('select[name="source"]'),Re=we.querySelector('select[name="target"]'),Be=we.querySelector('input[name="amount"]'),ce=we.querySelector('input[name="target_amount"]'),Rt=we.querySelector("[data-exchange-max]"),Et=we.querySelector("[data-exchange-available]"),qe=(it,yt,Je)=>{const lt=R[it],Xe=R[yt];if(!lt||!Xe)return{amount:0,targetAmount:0};const Ne=Number(F[it]??0),st=Math.min(Number(Je)||0,Ne)*lt,_t=Math.floor(st/Xe);return{amount:Math.floor(_t*Xe/lt),targetAmount:_t}},At=it=>{if(!Et)return;if(!it){Et.textContent="Nessuna moneta disponibile";return}const yt=M[it]??it;Et.textContent=`Disponibili: ${F[it]??0} ${yt}`},Nt=(it,{useAdjustedAmount:yt=!0}={})=>{const Je=Oe==null?void 0:Oe.value,lt=Re==null?void 0:Re.value;if(!Je||!lt||!Be||!ce)return;const Xe=qe(Je,lt,it);yt&&(Be.value=Xe.amount),ce.value=Xe.targetAmount};Oe&&At(Oe.value),Be&&ce&&Nt(Be.value,{useAdjustedAmount:!0});const ft=()=>{At(Oe==null?void 0:Oe.value),Nt((Be==null?void 0:Be.value)??0,{useAdjustedAmount:!0})},at=()=>{Nt((Be==null?void 0:Be.value)??0,{useAdjustedAmount:!0})},Vt=()=>{Nt((Be==null?void 0:Be.value)??0,{useAdjustedAmount:!0})},Ut=()=>{if(!Oe||!Re||!Be)return;const it=Oe.value,yt=Re.value,Je=qe(it,yt,F[it]??0).amount;Be.value=Je,Nt(Je,{useAdjustedAmount:!1})};return Oe==null||Oe.addEventListener("change",ft),Re==null||Re.addEventListener("change",at),Be==null||Be.addEventListener("input",Vt),Rt==null||Rt.addEventListener("click",Ut),()=>{Oe==null||Oe.removeEventListener("change",ft),Re==null||Re.removeEventListener("change",at),Be==null||Be.removeEventListener("input",Vt),Rt==null||Rt.removeEventListener("click",Ut)}}});if(!L)return;l||(l={user_id:r.user_id,character_id:r.id,cp:0,sp:0,gp:0,pp:0});const B=Number(L.get("amount")||0),X=L.get("source"),ee=L.get("target"),ue=Number(l[X]||0),be=R[X],ge=R[ee],ye=Math.min(B,ue)*be,Pe=Math.floor(ye/ge),Ve=Math.floor(Pe*ge/be);if(B<=0){Y("Inserisci un importo valido","error");return}if(X===ee){Y("Scegli due monete diverse","error");return}if(Ve<=0){Y("Importo troppo basso per il cambio","error");return}if(Ve>Number(l[X]||0)){Y("Monete insufficienti","error");return}Ve!==B&&Y(`Adeguato a ${Ve} ${X.toUpperCase()} per un cambio preciso`,"info");const Q={cp:0,sp:0,gp:0,pp:0,[X]:-Ve,[ee]:Pe},ze=$r(l,Q);await i(async()=>{try{const we=await dr({...ze,user_id:l.user_id,character_id:l.character_id});xt("wallet",we),await qt({wallet:we}),Y("Scambio completato"),bn(n)}catch{Y("Errore scambio monete","error")}})}));const T=R=>{const M=Ki(R.amount);return{cp:Number(M.cp??0),sp:Number(M.sp??0),gp:Number(M.gp??0),pp:Number(M.pp??0)}},H=R=>{if(!R)return"";const M=new Date(R);return Number.isNaN(M.getTime())?"":M.toISOString().split("T")[0]},U=R=>["pp","gp","sp","cp"].map(F=>({coin:F,value:Number(R[F]??0)})).find(F=>F.value!==0)??{coin:"gp",value:0};n.querySelectorAll("[data-edit-transaction]").forEach(R=>R.addEventListener("click",async()=>{const M=u.find(he=>he.id===R.dataset.editTransaction);if(!M)return;const F=T(M),{coin:pe,value:Ae}=U(F),G=await dt({title:"Modifica transazione",submitLabel:"Salva",content:Ri({amount:Math.abs(Ae),coin:pe,reason:M.reason??"",occurredOn:H(M.occurred_on||M.created_at),direction:M.direction,includeDirection:!0})});if(!G)return;const L=G.get("direction")||M.direction,B=G.get("coin"),X=Number(G.get("amount")||0),ee=L==="pay"?-1:1,ue={cp:0,sp:0,gp:0,pp:0,[B]:X*ee},be=Object.fromEntries(Object.keys(ue).map(he=>[he,(ue[he]||0)-(F[he]||0)])),ge=l?$r(l,be):null;await i(async()=>{try{if(ge){const he=await dr({...ge,user_id:l.user_id,character_id:l.character_id});xt("wallet",he),await qt({wallet:he})}await Sh(M.id,{direction:L,amount:ue,reason:G.get("reason"),occurred_on:G.get("occurred_on")}),Y("Transazione aggiornata"),bn(n)}catch{Y("Errore aggiornamento transazione","error")}})})),n.querySelectorAll("[data-delete-transaction]").forEach(R=>R.addEventListener("click",async()=>{const M=u.find(L=>L.id===R.dataset.deleteTransaction);if(!M||!await Pn({title:"Conferma eliminazione transazione",message:"Stai per eliminare una transazione dal registro del denaro. I saldi verranno aggiornati di conseguenza e l'azione non pu essere annullata.",confirmLabel:"Elimina"}))return;const pe=T(M),Ae=Object.fromEntries(Object.keys(pe).map(L=>[L,-pe[L]])),G=l?$r(l,Ae):null;await i(async()=>{try{if(G){const L=await dr({...G,user_id:l.user_id,character_id:l.character_id});xt("wallet",L),await qt({wallet:L})}await Eh(M.id),Y("Transazione eliminata"),bn(n)}catch{Y("Errore eliminazione transazione","error")}})})),n.querySelector("[data-add-item]").addEventListener("click",()=>{to(r,null,s,bn.bind(null,n))})}const Wi="journal-session-files";async function Gh(n){const{data:e,error:t}=await De.from("journal_entries").select("*").eq("character_id",n).order("entry_date",{ascending:!1});if(t)throw t;return e??[]}async function Jh(n){const{data:e,error:t}=await De.from("journal_tags").select("*").eq("user_id",n).order("name");if(t)throw t;return e??[]}async function Yh(n){if(!n.length)return[];const{data:e,error:t}=await De.from("journal_entry_tags").select("*").in("entry_id",n);if(t)throw t;return e??[]}async function Qh(n){const{data:e,error:t}=await De.from("journal_session_files").select("*").eq("character_id",n).order("created_at",{ascending:!1});if(t)throw t;return e??[]}async function Xh({userId:n,characterId:e,file:t}){const r=(t.name.split(".").pop()||"pdf").toLowerCase(),i=(t.name.replace(/\.[^.]+$/,"")||"session-file").toLowerCase().replace(/[^a-z0-9-_]+/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||"session-file",s=`${n}/${e}/${Date.now()}-${i}.${r}`,{error:l}=await De.storage.from(Wi).upload(s,t,{cacheControl:"3600",upsert:!1,contentType:t.type||"application/pdf"});if(l)throw l;return s}async function so(n,e=300){const{data:t,error:r}=await De.storage.from(Wi).createSignedUrl(n,e);if(r)throw r;return(t==null?void 0:t.signedUrl)??null}async function Zh(n){const{data:e,error:t}=await De.from("journal_session_files").insert(n).select("*").single();if(t)throw t;return e}async function ef(n){const{error:e}=await De.from("journal_session_files").delete().eq("id",n.id);if(e)throw e;const{error:t}=await De.storage.from(Wi).remove([n.file_path]);if(t)throw t}async function tf(n){const{data:e,error:t}=await De.from("journal_entries").insert(n).select("*").single();if(t)throw t;return e}async function nf(n,e){const{data:t,error:r}=await De.from("journal_entries").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function rf(n){const{error:e}=await De.from("journal_entries").delete().eq("id",n);if(e)throw e}async function af(n){const{data:e,error:t}=await De.from("journal_tags").insert(n).select("*").single();if(t)throw t;return e}async function oo(n,e){const{error:t}=await De.from("journal_entry_tags").insert({entry_id:n,tag_id:e});if(t)throw t}async function sf(n,e){const{error:t}=await De.from("journal_entry_tags").delete().eq("entry_id",n).eq("tag_id",e);if(t)throw t}async function tl(n){const e=ht(),t=bt(e.activeCharacterId),r=e.characters.find(T=>bt(T.id)===t);if(!r){n.innerHTML='<section class="card"><p>Nessun personaggio selezionato.</p></section>';return}let i=e.cache.journal,s=e.cache.tags,l=[],u=[];if(!e.offline)try{i=await Gh(r.id),s=await Jh(r.user_id),l=await Yh(i.map(T=>T.id)),u=await Qh(r.id),xt("journal",i),xt("tags",s),await qt({journal:i,tags:s,entryTags:l})}catch{Y("Errore caricamento diario","error")}const h=new Map(s.map(T=>[T.id,T])),f=l.reduce((T,H)=>(T[H.entry_id]||(T[H.entry_id]=[]),T[H.entry_id].push(H.tag_id),T),{});n.innerHTML=`
    <div class="journal-layout">
      <section class="card journal-section-card journal-section-card--entries">
        <header class="card-header">
          <div>
            <p class="eyebrow">Diario</p>
            <h2>Appunti e sessioni</h2>
          </div>
          <button class="icon-button icon-button--add" data-add-entry aria-label="Nuova voce" title="Nuova voce">
            <span aria-hidden="true">+</span>
          </button>
        </header>
        <div class="filters journal-filters-row">
          <input type="search" placeholder="Cerca per titolo o contenuto" data-search />
          <button data-add-tag class="icon-button" aria-label="Nuovo tag" title="Nuovo tag">
            <span aria-hidden="true"></span>
          </button>
        </div>
        <div data-journal-list></div>
      </section>

      <section class="card journal-section-card journal-section-card--files">
        <header class="card-header">
          <p class="eyebrow">File sessioni</p>
          <button class="icon-button" type="button" data-upload-session-file aria-label="Carica file sessione" title="Carica file sessione (PDF)">
            <span aria-hidden="true"></span>
          </button>
        </header>
        <input type="file" accept="application/pdf,.pdf" hidden data-session-file-input />
        <p class="muted" data-upload-feedback>${e.offline?"Modalit offline: upload non disponibile.":"Carica un PDF di sessione per salvarlo nel diario."}</p>
        <div data-session-files-list></div>
      </section>
    </div>
  `;const g=n.querySelector("[data-journal-list]"),y=n.querySelector("[data-session-files-list]"),_=n.querySelector("[data-search]"),w=n.querySelector("[data-upload-session-file]"),v=n.querySelector("[data-session-file-input]"),E=n.querySelector("[data-upload-feedback]");function j(){const T=_.value.toLowerCase().trim(),H=of(i,T);g.innerHTML=H.length?lf(H,f,h):'<p class="muted">Nessuna voce trovata.</p>',g.querySelectorAll("[data-edit]").forEach(U=>U.addEventListener("click",async()=>{const R=i.find(M=>M.id===U.dataset.edit);R&&await lo(r,R,s,f[R.id]??[],z)})),g.querySelectorAll("[data-delete]").forEach(U=>U.addEventListener("click",async()=>{const R=i.find(F=>F.id===U.dataset.delete);if(!(!R||!await Pn({title:"Conferma eliminazione voce",message:`Stai per eliminare la voce "${R.title||"Senza titolo"}" dal diario. Questa azione non pu essere annullata.`,confirmLabel:"Elimina"}))){rt(!0);try{await rf(R.id),Y("Voce eliminata"),await z()}catch{Y("Errore eliminazione","error")}finally{rt(!1)}}}))}function V(){y.innerHTML=u.length?cf(u):'<p class="muted">Nessun file caricato.</p>',y.querySelectorAll("[data-delete-file]").forEach(T=>T.addEventListener("click",async()=>{const H=u.find(R=>R.id===T.dataset.deleteFile);if(!(!H||!await Pn({title:"Conferma eliminazione file",message:`Stai per eliminare il file "${H.file_name}". Questa azione non pu essere annullata.`,confirmLabel:"Elimina"}))){rt(!0);try{await ef(H),Y("File eliminato"),z()}catch{Y("Errore eliminazione file","error")}finally{rt(!1)}}})),y.querySelectorAll("[data-preview-file]").forEach(T=>T.addEventListener("click",async()=>{const H=u.find(R=>R.id===T.dataset.previewFile);if(!H)return;rt(!0);let U=null;try{if(U=await so(H.file_path,600),!U){Y("Impossibile aprire lanteprima","error");return}}catch{Y("Errore apertura anteprima","error")}finally{rt(!1)}U&&ff(U)})),y.querySelectorAll("[data-download-file]").forEach(T=>T.addEventListener("click",async()=>{const H=u.find(U=>U.id===T.dataset.downloadFile);if(H){rt(!0);try{const U=await so(H.file_path,120);if(!U){Y("Impossibile scaricare il file","error");return}await hf(U,H.file_name)}catch{Y("Errore download file","error")}finally{rt(!1)}}}))}async function z(){await tl(n)}j(),V(),_.addEventListener("input",j),n.querySelector("[data-add-entry]").addEventListener("click",async()=>{await lo(r,null,s,[],z)}),n.querySelector("[data-add-tag]").addEventListener("click",async()=>{await mf(r,z)}),e.offline&&(w.disabled=!0),w==null||w.addEventListener("click",()=>v==null?void 0:v.click()),v==null||v.addEventListener("change",async()=>{var M;const T=(M=v.files)==null?void 0:M[0];if(!T)return;const H=10;if(T.type!=="application/pdf"){E&&(E.textContent="Formato non valido: carica un PDF."),Y("Carica solo file PDF","error"),v.value="";return}if(T.size>H*1024*1024){E&&(E.textContent="File troppo grande (max 10MB)."),Y("File troppo grande","error"),v.value="";return}const U=await pf(T);if(!U){v.value="",E&&(E.textContent="Caricamento annullato.");return}const R=U.displayName||T.name;E&&(E.textContent=`Upload in corso: ${R}...`),rt(!0);try{const F=await Xh({userId:r.user_id,characterId:r.id,file:T});await Zh({user_id:r.user_id,character_id:r.id,file_name:R,file_path:F,mime_type:T.type||"application/pdf",size_bytes:T.size,session_no:U.sessionNo,notes:U.notes,metadata:{original_name:T.name,display_name:R}}),Y("File caricato con successo","success"),E&&(E.textContent=`Caricato: ${R}`),v.value="",await z()}catch{E&&(E.textContent="Errore durante il caricamento del file."),Y("Errore upload file","error")}finally{rt(!1)}})}function of(n,e){return e?n.filter(t=>{var r,i;return((r=t.title)==null?void 0:r.toLowerCase().includes(e))||((i=t.content)==null?void 0:i.toLowerCase().includes(e))}):n}function lf(n,e,t){return`
    <ul class="journal-entry-list">
      ${n.map(r=>{const i=e[r.id]??[];return`
          <li class="journal-entry-card">
            <div>
              <strong>${r.title||"Senza titolo"}</strong>
              <p class="muted">${r.entry_date||""}  Sessione ${r.session_no??"-"}</p>
              <div class="tag-row">
                ${i.map(s=>{var l;return`<span class="chip">${((l=t.get(s))==null?void 0:l.name)??""}</span>`}).join("")}
              </div>
            </div>
            <div class="actions">
              <button class="icon-button" data-edit="${r.id}" aria-label="Modifica voce" title="Modifica">
                <span aria-hidden="true"></span>
              </button>
              <button class="icon-button icon-button--danger" data-delete="${r.id}" aria-label="Elimina voce" title="Elimina">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </li>
        `}).join("")}
    </ul>
  `}function cf(n){return`
    <ul class="journal-entry-list">
      ${n.map(e=>`
        <li class="journal-entry-card journal-entry-card--file">
          <div>
            <strong>${e.file_name}</strong>
            <p class="muted">${uf(e.size_bytes)}  ${e.mime_type||"application/pdf"}</p>
            ${e.session_no!==null&&e.session_no!==void 0?`<p class="muted">Sessione ${e.session_no}</p>`:""}
            ${e.notes?`<p class="muted">${e.notes}</p>`:""}
            <p class="muted">${df(e.created_at)}</p>
          </div>
          <div class="actions">
            <button class="icon-button" data-preview-file="${e.id}" aria-label="Visualizza file" title="Visualizza">
              <span aria-hidden="true"></span>
            </button>
            <button class="icon-button" data-download-file="${e.id}" aria-label="Scarica file" title="Scarica">
              <span aria-hidden="true"></span>
            </button>
            <button class="icon-button icon-button--danger" data-delete-file="${e.id}" aria-label="Elimina file" title="Elimina file">
              <span aria-hidden="true"></span>
            </button>
          </div>
        </li>
      `).join("")}
    </ul>
  `}function uf(n=0){const e=Number(n)||0;return e<1024?`${e} B`:e<1024*1024?`${Math.round(e/1024)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`}function df(n){if(!n)return"";const e=new Date(n);return Number.isNaN(e.getTime())?"":e.toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}async function hf(n,e){const t=e||"session-file.pdf";try{const r=await fetch(n,{credentials:"omit"});if(!r.ok)throw new Error(`Download HTTP error: ${r.status}`);const i=await r.blob(),s=URL.createObjectURL(i),l=document.createElement("a");l.href=s,l.download=t,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(s);return}catch{const i=document.createElement("a");i.href=n,i.download=t,i.rel="noopener",document.body.appendChild(i),i.click(),i.remove()}}function ff(n){if(window.open(n,"_blank","noopener,noreferrer"))return;const t=document.createElement("a");t.href=n,t.target="_blank",t.rel="noopener noreferrer",document.body.appendChild(t),t.click(),t.remove()}async function pf(n){const e=document.createElement("div");e.className="drawer-form modal-form-grid",e.appendChild(de({label:"Nome file visibile",name:"display_name",value:n.name})),e.appendChild(de({label:"Sessione (opzionale)",name:"session_no",type:"number"})),e.appendChild(yn({label:"Note (opzionale)",name:"notes",placeholder:"Aggiungi contesto o descrizione del file"}));const t=await dt({title:"Dettagli file sessione",submitLabel:"Carica file",content:e});if(!t)return null;const r=t.get("session_no"),i=Number(r),s=Number.isFinite(i)&&i>=0?i:null,l=String(t.get("display_name")||"").trim(),u=String(t.get("notes")||"").trim();return{displayName:l,sessionNo:s,notes:u||null}}async function lo(n,e,t,r,i){const s=document.createElement("div");s.className="drawer-form modal-form-grid",s.appendChild(de({label:"Titolo",name:"title",value:(e==null?void 0:e.title)??""})),s.appendChild(de({label:"Data",name:"entry_date",type:"date",value:(e==null?void 0:e.entry_date)??new Date().toISOString().split("T")[0]})),s.appendChild(de({label:"Sessione",name:"session_no",type:"number",value:(e==null?void 0:e.session_no)??""})),s.appendChild(yn({label:"Contenuto",name:"content",value:(e==null?void 0:e.content)??""}));const l=document.createElement("label");l.className="checkbox",l.innerHTML=`<input type="checkbox" name="is_pinned" ${e!=null&&e.is_pinned?"checked":""} /> <span>In evidenza</span>`,s.appendChild(l);const u=document.createElement("div");u.className="tag-selector",u.innerHTML="<span>Tag</span>",t.forEach(g=>{const y=document.createElement("label");y.className="checkbox";const _=document.createElement("input");_.type="checkbox",_.value=g.id,_.name="entry_tag",r.includes(g.id)&&(_.checked=!0),y.appendChild(_),y.append(g.name),u.appendChild(y)}),s.appendChild(u);const h=await dt({title:e?"Modifica voce":"Nuova voce",submitLabel:e?"Salva":"Crea",content:s,cardClass:"modal-card--wide"});if(!h)return;const f={user_id:n.user_id,character_id:n.id,title:h.get("title"),entry_date:h.get("entry_date"),session_no:Number(h.get("session_no")||0),content:h.get("content"),is_pinned:h.get("is_pinned")==="on"};rt(!0);try{const g=e?await nf(e.id,f):await tf(f),y=Array.from(u.querySelectorAll('input[type="checkbox"]')).filter(_=>_.checked).map(_=>_.value);if(e){const _=y.filter(v=>!r.includes(v)),w=r.filter(v=>!y.includes(v));await Promise.all([..._.map(v=>oo(g.id,v)),...w.map(v=>sf(g.id,v))])}else await Promise.all(y.map(_=>oo(g.id,_)));Y("Voce salvata"),await i()}catch{Y("Errore salvataggio voce","error")}finally{rt(!1)}}async function mf(n,e){const t=document.createElement("div");t.className="drawer-form modal-form-grid",t.appendChild(de({label:"Nome tag",name:"name"}));const r=await dt({title:"Nuovo tag",submitLabel:"Crea",content:t});if(r)try{await af({user_id:n.user_id,name:r.get("name")}),Y("Tag creato"),e()}catch{Y("Errore tag","error")}}const gf="modulepreload",vf=function(n){return"/dungeons-dragons-app/"+n},co={},bf=function(e,t,r){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(t.map(h=>{if(h=vf(h),h in co)return;co[h]=!0;const f=h.endsWith(".css"),g=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${g}`))return;const y=document.createElement("link");if(y.rel=f?"stylesheet":gf,f||(y.as="script"),y.crossOrigin="",y.href=h,u&&y.setAttribute("nonce",u),document.head.appendChild(y),f)return new Promise((_,w)=>{y.addEventListener("load",_),y.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${h}`)))})}))}function s(l){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=l,window.dispatchEvent(u),!u.defaultPrevented)throw l}return i.then(l=>{for(const u of l||[])u.status==="rejected"&&s(u.reason);return e().catch(s)})};function yf(n={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:r,onRegistered:i,onRegisteredSW:s,onRegisterError:l}=n;let u,h;const f=async(y=!0)=>{await h};async function g(){if("serviceWorker"in navigator){if(u=await bf(async()=>{const{Workbox:y}=await import("./workbox-window.prod.es5-vqzQaGvo.js");return{Workbox:y}},[]).then(({Workbox:y})=>new y("/dungeons-dragons-app/sw.js",{scope:"/dungeons-dragons-app/",type:"classic"})).catch(y=>{l==null||l(y)}),!u)return;u.addEventListener("activated",y=>{(y.isUpdate||y.isExternal)&&window.location.reload()}),u.addEventListener("installed",y=>{y.isUpdate||r==null||r()}),u.register({immediate:e}).then(y=>{s?s("/dungeons-dragons-app/sw.js",y):i==null||i(y)}).catch(y=>{l==null||l(y)})}}return h=g(),f}const _f=document.querySelector("#app");$l(_f);Oh();document.addEventListener("pointerdown",n=>{const e=n.target.closest("button, .bottom-nav a, .menu-item");e&&(e.classList.remove("is-pressed"),e.offsetWidth,e.classList.add("is-pressed"),window.setTimeout(()=>e.classList.remove("is-pressed"),220))});document.addEventListener("click",async n=>{if(n.target.closest("[data-logout]")){n.preventDefault();try{await yd()}finally{window.location.hash="#/login"}}});Dr("login",_d);Dr("home",Ze);Dr("characters",el);Dr("inventory",bn);Dr("journal",tl);Cl(()=>{xl(),ho()});window.addEventListener("online",()=>un({offline:!1}));window.addEventListener("offline",()=>un({offline:!0}));un({offline:!navigator.onLine});const wf=async()=>{await bd();const{user:n}=ht();n&&await Ro(n),ho(),await gd(),Pl()};yf({immediate:!0});wf();
